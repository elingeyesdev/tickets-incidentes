# ğŸ” DiagnÃ³stico de Problemas de RedirecciÃ³n - Helpdesk Inertia+JWT\n\n## ğŸ“‹ Resumen del Sistema\n\nTu aplicaciÃ³n usa una arquitectura compleja:\n- **Backend:** Laravel + GraphQL + JWT (sin sesiones tradicionales)\n- **Frontend:** React + Inertia.js + XState (state machine)\n- **AutenticaciÃ³n:** JWT tokens con TokenManager (single source of truth)\n- **Flujo:** Login â†’ Onboarding â†’ Role Selection â†’ Dashboard\n\n---\n\n## ğŸš¨ Problemas MÃ¡s Comunes de RedirecciÃ³n\n\n### Problema 1: Bucle Infinito de Redirecciones\n**SÃ­ntoma:** Usuario queda atrapado entre `/role-selector`, `/onboarding`, `/login`\n\n**Causas Posibles:**\n1. **TokenManager no persiste correctamente**\n   - El token se pierde entre renders\n   - `PersistenceService` falla al guardar/cargar estado\n\n2. **AuthContext inicializaciÃ³n defectuosa**\n   - `authMachine` queda en estado `initializing` indefinidamente\n   - `SESSION_DETECTED` nunca se envÃ­a a la mÃ¡quina de estados\n\n3. **DesincronizaciÃ³n backend-frontend**\n   - El backend valida diferente al frontend\n   - Ejemplo: Backend dice \"no onboarded\" pero frontend cree que sÃ­\n\n4. **RoleContext vacÃ­o o incompleto**\n   - `user.roleContexts` estÃ¡ vacÃ­o\n   - `dashboardPath` es `null` o `undefined`\n\n---\n\n## ğŸ› ï¸ Checklist de DiagnÃ³stico\n\n### Paso 1: Verificar Persistencia del Token\n\n```javascript\n// En la consola del navegador:\nconsole.log('=== TOKEN MANAGER DEBUG ===')\nconsole.log('Token en TokenManager:', TokenManager.getAccessToken())\nconsole.log('ValidaciÃ³n:', TokenManager.validateToken())\nconsole.log('Role seleccionado:', TokenManager.getLastSelectedRole())\n\n// Verificar localStorage/sessionStorage\nconsole.log('localStorage.authState:', localStorage.getItem('authState'))\nconsole.log('sessionStorage.authState:', sessionStorage.getItem('authState'))\n```\n\n**Â¿QuÃ© buscar?**\n- âœ… Token debe existir y ser vÃ¡lido\n- âœ… `lastSelectedRole` debe tener un valor si hay mÃºltiples roles\n- âœ… Estado debe persistirse entre recargas de pÃ¡gina\n\n---\n\n### Paso 2: Verificar AuthContext State Machine\n\n```javascript\n// En la consola:\nconsole.log('=== AUTH CONTEXT DEBUG ===')\nconst auth = useAuth() // Necesitas estar en un componente React\nconsole.log('Auth State:', auth.authState)  // 'initializing' | 'authenticated' | 'unauthenticated'\nconsole.log('User:', auth.user)\nconsole.log('Is Authenticated:', auth.isAuthenticated)\nconsole.log('Loading:', auth.loading)\n```\n\n**Â¿QuÃ© buscar?**\n- âŒ Si `authState === 'initializing'` por >2 segundos = problema\n- âœ… `authState` debe ser `'authenticated'` despuÃ©s del login\n- âœ… `user` debe contener `roleContexts` con al menos 1 role\n\n---\n\n### Paso 3: Revisar Logs de AuthContext\n\nAbre las DevTools (F12) y busca logs que empiezan con `[DIAGNOSTIC]`, `[AuthContext]`, `[useLogin]`:\n\n```\n[DIAGNOSTIC] 1. AuthGuard mounted. Starting session verification...\n[DIAGNOSTIC] 2. Found valid token in persistence. Verifying with backend...\n[DIAGNOSTIC] 3. Backend verification response received: {...}\n[DIAGNOSTIC] 4a. Success. Sending SESSION_DETECTED to state machine.\n```\n\n**Flujo correcto:**\n```\n1. Detecta token vÃ¡lido\n   â†“\n2. Verifica con backend (AUTH_STATUS_QUERY)\n   â†“\n3. Backend responde con user data\n   â†“\n4. EnvÃ­a SESSION_DETECTED a state machine\n   â†“\n5. AuthContext establece isAuthenticated=true\n```\n\n**Si algo falla:**\n- 4b = Token vÃ¡lido localmente pero backend dice \"no authenticado\" (problema grave)\n- 4c = Error en la query de backend (problema de red/GraphQL)\n\n---\n\n### Paso 4: Verificar Backend Response (GraphQL)\n\n**En Network tab â†’ GraphQL query `authStatus`:**\n\n```json\n{\n  \"data\": {\n    \"authStatus\": {\n      \"isAuthenticated\": true,\n      \"user\": {\n        \"id\": \"user-123\",\n        \"email\": \"user@example.com\",\n        \"onboardingCompletedAt\": \"2024-01-15T10:30:00Z\",\n        \"roleContexts\": [\n          {\n            \"roleCode\": \"USER\",\n            \"roleName\": \"Usuario\",\n            \"dashboardPath\": \"/tickets\",\n            \"company\": null\n          }\n        ]\n      }\n    }\n  }\n}\n```\n\n**Â¿QuÃ© buscar?**\n- âœ… `isAuthenticated: true`\n- âœ… `roleContexts` NO estÃ¡ vacÃ­o\n- âœ… Cada role tiene `dashboardPath` vÃ¡lido\n- âœ… Si `onboardingCompletedAt` es `null`, usuario debe ir a `/onboarding/profile`\n\n---\n\n### Paso 5: Rastrear Redirecciones (AuthGuard)\n\n```javascript\n// En components/Auth/AuthGuard.tsx\n// Los logs deberÃ­an mostrar por quÃ© se redirige:\n\nif (!isAuthenticated) {\n    console.log('âŒ AuthGuard: Not authenticated, redirecting to /login');\n    router.visit('/login', { replace: true });\n    return;\n}\n\nif (!hasCompletedOnboarding()) {\n    console.log('âŒ AuthGuard: Onboarding incomplete, redirecting to /onboarding/profile');\n    router.visit('/onboarding/profile', { replace: true });\n    return;\n}\n\nif (multiRole && !lastSelectedRole) {\n    console.log('âŒ AuthGuard: Multi-role user without role selected, redirecting to /role-selector');\n    router.visit('/role-selector', { replace: true });\n    return;\n}\n\nconsole.log('âœ… AuthGuard: All checks passed, rendering protected content');\n```\n\n**Â¿QuÃ© buscar?**\n- Cuenta cuÃ¡ntas veces se ejecuta cada condiciÃ³n\n- Si se ejecuta mÃ¡s de 1 vez = problema de dependencias en useEffect\n\n---\n\n### Paso 6: Verificar RoleSelector\n\n**En `/role-selector`:**\n\n```javascript\nconsole.log('=== ROLE SELECTOR DEBUG ===')\nconsole.log('User:', user)\nconsole.log('RoleContexts:', user?.roleContexts)\nconsole.log('RoleContexts.length:', user?.roleContexts?.length)\n\n// Verificar si dashboardPath existe\nuser?.roleContexts?.forEach((role, i) => {\n    console.log(`Role ${i}:`, role.roleCode, 'Path:', role.dashboardPath)\n})\n```\n\n**Â¿QuÃ© buscar?**\n- âœ… Si `roleContexts.length === 1` â†’ debe auto-redirigir al dashboard\n- âœ… Si `roleContexts.length > 1` â†’ mostrar selector\n- âŒ Si `roleContexts.length === 0` â†’ mostrar \"No roles asignados\"\n- âŒ Si `dashboardPath` es nulo â†’ **PROBLEMA CRÃTICO**\n\n---\n\n### Paso 7: Revisar useLogin Hook\n\n**Cuando presionas \"Login\":**\n\n```javascript\n// DeberÃ­a loguear:\nâœ… useLogin: Login successful {email, roles, onboardingCompleted}\n\n// Luego determinar:\nif (!onboardingCompleted) {\n    redirect('/onboarding/profile')  // â† Correcto\n} else if (roleContexts.length === 1) {\n    redirect(roleContexts[0].dashboardPath)  // â† Correcto\n} else {\n    redirect('/role-selector')  // â† Correcto\n}\n```\n\n**Â¿QuÃ© buscar?**\n- âœ… Login completa exitosamente\n- âœ… El token se establece en TokenManager\n- âœ… La redirecciÃ³n es correcta segÃºn el estado del usuario\n\n---\n\n## ğŸ› Problemas EspecÃ­ficos y Soluciones\n\n### Problema: \"TokenManager.onReady() nunca se resuelve\"\n\n**Causa:** `PersistenceService.loadState()` falla\n\n**SoluciÃ³n:**\n```javascript\n// En resources/js/lib/auth/PersistenceService.ts\n// Agrega logs:\nasync loadState() {\n    console.log('[PersistenceService] Starting loadState...')\n    try {\n        const data = await retrieveFromIndexedDB() // o localStorage\n        console.log('[PersistenceService] Loaded data:', data)\n        return data\n    } catch (error) {\n        console.error('[PersistenceService] Error loading:', error)\n        return null\n    }\n}\n```\n\n---\n\n### Problema: \"Backend valida diferente al frontend\"\n\n**Causa posible:** JWT token JWT middleware rechaza el token que el TokenManager cree que es vÃ¡lido\n\n**VerificaciÃ³n:**\n```javascript\n// En rutas protegidas (web-jwt-pure.php)\n// El middleware jwt.auth deberÃ­a:\n1. Extraer token del header Authorization\n2. Validar firma JWT\n3. Verificar que no estÃ¡ expirado\n4. Cargar el usuario asociado\n\n// Si falla aquÃ­:\nconsole.log('Token from request:', $token);\nconsole.log('Validation result:', $this->tokenService->validate($token));\n```\n\n---\n\n### Problema: \"Bucle entre role-selector y dashboard\"\n\n**Causa:** `lastSelectedRole` no persiste correctamente\n\n**SoluciÃ³n:**\n```javascript\n// En resources/js/lib/auth/TokenManager.ts\npublic setLastSelectedRole(roleCode: string): void {\n    this.lastSelectedRole = roleCode;\n    console.log('[TokenManager] Setting lastSelectedRole to:', roleCode);\n    \n    // Verificar que se persistiÃ³:\n    PersistenceService.saveState({...})\n        .then(() => {\n            console.log('[TokenManager] Persisted successfully');\n            // Verificar que se cargÃ³ de vuelta:\n            PersistenceService.loadState()\n                .then(data => {\n                    console.log('[TokenManager] Verification - loaded role:', data.lastSelectedRole);\n                });\n        });\n}\n```\n\n---\n\n## ğŸ“Š Tabla de Debugging por Pantalla\n\n| Pantalla | Â¿QuÃ© verificar? | Â¿DÃ³nde? |\n|----------|-----------------|----------|\n| `/login` | Â¿Token limpio? Â¿JWT cleared? | DevTools â†’ Storage â†’ localStorage/sessionStorage |\n| `/onboarding/profile` | Â¿`onboardingCompletedAt` aÃºn null? | GraphQL response en Network tab |\n| `/role-selector` | Â¿`user.roleContexts` tiene datos? | Console: `useAuth().user.roleContexts` |\n| `/admin/dashboard` | Â¿Token aÃºn vÃ¡lido? Â¿Role es ADMIN? | Network â†’ Authorization header |\n\n---\n\n## ğŸ¯ Comando para Limpiar Estado Completo\n\n```javascript\n// Si todo se daÃ±a, ejecuta en la consola:\nlocalStorage.clear();\nsessionStorage.clear();\nindexedDB.deleteDatabase('authDB'); // o el nombre correcto\nwindow.location.reload();\n// DeberÃ­as ser redirigido a /login\n```\n\n---\n\n## ğŸš€ PrÃ³ximos Pasos\n\n1. **Ejecuta el Paso 1-7** del checklist anterior\n2. **Comparte los logs** que generan (copy-paste de consola)\n3. **Identifica exactamente dÃ³nde se rompe**\n4. Una vez identificado, podemos:\n   - Agregar logs adicionales\n   - Parchear el middleware\n   - Actualizar el TokenManager\n   - Modificar el AuthContext state machine\n\n---\n\n## ğŸ“ Notas Importantes\n\n- **NO uses `<Navigate>` en componentes** â†’ usa `router.visit()` desde Inertia\n- **AsegÃºrate que `AuthGuard` envuelve rutas protegidas** para evitar race conditions\n- **El TokenManager debe ser la Ãºnica fuente de verdad** para tokens\n- **Los logs `[DIAGNOSTIC]` en AuthContext te mostrarÃ¡n exactamente quÃ© pasa**\n\n---\n\n**Ãšltima actualizaciÃ³n:** 2024\n**Sistema:** Laravel + Inertia + React + GraphQL + JWT\n"}