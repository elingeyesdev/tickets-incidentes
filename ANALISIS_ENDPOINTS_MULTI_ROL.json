{
  "analisis_generado": "2025-12-07",
  "proyecto": "Helpdesk - Sistema Multi-Rol",
  "objetivo": "Identificar endpoints que FILTRAN datos según rol del usuario y requieren cambios para sistema multi-rol",
  
  "endpoints_criticos": [
    {
      "ruta": "GET /api/tickets",
      "controlador": "TicketController::index",
      "servicio": "TicketService::list",
      "archivo_servicio": "app/Features/TicketManagement/Services/TicketService.php",
      "lineas_codigo": [
        "TicketService.php:79 - getUserRole() determina rol con prioridad fija",
        "TicketService.php:88 - applyVisibilityFilters() aplica filtros según rol",
        "TicketService.php:106-120 - getUserRole() usa hasRoleFromJWT con prioridad PLATFORM_ADMIN > COMPANY_ADMIN > AGENT > USER",
        "TicketService.php:216-246 - applyVisibilityFilters() filtra por company_id según rol"
      ],
      "filtrado_actual": "getUserRole() retorna UN SOLO rol con prioridad fija. Si usuario tiene AGENT+USER, SIEMPRE retorna AGENT. applyVisibilityFilters() luego filtra: PLATFORM_ADMIN (sin filtros), COMPANY_ADMIN (su empresa), AGENT (su empresa), USER (solo tickets propios)",
      "impacto_multi_rol": "CRÍTICO - Usuario con AGENT+USER siempre ve TODOS los tickets de la empresa, nunca solo los suyos. No puede cambiar entre vistas.",
      "company_id_required": true,
      "requires_active_role": true,
      "solucion_propuesta": "Reemplazar getUserRole() con getActiveRole() que consulta active_role_id del usuario. Aplicar filtros según el rol activo seleccionado."
    },
    {
      "ruta": "GET /api/announcements",
      "controlador": "AnnouncementController::index",
      "servicio": "VisibilityService (inyectado)",
      "archivo_controlador": "app/Features/ContentManagement/Http/Controllers/AnnouncementController.php",
      "lineas_codigo": [
        "AnnouncementController.php:180 - visibilityService->isPlatformAdmin()",
        "AnnouncementController.php:185-201 - Bloque COMPANY_ADMIN usa getCompanyIdFromJWT()",
        "AnnouncementController.php:203-210 - Bloque AGENT/USER filtra por followed companies + PUBLISHED"
      ],
      "filtrado_actual": "Usa hasRole() para determinar si es COMPANY_ADMIN, luego obtiene company_id del JWT. AGENT y USER ven solo PUBLISHED de empresas seguidas.",
      "impacto_multi_rol": "ALTO - Usuario COMPANY_ADMIN+USER siempre ve todos los estados (DRAFT, SCHEDULED, PUBLISHED, ARCHIVED) de su empresa. No puede ver solo PUBLISHED como usuario final.",
      "company_id_required": true,
      "requires_active_role": true,
      "solucion_propuesta": "Usar active_role_id para determinar qué filtros aplicar. Si active_role = USER, mostrar solo PUBLISHED de empresas seguidas. Si active_role = COMPANY_ADMIN, mostrar todos los estados."
    },
    {
      "ruta": "GET /api/announcements/{id}",
      "controlador": "AnnouncementController::show",
      "servicio": "VisibilityService (inyectado)",
      "archivo_controlador": "app/Features/ContentManagement/Http/Controllers/AnnouncementController.php",
      "lineas_codigo": [
        "AnnouncementController.php:362 - visibilityService->isPlatformAdmin()",
        "AnnouncementController.php:371-384 - Bloque COMPANY_ADMIN valida company_id del JWT",
        "AnnouncementController.php:391-408 - Bloque AGENT/USER valida PUBLISHED y followed companies"
      ],
      "filtrado_actual": "PLATFORM_ADMIN ve todo. COMPANY_ADMIN ve cualquier estado de su empresa. AGENT/USER solo PUBLISHED de empresas seguidas.",
      "impacto_multi_rol": "ALTO - Usuario con COMPANY_ADMIN puede ver anuncios DRAFT de su empresa, pero si quisiera verlo como USER (para testear experiencia), no puede.",
      "company_id_required": true,
      "requires_active_role": true,
      "solucion_propuesta": "Verificar active_role_id antes de aplicar restricciones de visibilidad."
    },
    {
      "ruta": "GET /api/help-center/articles",
      "controlador": "ArticleController::index",
      "servicio": "ArticleService::listArticles",
      "archivo_servicio": "app/Features/ContentManagement/Services/ArticleService.php",
      "lineas_codigo": [
        "ArticleService.php:373-521 - Método listArticles() completo",
        "ArticleService.php:382-411 - Bloque PLATFORM_ADMIN (ve todo)",
        "ArticleService.php:413-427 - Bloque COMPANY_ADMIN (solo su empresa, todos los estados)",
        "ArticleService.php:429-446 - Bloque AGENT (solo su empresa, solo PUBLISHED)",
        "ArticleService.php:448-469 - Bloque USER (empresas seguidas, solo PUBLISHED)"
      ],
      "filtrado_actual": "Usa hasRole() para determinar tipo de usuario. COMPANY_ADMIN ve DRAFT+PUBLISHED de su empresa. AGENT solo PUBLISHED de su empresa. USER solo PUBLISHED de empresas seguidas.",
      "impacto_multi_rol": "ALTO - Usuario COMPANY_ADMIN+USER siempre ve artículos DRAFT de su empresa. AGENT+USER siempre ve solo artículos de su empresa, no de otras empresas seguidas.",
      "company_id_required": true,
      "requires_active_role": true,
      "solucion_propuesta": "Reemplazar hasRole() con verificación de active_role_id. Aplicar filtros según rol activo."
    },
    {
      "ruta": "GET /api/help-center/articles/{id}",
      "controlador": "ArticleController::show",
      "servicio": "ArticleService::viewArticle",
      "archivo_servicio": "app/Features/ContentManagement/Services/ArticleService.php",
      "lineas_codigo": [
        "ArticleService.php:293-369 - Método viewArticle() completo",
        "ArticleService.php:310-314 - Bloque PLATFORM_ADMIN (ve todo)",
        "ArticleService.php:316-327 - Bloque COMPANY_ADMIN (solo su empresa)",
        "ArticleService.php:329-353 - Bloque AGENT (solo su empresa + PUBLISHED)",
        "ArticleService.php:355-369 - Bloque USER (empresas seguidas + PUBLISHED, incrementa views)"
      ],
      "filtrado_actual": "Valida rol con hasRole(). COMPANY_ADMIN puede ver DRAFT de su empresa. AGENT solo PUBLISHED de su empresa. USER solo PUBLISHED de empresas seguidas (incrementa views_count).",
      "impacto_multi_rol": "MEDIO-ALTO - Usuario COMPANY_ADMIN puede ver artículos DRAFT, pero no se incrementan las vistas. Si se cambia a rol USER, debería incrementar vistas.",
      "company_id_required": true,
      "requires_active_role": true,
      "solucion_propuesta": "Usar active_role_id para determinar visibilidad y si incrementar views_count."
    },
    {
      "ruta": "GET /api/activity-logs",
      "controlador": "ActivityLogController::index",
      "servicio": "ActivityLogService",
      "archivo_controlador": "app/Features/AuditLog/Http/Controllers/ActivityLogController.php",
      "lineas_codigo": [
        "ActivityLogController.php:111 - Determina si es admin con hasRoleFromJWT('PLATFORM_ADMIN') || hasRoleFromJWT('COMPANY_ADMIN')",
        "ActivityLogController.php:114-126 - Validación de permisos para ver logs de otros usuarios"
      ],
      "filtrado_actual": "Usuarios admin (PLATFORM_ADMIN o COMPANY_ADMIN) pueden ver logs de otros usuarios. No-admin solo ven sus propios logs.",
      "impacto_multi_rol": "MEDIO - Usuario COMPANY_ADMIN+USER puede ver logs de otros usuarios de su empresa. Si quiere ver solo sus logs, no puede.",
      "company_id_required": false,
      "requires_active_role": true,
      "solucion_propuesta": "Verificar active_role_id para determinar si puede ver logs de otros usuarios."
    },
    {
      "ruta": "GET /api/activity-logs/entity/{entityType}/{entityId}",
      "controlador": "ActivityLogController::entityActivity",
      "servicio": "ActivityLogService",
      "archivo_controlador": "app/Features/AuditLog/Http/Controllers/ActivityLogController.php",
      "lineas_codigo": [
        "ActivityLogController.php:334 - Determina si es admin con hasRoleFromJWT",
        "ActivityLogController.php:337-348 - Validación para tickets (solo creador o agente asignado)",
        "ActivityLogController.php:351-356 - Validación para usuarios (solo el mismo usuario o admin)"
      ],
      "filtrado_actual": "Valida permisos según entidad. Para tickets, solo creador u owner_agent pueden ver. Para usuarios, solo el mismo o admins.",
      "impacto_multi_rol": "MEDIO - Usuario AGENT+USER puede ver actividad de tickets donde es agente, pero si tiene active_role=USER, tal vez no debería.",
      "company_id_required": false,
      "requires_active_role": true,
      "solucion_propuesta": "Verificar active_role_id para determinar permisos de visualización."
    },
    {
      "ruta": "GET /api/users",
      "controlador": "UserController::index",
      "servicio": "UserService",
      "archivo_controlador": "app/Features/UserManagement/Http/Controllers/UserController.php",
      "lineas_codigo": [
        "UserController.php:193-199 - Verificación de permisos (PLATFORM_ADMIN, COMPANY_ADMIN, AGENT)",
        "UserController.php:210 - applyFilters() aplica filtros según rol",
        "UserController.php:591-609 - applyFilters() filtra por company usando userRoles si es COMPANY_ADMIN o AGENT"
      ],
      "filtrado_actual": "COMPANY_ADMIN y AGENT ven solo usuarios de su empresa. PLATFORM_ADMIN ve todos. Filtra usando whereHas('userRoles') por company_id.",
      "impacto_multi_rol": "MEDIO - Usuario COMPANY_ADMIN+AGENT siempre ve usuarios de su empresa. No afecta mucho porque ambos roles ven lo mismo.",
      "company_id_required": true,
      "requires_active_role": true,
      "solucion_propuesta": "Usar active_role_id para determinar scope de empresa."
    },
    {
      "ruta": "POST /api/tickets/responses",
      "controlador": "TicketResponseController::store",
      "servicio": "ResponseService::create",
      "archivo_servicio": "app/Features/TicketManagement/Services/ResponseService.php",
      "lineas_codigo": [
        "ResponseService.php:94-99 - determineAuthorType() usa hasRoleFromJWT('AGENT') para determinar si es AGENT o USER"
      ],
      "filtrado_actual": "Si tiene rol AGENT en JWT, marca la respuesta como author_type=AGENT. Si no, author_type=USER.",
      "impacto_multi_rol": "CRÍTICO - Usuario AGENT+USER que responde un ticket SIEMPRE lo hace como AGENT, nunca como USER. No puede cambiar.",
      "company_id_required": false,
      "requires_active_role": true,
      "solucion_propuesta": "Usar active_role_id para determinar author_type. Si active_role es AGENT, author_type=AGENT. Si es USER, author_type=USER."
    }
  ],

  "endpoints_media_prioridad": [
    {
      "ruta": "GET /api/companies",
      "controlador": "CompanyController::index",
      "servicio": "CompanyService::index",
      "archivo_controlador": "app/Features/CompanyManagement/Http/Controllers/CompanyController.php",
      "lineas_codigo": [
        "CompanyController.php:532-538 - Si es COMPANY_ADMIN, filtra solo su empresa (where admin_user_id)"
      ],
      "filtrado_actual": "COMPANY_ADMIN ve solo su empresa. PLATFORM_ADMIN ve todas.",
      "impacto_multi_rol": "BAJO - Filtrado es correcto. Solo necesita verificar active_role_id en lugar de hasRole().",
      "company_id_required": false,
      "requires_active_role": true,
      "solucion_propuesta": "Cambiar hasRole() por verificación de active_role_id."
    },
    {
      "ruta": "GET /api/tickets/categories",
      "controlador": "CategoryController::index",
      "servicio": "CategoryService::list",
      "archivo_servicio": "app/Features/TicketManagement/Services/CategoryService.php",
      "lineas_codigo": [
        "CategoryService.php:183-198 - list() filtra por company_id (parametrizado desde request)"
      ],
      "filtrado_actual": "Filtra categorías por company_id proporcionado en request. No usa rol para filtrar.",
      "impacto_multi_rol": "BAJO - El filtrado es por company_id explícito, no por rol. No requiere cambios inmediatos.",
      "company_id_required": true,
      "requires_active_role": false,
      "solucion_propuesta": "Sin cambios necesarios. El filtrado ya es explícito por company_id."
    },
    {
      "ruta": "GET /api/companies/{id}/areas",
      "controlador": "AreaController::index (CompanyManagement)",
      "servicio": "AreaService::list",
      "archivo_servicio": "app/Features/CompanyManagement/Services/AreaService.php",
      "lineas_codigo": [
        "AreaService.php:95-116 - list() filtra por company_id (parametrizado)"
      ],
      "filtrado_actual": "Filtra áreas por company_id proporcionado. No usa rol directamente.",
      "impacto_multi_rol": "BAJO - Similar a categorías, filtrado explícito por company_id.",
      "company_id_required": true,
      "requires_active_role": false,
      "solucion_propuesta": "Sin cambios necesarios."
    },
    {
      "ruta": "GET /api/analytics/company-dashboard",
      "controlador": "AnalyticsController (inferido)",
      "servicio": "AnalyticsService::getKpiStats, getTeamStats",
      "archivo_servicio": "app/Features/Analytics/Services/AnalyticsService.php",
      "lineas_codigo": [
        "AnalyticsService.php:99-102 - getKpiStats() cuenta agentes con whereHas('userRoles')",
        "AnalyticsService.php:462-465 - getTeamStats() filtra agentes por company_id"
      ],
      "filtrado_actual": "Filtra usuarios con rol AGENT por company_id. Usado para estadísticas de empresa.",
      "impacto_multi_rol": "BAJO - Solo cuenta agentes activos. No afecta visualización multi-rol.",
      "company_id_required": true,
      "requires_active_role": false,
      "solucion_propuesta": "Sin cambios. Las estadísticas son independientes del active_role del usuario que consulta."
    }
  ],

  "endpoints_excluidos": [
    {
      "ruta": "POST /api/tickets/categories",
      "controlador": "CategoryController::store",
      "motivo_exclusion": "Solo valida permisos con authorize() en Policy. No filtra datos de retorno según rol. Usa getCompanyIdFromJWT para asignar company_id, pero esto es creación, no filtrado.",
      "archivo": "app/Features/TicketManagement/Http/Controllers/CategoryController.php"
    },
    {
      "ruta": "PATCH /api/tickets/{ticket}",
      "controlador": "TicketController::update",
      "motivo_exclusion": "Usa Policy (authorize()) para validar permisos. No filtra datos, solo valida si puede actualizar. El filtrado ocurre en el list().",
      "archivo": "app/Features/TicketManagement/Http/Controllers/TicketController.php"
    },
    {
      "ruta": "POST /api/help-center/articles",
      "controlador": "ArticleController::store",
      "motivo_exclusion": "Solo crea artículo. No filtra datos según rol. Usa getCompanyIdFromJWT para asignar company_id.",
      "archivo": "app/Features/ContentManagement/Http/Controllers/ArticleController.php"
    },
    {
      "ruta": "DELETE /api/tickets/{ticket}",
      "controlador": "TicketController::destroy",
      "motivo_exclusion": "Usa Policy para bloquear acceso. No filtra datos, es operación de eliminación con validación de permisos.",
      "archivo": "app/Features/TicketManagement/Http/Controllers/TicketController.php"
    },
    {
      "ruta": "POST /api/tickets",
      "controlador": "TicketController::store",
      "motivo_exclusion": "Solo crea ticket. Requiere rol USER (middleware), pero no filtra datos de retorno.",
      "archivo": "app/Features/TicketManagement/Http/Controllers/TicketController.php"
    },
    {
      "ruta": "POST /api/companies/{company}/follow",
      "controlador": "CompanyFollowerController::follow",
      "motivo_exclusion": "Operación de seguimiento. No filtra datos según rol, solo ejecuta acción.",
      "archivo": "app/Features/CompanyManagement/Http/Controllers/CompanyFollowerController.php"
    },
    {
      "ruta": "GET /api/companies/{company}/is-following",
      "controlador": "CompanyFollowerController::isFollowing",
      "motivo_exclusion": "Solo verifica estado de seguimiento. No filtra colecciones de datos.",
      "archivo": "app/Features/CompanyManagement/Http/Controllers/CompanyFollowerController.php"
    },
    {
      "ruta": "POST /api/announcements",
      "controlador": "AnnouncementController::store",
      "motivo_exclusion": "Operación de creación. No filtra datos según rol.",
      "archivo": "app/Features/ContentManagement/Http/Controllers/AnnouncementController.php"
    },
    {
      "ruta": "PATCH /api/announcements/{id}",
      "controlador": "AnnouncementController::update",
      "motivo_exclusion": "Operación de actualización con validación de permisos. No filtra listas de datos.",
      "archivo": "app/Features/ContentManagement/Http/Controllers/AnnouncementController.php"
    }
  ],

  "resumen_impacto": {
    "endpoints_criticos_total": 9,
    "endpoints_media_prioridad_total": 4,
    "endpoints_excluidos_total": 9,
    "require_active_role_system": 13,
    "require_company_id_context": 11,
    
    "cambios_necesarios": {
      "services_a_modificar": [
        "TicketService.php - Reemplazar getUserRole() y applyVisibilityFilters()",
        "ArticleService.php - Reemplazar hasRole() en listArticles() y viewArticle()",
        "ResponseService.php - Reemplazar hasRoleFromJWT() en determineAuthorType()"
      ],
      "controllers_a_modificar": [
        "AnnouncementController.php - Reemplazar hasRole() y getCompanyIdFromJWT() en index() y show()",
        "ActivityLogController.php - Reemplazar hasRoleFromJWT() en index() y entityActivity()",
        "UserController.php - Reemplazar hasRole() en index() y applyFilters()",
        "CompanyController.php - Reemplazar hasRole() en index()"
      ],
      "helpers_a_crear": [
        "ActiveRoleHelper::getActiveRole() - Obtener rol activo del usuario autenticado",
        "ActiveRoleHelper::getActiveCompanyId() - Obtener company_id del rol activo",
        "ActiveRoleHelper::hasActiveRole($roleCode) - Verificar si rol activo coincide"
      ]
    }
  },

  "patron_detectado": {
    "problema_principal": "Uso de JWTHelper::hasRoleFromJWT() y User::hasRole() para determinar visibilidad de datos. Estos métodos retornan true si el usuario TIENE el rol (aunque no esté activo), causando que usuarios multi-rol siempre vean datos del rol con mayor privilegio.",
    "solucion_general": "Implementar sistema de active_role_id que almacena el rol actualmente seleccionado por el usuario. Todos los filtros de visibilidad deben consultar active_role_id en lugar de verificar si el usuario TIENE el rol.",
    "migracion_requerida": "Agregar columna active_role_id a tabla auth.users (FK a auth.user_roles). Crear middleware para validar que active_role_id sea válido y activo.",
    "endpoints_de_gestion": "Crear endpoints POST /api/users/me/active-role y GET /api/users/me/available-roles para gestionar cambio de rol activo."
  },

  "notas_adicionales": [
    "Todos los endpoints críticos usan lógica if/else para determinar rol con prioridad fija (PLATFORM_ADMIN > COMPANY_ADMIN > AGENT > USER)",
    "La mayoría de servicios NO reciben rol como parámetro, lo obtienen directamente del JWT usando helpers",
    "Algunos controladores inyectan VisibilityService pero siguen usando hasRole() directamente",
    "El filtrado por company_id usa getCompanyIdFromJWT($roleName) que asume solo UN rol de ese tipo por usuario",
    "No hay validación de que el usuario tenga active_role_id configurado en la mayoría de endpoints",
    "Las Policies usan authorize() pero también verifican hasRoleFromJWT() internamente para obtener company_id"
  ]
}
