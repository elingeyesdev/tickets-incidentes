# üè¢ COMPANY MANAGEMENT FEATURE - DOCUMENTACI√ìN COMPLETA

## üéØ OVERVIEW DEL FEATURE

El **CompanyManagement Feature** es fundamental para la arquitectura multi-tenant del sistema Helpdesk. Gestiona empresas, solicitudes de registro, configuraci√≥n corporativa y validaci√≥n de contextos empresariales para roles de agentes y administradores.

### üèóÔ∏è ARQUITECTURA DEL FEATURE

```
CompanyManagement/
‚îú‚îÄ‚îÄ Services/           # L√≥gica de negocio empresarial
‚îÇ   ‚îú‚îÄ‚îÄ CompanyService.php
‚îÇ   ‚îú‚îÄ‚îÄ CompanyRequestService.php
‚îÇ   ‚îî‚îÄ‚îÄ CompanyConfigService.php
‚îú‚îÄ‚îÄ GraphQL/           # API Layer
‚îú‚îÄ‚îÄ Models/            # Company, CompanyRequest
‚îú‚îÄ‚îÄ Events/            # Eventos empresariales
‚îî‚îÄ‚îÄ Tests/             # Tests espec√≠ficos
```

### üé≠ TIPOS DE USUARIOS Y ACCESOS

1. **Usuario P√∫blico**: Puede ver empresas p√∫blicas y solicitar registro
2. **Platform Admin**: Gesti√≥n completa de empresas y solicitudes
3. **Company Admin**: Gesti√≥n de su propia empresa
4. **Agent**: Acceso de solo lectura a info de su empresa
5. **User**: Puede seguir empresas y crear tickets

---

## üìñ QUERIES - OPERACIONES DE LECTURA

### 1. PUBLIC_COMPANIES - Empresas P√∫blicas

**Descripci√≥n**: Lista de empresas p√∫blicas disponibles para registro de usuarios y creaci√≥n de tickets. No requiere autenticaci√≥n.

```graphql
query PublicCompanies(
    $search: String
    $activeOnly: Boolean = true
    $first: Int = 20
) {
    publicCompanies(
        search: $search
        activeOnly: $activeOnly
        first: $first
    ) {
        id
        companyCode
        name
        supportEmail
        website
        logoUrl
        description
        industry
        city
        country
        acceptsPublicUsers
        businessHoursDisplay
    }
}
```

**Variables de Ejemplo**:
```json
{
    "search": "universidad",
    "activeOnly": true,
    "first": 10
}
```

**Respuesta de Ejemplo**:
```json
{
    "data": {
        "publicCompanies": [
            {
                "id": "550e8400-e29b-41d4-a716-446655440000",
                "companyCode": "CMP-2025-00001",
                "name": "Universidad del Valle",
                "supportEmail": "soporte@univalle.edu.bo",
                "website": "https://univalle.edu.bo",
                "logoUrl": "https://storage.helpdesk.com/logos/univalle.png",
                "description": "Universidad privada l√≠der en Bolivia",
                "industry": "Educaci√≥n Superior",
                "city": "Cochabamba",
                "country": "Bolivia",
                "acceptsPublicUsers": true,
                "businessHoursDisplay": "Lunes a Viernes: 8:00 - 18:00"
            },
            {
                "id": "550e8400-e29b-41d4-a716-446655440001",
                "companyCode": "CMP-2025-00002",
                "name": "Empresa Tech Solutions",
                "supportEmail": "help@techsolutions.bo",
                "website": "https://techsolutions.bo",
                "logoUrl": "https://storage.helpdesk.com/logos/techsolutions.png",
                "description": "Soluciones tecnol√≥gicas innovadoras",
                "industry": "Tecnolog√≠a",
                "city": "Santa Cruz",
                "country": "Bolivia",
                "acceptsPublicUsers": true,
                "businessHoursDisplay": "24/7 - Soporte continuo"
            }
        ]
    }
}
```

**Casos de Uso**:
- Selector de empresa en formulario de tickets
- Directorio p√∫blico de empresas
- P√°gina de registro donde elegir empresa
- Marketplace de servicios

---

### 2. COMPANY - Empresa Espec√≠fica

**Descripci√≥n**: Obtiene informaci√≥n completa de una empresa espec√≠fica. Requiere permisos de acceso.

```graphql
query Company($id: UUID!) {
    company(id: $id) {
        id
        companyCode
        name
        legalName
        supportEmail
        phone
        website

        # Informaci√≥n de contacto
        contactAddress
        contactCity
        contactState
        contactCountry
        contactPostalCode

        # Informaci√≥n legal
        taxId
        legalRepresentative

        # Configuraci√≥n operativa
        businessHours
        timezone

        # Branding
        logoUrl
        faviconUrl
        primaryColor
        secondaryColor

        # Estado
        status
        settings

        # Relaciones
        admin {
            id
            displayName
            email
        }

        # Estad√≠sticas (evita loops infinitos)
        activeAgentsCount
        totalUsersCount
        totalTicketsCount
        openTicketsCount
        averageRating
        categoriesCount
        macrosCount

        # Auditor√≠a
        createdAt
        updatedAt
        originRequest {
            id
            requestCode
        }
    }
}
```

**Variables**:
```json
{
    "id": "550e8400-e29b-41d4-a716-446655440000"
}
```

**Respuesta de Ejemplo**:
```json
{
    "data": {
        "company": {
            "id": "550e8400-e29b-41d4-a716-446655440000",
            "companyCode": "CMP-2025-00001",
            "name": "Universidad del Valle",
            "legalName": "Universidad del Valle S.R.L.",
            "supportEmail": "soporte@univalle.edu.bo",
            "phone": "+591 4 4232323",
            "website": "https://univalle.edu.bo",
            "contactAddress": "Av. Espa√±a #123, Zona Central",
            "contactCity": "Cochabamba",
            "contactState": "Cochabamba",
            "contactCountry": "Bolivia",
            "contactPostalCode": "0000",
            "taxId": "1234567890",
            "legalRepresentative": "Dr. Carlos Mendoza",
            "businessHours": {
                "monday": {"open": "08:00", "close": "18:00"},
                "tuesday": {"open": "08:00", "close": "18:00"},
                "wednesday": {"open": "08:00", "close": "18:00"},
                "thursday": {"open": "08:00", "close": "18:00"},
                "friday": {"open": "08:00", "close": "18:00"},
                "saturday": {"open": "08:00", "close": "12:00"}
            },
            "timezone": "America/La_Paz",
            "logoUrl": "https://storage.helpdesk.com/logos/univalle.png",
            "faviconUrl": "https://storage.helpdesk.com/favicons/univalle.ico",
            "primaryColor": "#1e40af",
            "secondaryColor": "#64748b",
            "status": "ACTIVE",
            "settings": {
                "allowPublicTickets": true,
                "autoAssignTickets": true,
                "requireEmailVerification": false
            },
            "admin": {
                "id": "admin-001",
                "displayName": "Admin Universidad",
                "email": "admin@univalle.edu.bo"
            },
            "activeAgentsCount": 12,
            "totalUsersCount": 145,
            "totalTicketsCount": 1247,
            "openTicketsCount": 23,
            "averageRating": 4.3,
            "categoriesCount": 8,
            "macrosCount": 15,
            "createdAt": "2025-01-15T10:00:00Z",
            "updatedAt": "2025-09-20T14:30:00Z",
            "originRequest": {
                "id": "req-001",
                "requestCode": "REQ-2025-00001"
            }
        }
    }
}
```

**Casos de Uso**:
- P√°gina de detalle de empresa
- Panel de configuraci√≥n empresarial
- Validaci√≥n de contexto para agentes
- Informaci√≥n para branding din√°mico

---

### 3. MY_COMPANIES - Mis Empresas

**Descripci√≥n**: Lista las empresas donde el usuario autenticado tiene roles activos.

```graphql
query MyCompanies {
    myCompanies {
        id
        companyCode
        name
        logoUrl
        primaryColor
        status
    }
}
```

**Respuesta de Ejemplo**:
```json
{
    "data": {
        "myCompanies": [
            {
                "id": "550e8400-e29b-41d4-a716-446655440000",
                "companyCode": "CMP-2025-00001",
                "name": "Universidad del Valle",
                "logoUrl": "https://storage.helpdesk.com/logos/univalle.png",
                "primaryColor": "#1e40af",
                "status": "ACTIVE"
            },
            {
                "id": "550e8400-e29b-41d4-a716-446655440001",
                "companyCode": "CMP-2025-00002",
                "name": "Empresa Tech Solutions",
                "logoUrl": "https://storage.helpdesk.com/logos/techsolutions.png",
                "primaryColor": "#dc2626",
                "status": "ACTIVE"
            }
        ]
    }
}
```

**Casos de Uso**:
- Selector de contexto empresarial
- Dashboard de usuario con m√∫ltiples roles
- Navegaci√≥n entre empresas
- Validaci√≥n de permisos

---

### 4. COMPANIES - Lista Completa (Admin)

**Descripci√≥n**: Lista paginada de todas las empresas del sistema. Solo para platform admins.

```graphql
query Companies(
    $filters: CompanyFilters
    $orderBy: [CompanyOrderBy!]
    $page: Int = 1
    $first: Int = 15
) {
    companies(
        filters: $filters
        orderBy: $orderBy
        page: $page
        first: $first
    ) {
        data {
            id
            companyCode
            name
            supportEmail
            status
            admin {
                displayName
                email
            }
            activeAgentsCount
            totalTicketsCount
            averageRating
            createdAt
        }
        paginatorInfo {
            total
            perPage
            currentPage
            lastPage
            hasMorePages
        }
    }
}
```

**Variables con Filtros**:
```json
{
    "filters": {
        "search": "universidad",
        "status": "ACTIVE",
        "industry": "Educaci√≥n",
        "country": "Bolivia",
        "recentActivity": true,
        "createdBetween": {
            "from": "2025-01-01T00:00:00Z",
            "to": "2025-12-31T23:59:59Z"
        }
    },
    "orderBy": [
        {
            "field": "CREATED_AT",
            "order": "DESC"
        }
    ],
    "page": 1,
    "first": 25
}
```

**Casos de Uso**:
- Panel de administraci√≥n de plataforma
- Gesti√≥n masiva de empresas
- An√°lisis y reportes administrativos
- Monitoreo de actividad empresarial

---

### 5. COMPANY_REQUESTS - Solicitudes Pendientes

**Descripci√≥n**: Lista de solicitudes de empresa pendientes de aprobaci√≥n. Solo para platform admins.

```graphql
query CompanyRequests(
    $status: CompanyRequestStatus
    $first: Int = 15
) {
    companyRequests(
        status: $status
        first: $first
    ) {
        id
        requestCode
        companyName
        legalName
        adminEmail
        businessDescription
        website
        industryType
        estimatedUsers

        # Informaci√≥n de contacto
        contactAddress
        contactCity
        contactCountry
        taxId

        # Estado de solicitud
        status
        reviewedBy {
            displayName
        }
        reviewedAt
        rejectionReason
        createdCompany {
            id
            name
            companyCode
        }

        # Auditor√≠a
        createdAt
        updatedAt
    }
}
```

**Variables**:
```json
{
    "status": "PENDING",
    "first": 20
}
```

**Respuesta de Ejemplo**:
```json
{
    "data": {
        "companyRequests": [
            {
                "id": "req-001",
                "requestCode": "REQ-2025-00003",
                "companyName": "Consultor√≠a Legal P√©rez",
                "legalName": "Consultor√≠a Legal P√©rez & Asociados S.R.L.",
                "adminEmail": "admin@legaleperez.bo",
                "businessDescription": "Consultor√≠a legal especializada en derecho empresarial y tributario con m√°s de 15 a√±os de experiencia en el mercado boliviano.",
                "website": "https://legalperez.bo",
                "industryType": "Servicios Legales",
                "estimatedUsers": 25,
                "contactAddress": "Av. Ballivi√°n #456, Zona Sur",
                "contactCity": "La Paz",
                "contactCountry": "Bolivia",
                "taxId": "9876543210",
                "status": "PENDING",
                "reviewedBy": null,
                "reviewedAt": null,
                "rejectionReason": null,
                "createdCompany": null,
                "createdAt": "2025-09-20T15:30:00Z",
                "updatedAt": "2025-09-20T15:30:00Z"
            }
        ]
    }
}
```

**Casos de Uso**:
- Panel de revisi√≥n de solicitudes
- Proceso de aprobaci√≥n empresarial
- Auditor√≠a de nuevas empresas
- Gesti√≥n de cola de solicitudes

---

## ‚úèÔ∏è MUTATIONS - OPERACIONES DE ESCRITURA

### 1. REQUEST_COMPANY - Solicitar Nueva Empresa

**Descripci√≥n**: Solicitud p√∫blica para crear una nueva empresa. No requiere autenticaci√≥n.

```graphql
mutation RequestCompany($input: CompanyRequestInput!) {
    requestCompany(input: $input) {
        id
        requestCode
        companyName
        adminEmail
        status
        createdAt
    }
}
```

**Input Variables**:
```json
{
    "input": {
        "companyName": "Consultor√≠a Legal P√©rez",
        "legalName": "Consultor√≠a Legal P√©rez & Asociados S.R.L.",
        "adminEmail": "admin@legalperez.bo",
        "businessDescription": "Consultor√≠a legal especializada en derecho empresarial y tributario con m√°s de 15 a√±os de experiencia en el mercado boliviano. Ofrecemos servicios integrales de asesoramiento legal para empresas de todos los tama√±os.",
        "website": "https://legalperez.bo",
        "industryType": "Servicios Legales",
        "estimatedUsers": 25,
        "contactAddress": "Av. Ballivi√°n #456, Zona Sur",
        "contactCity": "La Paz",
        "contactCountry": "Bolivia",
        "contactPostalCode": "0000",
        "taxId": "9876543210"
    }
}
```

**Validaciones del Input**:
- `companyName`: Requerido, 2-200 caracteres
- `adminEmail`: Requerido, formato email v√°lido
- `businessDescription`: Requerido, 50-1000 caracteres
- `industryType`: Requerido, m√°ximo 100 caracteres
- `estimatedUsers`: Opcional, entre 1 y 10,000
- `website`: Opcional, URL v√°lida
- `taxId`: Opcional, m√°ximo 50 caracteres

**Respuesta de Ejemplo**:
```json
{
    "data": {
        "requestCompany": {
            "id": "550e8400-e29b-41d4-a716-446655440010",
            "requestCode": "REQ-2025-00003",
            "companyName": "Consultor√≠a Legal P√©rez",
            "adminEmail": "admin@legalperez.bo",
            "status": "PENDING",
            "createdAt": "2025-09-21T16:45:00Z"
        }
    }
}
```

**Flujo Post-Solicitud**:
1. Solicitud creada con status "PENDING"
2. Email de confirmaci√≥n enviado al solicitante
3. Notificaci√≥n a platform admins para revisi√≥n
4. Solicitud aparece en cola de revisi√≥n

**Rate Limiting**:
- M√°ximo 3 solicitudes por hora por IP
- Validaci√≥n de email √∫nico por solicitud

---

### 2. APPROVE_COMPANY_REQUEST - Aprobar Solicitud

**Descripci√≥n**: Aprueba una solicitud de empresa y crea autom√°ticamente la empresa y admin. Solo platform admins.

```graphql
mutation ApproveCompanyRequest($requestId: UUID!) {
    approveCompanyRequest(requestId: $requestId) {
        id
        companyCode
        name
        status
        admin {
            id
            email
            displayName
        }
        createdAt
    }
}
```

**Variables**:
```json
{
    "requestId": "550e8400-e29b-41d4-a716-446655440010"
}
```

**Respuesta de Ejemplo**:
```json
{
    "data": {
        "approveCompanyRequest": {
            "id": "550e8400-e29b-41d4-a716-446655440020",
            "companyCode": "CMP-2025-00003",
            "name": "Consultor√≠a Legal P√©rez",
            "status": "ACTIVE",
            "admin": {
                "id": "user-admin-003",
                "email": "admin@legalperez.bo",
                "displayName": "Admin Legal P√©rez"
            },
            "createdAt": "2025-09-21T17:00:00Z"
        }
    }
}
```

**Proceso Autom√°tico de Aprobaci√≥n**:
1. **Actualizar solicitud**: Status cambia a "APPROVED"
2. **Crear empresa**: Nueva empresa con datos de la solicitud
3. **Verificar admin**:
   - Si email existe: Asignar rol "COMPANY_ADMIN"
   - Si no existe: Crear usuario + rol autom√°ticamente
4. **Generar c√≥digos**: Company code √∫nico (CMP-YYYY-NNNNN)
5. **Configuraci√≥n inicial**: Categor√≠as y macros por defecto
6. **Notificaciones**: Email al admin con credenciales y acceso

**Auditor√≠a**:
- Registro completo de qui√©n aprob√≥ y cu√°ndo
- Link entre solicitud original y empresa creada
- Log de acciones automatizadas

---

### 3. REJECT_COMPANY_REQUEST - Rechazar Solicitud

**Descripci√≥n**: Rechaza una solicitud de empresa con motivo. Solo platform admins.

```graphql
mutation RejectCompanyRequest($requestId: UUID!, $reason: String!) {
    rejectCompanyRequest(requestId: $requestId, reason: $reason)
}
```

**Variables**:
```json
{
    "requestId": "550e8400-e29b-41d4-a716-446655440010",
    "reason": "La descripci√≥n del negocio no es suficientemente clara y no se proporciona informaci√≥n v√°lida de contacto. Por favor, proporcione m√°s detalles sobre los servicios que ofrece y verifique la informaci√≥n de contacto."
}
```

**Respuesta**:
```json
{
    "data": {
        "rejectCompanyRequest": true
    }
}
```

**Proceso de Rechazo**:
1. **Actualizar solicitud**: Status "REJECTED" + motivo
2. **Registrar auditor√≠a**: Qui√©n rechaz√≥ y por qu√©
3. **Notificar solicitante**: Email con motivo del rechazo
4. **Permitir reenv√≠o**: Solicitante puede corregir y reenviar

---

### 4. CREATE_COMPANY - Crear Empresa Directamente

**Descripci√≥n**: Crea una empresa directamente sin proceso de solicitud. Solo platform admins.

```graphql
mutation CreateCompany($input: CreateCompanyInput!) {
    createCompany(input: $input) {
        id
        companyCode
        name
        status
        admin {
            displayName
            email
        }
        createdAt
    }
}
```

**Input Variables**:
```json
{
    "input": {
        "name": "Empresa Test Directa",
        "legalName": "Empresa Test Directa S.A.",
        "adminUserId": "550e8400-e29b-41d4-a716-446655440000",
        "supportEmail": "soporte@test.com",
        "phone": "+591 70123456",
        "website": "https://test.com",
        "contactInfo": {
            "address": "Calle Test #123",
            "city": "Santa Cruz",
            "state": "Santa Cruz",
            "country": "Bolivia",
            "postalCode": "0000",
            "taxId": "1111111111",
            "legalRepresentative": "Juan Test"
        },
        "initialConfig": {
            "businessHours": {
                "monday": {"open": "09:00", "close": "17:00"},
                "tuesday": {"open": "09:00", "close": "17:00"},
                "wednesday": {"open": "09:00", "close": "17:00"},
                "thursday": {"open": "09:00", "close": "17:00"},
                "friday": {"open": "09:00", "close": "17:00"}
            },
            "timezone": "America/La_Paz"
        },
        "branding": {
            "primaryColor": "#3b82f6",
            "secondaryColor": "#64748b"
        }
    }
}
```

**Casos de Uso**:
- Crear empresas para testing
- Migraci√≥n de datos
- Configuraci√≥n inicial del sistema
- Casos especiales sin solicitud p√∫blica

---

### 5. UPDATE_COMPANY - Actualizar Empresa

**Descripci√≥n**: Actualiza informaci√≥n de una empresa existente. Company admin o platform admin.

```graphql
mutation UpdateCompany($id: UUID!, $input: UpdateCompanyInput!) {
    updateCompany(id: $id, input: $input) {
        id
        name
        legalName
        supportEmail
        website
        primaryColor
        secondaryColor
        updatedAt
    }
}
```

**Input Variables**:
```json
{
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "input": {
        "name": "Universidad del Valle - Campus Norte",
        "supportEmail": "soporte.norte@univalle.edu.bo",
        "website": "https://norte.univalle.edu.bo",
        "contactInfo": {
            "address": "Av. Norte #789, Zona Norte",
            "city": "Cochabamba",
            "phone": "+591 4 4567890"
        },
        "branding": {
            "primaryColor": "#1e40af",
            "secondaryColor": "#3730a3"
        }
    }
}
```

**Permisos**:
- **Platform Admin**: Puede modificar cualquier empresa
- **Company Admin**: Solo su propia empresa
- **Validaci√≥n**: Verificaci√≥n autom√°tica de permisos por directiva @can

---

### 6. SUSPEND_COMPANY - Suspender Empresa

**Descripci√≥n**: Suspende temporalmente una empresa. Solo platform admins.

```graphql
mutation SuspendCompany($id: UUID!, $reason: String!) {
    suspendCompany(id: $id, reason: $reason) {
        id
        status
        updatedAt
    }
}
```

**Variables**:
```json
{
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "reason": "Incumplimiento de t√©rminos de servicio - uso excesivo de recursos"
}
```

**Efectos de Suspensi√≥n**:
1. **Cambiar status** a "SUSPENDED"
2. **Desactivar agentes**: Todos los roles de agentes se desactivan
3. **Bloquear operaciones**: No pueden crear tickets ni responder
4. **Notificar admin**: Email autom√°tico con motivo
5. **Registrar auditor√≠a**: Log completo de la suspensi√≥n

---

### 7. ACTIVATE_COMPANY - Reactivar Empresa

**Descripci√≥n**: Reactiva una empresa suspendida. Solo platform admins.

```graphql
mutation ActivateCompany($id: UUID!) {
    activateCompany(id: $id) {
        id
        status
        updatedAt
    }
}
```

**Efectos de Reactivaci√≥n**:
1. **Cambiar status** a "ACTIVE"
2. **Reactivar agentes**: Restaurar roles de agentes
3. **Restaurar operaciones**: Funcionalidad completa
4. **Notificar admin**: Email de reactivaci√≥n
5. **Registrar auditor√≠a**: Log de reactivaci√≥n

---

## üîí SEGURIDAD Y PERMISOS

### Matriz de Permisos por Operaci√≥n

| Operaci√≥n | P√∫blico | USER | AGENT | COMPANY_ADMIN | PLATFORM_ADMIN |
|-----------|---------|------|-------|---------------|----------------|
| publicCompanies | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| company | ‚ùå | ‚úÖ (con rol) | ‚úÖ (su empresa) | ‚úÖ (su empresa) | ‚úÖ (todas) |
| myCompanies | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| companies | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| requestCompany | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| approveRequest | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| rejectRequest | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| createCompany | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| updateCompany | ‚ùå | ‚ùå | ‚ùå | ‚úÖ (su empresa) | ‚úÖ (todas) |
| suspendCompany | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |

### Rate Limiting Espec√≠fico

- **requestCompany**: 3 requests/hora por IP
- **createCompany**: 10 requests/hora por admin
- **updateCompany**: 30 requests/hora por empresa

### Validaciones de Contexto Empresarial

```graphql
# Validaci√≥n autom√°tica por directivas
query Company($id: UUID!) {
    company(id: $id) @can(ability: "view", model: "Company", find: "id") {
        # Solo retorna si el usuario tiene acceso
    }
}

mutation UpdateCompany($id: UUID!, $input: UpdateCompanyInput!) {
    updateCompany(id: $id, input: $input)
        @can(ability: "update", model: "Company", find: "id") {
        # Solo ejecuta si tiene permisos
    }
}
```

---

## üß™ EJEMPLOS DE USO FRONTEND

### Hook para Gesti√≥n de Empresas

```typescript
// useCompanies.ts
import { useQuery, useMutation } from '@apollo/client';
import {
    PUBLIC_COMPANIES_QUERY,
    MY_COMPANIES_QUERY,
    REQUEST_COMPANY_MUTATION
} from '../graphql';

export const useCompanies = () => {
    const { data: publicCompanies, loading: publicLoading } = useQuery(
        PUBLIC_COMPANIES_QUERY,
        {
            variables: { activeOnly: true, first: 50 }
        }
    );

    const { data: myCompanies, loading: myLoading } = useQuery(
        MY_COMPANIES_QUERY,
        {
            skip: !isAuthenticated // Solo si est√° logueado
        }
    );

    const [requestCompany] = useMutation(REQUEST_COMPANY_MUTATION);

    const handleRequestCompany = async (input: CompanyRequestInput) => {
        try {
            const { data } = await requestCompany({ variables: { input } });
            return data.requestCompany;
        } catch (error) {
            throw error;
        }
    };

    return {
        publicCompanies: publicCompanies?.publicCompanies || [],
        myCompanies: myCompanies?.myCompanies || [],
        loading: publicLoading || myLoading,
        requestCompany: handleRequestCompany
    };
};
```

### Componente Selector de Empresa

```typescript
// CompanySelector.tsx
import React from 'react';
import { useCompanies } from '../hooks/useCompanies';

interface CompanySelectorProps {
    onSelect: (company: CompanyPublicInfo) => void;
    selectedCompanyId?: string;
}

export const CompanySelector: React.FC<CompanySelectorProps> = ({
    onSelect,
    selectedCompanyId
}) => {
    const { publicCompanies, loading } = useCompanies();

    if (loading) {
        return <div className="animate-pulse">Cargando empresas...</div>;
    }

    return (
        <div className="space-y-2">
            <label className="block text-sm font-medium text-gray-700">
                Selecciona una empresa
            </label>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {publicCompanies.map((company) => (
                    <div
                        key={company.id}
                        onClick={() => onSelect(company)}
                        className={`
                            p-4 border rounded-lg cursor-pointer transition-all
                            ${selectedCompanyId === company.id
                                ? 'border-blue-500 bg-blue-50'
                                : 'border-gray-200 hover:border-gray-300'
                            }
                        `}
                    >
                        <div className="flex items-center space-x-3">
                            {company.logoUrl && (
                                <img
                                    src={company.logoUrl}
                                    alt={`Logo ${company.name}`}
                                    className="w-12 h-12 object-contain"
                                />
                            )}
                            <div className="flex-1">
                                <h3 className="font-medium text-gray-900">
                                    {company.name}
                                </h3>
                                <p className="text-sm text-gray-500">
                                    {company.industry} ‚Ä¢ {company.city}
                                </p>
                                {company.businessHoursDisplay && (
                                    <p className="text-xs text-gray-400 mt-1">
                                        {company.businessHoursDisplay}
                                    </p>
                                )}
                            </div>
                        </div>
                    </div>
                ))}
            </div>

            <div className="mt-4 p-3 bg-gray-50 rounded-lg">
                <p className="text-sm text-gray-600">
                    ¬øNo encuentras tu empresa?{' '}
                    <a href="/request-company" className="text-blue-600 hover:text-blue-500">
                        Solicita que la agreguen
                    </a>
                </p>
            </div>
        </div>
    );
};
```

---

## üö® MANEJO DE ERRORES

### C√≥digos de Error Espec√≠ficos

```typescript
enum CompanyManagementErrors {
    COMPANY_NOT_FOUND = 'COMPANY_NOT_FOUND',
    COMPANY_NAME_EXISTS = 'COMPANY_NAME_EXISTS',
    COMPANY_SUSPENDED = 'COMPANY_SUSPENDED',
    INVALID_COMPANY_CONTEXT = 'INVALID_COMPANY_CONTEXT',
    REQUEST_ALREADY_EXISTS = 'REQUEST_ALREADY_EXISTS',
    REQUEST_NOT_FOUND = 'REQUEST_NOT_FOUND',
    INSUFFICIENT_COMPANY_PERMISSIONS = 'INSUFFICIENT_COMPANY_PERMISSIONS'
}
```

### Estructura de Error

```json
{
    "errors": [
        {
            "message": "No tienes permisos para acceder a esta empresa",
            "extensions": {
                "code": "INSUFFICIENT_COMPANY_PERMISSIONS",
                "companyId": "cmp-001",
                "requiredRole": "COMPANY_ADMIN"
            },
            "path": ["company"]
        }
    ]
}
```

---

## üìä M√âTRICAS Y ESTAD√çSTICAS

### Eventos de Auditor√≠a

- `company.created`: Empresa creada
- `company.updated`: Empresa actualizada
- `company.suspended`: Empresa suspendida
- `company.activated`: Empresa reactivada
- `company_request.submitted`: Solicitud enviada
- `company_request.approved`: Solicitud aprobada
- `company_request.rejected`: Solicitud rechazada

### M√©tricas de Sistema

- N√∫mero total de empresas activas/suspendidas
- Solicitudes pendientes vs tiempo promedio de aprobaci√≥n
- Distribuci√≥n geogr√°fica de empresas
- Empresas m√°s activas por tickets/usuarios
- Crecimiento mensual de nuevas empresas

---

## üîÑ INTEGRACI√ìN CON OTROS FEATURES

### UserManagement Feature

- **Roles Contextuales**: Valida company_id para AGENT y COMPANY_ADMIN
- **CompanyBasicInfo**: Proporciona info b√°sica sin loops infinitos
- **User Assignments**: Gestiona asignaciones de usuarios a empresas

### Authentication Feature

- **Multi-tenant Context**: Proporciona contexto empresarial en tokens
- **Company Branding**: Informaci√≥n para personalizaci√≥n de UI
- **Role Validation**: Valida contexto empresarial en autenticaci√≥n

### TicketManagement Feature

- **Ticket Context**: Todos los tickets pertenecen a una empresa
- **Agent Assignment**: Solo agentes de la empresa pueden tomar tickets
- **Company Settings**: Configuraciones espec√≠ficas de ticket por empresa

---

Esta documentaci√≥n cubre completamente el **CompanyManagement Feature**, proporcionando la base fundamental para el sistema multi-tenant del Helpdesk. Es cr√≠tico para que funcionen correctamente los roles de agentes y la separaci√≥n de datos por empresa.
