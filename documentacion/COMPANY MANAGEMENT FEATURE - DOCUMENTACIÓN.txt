# üìò COMPANY MANAGEMENT API V9.0 - DOCUMENTACI√ìN COMPLETA

> Sistema Helpdesk Multi-Tenant
> Feature: Company Management
> Schema Version: 9.0 (Sistema de Emails y Contrase√±as Temporales)
> √öltima actualizaci√≥n: 26 de Octubre, 2025

---

## üìë TABLA DE CONTENIDOS

1. [Introducci√≥n](#introducci√≥n)
2. [Arquitectura](#arquitectura)
3. [Sistema de Emails y Contrase√±as Temporales](#sistema-de-emails-y-contrase√±as-temporales)
4. [Queries](#queries)
5. [Mutations](#mutations)
6. [Types](#types)
7. [Enums e Inputs](#enums-e-inputs)
8. [Permisos y Autenticaci√≥n](#permisos-y-autenticaci√≥n)
9. [C√≥digos de Error](#c√≥digos-de-error)
10. [Rate Limiting](#rate-limiting)
11. [Casos de Uso](#casos-de-uso)

---

## üéØ INTRODUCCI√ìN

### Prop√≥sito del Feature
El **Company Management Feature** gestiona empresas en el sistema Helpdesk multi-tenant, permitiendo:
- Creaci√≥n y administraci√≥n de empresas
- Sistema de seguimiento de empresas por usuarios
- Solicitudes p√∫blicas de nuevas empresas
- Gesti√≥n de permisos y contextos empresariales

### Caracter√≠sticas Principales
‚úÖ **Sin loops infinitos**: Arquitectura optimizada para GraphQL
‚úÖ **Queries contextuales**: Una query principal con contextos inteligentes
‚úÖ **Performance optimizado**: Contadores en lugar de listas, cach√© eficiente
‚úÖ **Multi-tenant**: Aislamiento completo entre empresas
‚úÖ **Sistema de seguimiento**: Usuarios pueden seguir empresas de inter√©s
‚úÖ **Sistema de emails profesional**: Event ‚Üí Listener ‚Üí Job ‚Üí Mail ‚Üí Queue
‚úÖ **Contrase√±as temporales**: Generaci√≥n autom√°tica para nuevos admins (16 chars, expira 7 d√≠as)
‚úÖ **Responses profesionales**: Mensajes descriptivos en espa√±ol, campos limitados por seguridad

---

## üèóÔ∏è ARQUITECTURA

### Filosof√≠a del Dise√±o

#### ‚ùå Problema: Loops Infinitos (V8.0 - V8.2)
```graphql
# ANTIGUO - CAUSA LOOPS
type Company {
    admin: User  # User tiene roles: [Role]
                 # Role tiene company: Company
                 # LOOP INFINITO ‚ôæÔ∏è

    followers: [User!]!  # Carga N usuarios
    agents: [User!]!     # Carga M usuarios
}
```

#### ‚úÖ Soluci√≥n: Campos Planos + Contadores (V8.3)
```graphql
# ACTUAL - SIN LOOPS
type Company {
    # Admin como campos individuales
    adminId: UUID!
    adminName: String!
    adminEmail: Email!
    adminAvatar: URL

    # Contadores en lugar de listas
    followersCount: Int!
    activeAgentsCount: Int!
}
```

### Query Principal con Contextos

En lugar de 9 queries redundantes, usamos **una query principal con contextos**:

```graphql
companies(context: CompanyQueryContext!)
```

**Contextos disponibles:**
- `MINIMAL`: Para selectores (4 campos)
- `EXPLORE`: Para explorar empresas (11 campos)
- `MANAGEMENT`: Para administraci√≥n (todos los campos)
- `ANALYTICS`: Para dashboards con estad√≠sticas

---

## üìß SISTEMA DE EMAILS Y CONTRASE√ëAS TEMPORALES

### Filosof√≠a del Sistema

El sistema de aprobaci√≥n/rechazo de solicitudes de empresas implementa un **flujo profesional de notificaciones por email** con dos escenarios distintos:

1. **Usuario Admin Ya Existe**: Se le asigna rol de COMPANY_ADMIN y recibe email de confirmaci√≥n (sin contrase√±a)
2. **Usuario Admin Nuevo**: Se crea cuenta con contrase√±a temporal y recibe email con credenciales
3. **Solicitud Rechazada**: Se env√≠a email con la raz√≥n del rechazo

### Arquitectura del Sistema de Emails

El sistema sigue el patr√≥n profesional **Event ‚Üí Listener ‚Üí Job ‚Üí Mail ‚Üí Queue** implementado en el Authentication Feature:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    MUTATION EJECUTADA                    ‚îÇ
‚îÇ              (Approve/Reject Company Request)            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ  Event Disparado      ‚îÇ
         ‚îÇ  - CompanyRequest     ‚îÇ
         ‚îÇ    Approved/Rejected  ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
                    ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ  Listener Escucha     ‚îÇ
         ‚îÇ  - SendCompanyEmail   ‚îÇ
         ‚îÇ    Notification       ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
                    ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ  Job Encolado         ‚îÇ
         ‚îÇ  - Queue: 'emails'    ‚îÇ
         ‚îÇ  - Retry: 3 veces     ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
                    ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ  Mail Enviado         ‚îÇ
         ‚îÇ  - Mailpit (dev)      ‚îÇ
         ‚îÇ  - SMTP (prod)        ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Sistema de Contrase√±as Temporales

#### Caracter√≠sticas

- **Longitud**: 16 caracteres alfanum√©ricos seguros (generados con `Str::random(16)`)
- **Expiraci√≥n**: 7 d√≠as desde la creaci√≥n
- **Seguridad**: Hash con bcrypt antes de almacenar
- **Campos en DB**:
  - `has_temporary_password` (boolean): Marca si el usuario debe cambiar su contrase√±a
  - `temporary_password_expires_at` (timestamp): Fecha de expiraci√≥n

#### Flujo de Contrase√±a Temporal

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. Admin aprueba solicitud                       ‚îÇ
‚îÇ    - admin_email NO existe en sistema            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. UserService::createFromCompanyRequest()       ‚îÇ
‚îÇ    - Genera password temporal (16 chars)         ‚îÇ
‚îÇ    - Hash con bcrypt                             ‚îÇ
‚îÇ    - Sets has_temporary_password = true          ‚îÇ
‚îÇ    - Sets temporary_password_expires_at = +7d    ‚îÇ
‚îÇ    - Returns ['user' => $user, 'password' => $p] ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. CompanyRequestApproved Event                  ‚îÇ
‚îÇ    - Lleva la contrase√±a temporal (plain text)   ‚îÇ
‚îÇ    - Solo para nuevos usuarios (null si existe)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 4. SendCompanyApprovalEmailJob                   ‚îÇ
‚îÇ    - Detecta si temporaryPassword != null        ‚îÇ
‚îÇ    - Env√≠a CompanyApprovalMailForNewUser         ‚îÇ
‚îÇ    - Email incluye contrase√±a en texto plano     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 5. Usuario recibe email con credenciales         ‚îÇ
‚îÇ    - Email: admin@company.com                    ‚îÇ
‚îÇ    - Password temporal: XyZ123abc...             ‚îÇ
‚îÇ    - Link de login al sistema                    ‚îÇ
‚îÇ    - Instrucci√≥n de cambiar contrase√±a           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Clases de Email Implementadas

#### 1. CompanyApprovalMailForNewUser

**Ubicaci√≥n**: `app/Features/CompanyManagement/Mail/CompanyApprovalMailForNewUser.php`

**Prop√≥sito**: Notificar aprobaci√≥n a nuevos usuarios con contrase√±a temporal

**Contenido del Email**:
```
Asunto: ‚úÖ Bienvenido a Helpdesk - Solicitud de Empresa Aprobada

¬°Bienvenido {displayName}!

Tu solicitud para crear la empresa "{company_name}" ha sido APROBADA.

Credenciales de Acceso:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Email: {admin_email}
Contrase√±a Temporal: {temporaryPassword}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚ö†Ô∏è IMPORTANTE: Esta contrase√±a es temporal y expira en 7 d√≠as.
Deber√°s cambiarla al iniciar sesi√≥n por primera vez.

[Iniciar Sesi√≥n] ‚Üí {loginUrl}

Datos de tu Empresa:
- C√≥digo: {company_code}
- Nombre: {company_name}
- Rol Asignado: Administrador de Empresa
```

**Templates**:
- HTML: `resources/views/emails/company/approval-new-user.blade.php`
- Texto plano: `resources/views/emails/company/approval-new-user-text.blade.php`

---

#### 2. CompanyApprovalMailForExistingUser

**Ubicaci√≥n**: `app/Features/CompanyManagement/Mail/CompanyApprovalMailForExistingUser.php`

**Prop√≥sito**: Notificar aprobaci√≥n a usuarios existentes (sin contrase√±a)

**Contenido del Email**:
```
Asunto: ‚úÖ Nueva Empresa Asignada - Solicitud Aprobada

¬°Hola {displayName}!

Tu solicitud para crear la empresa "{company_name}" ha sido APROBADA.

Como ya tienes una cuenta en nuestro sistema, hemos asignado el
rol de Administrador de Empresa a tu cuenta existente.

Datos de tu Nueva Empresa:
- C√≥digo: {company_code}
- Nombre: {company_name}
- Rol Asignado: Administrador de Empresa

Puedes iniciar sesi√≥n con tus credenciales actuales:
[Iniciar Sesi√≥n] ‚Üí {loginUrl}
```

**Templates**:
- HTML: `resources/views/emails/company/approval-existing-user.blade.php`
- Texto plano: `resources/views/emails/company/approval-existing-user-text.blade.php`

---

#### 3. CompanyRejectionMail

**Ubicaci√≥n**: `app/Features/CompanyManagement/Mail/CompanyRejectionMail.php`

**Prop√≥sito**: Notificar rechazo de solicitud con raz√≥n

**Contenido del Email**:
```
Asunto: ‚ùå Solicitud de Empresa Rechazada - {requestCode}

Estimado/a,

Lamentamos informarte que tu solicitud para crear la empresa
"{company_name}" ha sido RECHAZADA.

C√≥digo de Solicitud: {requestCode}

Raz√≥n del Rechazo:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
{reason}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Puedes enviar una nueva solicitud corrigiendo los aspectos
mencionados.

Si tienes dudas, cont√°ctanos a: {supportEmail}
```

**Templates**:
- HTML: `resources/views/emails/company/rejection.blade.php`
- Texto plano: `resources/views/emails/company/rejection-text.blade.php`

---

### Jobs de Email

#### SendCompanyApprovalEmailJob

**Ubicaci√≥n**: `app/Features/CompanyManagement/Jobs/SendCompanyApprovalEmailJob.php`

**Configuraci√≥n**:
```php
public int $tries = 3;          // 3 intentos en caso de fallo
public int $timeout = 30;       // 30 segundos de timeout
public string $queue = 'emails'; // Cola de alta prioridad
```

**L√≥gica**:
```php
public function handle(): void
{
    if ($this->temporaryPassword) {
        // Usuario NUEVO - env√≠a con contrase√±a
        Mail::to($this->adminUser->email)->send(
            new CompanyApprovalMailForNewUser(
                $this->company,
                $this->adminUser,
                $this->temporaryPassword
            )
        );
    } else {
        // Usuario EXISTENTE - sin contrase√±a
        Mail::to($this->adminUser->email)->send(
            new CompanyApprovalMailForExistingUser(
                $this->company,
                $this->adminUser
            )
        );
    }
}
```

---

#### SendCompanyRejectionEmailJob

**Ubicaci√≥n**: `app/Features/CompanyManagement/Jobs/SendCompanyRejectionEmailJob.php`

**Configuraci√≥n**: Igual que approval (3 tries, 30s timeout, cola 'emails')

**L√≥gica**:
```php
public function handle(): void
{
    Mail::to($this->request->admin_email)->send(
        new CompanyRejectionMail(
            $this->request,
            $this->reason
        )
    );
}
```

---

### Configuraci√≥n del Sistema

#### Cola de Emails

**Redis Queue**: `emails` (alta prioridad)

**Worker Configuration** (`queue` service en Docker):
```bash
php artisan queue:work redis \
    --queue=emails,default \
    --verbose \
    --tries=3 \
    --timeout=90
```

**Prioridad de Colas**:
1. `emails` - Emails cr√≠ticos (verificaci√≥n, passwords, aprobaciones)
2. `default` - Jobs est√°ndar del sistema

---

#### Mailpit (Development)

**Configuraci√≥n** (`.env`):
```env
MAIL_MAILER=smtp
MAIL_HOST=mailpit
MAIL_PORT=1025
MAIL_USERNAME=null
MAIL_PASSWORD=null
MAIL_ENCRYPTION=null
MAIL_FROM_ADDRESS=noreply@helpdesk.local
MAIL_FROM_NAME="Helpdesk System"
```

**Acceso**:
- SMTP: `mailpit:1025` (desde containers)
- UI: `http://localhost:8025` (desde browser)

---

### Eventos Disparados

#### CompanyRequestApproved

**Ubicaci√≥n**: `app/Features/CompanyManagement/Events/CompanyRequestApproved.php`

**Constructor**:
```php
public function __construct(
    public CompanyRequest $request,
    public Company $company,
    public User $adminUser,
    public ?string $temporaryPassword = null  // ‚ö†Ô∏è Null para usuarios existentes
) {}
```

**Listeners**:
- `SendCompanyApprovalEmailNotification` ‚Üí Dispara `SendCompanyApprovalEmailJob`

---

#### CompanyRequestRejected

**Ubicaci√≥n**: `app/Features/CompanyManagement/Events/CompanyRequestRejected.php`

**Constructor**:
```php
public function __construct(
    public CompanyRequest $request,
    public string $reason
) {}
```

**Listeners**:
- `SendCompanyRejectionEmailNotification` ‚Üí Dispara `SendCompanyRejectionEmailJob`

---

### Horario Laboral por Defecto

Cuando se crea una empresa (ya sea por aprobaci√≥n o creaci√≥n directa), si no se especifica `business_hours`, se aplica el **horario laboral est√°ndar**:

```json
{
    "monday": {"open": "09:00", "close": "18:00", "is_open": true},
    "tuesday": {"open": "09:00", "close": "18:00", "is_open": true},
    "wednesday": {"open": "09:00", "close": "18:00", "is_open": true},
    "thursday": {"open": "09:00", "close": "18:00", "is_open": true},
    "friday": {"open": "09:00", "close": "18:00", "is_open": true},
    "saturday": {"open": "09:00", "close": "13:00", "is_open": false},
    "sunday": {"is_open": false}
}
```

**Implementaci√≥n**: `CompanyService::create()`

---

### Testing del Sistema de Emails

#### Tests Implementados

**ApproveCompanyRequestMutationTest.php** (9 tests de email):
- ‚úÖ `sends_approval_email_when_user_already_exists`
- ‚úÖ `sends_approval_email_with_temporary_password_for_new_user`
- ‚úÖ `new_user_can_login_with_temporary_password`
- ‚úÖ `temporary_password_expires_after_configured_time`
- ‚úÖ `approval_email_is_sent_to_correct_queue`
- ‚úÖ `approval_email_contains_company_information`
- ‚úÖ `multiple_companies_can_be_approved_without_email_conflicts`
- ‚úÖ `email_is_sent_via_mailpit_in_development`

**RejectCompanyRequestMutationTest.php** (6 tests de email):
- ‚úÖ `sends_rejection_email_with_reason`
- ‚úÖ `rejection_email_is_sent_to_correct_queue`
- ‚úÖ `rejection_email_contains_request_information`
- ‚úÖ `rejection_reason_is_included_in_email`
- ‚úÖ `rejection_email_is_sent_via_mailpit`

#### Helper Methods para Mailpit

```php
protected function isMailpitAvailable(): bool
{
    try {
        $response = \Illuminate\Support\Facades\Http::get('http://localhost:8025/api/v1/messages');
        return $response->successful();
    } catch (\Exception $e) {
        return false;
    }
}

protected function clearMailpit(): void
{
    \Illuminate\Support\Facades\Http::delete('http://localhost:8025/api/v1/messages');
}

protected function getMailpitMessages(): array
{
    $response = \Illuminate\Support\Facades\Http::get('http://localhost:8025/api/v1/messages');
    return $response->json('messages') ?? [];
}
```

---

### Monitoreo y Debugging

#### Ver Logs de Jobs

```bash
# Ver logs del worker de cola
docker compose logs -f queue

# Ver todos los emails enviados (Mailpit UI)
# Navegar a http://localhost:8025
```

#### Verificar Estado de Cola

```bash
# Ver jobs pendientes en Redis
docker compose exec redis redis-cli
> LLEN queues:emails

# Ver jobs fallidos
php artisan queue:failed
```

#### Reintentar Jobs Fallidos

```bash
# Reintentar todos los jobs fallidos
php artisan queue:retry all

# Reintentar job espec√≠fico
php artisan queue:retry {job-id}
```

---

## üîç QUERIES

### 1. `companies` - Query Principal Contextual

**Descripci√≥n**: Query principal que adapta los campos devueltos seg√∫n el contexto solicitado.

**Firma:**
```graphql
companies(
    context: CompanyQueryContext!
    filters: CompanyFilters
    search: String
    page: Int = 1
    first: Int = 20
): CompanyQueryResult!
```

**Par√°metros:**

| Par√°metro | Tipo | Requerido | Default | Descripci√≥n |
|-----------|------|-----------|---------|-------------|
| `context` | `CompanyQueryContext` | ‚úÖ S√≠ | - | Define qu√© campos se devuelven |
| `filters` | `CompanyFilters` | ‚ùå No | `null` | Filtros de b√∫squeda |
| `search` | `String` | ‚ùå No | `null` | B√∫squeda de texto libre |
| `page` | `Int` | ‚ùå No | `1` | N√∫mero de p√°gina |
| `first` | `Int` | ‚ùå No | `20` | Registros por p√°gina |

**Directivas:**
- `@field`: `CompaniesQuery` resolver
- `@cache`: TTL 300s, key din√°mica por contexto

---

#### üìã CASO 1: Contexto MINIMAL (Selectores)

**Uso:** Selectores simples para crear tickets, navbar de contexto.

**Request:**
```graphql
query CompaniesForTickets {
    companies(context: MINIMAL, first: 50) {
        ... on CompanyMinimalList {
            items {
                id
                companyCode
                name
                logoUrl
            }
            totalCount
            hasNextPage
        }
    }
}
```

**Response:**
```json
{
    "data": {
        "companies": {
            "items": [
                {
                    "id": "550e8400-e29b-41d4-a716-446655440001",
                    "companyCode": "CMP-2025-00001",
                    "name": "Tech Solutions Inc.",
                    "logoUrl": "https://cdn.example.com/logos/tech-solutions.png"
                },
                {
                    "id": "550e8400-e29b-41d4-a716-446655440002",
                    "companyCode": "CMP-2025-00002",
                    "name": "Digital Innovations Corp.",
                    "logoUrl": "https://cdn.example.com/logos/digital-innovations.png"
                }
            ],
            "totalCount": 127,
            "hasNextPage": true
        }
    }
}
```

**Performance:**
- ‚ö° Solo carga 4 campos por empresa
- ‚ö° Cache de 5 minutos
- ‚ö° Ideal para selectores con cientos de empresas

---

#### üìã CASO 2: Contexto EXPLORE (Explorar y Seguir)

**Uso:** P√°gina de "Explorar Empresas", onboarding de usuario.

**Request:**
```graphql
query ExploreCompanies($filters: CompanyFilters, $search: String) {
    companies(
        context: EXPLORE
        filters: $filters
        search: $search
        first: 20
    ) {
        ... on CompanyExploreList {
            items {
                id
                companyCode
                name
                logoUrl
                description
                industry
                city
                country
                primaryColor
                followersCount
                isFollowedByMe
            }
            totalCount
            hasNextPage
        }
    }
}
```

**Variables:**
```json
{
    "filters": {
        "industry": "Technology",
        "country": "Bolivia"
    },
    "search": "software"
}
```

**Response:**
```json
{
    "data": {
        "companies": {
            "items": [
                {
                    "id": "550e8400-e29b-41d4-a716-446655440001",
                    "companyCode": "CMP-2025-00001",
                    "name": "Tech Solutions Inc.",
                    "logoUrl": "https://cdn.example.com/logos/tech-solutions.png",
                    "description": "Soluciones tecnol√≥gicas innovadoras para empresas",
                    "industry": "Technology",
                    "city": "Santa Cruz",
                    "country": "Bolivia",
                    "primaryColor": "#3B82F6",
                    "followersCount": 1247,
                    "isFollowedByMe": false
                },
                {
                    "id": "550e8400-e29b-41d4-a716-446655440003",
                    "companyCode": "CMP-2025-00003",
                    "name": "SoftDev Solutions",
                    "logoUrl": "https://cdn.example.com/logos/softdev.png",
                    "description": "Desarrollo de software a medida",
                    "industry": "Technology",
                    "city": "La Paz",
                    "country": "Bolivia",
                    "primaryColor": "#10B981",
                    "followersCount": 856,
                    "isFollowedByMe": true
                }
            ],
            "totalCount": 23,
            "hasNextPage": true
        }
    }
}
```

**Casos de Uso:**
- P√°gina de exploraci√≥n de empresas
- Selector de empresas en onboarding
- Directorio p√∫blico de empresas

---

#### üìã CASO 3: Contexto MANAGEMENT (Administraci√≥n)

**Uso:** Panel administrativo, gesti√≥n completa de empresas.

**Request:**
```graphql
query ManageCompanies($filters: CompanyFilters, $page: Int) {
    companies(
        context: MANAGEMENT
        filters: $filters
        page: $page
        first: 15
    ) {
        ... on CompanyFullList {
            items {
                id
                companyCode
                name
                legalName
                status
                supportEmail
                website
                contactCity
                contactCountry
                adminId
                adminName
                adminEmail
                activeAgentsCount
                totalUsersCount
                totalTicketsCount
                openTicketsCount
                followersCount
                createdAt
                updatedAt
            }
            totalCount
            hasNextPage
        }
    }
}
```

**Variables:**
```json
{
    "filters": {
        "status": "ACTIVE",
        "hasActiveTickets": true
    },
    "page": 1
}
```

**Response:**
```json
{
    "data": {
        "companies": {
            "items": [
                {
                    "id": "550e8400-e29b-41d4-a716-446655440001",
                    "companyCode": "CMP-2025-00001",
                    "name": "Tech Solutions Inc.",
                    "legalName": "Tech Solutions Incorporated SRL",
                    "status": "ACTIVE",
                    "supportEmail": "support@techsolutions.com",
                    "website": "https://techsolutions.com",
                    "contactCity": "Santa Cruz",
                    "contactCountry": "Bolivia",
                    "adminId": "660e8400-e29b-41d4-a716-446655440010",
                    "adminName": "Carlos Mendoza",
                    "adminEmail": "carlos@techsolutions.com",
                    "activeAgentsCount": 5,
                    "totalUsersCount": 234,
                    "totalTicketsCount": 1567,
                    "openTicketsCount": 23,
                    "followersCount": 1247,
                    "createdAt": "2024-01-15T10:30:00Z",
                    "updatedAt": "2025-10-01T14:22:00Z"
                }
            ],
            "totalCount": 45,
            "hasNextPage": true
        }
    }
}
```

**Permisos:**
- ‚úÖ `PLATFORM_ADMIN`: Ve todas las empresas
- ‚úÖ `COMPANY_ADMIN`: Solo ve su empresa

---

### 2. `company` - Detalle Completo de Empresa

**Descripci√≥n**: Obtiene toda la informaci√≥n de una empresa espec√≠fica.

**Firma:**
```graphql
company(id: UUID!): Company
```

**Directivas:**
- `@auth`: Requiere autenticaci√≥n
- `@can(ability: "view", model: "Company", find: "id")`: Valida permisos

**Request:**
```graphql
query GetCompany($id: UUID!) {
    company(id: $id) {
        # Identificadores
        id
        companyCode

        # Informaci√≥n b√°sica
        name
        legalName
        supportEmail
        phone
        website

        # Contacto
        contactAddress
        contactCity
        contactState
        contactCountry
        contactPostalCode

        # Legal
        taxId
        legalRepresentative

        # Configuraci√≥n
        businessHours
        timezone

        # Branding
        logoUrl
        faviconUrl
        primaryColor
        secondaryColor

        # Estado
        status
        settings

        # Admin (sin loops)
        adminId
        adminName
        adminEmail
        adminAvatar

        # Estad√≠sticas
        activeAgentsCount
        totalUsersCount
        totalTicketsCount
        openTicketsCount
        averageRating
        categoriesCount
        macrosCount
        followersCount

        # Contextuales
        isFollowedByMe

        # Auditor√≠a
        createdAt
        updatedAt
    }
}
```

**Variables:**
```json
{
    "id": "550e8400-e29b-41d4-a716-446655440001"
}
```

**Response:**
```json
{
    "data": {
        "company": {
            "id": "550e8400-e29b-41d4-a716-446655440001",
            "companyCode": "CMP-2025-00001",
            "name": "Tech Solutions Inc.",
            "legalName": "Tech Solutions Incorporated SRL",
            "supportEmail": "support@techsolutions.com",
            "phone": "+59133224455",
            "website": "https://techsolutions.com",
            "contactAddress": "Av. San Mart√≠n 123, Piso 5",
            "contactCity": "Santa Cruz de la Sierra",
            "contactState": "Santa Cruz",
            "contactCountry": "Bolivia",
            "contactPostalCode": "0000",
            "taxId": "123456789",
            "legalRepresentative": "Carlos Mendoza Garc√≠a",
            "businessHours": {
                "monday": {"open": "08:00", "close": "18:00"},
                "tuesday": {"open": "08:00", "close": "18:00"},
                "wednesday": {"open": "08:00", "close": "18:00"},
                "thursday": {"open": "08:00", "close": "18:00"},
                "friday": {"open": "08:00", "close": "18:00"},
                "saturday": null,
                "sunday": null
            },
            "timezone": "America/La_Paz",
            "logoUrl": "https://cdn.example.com/logos/tech-solutions.png",
            "faviconUrl": "https://cdn.example.com/favicons/tech-solutions.ico",
            "primaryColor": "#3B82F6",
            "secondaryColor": "#1E40AF",
            "status": "ACTIVE",
            "settings": {
                "autoAssignTickets": true,
                "allowPublicTickets": true,
                "requireEmailVerification": false,
                "enableSLA": true
            },
            "adminId": "660e8400-e29b-41d4-a716-446655440010",
            "adminName": "Carlos Mendoza",
            "adminEmail": "carlos@techsolutions.com",
            "adminAvatar": "https://cdn.example.com/avatars/carlos.jpg",
            "activeAgentsCount": 5,
            "totalUsersCount": 234,
            "totalTicketsCount": 1567,
            "openTicketsCount": 23,
            "averageRating": 4.7,
            "categoriesCount": 12,
            "macrosCount": 8,
            "followersCount": 1247,
            "isFollowedByMe": true,
            "createdAt": "2024-01-15T10:30:00Z",
            "updatedAt": "2025-10-01T14:22:00Z"
        }
    }
}
```

**Errores Posibles:**
```json
{
    "errors": [
        {
            "message": "Empresa no encontrada",
            "extensions": {
                "code": "COMPANY_NOT_FOUND",
                "companyId": "550e8400-e29b-41d4-a716-446655440999"
            }
        }
    ]
}
```

---

### 3. `myFollowedCompanies` - Empresas que Sigo

**Descripci√≥n**: Lista de empresas que el usuario autenticado est√° siguiendo, con estad√≠sticas personales.

**Firma:**
```graphql
myFollowedCompanies: [CompanyFollowInfo!]!
```

**Directivas:**
- `@auth`: Requiere autenticaci√≥n

**Request:**
```graphql
query MyFollowedCompanies {
    myFollowedCompanies {
        id
        company {
            id
            companyCode
            name
            logoUrl
        }
        followedAt
        myTicketsCount
        lastTicketCreatedAt
        hasUnreadAnnouncements
    }
}
```

**Response:**
```json
{
    "data": {
        "myFollowedCompanies": [
            {
                "id": "770e8400-e29b-41d4-a716-446655440020",
                "company": {
                    "id": "550e8400-e29b-41d4-a716-446655440001",
                    "companyCode": "CMP-2025-00001",
                    "name": "Tech Solutions Inc.",
                    "logoUrl": "https://cdn.example.com/logos/tech-solutions.png"
                },
                "followedAt": "2024-08-10T09:15:00Z",
                "myTicketsCount": 12,
                "lastTicketCreatedAt": "2025-09-28T11:30:00Z",
                "hasUnreadAnnouncements": true
            },
            {
                "id": "770e8400-e29b-41d4-a716-446655440021",
                "company": {
                    "id": "550e8400-e29b-41d4-a716-446655440003",
                    "companyCode": "CMP-2025-00003",
                    "name": "SoftDev Solutions",
                    "logoUrl": "https://cdn.example.com/logos/softdev.png"
                },
                "followedAt": "2025-02-14T14:22:00Z",
                "myTicketsCount": 3,
                "lastTicketCreatedAt": "2025-03-05T16:45:00Z",
                "hasUnreadAnnouncements": false
            }
        ]
    }
}
```

**Casos de Uso:**
- Dashboard personal
- P√°gina "Mis empresas"
- Selector de contexto empresarial

---

### 4. `isFollowingCompany` - Verificar Seguimiento

**Descripci√≥n**: Verifica r√°pidamente si el usuario actual est√° siguiendo una empresa espec√≠fica.

**Firma:**
```graphql
isFollowingCompany(companyId: UUID!): Boolean!
```

**Directivas:**
- `@auth`: Requiere autenticaci√≥n

**Request:**
```graphql
query IsFollowing($companyId: UUID!) {
    isFollowingCompany(companyId: $companyId)
}
```

**Variables:**
```json
{
    "companyId": "550e8400-e29b-41d4-a716-446655440001"
}
```

**Response (Siguiendo):**
```json
{
    "data": {
        "isFollowingCompany": true
    }
}
```

**Response (No Siguiendo):**
```json
{
    "data": {
        "isFollowingCompany": false
    }
}
```

**Casos de Uso:**
- Mostrar bot√≥n "Seguir" vs "Siguiendo"
- Validaciones en UI
- Conditional rendering

---

### 5. `companyRequests` - Solicitudes de Empresas

**Descripci√≥n**: Lista de solicitudes pendientes/aprobadas/rechazadas de nuevas empresas. Solo para administradores de plataforma.

**Firma:**
```graphql
companyRequests(
    status: CompanyRequestStatus
    first: Int = 15
): [CompanyRequest!]!
```

**Directivas:**
- `@auth(requires: [PLATFORM_ADMIN])`: Solo administradores

**Request:**
```graphql
query CompanyRequests($status: CompanyRequestStatus) {
    companyRequests(status: $status, first: 20) {
        id
        requestCode
        companyName
        legalName
        adminEmail
        businessDescription
        website
        industryType
        estimatedUsers
        contactAddress
        contactCity
        contactCountry
        status
        reviewedById
        reviewedByName
        reviewedAt
        rejectionReason
        createdCompanyId
        createdCompanyName
        createdAt
        updatedAt
    }
}
```

**Variables (Pendientes):**
```json
{
    "status": "PENDING"
}
```

**Response:**
```json
{
    "data": {
        "companyRequests": [
            {
                "id": "880e8400-e29b-41d4-a716-446655440030",
                "requestCode": "REQ-2025-00042",
                "companyName": "Innovaci√≥n Digital SRL",
                "legalName": "Innovaci√≥n Digital Sociedad de Responsabilidad Limitada",
                "adminEmail": "admin@innovaciondigital.bo",
                "businessDescription": "Empresa dedicada al desarrollo de software personalizado y consultor√≠a tecnol√≥gica para PyMEs en Bolivia. Contamos con m√°s de 5 a√±os de experiencia en el mercado local.",
                "website": "https://innovaciondigital.bo",
                "industryType": "Technology",
                "estimatedUsers": 50,
                "contactAddress": "Calle Comercio 456",
                "contactCity": "Cochabamba",
                "contactCountry": "Bolivia",
                "status": "PENDING",
                "reviewedById": null,
                "reviewedByName": null,
                "reviewedAt": null,
                "rejectionReason": null,
                "createdCompanyId": null,
                "createdCompanyName": null,
                "createdAt": "2025-10-02T08:30:00Z",
                "updatedAt": "2025-10-02T08:30:00Z"
            }
        ]
    }
}
```

---

## ‚úèÔ∏è MUTATIONS

### 1. `followCompany` - Seguir Empresa

**Descripci√≥n**: Permite a un usuario autenticado seguir una empresa.

**Firma:**
```graphql
followCompany(companyId: UUID!): CompanyFollowResult!
```

**Directivas:**
- `@auth`: Requiere autenticaci√≥n
- `@audit(action: "follow_company")`: Auditor√≠a

**Request:**
```graphql
mutation FollowCompany($companyId: UUID!) {
    followCompany(companyId: $companyId) {
        success
        message
        company {
            id
            companyCode
            name
            logoUrl
        }
        followedAt
    }
}
```

**Variables:**
```json
{
    "companyId": "550e8400-e29b-41d4-a716-446655440001"
}
```

**Response (√âxito):**
```json
{
    "data": {
        "followCompany": {
            "success": true,
            "message": "Ahora sigues a Tech Solutions Inc.",
            "company": {
                "id": "550e8400-e29b-41d4-a716-446655440001",
                "companyCode": "CMP-2025-00001",
                "name": "Tech Solutions Inc.",
                "logoUrl": "https://cdn.example.com/logos/tech-solutions.png"
            },
            "followedAt": "2025-10-03T10:45:00Z"
        }
    }
}
```

**Errores Posibles:**
```json
{
    "errors": [
        {
            "message": "Ya est√°s siguiendo esta empresa",
            "extensions": {
                "code": "ALREADY_FOLLOWING",
                "companyId": "550e8400-e29b-41d4-a716-446655440001"
            }
        }
    ]
}
```

```json
{
    "errors": [
        {
            "message": "Has alcanzado el l√≠mite de empresas que puedes seguir (50)",
            "extensions": {
                "code": "MAX_FOLLOWS_EXCEEDED",
                "currentFollows": 50,
                "maxAllowed": 50
            }
        }
    ]
}
```

---

### 2. `unfollowCompany` - Dejar de Seguir

**Descripci√≥n**: Permite a un usuario dejar de seguir una empresa.

**Firma:**
```graphql
unfollowCompany(companyId: UUID!): Boolean!
```

**Directivas:**
- `@auth`: Requiere autenticaci√≥n
- `@audit(action: "unfollow_company")`: Auditor√≠a

**Request:**
```graphql
mutation UnfollowCompany($companyId: UUID!) {
    unfollowCompany(companyId: $companyId)
}
```

**Variables:**
```json
{
    "companyId": "550e8400-e29b-41d4-a716-446655440001"
}
```

**Response (√âxito):**
```json
{
    "data": {
        "unfollowCompany": true
    }
}
```

**Errores Posibles:**
```json
{
    "errors": [
        {
            "message": "No est√°s siguiendo esta empresa",
            "extensions": {
                "code": "NOT_FOLLOWING",
                "companyId": "550e8400-e29b-41d4-a716-446655440001"
            }
        }
    ]
}
```

---

### 3. `requestCompany` - Solicitar Nueva Empresa

**Descripci√≥n**: Solicitud p√∫blica para crear una nueva empresa. No requiere autenticaci√≥n. Genera solicitud para revisi√≥n por administradores.

**Firma:**
```graphql
requestCompany(input: CompanyRequestInput!): CompanyRequest!
```

**Directivas:**
- `@rateLimit(max: 3, window: 3600)`: M√°ximo 3 solicitudes por hora

**Request:**
```graphql
mutation RequestCompany($input: CompanyRequestInput!) {
    requestCompany(input: $input) {
        id
        requestCode
        companyName
        adminEmail
        status
        createdAt
    }
}
```

**Variables:**
```json
{
    "input": {
        "companyName": "Innovaci√≥n Digital SRL",
        "legalName": "Innovaci√≥n Digital Sociedad de Responsabilidad Limitada",
        "adminEmail": "admin@innovaciondigital.bo",
        "businessDescription": "Empresa dedicada al desarrollo de software personalizado y consultor√≠a tecnol√≥gica para PyMEs en Bolivia. Contamos con m√°s de 5 a√±os de experiencia en el mercado local, ofreciendo soluciones innovadoras que impulsan la transformaci√≥n digital.",
        "website": "https://innovaciondigital.bo",
        "industryType": "Technology",
        "estimatedUsers": 50,
        "contactAddress": "Calle Comercio 456",
        "contactCity": "Cochabamba",
        "contactCountry": "Bolivia",
        "contactPostalCode": "0000",
        "taxId": "987654321"
    }
}
```

**Input Validations:**

| Campo | Validaci√≥n |
|-------|------------|
| `companyName` | Required, min:2, max:200 |
| `legalName` | Optional, max:250 |
| `adminEmail` | Required, email v√°lido |
| `businessDescription` | Required, min:50, max:1000 |
| `website` | Optional, URL v√°lida |
| `industryType` | Required, max:100 |
| `estimatedUsers` | Optional, min:1, max:10000 |
| `contactAddress` | Optional, max:500 |
| `taxId` | Optional, max:50 |

**Response:**
```json
{
    "data": {
        "requestCompany": {
            "id": "880e8400-e29b-41d4-a716-446655440031",
            "requestCode": "REQ-2025-00043",
            "companyName": "Innovaci√≥n Digital SRL",
            "adminEmail": "admin@innovaciondigital.bo",
            "status": "PENDING",
            "createdAt": "2025-10-03T11:00:00Z"
        }
    }
}
```

**Errores Posibles:**
```json
{
    "errors": [
        {
            "message": "Ya existe una solicitud pendiente con este email",
            "extensions": {
                "code": "REQUEST_ALREADY_EXISTS",
                "email": "admin@innovaciondigital.bo"
            }
        }
    ]
}
```

```json
{
    "errors": [
        {
            "message": "Solo 3 solicitudes por hora",
            "extensions": {
                "code": "RATE_LIMIT_EXCEEDED",
                "retryAfter": 1800
            }
        }
    ]
}
```

---

### 4. `approveCompanyRequest` - Aprobar Solicitud

**Descripci√≥n**: Aprueba una solicitud y crea autom√°ticamente la empresa. Solo administradores de plataforma. Retorna una respuesta profesional con mensaje descriptivo y datos limitados.

**Firma:**
```graphql
approveCompanyRequest(requestId: UUID!): CompanyRequestApprovalResponse!
```

**Directivas:**
- `@jwt(requires: [PLATFORM_ADMIN])`: Solo admins
- `@audit(action: "company_request_approve", includePayload: true)`: Auditor√≠a completa

**Request:**
```graphql
mutation ApproveRequest($requestId: UUID!) {
    approveCompanyRequest(requestId: $requestId) {
        success
        message
        company {
            id
            companyCode
            name
            legalName
            status
            adminId
            adminEmail
            adminName
            createdAt
        }
        newUserCreated
        notificationSentTo
    }
}
```

**Variables:**
```json
{
    "requestId": "880e8400-e29b-41d4-a716-446655440030"
}
```

**Response (Usuario Nuevo - Con Contrase√±a Temporal):**
```json
{
    "data": {
        "approveCompanyRequest": {
            "success": true,
            "message": "Solicitud aprobada exitosamente. Se ha creado la empresa 'Innovaci√≥n Digital SRL' y se envi√≥ un email con las credenciales de acceso a admin@innovaciondigital.bo.",
            "company": {
                "id": "550e8400-e29b-41d4-a716-446655440010",
                "companyCode": "CMP-2025-00010",
                "name": "Innovaci√≥n Digital SRL",
                "legalName": "Innovaci√≥n Digital Sociedad de Responsabilidad Limitada",
                "status": "ACTIVE",
                "adminId": "660e8400-e29b-41d4-a716-446655440050",
                "adminEmail": "admin@innovaciondigital.bo",
                "adminName": "Admin Usuario",
                "createdAt": "2025-10-26T11:30:00Z"
            },
            "newUserCreated": true,
            "notificationSentTo": "admin@innovaciondigital.bo"
        }
    }
}
```

**Response (Usuario Existente - Sin Contrase√±a):**
```json
{
    "data": {
        "approveCompanyRequest": {
            "success": true,
            "message": "Solicitud aprobada exitosamente. Se ha creado la empresa 'Tech Solutions Inc.' y se asign√≥ el rol de administrador al usuario existente.",
            "company": {
                "id": "550e8400-e29b-41d4-a716-446655440011",
                "companyCode": "CMP-2025-00011",
                "name": "Tech Solutions Inc.",
                "legalName": null,
                "status": "ACTIVE",
                "adminId": "660e8400-e29b-41d4-a716-446655440055",
                "adminEmail": "existing@user.com",
                "adminName": "Juan P√©rez",
                "createdAt": "2025-10-26T11:35:00Z"
            },
            "newUserCreated": false,
            "notificationSentTo": "existing@user.com"
        }
    }
}
```

**Proceso Autom√°tico:**
1. ‚úÖ Valida que la solicitud est√© PENDING
2. ‚úÖ Verifica si admin_email existe en sistema
3. ‚úÖ **Si usuario NO existe**:
   - Crea usuario con contrase√±a temporal (16 chars, expira en 7 d√≠as)
   - Marca `has_temporary_password = true`
   - Env√≠a `CompanyApprovalMailForNewUser` con credenciales
4. ‚úÖ **Si usuario S√ç existe**:
   - Reutiliza usuario existente
   - Env√≠a `CompanyApprovalMailForExistingUser` sin contrase√±a
5. ‚úÖ Crea empresa con business_hours por defecto (Lun-Vie 9-18)
6. ‚úÖ Asigna rol COMPANY_ADMIN al usuario
7. ‚úÖ Marca solicitud como APPROVED
8. ‚úÖ Dispara evento CompanyRequestApproved
9. ‚úÖ Encola email en cola 'emails' (alta prioridad)
10. ‚úÖ Registra evento de auditor√≠a

**‚ö†Ô∏è IMPORTANTE - Campos NO Expuestos:**

Por seguridad y profesionalismo, la respuesta **NO incluye**:
- ‚ùå `business_hours` (configuraci√≥n interna)
- ‚ùå `settings` (configuraci√≥n interna)
- ‚ùå `timezone` (configuraci√≥n interna)
- ‚ùå Contrase√±a temporal (solo va por email)

Solo se devuelven campos esenciales para confirmar la operaci√≥n.

---

### 5. `rejectCompanyRequest` - Rechazar Solicitud

**Descripci√≥n**: Rechaza una solicitud con una raz√≥n espec√≠fica. Solo administradores. Retorna una respuesta profesional con mensaje descriptivo.

**Firma:**
```graphql
rejectCompanyRequest(
    requestId: UUID!
    reason: String! @rules(apply: ["required", "min:3"])
): CompanyRequestRejectionResponse!
```

**Directivas:**
- `@jwt(requires: [PLATFORM_ADMIN])`: Solo admins
- `@audit(action: "company_request_reject", includePayload: true)`: Auditor√≠a completa

**Request:**
```graphql
mutation RejectRequest($requestId: UUID!, $reason: String!) {
    rejectCompanyRequest(requestId: $requestId, reason: $reason) {
        success
        message
        reason
        notificationSentTo
        requestCode
    }
}
```

**Variables:**
```json
{
    "requestId": "880e8400-e29b-41d4-a716-446655440030",
    "reason": "La descripci√≥n del negocio no proporciona suficiente informaci√≥n sobre los servicios ofrecidos. Por favor, reenv√≠e la solicitud con m√°s detalles sobre su modelo de negocio y servicios espec√≠ficos."
}
```

**Response:**
```json
{
    "data": {
        "rejectCompanyRequest": {
            "success": true,
            "message": "La solicitud de empresa 'Innovaci√≥n Digital SRL' ha sido rechazada. Se ha enviado un email a admin@innovaciondigital.bo con la raz√≥n del rechazo.",
            "reason": "La descripci√≥n del negocio no proporciona suficiente informaci√≥n sobre los servicios ofrecidos. Por favor, reenv√≠e la solicitud con m√°s detalles sobre su modelo de negocio y servicios espec√≠ficos.",
            "notificationSentTo": "admin@innovaciondigital.bo",
            "requestCode": "REQ-2025-00042"
        }
    }
}
```

**Proceso Autom√°tico:**
1. ‚úÖ Valida que la solicitud est√© PENDING
2. ‚úÖ Guarda datos antes del rechazo (c√≥digo, nombre, email)
3. ‚úÖ Marca solicitud como REJECTED
4. ‚úÖ Guarda raz√≥n de rechazo en la solicitud
5. ‚úÖ Dispara evento CompanyRequestRejected
6. ‚úÖ Encola email en cola 'emails' (alta prioridad)
7. ‚úÖ Env√≠a `CompanyRejectionMail` con la raz√≥n
8. ‚úÖ Registra evento de auditor√≠a

**Validaciones:**
- `reason` es requerido y debe tener al menos 3 caracteres
- La solicitud debe estar en estado PENDING
- Solo PLATFORM_ADMIN puede ejecutar esta mutaci√≥n

---

### 6. `createCompany` - Crear Empresa Directamente

**Descripci√≥n**: Crea una empresa directamente sin proceso de solicitud. Solo administradores de plataforma.

**Firma:**
```graphql
createCompany(input: CreateCompanyInput!): Company!
```

**Directivas:**
- `@auth(requires: [PLATFORM_ADMIN])`: Solo admins
- `@audit(action: "create_company", includePayload: true)`: Auditor√≠a completa
- `@rateLimit(max: 10, window: 3600)`: M√°ximo 10 empresas por hora

**Request:**
```graphql
mutation CreateCompany($input: CreateCompanyInput!) {
    createCompany(input: $input) {
        id
        companyCode
        name
        status
        adminId
        adminName
        createdAt
    }
}
```

**Variables:**
```json
{
    "input": {
        "name": "Enterprise Solutions Corp",
        "legalName": "Enterprise Solutions Corporation SRL",
        "adminUserId": "660e8400-e29b-41d4-a716-446655440999",
        "supportEmail": "support@enterprise-solutions.com",
        "phone": "+59133445566",
        "website": "https://enterprise-solutions.com",
        "contactInfo": {
            "address": "Av. Empresarial 789",
            "city": "Santa Cruz",
            "state": "Santa Cruz",
            "country": "Bolivia",
            "postalCode": "0000",
            "taxId": "456789123",
            "legalRepresentative": "Mar√≠a Gonz√°lez"
        },
        "initialConfig": {
            "businessHours": {
                "monday": {"open": "09:00", "close": "18:00"},
                "tuesday": {"open": "09:00", "close": "18:00"},
                "wednesday": {"open": "09:00", "close": "18:00"},
                "thursday": {"open": "09:00", "close": "18:00"},
                "friday": {"open": "09:00", "close": "17:00"}
            },
            "timezone": "America/La_Paz"
        }
    }
}
```

**Response:**
```json
{
    "data": {
        "createCompany": {
            "id": "550e8400-e29b-41d4-a716-446655440011",
            "companyCode": "CMP-2025-00011",
            "name": "Enterprise Solutions Corp",
            "status": "ACTIVE",
            "adminId": "660e8400-e29b-41d4-a716-446655440999",
            "adminName": "Mar√≠a Gonz√°lez",
            "createdAt": "2025-10-03T12:00:00Z"
        }
    }
}
```

---

### 7. `updateCompany` - Actualizar Empresa

**Descripci√≥n**: Actualiza informaci√≥n de una empresa existente.

**Firma:**
```graphql
updateCompany(id: UUID!, input: UpdateCompanyInput!): Company!
```

**Directivas:**
- `@auth(requires: [PLATFORM_ADMIN, COMPANY_ADMIN])`: Admins o admin de la empresa
- `@can(ability: "update", model: "Company", find: "id")`: Valida permisos
- `@audit(action: "update_company", includePayload: true)`: Auditor√≠a completa

**Request:**
```graphql
mutation UpdateCompany($id: UUID!, $input: UpdateCompanyInput!) {
    updateCompany(id: $id, input: $input) {
        id
        name
        supportEmail
        website
        primaryColor
        updatedAt
    }
}
```

**Variables:**
```json
{
    "id": "550e8400-e29b-41d4-a716-446655440001",
    "input": {
        "supportEmail": "soporte@techsolutions.com",
        "website": "https://www.techsolutions.com",
        "branding": {
            "primaryColor": "#2563EB",
            "secondaryColor": "#1E3A8A"
        },
        "config": {
            "settings": {
                "autoAssignTickets": false,
                "allowPublicTickets": true
            }
        }
    }
}
```

**Response:**
```json
{
    "data": {
        "updateCompany": {
            "id": "550e8400-e29b-41d4-a716-446655440001",
            "name": "Tech Solutions Inc.",
            "supportEmail": "soporte@techsolutions.com",
            "website": "https://www.techsolutions.com",
            "primaryColor": "#2563EB",
            "updatedAt": "2025-10-03T12:30:00Z"
        }
    }
}
```

---

## üì¶ TYPES

### CompanyMinimal

**Descripci√≥n**: Type m√≠nimo para selectores y referencias r√°pidas.

**Campos:**
```graphql
type CompanyMinimal {
    id: UUID!
    companyCode: String!
    name: String!
    logoUrl: URL
}
```

**Uso:**
- Selectores de empresas
- Referencias en otros types
- Navbar de contexto

---

### CompanyForFollowing

**Descripci√≥n**: Type para explorar empresas y decidir seguirlas.

**Campos:**
```graphql
type CompanyForFollowing {
    id: UUID!
    companyCode: String!
    name: String!
    logoUrl: URL
    description: String
    industry: String
    city: String
    country: String
    primaryColor: HexColor
    followersCount: Int!
    isFollowedByMe: Boolean!
}
```

**Campo Especial:**
- `isFollowedByMe`: Calculado por resolver seg√∫n usuario autenticado

---

### Company (Full)

**Descripci√≥n**: Type completo con toda la informaci√≥n de empresa.

**Secciones:**

#### Identificadores
```graphql
id: UUID!
companyCode: String!
```

#### Informaci√≥n B√°sica
```graphql
name: String!
legalName: String
supportEmail: Email
phone: PhoneNumber
website: URL
```

#### Informaci√≥n de Contacto
```graphql
contactAddress: String
contactCity: String
contactState: String
contactCountry: String
contactPostalCode: String
```

#### Informaci√≥n Legal
```graphql
taxId: String
legalRepresentative: String
```

#### Configuraci√≥n Operativa
```graphql
businessHours: JSON!
timezone: String!
```

#### Branding
```graphql
logoUrl: URL
faviconUrl: URL
primaryColor: HexColor!
secondaryColor: HexColor!
```

#### Estado
```graphql
status: CompanyStatus!
settings: JSON
```

#### Admin (Sin Loops)
```graphql
adminId: UUID!
adminName: String!
adminEmail: Email!
adminAvatar: URL
```

#### Estad√≠sticas (Contadores)
```graphql
activeAgentsCount: Int!
totalUsersCount: Int!
totalTicketsCount: Int!
openTicketsCount: Int!
averageRating: Float
categoriesCount: Int!
macrosCount: Int!
followersCount: Int!
```

#### Flags Contextuales
```graphql
isFollowedByMe: Boolean @auth
```

#### Auditor√≠a
```graphql
createdAt: DateTime!
updatedAt: DateTime!
```

---

### CompanyFollowInfo

**Descripci√≥n**: Informaci√≥n de empresa seguida CON contexto personal del usuario.

**Campos:**
```graphql
type CompanyFollowInfo {
    id: UUID!
    company: CompanyMinimal!
    followedAt: DateTime!
    myTicketsCount: Int!
    lastTicketCreatedAt: DateTime
    hasUnreadAnnouncements: Boolean!
}
```

**Uso:**
- Query `myFollowedCompanies`
- Dashboard personal

---

### CompanyRequest

**Descripci√≥n**: Solicitud de empresa pendiente de aprobaci√≥n.

**Campos:**
```graphql
type CompanyRequest {
    id: UUID!
    requestCode: String!
    companyName: String!
    legalName: String
    adminEmail: Email!
    businessDescription: String!
    website: URL
    industryType: String!
    estimatedUsers: Int
    contactAddress: String
    contactCity: String
    contactCountry: String
    contactPostalCode: String
    taxId: String
    status: CompanyRequestStatus!
    reviewedById: UUID
    reviewedByName: String
    reviewedAt: DateTime
    rejectionReason: String
    createdCompanyId: UUID
    createdCompanyName: String
    createdAt: DateTime!
    updatedAt: DateTime!
}
```

---

### CompanyRequestApprovalResponse

**Descripci√≥n**: Respuesta profesional al aprobar solicitud de empresa. Incluye mensaje descriptivo y campos limitados por seguridad.

**Campos:**
```graphql
type CompanyRequestApprovalResponse {
    """Siempre true si la mutation fue exitosa"""
    success: Boolean!

    """Mensaje descriptivo del resultado"""
    message: String!

    """Datos b√°sicos de la empresa creada"""
    company: CompanyApprovalInfo!

    """Si se cre√≥ un nuevo usuario administrador"""
    newUserCreated: Boolean!

    """Email al que se envi√≥ la notificaci√≥n"""
    notificationSentTo: Email!
}
```

**Uso:**
- Response de `approveCompanyRequest` mutation
- Proporciona feedback profesional al cliente
- Expone solo campos esenciales (no internos)

**Mensajes Posibles:**
- Usuario nuevo: `"Solicitud aprobada exitosamente. Se ha creado la empresa '{company_name}' y se envi√≥ un email con las credenciales de acceso a {admin_email}."`
- Usuario existente: `"Solicitud aprobada exitosamente. Se ha creado la empresa '{company_name}' y se asign√≥ el rol de administrador al usuario existente."`

---

### CompanyApprovalInfo

**Descripci√≥n**: Informaci√≥n limitada de empresa creada tras aprobaci√≥n. NO incluye campos internos como business_hours, settings, etc.

**Campos:**
```graphql
type CompanyApprovalInfo {
    id: UUID!
    companyCode: String!
    name: String!
    legalName: String
    status: CompanyStatus!
    adminId: UUID!
    adminEmail: Email!
    adminName: String!
    createdAt: DateTime!
}
```

**Uso:**
- Anidado en `CompanyRequestApprovalResponse`
- Versi√≥n segura del tipo `Company` sin datos sensibles

**‚ö†Ô∏è Campos NO Incluidos (por seguridad):**
- ‚ùå `business_hours` - Configuraci√≥n interna
- ‚ùå `settings` - Configuraci√≥n interna
- ‚ùå `timezone` - Configuraci√≥n interna
- ‚ùå `phone`, `website`, `contactAddress` - Info detallada no necesaria
- ‚ùå Estad√≠sticas (counts) - No relevantes en respuesta de aprobaci√≥n

---

### CompanyRequestRejectionResponse

**Descripci√≥n**: Respuesta profesional al rechazar solicitud de empresa.

**Campos:**
```graphql
type CompanyRequestRejectionResponse {
    """Siempre true si la mutation fue exitosa"""
    success: Boolean!

    """Mensaje descriptivo del resultado"""
    message: String!

    """Raz√≥n del rechazo (la misma que se proporcion√≥)"""
    reason: String!

    """Email al que se envi√≥ la notificaci√≥n de rechazo"""
    notificationSentTo: Email!

    """C√≥digo de la solicitud rechazada"""
    requestCode: String!
}
```

**Uso:**
- Response de `rejectCompanyRequest` mutation
- Confirma que el rechazo fue procesado y notificado
- Incluye el c√≥digo de solicitud para referencia futura

**Mensaje:**
`"La solicitud de empresa '{company_name}' ha sido rechazada. Se ha enviado un email a {admin_email} con la raz√≥n del rechazo."`

---

## üî¢ ENUMS E INPUTS

### CompanyQueryContext (Enum)

**Descripci√≥n**: Define el contexto de la query `companies` para optimizar campos devueltos.

```graphql
enum CompanyQueryContext {
    MINIMAL      # Selectores: 4 campos
    EXPLORE      # Explorar: 11 campos
    MANAGEMENT   # Admin: todos los campos
    ANALYTICS    # Dashboards: + estad√≠sticas
}
```

---

### CompanyStatus (Enum)

```graphql
enum CompanyStatus {
    ACTIVE      # Empresa activa
    SUSPENDED   # Empresa suspendida temporalmente
}
```

---

### CompanyRequestStatus (Enum)

```graphql
enum CompanyRequestStatus {
    PENDING    # Pendiente de revisi√≥n
    APPROVED   # Aprobada (empresa creada)
    REJECTED   # Rechazada
}
```

---

### CompanyFilters (Input)

**Descripci√≥n**: Filtros para query `companies`.

```graphql
input CompanyFilters {
    status: CompanyStatus
    industry: String
    country: String
    hasActiveTickets: Boolean
    followedByMe: Boolean
}
```

**Ejemplos de Uso:**

Empresas activas con tickets abiertos:
```json
{
    "status": "ACTIVE",
    "hasActiveTickets": true
}
```

Empresas que sigo en Bolivia:
```json
{
    "followedByMe": true,
    "country": "Bolivia"
}
```

---

### CompanyRequestInput (Input)

**Descripci√≥n**: Input para solicitar nueva empresa.

```graphql
input CompanyRequestInput {
    companyName: String!              # required, min:2, max:200
    legalName: String                 # optional, max:250
    adminEmail: Email!                # required, email v√°lido
    businessDescription: String!      # required, min:50, max:1000
    website: URL                      # optional, URL v√°lida
    industryType: String!             # required, max:100
    estimatedUsers: Int               # optional, min:1, max:10000
    contactAddress: String            # optional, max:500
    contactCity: String               # optional, max:100
    contactCountry: String            # optional, max:100
    contactPostalCode: String         # optional, max:20
    taxId: String                     # optional, max:50
}
```

---

### CreateCompanyInput (Input)

**Descripci√≥n**: Input para crear empresa directamente (solo admins).

```graphql
input CreateCompanyInput {
    name: String!                     # required, min:2, max:200
    legalName: String                 # optional, max:250
    adminUserId: UUID!                # required, debe existir en users
    supportEmail: Email               # optional, email v√°lido
    phone: PhoneNumber                # optional
    website: URL                      # optional, URL v√°lida
    contactInfo: ContactInfoInput     # optional
    initialConfig: CompanyConfigInput # optional
}
```

---

### UpdateCompanyInput (Input)

**Descripci√≥n**: Input para actualizar empresa.

```graphql
input UpdateCompanyInput {
    name: String                      # optional, min:2, max:200
    legalName: String                 # optional, max:250
    supportEmail: Email               # optional, email v√°lido
    phone: PhoneNumber                # optional
    website: URL                      # optional, URL v√°lida
    contactInfo: ContactInfoInput     # optional
    config: CompanyConfigInput        # optional
    branding: CompanyBrandingInput    # optional
}
```

---

### ContactInfoInput (Input)

```graphql
input ContactInfoInput {
    address: String                   # max:500
    city: String                      # max:100
    state: String                     # max:100
    country: String                   # max:100
    postalCode: String                # max:20
    taxId: String                     # max:50
    legalRepresentative: String       # max:200
}
```

---

### CompanyConfigInput (Input)

```graphql
input CompanyConfigInput {
    businessHours: JSON               # Horarios por d√≠a
    timezone: String                  # Zona horaria IANA
    settings: JSON                    # Configuraciones custom
}
```

**businessHours Format:**
```json
{
    "monday": {"open": "08:00", "close": "18:00"},
    "tuesday": {"open": "08:00", "close": "18:00"},
    "wednesday": {"open": "08:00", "close": "18:00"},
    "thursday": {"open": "08:00", "close": "18:00"},
    "friday": {"open": "08:00", "close": "17:00"},
    "saturday": null,
    "sunday": null
}
```

---

### CompanyBrandingInput (Input)

```graphql
input CompanyBrandingInput {
    logoUrl: URL                      # URL del logo
    faviconUrl: URL                   # URL del favicon
    primaryColor: HexColor            # Color primario hex
    secondaryColor: HexColor          # Color secundario hex
}
```

---

## üîí PERMISOS Y AUTENTICACI√ìN

### Matriz de Permisos

| Operaci√≥n | P√∫blico | USER | AGENT | COMPANY_ADMIN | PLATFORM_ADMIN |
|-----------|---------|------|-------|---------------|----------------|
| `companies(MINIMAL)` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| `companies(EXPLORE)` | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| `companies(MANAGEMENT)` | ‚ùå | ‚ùå | ‚ùå | ‚úÖ (su empresa) | ‚úÖ (todas) |
| `company(id)` | ‚ùå | ‚úÖ (con permisos) | ‚úÖ (su empresa) | ‚úÖ (su empresa) | ‚úÖ (todas) |
| `myFollowedCompanies` | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| `isFollowingCompany` | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| `companyRequests` | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| `followCompany` | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| `unfollowCompany` | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| `requestCompany` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| `approveCompanyRequest` | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| `rejectCompanyRequest` | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| `createCompany` | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| `updateCompany` | ‚ùå | ‚ùå | ‚ùå | ‚úÖ (su empresa) | ‚úÖ (todas) |

### Directivas de Autenticaci√≥n

#### @auth
```graphql
@auth                                  # Requiere autenticaci√≥n
@auth(requires: [PLATFORM_ADMIN])      # Requiere rol espec√≠fico
```

#### @can
```graphql
@can(ability: "view", model: "Company", find: "id")
@can(ability: "update", model: "Company", find: "id")
```

#### @company
```graphql
@company(requireOwnership: true)       # Valida ownership de empresa
```

---

## üö® C√ìDIGOS DE ERROR

### Errores del Feature

```typescript
enum CompanyManagementErrors {
    COMPANY_NOT_FOUND = 'COMPANY_NOT_FOUND',
    COMPANY_SUSPENDED = 'COMPANY_SUSPENDED',
    ALREADY_FOLLOWING = 'ALREADY_FOLLOWING',
    NOT_FOLLOWING = 'NOT_FOLLOWING',
    MAX_FOLLOWS_EXCEEDED = 'MAX_FOLLOWS_EXCEEDED',
    REQUEST_ALREADY_EXISTS = 'REQUEST_ALREADY_EXISTS',
    INSUFFICIENT_PERMISSIONS = 'INSUFFICIENT_PERMISSIONS',
    INVALID_COMPANY_CODE = 'INVALID_COMPANY_CODE',
    ADMIN_USER_NOT_FOUND = 'ADMIN_USER_NOT_FOUND',
    REQUEST_NOT_PENDING = 'REQUEST_NOT_PENDING'
}
```

### Estructura de Error

```json
{
    "errors": [
        {
            "message": "Mensaje legible para el usuario",
            "extensions": {
                "code": "ERROR_CODE",
                "field": "campo_invalido",
                "value": "valor_recibido",
                "...": "metadata adicional"
            },
            "path": ["mutation", "field"]
        }
    ],
    "data": null
}
```

### Ejemplos de Errores

#### Empresa No Encontrada
```json
{
    "errors": [
        {
            "message": "Empresa no encontrada",
            "extensions": {
                "code": "COMPANY_NOT_FOUND",
                "companyId": "550e8400-invalid-uuid"
            }
        }
    ]
}
```

#### Ya Siguiendo
```json
{
    "errors": [
        {
            "message": "Ya est√°s siguiendo esta empresa",
            "extensions": {
                "code": "ALREADY_FOLLOWING",
                "companyId": "550e8400-e29b-41d4-a716-446655440001",
                "followedAt": "2024-08-10T09:15:00Z"
            }
        }
    ]
}
```

#### L√≠mite Excedido
```json
{
    "errors": [
        {
            "message": "Has alcanzado el l√≠mite de empresas que puedes seguir",
            "extensions": {
                "code": "MAX_FOLLOWS_EXCEEDED",
                "currentFollows": 50,
                "maxAllowed": 50
            }
        }
    ]
}
```

#### Permisos Insuficientes
```json
{
    "errors": [
        {
            "message": "No tienes permisos para esta operaci√≥n",
            "extensions": {
                "code": "INSUFFICIENT_PERMISSIONS",
                "requiredRole": "PLATFORM_ADMIN",
                "currentRole": "USER"
            }
        }
    ]
}
```

---

## ‚è±Ô∏è RATE LIMITING

### L√≠mites por Endpoint

| Endpoint | M√°ximo | Ventana | Mensaje |
|----------|--------|---------|---------|
| `requestCompany` | 3 | 1 hora | "Solo 3 solicitudes por hora" |
| `createCompany` | 10 | 1 hora | "L√≠mite de creaci√≥n excedido" |
| `followCompany` | 20 | 1 hora | "Demasiados intentos de seguimiento" |

### Error de Rate Limit

```json
{
    "errors": [
        {
            "message": "Solo 3 solicitudes por hora",
            "extensions": {
                "code": "RATE_LIMIT_EXCEEDED",
                "retryAfter": 1800,
                "limit": 3,
                "window": 3600
            }
        }
    ]
}
```

---

## üí° CASOS DE USO COMPLETOS

### Caso 1: Selector de Empresa al Crear Ticket

**Objetivo**: Mostrar lista simple de empresas para selector.

**Query:**
```graphql
query CompaniesForTicketSelector {
    companies(context: MINIMAL, first: 100) {
        ... on CompanyMinimalList {
            items {
                id
                name
                logoUrl
            }
        }
    }
}
```

**UI Implementation:**
- Select/Combobox con b√∫squeda
- Mostrar logo + nombre
- Cache agresivo (5 min)

---

### Caso 2: Explorar Empresas para Seguir

**Objetivo**: P√°gina donde usuarios descubren y siguen empresas.

**1. Cargar Empresas:**
```graphql
query ExploreCompanies($filters: CompanyFilters) {
    companies(context: EXPLORE, filters: $filters, first: 20) {
        ... on CompanyExploreList {
            items {
                id
                name
                logoUrl
                description
                industry
                city
                followersCount
                isFollowedByMe
            }
            hasNextPage
        }
    }
}
```

**2. Seguir Empresa:**
```graphql
mutation FollowCompany($companyId: UUID!) {
    followCompany(companyId: $companyId) {
        success
        message
        followedAt
    }
}
```

**3. Actualizar UI:**
- Cambiar bot√≥n "Seguir" ‚Üí "Siguiendo"
- Incrementar contador de seguidores
- Agregar a lista personal

---

### Caso 3: Dashboard Personal (Mis Empresas Seguidas)

**Objetivo**: Ver empresas que sigo con mi actividad.

**Query:**
```graphql
query MyDashboard {
    myFollowedCompanies {
        id
        company {
            id
            name
            logoUrl
        }
        followedAt
        myTicketsCount
        lastTicketCreatedAt
        hasUnreadAnnouncements
    }
}
```

**UI:**
- Tarjetas de empresas
- Badge de tickets sin leer
- Indicador de anuncios nuevos
- Link a tickets de cada empresa

---

### Caso 4: Solicitud P√∫blica de Empresa

**Objetivo**: Cualquier persona puede solicitar agregar su empresa.

**1. Enviar Solicitud:**
```graphql
mutation RequestNewCompany($input: CompanyRequestInput!) {
    requestCompany(input: $input) {
        requestCode
        status
        createdAt
    }
}
```

**2. Mensaje de √âxito:**
"Tu solicitud **REQ-2025-00043** fue enviada exitosamente. La revisaremos en 24-48 horas y te notificaremos por email."

---

### Caso 5: Panel Admin - Revisar Solicitudes

**Objetivo**: Admin revisa y aprueba/rechaza solicitudes con feedback profesional.

**1. Ver Pendientes:**
```graphql
query PendingRequests {
    companyRequests(status: PENDING) {
        id
        requestCode
        companyName
        adminEmail
        businessDescription
        industryType
        estimatedUsers
        createdAt
    }
}
```

**2. Aprobar Solicitud (Usuario Nuevo):**
```graphql
mutation ApproveRequest($requestId: UUID!) {
    approveCompanyRequest(requestId: $requestId) {
        success
        message
        company {
            id
            companyCode
            name
            adminEmail
        }
        newUserCreated
        notificationSentTo
    }
}
```

**Response:**
```json
{
    "data": {
        "approveCompanyRequest": {
            "success": true,
            "message": "Solicitud aprobada exitosamente. Se ha creado la empresa 'Innovaci√≥n Digital SRL' y se envi√≥ un email con las credenciales de acceso a admin@innovaciondigital.bo.",
            "company": {
                "id": "550e8400-...",
                "companyCode": "CMP-2025-00042",
                "name": "Innovaci√≥n Digital SRL",
                "adminEmail": "admin@innovaciondigital.bo"
            },
            "newUserCreated": true,
            "notificationSentTo": "admin@innovaciondigital.bo"
        }
    }
}
```

**Proceso en Background:**
1. ‚úÖ Usuario creado con contrase√±a temporal (16 chars, expira en 7 d√≠as)
2. ‚úÖ Empresa creada con business_hours por defecto
3. ‚úÖ Rol COMPANY_ADMIN asignado
4. ‚úÖ Email enviado con credenciales a Mailpit
5. ‚úÖ Job encolado en 'emails' queue

**3. Rechazar Solicitud:**
```graphql
mutation RejectRequest($requestId: UUID!, $reason: String!) {
    rejectCompanyRequest(requestId: $requestId, reason: $reason) {
        success
        message
        reason
        notificationSentTo
        requestCode
    }
}
```

**Response:**
```json
{
    "data": {
        "rejectCompanyRequest": {
            "success": true,
            "message": "La solicitud de empresa 'Innovaci√≥n Digital SRL' ha sido rechazada. Se ha enviado un email a admin@innovaciondigital.bo con la raz√≥n del rechazo.",
            "reason": "La descripci√≥n del negocio no proporciona suficiente informaci√≥n...",
            "notificationSentTo": "admin@innovaciondigital.bo",
            "requestCode": "REQ-2025-00042"
        }
    }
}
```

**UI Feedback:**
- Mostrar toast de √©xito con el mensaje profesional
- Actualizar lista de solicitudes pendientes
- Indicar que el email fue enviado exitosamente

---

### Caso 6: Actualizar Branding de Empresa

**Objetivo**: COMPANY_ADMIN actualiza logo y colores.

**Mutation:**
```graphql
mutation UpdateBranding($id: UUID!, $input: UpdateCompanyInput!) {
    updateCompany(id: $id, input: $input) {
        logoUrl
        primaryColor
        secondaryColor
        updatedAt
    }
}
```

**Variables:**
```json
{
    "id": "550e8400-e29b-41d4-a716-446655440001",
    "input": {
        "branding": {
            "logoUrl": "https://cdn.example.com/new-logo.png",
            "primaryColor": "#2563EB",
            "secondaryColor": "#1E3A8A"
        }
    }
}
```

---

## üìä EVENTOS DE AUDITOR√çA

Todos los eventos se registran en el sistema de auditor√≠a:

### Eventos Company
- `company.created`: Empresa creada
- `company.updated`: Empresa actualizada
- `company.suspended`: Empresa suspendida
- `company.activated`: Empresa reactivada

### Eventos Request
- `company_request.submitted`: Solicitud enviada
- `company_request.approved`: Solicitud aprobada
- `company_request.rejected`: Solicitud rechazada

### Eventos Follow
- `company.followed`: Usuario sigui√≥ empresa
- `company.unfollowed`: Usuario dej√≥ de seguir

**Metadata Incluida:**
```json
{
    "event": "company.followed",
    "userId": "660e8400-...",
    "companyId": "550e8400-...",
    "timestamp": "2025-10-03T10:45:00Z",
    "ip": "190.186.xxx.xxx",
    "userAgent": "Mozilla/5.0..."
}
```

---

## üîÑ INTEGRACI√ìN CON OTROS FEATURES

### UserManagement Feature
- Valida `company_id` para roles `AGENT` y `COMPANY_ADMIN`
- Proporciona `CompanyMinimal` en referencias de usuario
- Sincroniza followers con UserCompanyRoles

### Authentication Feature
- Contexto empresarial en tokens JWT
- Branding din√°mico en login por empresa
- Permisos basados en roles empresariales

### TicketManagement Feature
- Todos los tickets pertenecen a una empresa
- Solo agentes de la empresa pueden responder
- Selector de empresa al crear ticket p√∫blico

### Notifications Feature
- Seguidores reciben notificaciones de anuncios
- Preferencias de notificaci√≥n por empresa
- Emails con branding de empresa

---

## ‚ö° OPTIMIZACIONES DE PERFORMANCE

### Cach√©
- **Queries MINIMAL**: 5 minutos
- **Queries EXPLORE**: 2 minutos
- **Company full**: Sin cache (datos din√°micos)

### DataLoaders
```php
CompanyByIdLoader
CompaniesByStatusLoader
CompaniesFollowedByUserLoader
FollowersCountLoader
```

### Indexes en Base de Datos
```sql
-- Companies
CREATE INDEX idx_companies_status ON companies(status);
CREATE INDEX idx_companies_admin_id ON companies(admin_id);
CREATE INDEX idx_companies_company_code ON companies(company_code);

-- Company Followers
CREATE INDEX idx_company_followers_user_company ON company_followers(user_id, company_id);
CREATE INDEX idx_company_followers_company_id ON company_followers(company_id);
```

---

## üìù CHANGELOG

### V9.0 (Actual - 26 de Octubre, 2025)

**Sistema de Emails y Contrase√±as Temporales** - Implementaci√≥n completa del flujo profesional de notificaciones

#### ‚ú® Nuevas Funcionalidades

**Sistema de Contrase√±as Temporales:**
- ‚úÖ Migraci√≥n de base de datos (`has_temporary_password`, `temporary_password_expires_at`)
- ‚úÖ Generaci√≥n de contrase√±as seguras de 16 caracteres
- ‚úÖ Expiraci√≥n autom√°tica a los 7 d√≠as
- ‚úÖ Hash bcrypt para seguridad
- ‚úÖ Modelo User actualizado con campos y accesorios

**Sistema de Emails:**
- ‚úÖ 3 clases Mail implementadas:
  - `CompanyApprovalMailForNewUser` (con contrase√±a temporal)
  - `CompanyApprovalMailForExistingUser` (sin contrase√±a)
  - `CompanyRejectionMail` (con raz√≥n de rechazo)
- ‚úÖ 6 templates Blade (3 HTML + 3 texto plano)
- ‚úÖ 2 Jobs de email con retry (3 intentos, timeout 30s)
- ‚úÖ Cola 'emails' de alta prioridad
- ‚úÖ Integraci√≥n con Mailpit para desarrollo

**Eventos y Listeners:**
- ‚úÖ `CompanyRequestApproved` actualizado con `temporaryPassword`
- ‚úÖ `CompanyRequestRejected` implementado
- ‚úÖ Listeners para disparar jobs de email

**GraphQL Responses Profesionales:**
- ‚úÖ `CompanyRequestApprovalResponse` - respuesta estructurada para aprobaciones
- ‚úÖ `CompanyApprovalInfo` - type limitado sin campos internos
- ‚úÖ `CompanyRequestRejectionResponse` - respuesta estructurada para rechazos
- ‚úÖ Mensajes descriptivos en espa√±ol
- ‚úÖ Campos limitados por seguridad (NO expone business_hours, settings, etc.)

**Configuraci√≥n por Defecto:**
- ‚úÖ business_hours est√°ndar (Lun-Vie 9-18) cuando no se especifica
- ‚úÖ Implementado en `CompanyService::create()`

#### üß™ Testing

**15 Tests de Email Implementados:**
- ‚úÖ `ApproveCompanyRequestMutationTest`: 9 tests de aprobaci√≥n
- ‚úÖ `RejectCompanyRequestMutationTest`: 6 tests de rechazo
- ‚úÖ Helper methods para integraci√≥n con Mailpit API
- ‚úÖ Verificaci√≥n de Queue dispatch a 'emails'
- ‚úÖ Verificaci√≥n de Mail sending con clases correctas
- ‚úÖ Tests de login con contrase√±a temporal
- ‚úÖ Tests de expiraci√≥n de contrase√±a

**Cobertura:**
- ‚úÖ Escenario usuario nuevo (con contrase√±a)
- ‚úÖ Escenario usuario existente (sin contrase√±a)
- ‚úÖ Escenario de rechazo con raz√≥n
- ‚úÖ Validaci√≥n de emails llegando a Mailpit

#### üîß Mejoras T√©cnicas

**Service Layer:**
- ‚úÖ `UserService::createFromCompanyRequest()` retorna array con user y password
- ‚úÖ `CompanyRequestService::approve()` maneja contrase√±a temporal
- ‚úÖ `CompanyService::create()` aplica business_hours por defecto

**Mutations Actualizadas:**
- ‚úÖ `approveCompanyRequest`: Retorna `CompanyRequestApprovalResponse!`
- ‚úÖ `rejectCompanyRequest`: Retorna `CompanyRequestRejectionResponse!`
- ‚úÖ Mensajes profesionales en espa√±ol
- ‚úÖ Confirmaci√≥n de env√≠o de email

#### üìã Documentaci√≥n

- ‚úÖ Secci√≥n completa "Sistema de Emails y Contrase√±as Temporales"
- ‚úÖ Diagramas de flujo de arquitectura
- ‚úÖ Ejemplos de contenido de emails
- ‚úÖ Gu√≠as de testing con Mailpit
- ‚úÖ Instrucciones de monitoreo y debugging

#### üêõ Fixes

- ‚úÖ User model: Fix compatibilidad con AuthenticatableTrait (`password` vs `password_hash`)
- ‚úÖ business_hours: Fix null default, ahora usa horario est√°ndar
- ‚úÖ Missing imports: Added `use Illuminate\Support\Str` en UserService

---

### V8.3
- ‚úÖ Consolidaci√≥n de queries: 9 ‚Üí 5
- ‚úÖ Query principal con contextos
- ‚úÖ Eliminaci√≥n de redundancia
- ‚úÖ Mantenibilidad mejorada

### V8.2
- Eliminaci√≥n de loops infinitos
- Queries espec√≠ficas por caso de uso
- Sistema de seguimiento

### V8.0
- Primera versi√≥n con loops
- Arquitectura b√°sica

---

## üéØ PR√ìXIMOS PASOS

### ‚úÖ Completado (V9.0)

1. ‚úÖ **Backend Completo**: Services, Resolvers, DataLoaders
2. ‚úÖ **Sistema de Emails**: 3 Mail classes, 6 templates Blade
3. ‚úÖ **Contrase√±as Temporales**: Sistema completo con expiraci√≥n
4. ‚úÖ **Tests Completos**: 15 tests de email + tests de integraci√≥n
5. ‚úÖ **GraphQL Profesional**: Responses estructuradas con mensajes
6. ‚úÖ **Documentaci√≥n Completa**: Sistema de emails documentado

### üîú Pendientes

1. **Frontend React:**
   - Panel admin para revisar solicitudes
   - UI para aprobar/rechazar con feedback visual
   - Formulario p√∫blico de solicitud de empresa
   - Toast notifications con mensajes profesionales

2. **Validaci√≥n de Contrase√±a Temporal:**
   - Middleware para detectar `has_temporary_password = true`
   - Forzar cambio de contrase√±a en primer login
   - UI de cambio obligatorio de contrase√±a

3. **Email Templates Mejorados:**
   - Branding personalizable por empresa
   - Soporte multi-idioma (ES/EN)
   - Templates responsive avanzados

4. **Notificaciones Adicionales:**
   - Notificaci√≥n a PLATFORM_ADMIN cuando llega nueva solicitud
   - Recordatorio de contrase√±a temporal pr√≥xima a expirar
   - Email de bienvenida post-cambio de contrase√±a

5. **Analytics:**
   - Dashboard de solicitudes (aprobadas/rechazadas/pendientes)
   - M√©tricas de tiempo de respuesta
   - Tasas de aprobaci√≥n por industria

---

**Fin de la Documentaci√≥n V9.0**

> Para m√°s informaci√≥n sobre implementaci√≥n backend, consulta los archivos del proyecto en:
> - `app/Features/CompanyManagement/`
> - `app/Features/UserManagement/` (User model con contrase√±as temporales)
> - `resources/views/emails/company/` (Templates de email)
