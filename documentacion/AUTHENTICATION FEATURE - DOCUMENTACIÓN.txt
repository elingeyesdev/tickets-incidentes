# üìò AUTHENTICATION API V9.0 - DOCUMENTACI√ìN COMPLETA

> Sistema Helpdesk Multi-Tenant
> Feature: Authentication
> Schema Version: 9.0 (Refactorizado - Reutiliza Shared Types)
> √öltima actualizaci√≥n: 2025

---

## üìë TABLA DE CONTENIDOS

1. [Introducci√≥n](#introducci√≥n)
2. [Arquitectura](#arquitectura)
3. [Queries](#queries)
4. [Mutations](#mutations)
5. [Types](#types)
6. [Shared Types](#shared-types)
7. [Permisos y Seguridad](#permisos-y-seguridad)
8. [C√≥digos de Error](#c√≥digos-de-error)
9. [Rate Limiting](#rate-limiting)
10. [Casos de Uso](#casos-de-uso)

---

## üéØ INTRODUCCI√ìN

### Prop√≥sito del Feature
El **Authentication Feature** gestiona todo el ciclo de autenticaci√≥n y autorizaci√≥n del sistema:
- Registro de nuevos usuarios
- Login con email/password y OAuth (Google)
- Gesti√≥n de tokens JWT (access + refresh)
- Reset de contrase√±as
- Verificaci√≥n de emails
- Gesti√≥n de sesiones multi-dispositivo

### Caracter√≠sticas Principales
‚úÖ **JWT Tokens**: Access tokens de corta duraci√≥n (15-60 min)
‚úÖ **Refresh Tokens**: Tokens de larga duraci√≥n (30 d√≠as) en BD
‚úÖ **Multi-device Sessions**: Tracking de sesiones por dispositivo
‚úÖ **OAuth Integration**: Google OAuth2 para SSO
‚úÖ **Rate Limiting**: Protecci√≥n contra ataques de fuerza bruta
‚úÖ **Email Verification**: Verificaci√≥n obligatoria de emails

---

## üèóÔ∏è ARQUITECTURA

### Cambios Clave en V9.0

#### ‚úÖ **Reutilizaci√≥n de Shared Types**

```graphql
# Antes V8.0 (duplicaci√≥n)
type AuthPayload {
    user {
        id
        email
        profile {
            firstName
            lastName
            # ... duplicando definici√≥n
        }
    }
}

# Ahora V9.0 (reutilizaci√≥n)
type AuthPayload {
    user: UserAuthInfo!  # Shared type
}
```

#### ‚úÖ **AuthPayload Minimalista**

```graphql
# Antes V8.0 (sobrecargado)
type AuthPayload {
    user { ... 50+ campos ... }
    availableRoles { ... nested confuso ... }
    defaultRedirect
    requiresEmailVerification
    requiresProfileCompletion
    # ... demasiado
}

# Ahora V9.0 (solo lo necesario)
type AuthPayload {
    accessToken: String!
    refreshToken: String!
    user: UserAuthInfo!
    roleContexts: [RoleContext!]!
    sessionId: String!
    loginTimestamp: DateTime!
}
```

#### ‚úÖ **RoleContext Claro**

```graphql
# Antes V8.0 (confuso con nulls)
type AvailableRole {
    roleCode: String!
    companyId: UUID        # null para USER
    companyName: String    # null para USER
}

# Ahora V9.0 (type-safe)
type RoleContext {
    roleCode: RoleCode!
    roleName: String!
    company: RoleCompanyContext  # Presente SOLO si el rol requiere empresa
    dashboardPath: String!
}
```

---

## üîç QUERIES

### 1. `authStatus` - Estado de Autenticaci√≥n

**Descripci√≥n**: Obtiene el estado completo de autenticaci√≥n del usuario actual.

**Firma:**
```graphql
authStatus: AuthStatus!
```

**Directivas:**
- `@auth`: Requiere autenticaci√≥n

**Request:**
```graphql
query AuthStatus {
    authStatus {
        isAuthenticated
        user {
            id
            userCode
            email
            emailVerified
            status
            displayName
            avatarUrl
            theme
            language
        }
        currentSession {
            sessionId
            deviceName
            ipAddress
            lastUsedAt
            expiresAt
            isCurrent
        }
        tokenInfo {
            expiresIn
            issuedAt
            tokenType
        }
    }
}
```

**Response:**
```json
{
    "data": {
        "authStatus": {
            "isAuthenticated": true,
            "user": {
                "id": "550e8400-e29b-41d4-a716-446655440000",
                "userCode": "USR-2025-00123",
                "email": "maria.garcia@empresa.com",
                "emailVerified": true,
                "status": "ACTIVE",
                "displayName": "Mar√≠a Garc√≠a",
                "avatarUrl": "https://storage.helpdesk.com/avatars/usr_123.jpg",
                "theme": "dark",
                "language": "es"
            },
            "currentSession": {
                "sessionId": "sess_abc123def456",
                "deviceName": "Chrome on Windows",
                "ipAddress": "192.168.1.100",
                "lastUsedAt": "2025-10-03T15:30:00Z",
                "expiresAt": "2025-11-02T15:30:00Z",
                "isCurrent": true
            },
            "tokenInfo": {
                "expiresIn": 3400,
                "issuedAt": "2025-10-03T14:45:00Z",
                "tokenType": "Bearer"
            }
        }
    }
}
```

**Casos de Uso:**
- Middleware de autenticaci√≥n en frontend
- Validaci√≥n de sesi√≥n activa
- Debugging de estado de auth

---

### 2. `mySessions` - Sesiones Activas

**Descripci√≥n**: Lista todas las sesiones activas del usuario para gesti√≥n de dispositivos.

**Firma:**
```graphql
mySessions: [SessionInfo!]!
```

**Directivas:**
- `@auth`: Requiere autenticaci√≥n

**Request:**
```graphql
query MySessions {
    mySessions {
        sessionId
        deviceName
        ipAddress
        userAgent
        lastUsedAt
        expiresAt
        isCurrent
        location {
            city
            country
        }
    }
}
```

**Response:**
```json
{
    "data": {
        "mySessions": [
            {
                "sessionId": "sess_current123",
                "deviceName": "Chrome on Windows",
                "ipAddress": "192.168.1.100",
                "userAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64)...",
                "lastUsedAt": "2025-10-03T15:30:00Z",
                "expiresAt": "2025-11-02T15:30:00Z",
                "isCurrent": true,
                "location": {
                    "city": "Santa Cruz",
                    "country": "Bolivia"
                }
            },
            {
                "sessionId": "sess_mobile456",
                "deviceName": "iPhone Safari",
                "ipAddress": "192.168.1.105",
                "userAgent": "Mozilla/5.0 (iPhone; CPU iPhone OS 17_0)...",
                "lastUsedAt": "2025-10-02T22:30:00Z",
                "expiresAt": "2025-11-01T20:15:00Z",
                "isCurrent": false,
                "location": {
                    "city": "Santa Cruz",
                    "country": "Bolivia"
                }
            }
        ]
    }
}
```

**Casos de Uso:**
- P√°gina de seguridad del usuario
- Gesti√≥n de dispositivos conectados
- Detecci√≥n de sesiones sospechosas

---

### 3. `passwordResetStatus` - Estado de Token de Reset

**Descripci√≥n**: Valida un token de reset de contrase√±a antes de mostrar el formulario.

**Firma:**
```graphql
passwordResetStatus(token: String!): PasswordResetStatus!
```

**Request:**
```graphql
query PasswordResetStatus($token: String!) {
    passwordResetStatus(token: $token) {
        isValid
        email
        expiresAt
        canReset
        attemptsRemaining
    }
}
```

**Variables:**
```json
{
    "token": "reset_abc123def456ghi789jkl012"
}
```

**Response (Token V√°lido):**
```json
{
    "data": {
        "passwordResetStatus": {
            "isValid": true,
            "email": "m***a@empresa.com",
            "expiresAt": "2025-10-03T17:00:00Z",
            "canReset": true,
            "attemptsRemaining": 3
        }
    }
}
```

**Response (Token Inv√°lido):**
```json
{
    "data": {
        "passwordResetStatus": {
            "isValid": false,
            "email": null,
            "expiresAt": null,
            "canReset": false,
            "attemptsRemaining": 0
        }
    }
}
```

---

### 4. `emailVerificationStatus` - Estado de Verificaci√≥n

**Descripci√≥n**: Estado actual de verificaci√≥n de email del usuario autenticado.

**Firma:**
```graphql
emailVerificationStatus: EmailVerificationStatus!
```

**Directivas:**
- `@auth`: Requiere autenticaci√≥n

**Request:**
```graphql
query EmailVerificationStatus {
    emailVerificationStatus {
        isVerified
        email
        verificationSentAt
        canResend
        resendAvailableAt
        attemptsRemaining
    }
}
```

**Response (No Verificado):**
```json
{
    "data": {
        "emailVerificationStatus": {
            "isVerified": false,
            "email": "nuevo.usuario@empresa.com",
            "verificationSentAt": "2025-10-03T15:30:00Z",
            "canResend": false,
            "resendAvailableAt": "2025-10-03T15:35:00Z",
            "attemptsRemaining": 2
        }
    }
}
```

---

## ‚úèÔ∏è MUTATIONS

### 1. `register` - Registro de Usuario

**Descripci√≥n**: Registra un nuevo usuario y genera tokens autom√°ticamente.

**Firma:**
```graphql
register(input: RegisterInput!): AuthPayload!
```

**Directivas:**
- `@rateLimit(max: 5, window: 60)`: M√°ximo 5 registros por hora
- `@audit(action: "user_register")`: Auditor√≠a autom√°tica

**Request:**
```graphql
mutation Register($input: RegisterInput!) {
    register(input: $input) {
        accessToken
        refreshToken
        tokenType
        expiresIn
        user {
            id
            userCode
            email
            emailVerified
            displayName
            theme
            language
        }
        roleContexts {
            roleCode
            roleName
            dashboardPath
        }
        sessionId
        loginTimestamp
    }
}
```

**Variables:**
```json
{
    "input": {
        "email": "carlos.mendoza@empresa.com",
        "password": "MiPassword123!",
        "passwordConfirmation": "MiPassword123!",
        "firstName": "Carlos",
        "lastName": "Mendoza",
        "acceptsTerms": true,
        "acceptsPrivacyPolicy": true
    }
}
```

**Validaciones:**
- `email`: Requerido, formato email v√°lido, √∫nico en sistema
- `password`: Requerido, m√≠nimo 8 caracteres, debe coincidir con confirmaci√≥n
- `firstName`, `lastName`: Requeridos, entre 2 y 100 caracteres
- `acceptsTerms`, `acceptsPrivacyPolicy`: Deben ser `true`

**Response:**
```json
{
    "data": {
        "register": {
            "accessToken": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9...",
            "refreshToken": "def50200a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6...",
            "tokenType": "Bearer",
            "expiresIn": 3600,
            "user": {
                "id": "550e8400-e29b-41d4-a716-446655440001",
                "userCode": "USR-2025-00124",
                "email": "carlos.mendoza@empresa.com",
                "emailVerified": false,
                "displayName": "Carlos Mendoza",
                "theme": "light",
                "language": "es"
            },
            "roleContexts": [
                {
                    "roleCode": "USER",
                    "roleName": "Cliente",
                    "dashboardPath": "/tickets"
                }
            ],
            "sessionId": "sess_reg123abc456def",
            "loginTimestamp": "2025-10-03T16:00:00Z"
        }
    }
}
```

**Flujo Post-Registro:**
1. Usuario autom√°ticamente logueado
2. Email de verificaci√≥n enviado
3. Rol "USER" asignado por defecto
4. Redirecci√≥n a `/verify-email`

**Errores:**
```json
{
    "errors": [
        {
            "message": "El email ya est√° registrado en el sistema",
            "extensions": {
                "code": "EMAIL_ALREADY_EXISTS",
                "field": "email"
            }
        }
    ]
}
```

---

### 2. `login` - Iniciar Sesi√≥n

**Descripci√≥n**: Autentica usuario con email/contrase√±a.

**Firma:**
```graphql
login(input: LoginInput!): AuthPayload!
```

**Directivas:**
- `@rateLimit(max: 5, window: 15)`: M√°ximo 5 intentos por 15 minutos
- `@audit(action: "user_login")`: Auditor√≠a autom√°tica

**Request:**
```graphql
mutation Login($input: LoginInput!) {
    login(input: $input) {
        accessToken
        refreshToken
        tokenType
        expiresIn
        user {
            id
            userCode
            email
            emailVerified
            status
            displayName
            avatarUrl
            theme
            language
        }
        roleContexts {
            roleCode
            roleName
            company {
                id
                companyCode
                name
                logoUrl
            }
            dashboardPath
        }
        sessionId
        loginTimestamp
    }
}
```

**Variables:**
```json
{
    "input": {
        "email": "maria.garcia@empresa.com",
        "password": "MiPassword123!",
        "rememberMe": true,
        "deviceName": "Chrome on Windows"
    }
}
```

**Response - Usuario con M√∫ltiples Roles:**
```json
{
    "data": {
        "login": {
            "accessToken": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9...",
            "refreshToken": "def50200b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6...",
            "tokenType": "Bearer",
            "expiresIn": 3600,
            "user": {
                "id": "550e8400-e29b-41d4-a716-446655440000",
                "userCode": "USR-2025-00123",
                "email": "maria.garcia@empresa.com",
                "emailVerified": true,
                "status": "ACTIVE",
                "displayName": "Mar√≠a Garc√≠a",
                "avatarUrl": "https://storage.helpdesk.com/avatars/usr_123.jpg",
                "theme": "dark",
                "language": "es"
            },
            "roleContexts": [
                {
                    "roleCode": "USER",
                    "roleName": "Cliente",
                    "company": null,
                    "dashboardPath": "/tickets"
                },
                {
                    "roleCode": "AGENT",
                    "roleName": "Agente de Soporte",
                    "company": {
                        "id": "cmp-001",
                        "companyCode": "CMP-2025-00001",
                        "name": "Universidad del Valle",
                        "logoUrl": "https://storage.helpdesk.com/logos/cmp_001.png"
                    },
                    "dashboardPath": "/agent/dashboard"
                }
            ],
            "sessionId": "sess_login789xyz",
            "loginTimestamp": "2025-10-03T16:15:00Z"
        }
    }
}
```

**L√≥gica de Redirecci√≥n Frontend:**
```typescript
const { roleContexts } = loginResponse;

if (roleContexts.length === 1) {
    // Un solo rol: redirect directo
    redirect(roleContexts[0].dashboardPath);
} else {
    // M√∫ltiples roles: mostrar selector
    redirect('/role-selector');
}
```

**Errores:**
```json
{
    "errors": [
        {
            "message": "Credenciales incorrectas",
            "extensions": {
                "code": "INVALID_CREDENTIALS"
            }
        }
    ]
}
```

```json
{
    "errors": [
        {
            "message": "Usuario suspendido",
            "extensions": {
                "code": "USER_SUSPENDED",
                "suspendedAt": "2025-10-01T10:00:00Z",
                "reason": "Violaci√≥n de t√©rminos de servicio"
            }
        }
    ]
}
```

---

### 3. `loginWithGoogle` - Login OAuth con Google

**Descripci√≥n**: Autentica usuario usando token de Google OAuth. Crea cuenta autom√°ticamente si no existe.

**Firma:**
```graphql
loginWithGoogle(input: GoogleLoginInput!): AuthPayload!
```

**Directivas:**
- `@rateLimit(max: 10, window: 60)`: M√°ximo 10 intentos por hora
- `@audit(action: "user_login_google")`: Auditor√≠a autom√°tica

**Request:**
```graphql
mutation LoginWithGoogle($input: GoogleLoginInput!) {
    loginWithGoogle(input: $input) {
        accessToken
        refreshToken
        tokenType
        expiresIn
        user {
            id
            email
            emailVerified
            displayName
            avatarUrl
        }
        roleContexts {
            roleCode
            roleName
            dashboardPath
        }
        sessionId
        loginTimestamp
    }
}
```

**Variables:**
```json
{
    "input": {
        "googleToken": "ya29.a0AfH6SMC7J8X9Y2Z3A4B5C6D7E8F9G0H1...",
        "deviceName": "iPhone Safari"
    }
}
```

**Flujo:**
1. Frontend obtiene token de Google OAuth
2. Frontend env√≠a token al backend
3. Backend valida token con Google API
4. Si usuario existe: Login normal
5. Si usuario NO existe: Crear cuenta autom√°ticamente
6. Retorna AuthPayload est√°ndar

**Response (Usuario Nuevo - Auto-creado):**
```json
{
    "data": {
        "loginWithGoogle": {
            "accessToken": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9...",
            "refreshToken": "def50200d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8...",
            "tokenType": "Bearer",
            "expiresIn": 3600,
            "user": {
                "id": "550e8400-e29b-41d4-a716-446655440003",
                "email": "usuario.google@gmail.com",
                "emailVerified": true,
                "displayName": "Ana L√≥pez",
                "avatarUrl": "https://lh3.googleusercontent.com/a/photo.jpg"
            },
            "roleContexts": [
                {
                    "roleCode": "USER",
                    "roleName": "Cliente",
                    "dashboardPath": "/tickets"
                }
            ],
            "sessionId": "sess_google789ghi",
            "loginTimestamp": "2025-10-03T16:25:00Z"
        }
    }
}
```

**Datos Obtenidos de Google:**
- Email (autom√°ticamente verificado)
- Nombre y apellido
- Foto de perfil
- ID externo de Google

---

### 4. `refreshToken` - Renovar Token

**Descripci√≥n**: Genera nuevo access token usando refresh token v√°lido.

**Firma:**
```graphql
refreshToken: RefreshPayload!
```

**Directivas:**
- `@auth`: Requiere refresh token v√°lido en headers
- `@audit(action: "token_refresh")`: Auditor√≠a autom√°tica

**Headers Requeridos:**
```
Authorization: Bearer <refresh_token>
```

**Request:**
```graphql
mutation RefreshToken {
    refreshToken {
        accessToken
        refreshToken
        tokenType
        expiresIn
    }
}
```

**Response:**
```json
{
    "data": {
        "refreshToken": {
            "accessToken": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9...",
            "refreshToken": "def50200e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9...",
            "tokenType": "Bearer",
            "expiresIn": 3600
        }
    }
}
```

**Flujo de Refresh Autom√°tico:**
1. Access token expira (15-60 min)
2. Frontend detecta 401 en requests
3. Frontend autom√°ticamente llama `refreshToken`
4. Nuevo access token obtenido
5. Request original se reintenta con nuevo token

**Seguridad:**
- Refresh token anterior se invalida
- Nuevo refresh token generado
- Registro en auditor√≠a

**Errores:**
```json
{
    "errors": [
        {
            "message": "Refresh token inv√°lido o expirado",
            "extensions": {
                "code": "INVALID_REFRESH_TOKEN"
            }
        }
    ]
}
```

---

### 5. `logout` - Cerrar Sesi√≥n

**Descripci√≥n**: Cierra sesi√≥n. Puede cerrar solo sesi√≥n actual o todas.

**Firma:**
```graphql
logout(everywhere: Boolean = false): Boolean!
```

**Directivas:**
- `@auth`: Requiere autenticaci√≥n
- `@audit(action: "user_logout")`: Auditor√≠a autom√°tica

**Request:**
```graphql
mutation Logout($everywhere: Boolean) {
    logout(everywhere: $everywhere)
}
```

**Variables (Logout Normal):**
```json
{
    "everywhere": false
}
```

**Variables (Logout Everywhere):**
```json
{
    "everywhere": true
}
```

**Response:**
```json
{
    "data": {
        "logout": true
    }
}
```

**Efectos por Tipo:**

| Tipo | `everywhere: false` | `everywhere: true` |
|------|---------------------|-------------------|
| Revoca | Solo sesi√≥n actual | TODAS las sesiones |
| Access token | Actual se invalida | Todos se invalidan |
| Refresh token | Actual se revoca | Todos se revocan |
| Otros dispositivos | Permanecen activos | Deben re-loguearse |

**Casos de Uso:**
- **Normal**: Bot√≥n logout est√°ndar
- **Everywhere**: Cambio de contrase√±a, sospecha de compromiso

---

### 6. `revokeOtherSession` - Revocar Sesi√≥n Espec√≠fica

**Descripci√≥n**: Revoca una sesi√≥n espec√≠fica de otro dispositivo.

**Firma:**
```graphql
revokeOtherSession(sessionId: String!): Boolean!
```

**Directivas:**
- `@auth`: Requiere autenticaci√≥n
- `@audit(action: "session_revoke")`: Auditor√≠a autom√°tica

**Request:**
```graphql
mutation RevokeOtherSession($sessionId: String!) {
    revokeOtherSession(sessionId: $sessionId)
}
```

**Variables:**
```json
{
    "sessionId": "sess_mobile456"
}
```

**Response:**
```json
{
    "data": {
        "revokeOtherSession": true
    }
}
```

**Validaciones:**
- No puede revocar su propia sesi√≥n actual (usar `logout` para eso)
- Solo puede revocar sesiones de su propio usuario
- SessionId debe existir y estar activo

**Casos de Uso:**
- Gesti√≥n de dispositivos conectados
- Revocar acceso de dispositivo perdido/robado
- P√°gina de seguridad del usuario

---

### 7. `resetPassword` - Solicitar Reset

**Descripci√≥n**: Env√≠a email con token para reset de contrase√±a. Siempre retorna `true` por seguridad.

**Firma:**
```graphql
resetPassword(email: Email!): Boolean!
```

**Directivas:**
- `@rateLimit(max: 3, window: 3600)`: M√°ximo 3 intentos por hora
- `@audit(action: "password_reset_request")`: Auditor√≠a autom√°tica

**Request:**
```graphql
mutation ResetPassword($email: Email!) {
    resetPassword(email: $email)
}
```

**Variables:**
```json
{
    "email": "usuario@empresa.com"
}
```

**Response (Siempre):**
```json
{
    "data": {
        "resetPassword": true
    }
}
```

**Comportamiento por Seguridad:**
- **SIEMPRE** retorna `true`, incluso si email NO existe
- NO revela si un email est√° registrado
- Rate limiting: m√°ximo 3 intentos por hora

**Flujo Real:**
| Email Existe | Acci√≥n |
|--------------|--------|
| ‚úÖ S√≠ | Env√≠a email con token de reset |
| ‚ùå No | No hace nada, pero retorna `true` |

**Email de Reset (si email existe):**
- Contiene link: `https://app.com/reset-password?token=abc123...`
- Token expira en 1 hora
- M√°ximo 3 intentos de reset por token

---

### 8. `confirmPasswordReset` - Confirmar Reset

**Descripci√≥n**: Establece nueva contrase√±a usando token v√°lido.

**Firma:**
```graphql
confirmPasswordReset(input: PasswordResetInput!): PasswordResetResult!
```

**Directivas:**
- `@rateLimit(max: 3, window: 900)`: M√°ximo 3 intentos por 15 minutos
- `@audit(action: "password_reset_confirm")`: Auditor√≠a autom√°tica

**Request:**
```graphql
mutation ConfirmPasswordReset($input: PasswordResetInput!) {
    confirmPasswordReset(input: $input) {
        success
        message
        user {
            id
            email
            displayName
        }
    }
}
```

**Variables:**
```json
{
    "input": {
        "token": "reset_abc123def456ghi789jkl012mno345",
        "password": "NuevaPassword123!",
        "passwordConfirmation": "NuevaPassword123!"
    }
}
```

**Response (Exitosa):**
```json
{
    "data": {
        "confirmPasswordReset": {
            "success": true,
            "message": "Contrase√±a actualizada exitosamente",
            "user": {
                "id": "550e8400-e29b-41d4-a716-446655440000",
                "email": "usuario@empresa.com",
                "displayName": "Mar√≠a Garc√≠a"
            }
        }
    }
}
```

**Response (Error):**
```json
{
    "data": {
        "confirmPasswordReset": {
            "success": false,
            "message": "Token de reset inv√°lido o expirado",
            "user": null
        }
    }
}
```

**Efectos del Reset Exitoso:**
1. Contrase√±a actualizada con nuevo hash
2. Token de reset invalidado
3. **TODAS las sesiones activas invalidadas** (logout everywhere)
4. Usuario debe loguearse nuevamente
5. Email de confirmaci√≥n enviado

---

### 9. `verifyEmail` - Verificar Email

**Descripci√≥n**: Verifica email del usuario usando token.

**Firma:**
```graphql
verifyEmail(token: String!): EmailVerificationResult!
```

**Directivas:**
- `@audit(action: "email_verify")`: Auditor√≠a autom√°tica

**Request:**
```graphql
mutation VerifyEmail($token: String!) {
    verifyEmail(token: $token) {
        success
        message
        canResend
        resendAvailableAt
    }
}
```

**Variables:**
```json
{
    "token": "verify_def456ghi789jkl012mno345pqr678"
}
```

**Response (Exitosa):**
```json
{
    "data": {
        "verifyEmail": {
            "success": true,
            "message": "Email verificado exitosamente",
            "canResend": false,
            "resendAvailableAt": null
        }
    }
}
```

**Response (Error):**
```json
{
    "data": {
        "verifyEmail": {
            "success": false,
            "message": "Token de verificaci√≥n inv√°lido o expirado",
            "canResend": true,
            "resendAvailableAt": "2025-10-03T16:40:00Z"
        }
    }
}
```

**Efectos de Verificaci√≥n Exitosa:**
1. `emailVerified` cambia a `true`
2. `emailVerifiedAt` se establece
3. Usuario obtiene acceso completo
4. Token se invalida

---

### 10. `resendVerification` - Reenviar Verificaci√≥n

**Descripci√≥n**: Reenv√≠a email de verificaci√≥n. Respeta rate limiting.

**Firma:**
```graphql
resendVerification: EmailVerificationResult!
```

**Directivas:**
- `@auth`: Requiere autenticaci√≥n
- `@rateLimit(max: 3, window: 300)`: M√°ximo 3 reenv√≠os por 5 minutos
- `@audit(action: "email_verification_resend")`: Auditor√≠a autom√°tica

**Request:**
```graphql
mutation ResendVerification {
    resendVerification {
        success
        message
        canResend
        resendAvailableAt
    }
}
```

**Response (Exitosa):**
```json
{
    "data": {
        "resendVerification": {
            "success": true,
            "message": "Email de verificaci√≥n enviado",
            "canResend": false,
            "resendAvailableAt": "2025-10-03T17:05:00Z"
        }
    }
}
```

**Response (Rate Limit):**
```json
{
    "data": {
        "resendVerification": {
            "success": false,
            "message": "Debes esperar 5 minutos antes de reenviar",
            "canResend": false,
            "resendAvailableAt": "2025-10-03T17:00:00Z"
        }
    }
}
```

**Rate Limiting:**
- M√°ximo 3 reenv√≠os por 5 minutos
- Bloqueo temporal despu√©s de l√≠mite
- Usuario ya verificado recibe error

---

## üì¶ TYPES

### AuthPayload (V9.0 - Refactorizado)

**Descripci√≥n**: Response de login/register. Solo lo necesario.

```graphql
type AuthPayload {
    accessToken: String!
    refreshToken: String!
    tokenType: String!
    expiresIn: Int!
    user: UserAuthInfo!
    roleContexts: [RoleContext!]!
    sessionId: String!
    loginTimestamp: DateTime!
}
```

**Campos:**
- `accessToken`: JWT de corta duraci√≥n (15-60 min)
- `refreshToken`: Token de larga duraci√≥n (30 d√≠as)
- `user`: Info b√°sica (reutiliza `UserAuthInfo` de shared types)
- `roleContexts`: Lista de roles para selector
- `sessionId`: ID √∫nico de sesi√≥n

---

### RefreshPayload

**Descripci√≥n**: Response de refresh token. Versi√≥n minimalista.

```graphql
type RefreshPayload {
    accessToken: String!
    refreshToken: String!
    tokenType: String!
    expiresIn: Int!
}
```

**Nota**: No incluye informaci√≥n de usuario para m√°xima eficiencia.

---

### AuthStatus

**Descripci√≥n**: Estado completo de autenticaci√≥n.

```graphql
type AuthStatus {
    isAuthenticated: Boolean!
    user: UserAuthInfo
    currentSession: SessionInfo
    tokenInfo: TokenInfo
}
```

---

### SessionInfo

**Descripci√≥n**: Informaci√≥n de sesi√≥n activa.

```graphql
type SessionInfo {
    sessionId: String!
    deviceName: String
    ipAddress: String
    userAgent: String
    lastUsedAt: DateTime!
    expiresAt: DateTime!
    isCurrent: Boolean!
    location: SessionLocation
}
```

---

## üåê SHARED TYPES

Estos types est√°n en `shared/types.graphql` y son reutilizados por m√∫ltiples features:

### UserAuthInfo

**Descripci√≥n**: Info de usuario para contexto de autenticaci√≥n.

```graphql
type UserAuthInfo {
    id: UUID!
    userCode: String!
    email: Email!
    emailVerified: Boolean!
    status: UserStatus!
    displayName: String!
    avatarUrl: URL
    theme: String!
    language: String!
}
```

**Usado por:**
- `AuthPayload.user`
- `AuthStatus.user`

---

### RoleContext

**Descripci√≥n**: Informaci√≥n de rol para selector (SIN over-fetching).

```graphql
type RoleContext {
    roleCode: RoleCode!
    roleName: String!
    company: RoleCompanyContext
    dashboardPath: String!
}
```

**Campo Especial:**
- `company`: **Opcional** - presente SOLO si el rol requiere empresa

**Ejemplos:**

```json
// USER (sin empresa)
{
    "roleCode": "USER",
    "roleName": "Cliente",
    "company": null,
    "dashboardPath": "/tickets"
}

// AGENT (con empresa)
{
    "roleCode": "AGENT",
    "roleName": "Agente de Soporte",
    "company": {
        "id": "cmp-001",
        "name": "Universidad del Valle",
        "logoUrl": "https://..."
    },
    "dashboardPath": "/agent/dashboard"
}
```

---

### UserMinimal

**Descripci√≥n**: Type m√≠nimo de usuario para referencias.

```graphql
type UserMinimal {
    id: UUID!
    userCode: String!
    email: Email!
    displayName: String!
    avatarUrl: URL
}
```

**Usado por:**
- `PasswordResetResult.user`
- M√∫ltiples features (UserManagement, TicketManagement, etc.)

---

## üîí PERMISOS Y SEGURIDAD

### Matriz de Permisos

| Operaci√≥n | P√∫blico | Autenticado | Notas |
|-----------|---------|-------------|-------|
| `register` | ‚úÖ | ‚úÖ | Rate limited: 5/hora |
| `login` | ‚úÖ | ‚úÖ | Rate limited: 5 cada 15min |
| `loginWithGoogle` | ‚úÖ | ‚úÖ | Rate limited: 10/hora |
| `resetPassword` | ‚úÖ | ‚úÖ | Rate limited: 3/hora |
| `confirmPasswordReset` | ‚úÖ | ‚úÖ | Rate limited: 3 cada 15min |
| `verifyEmail` | ‚úÖ | ‚úÖ | No rate limit |
| `authStatus` | ‚ùå | ‚úÖ | Requiere @auth |
| `mySessions` | ‚ùå | ‚úÖ | Requiere @auth |
| `refreshToken` | ‚ùå | ‚úÖ | Requiere refresh token |
| `logout` | ‚ùå | ‚úÖ | Requiere @auth |
| `revokeOtherSession` | ‚ùå | ‚úÖ | Requiere @auth |
| `resendVerification` | ‚ùå | ‚úÖ | Rate limited: 3 cada 5min |

### JWT Token Structure

```json
{
    "header": {
        "typ": "JWT",
        "alg": "RS256"
    },
    "payload": {
        "iss": "helpdesk-api",
        "sub": "550e8400-...",
        "aud": "helpdesk-frontend",
        "exp": 1695308700,
        "iat": 1695305100,
        "user_id": "550e8400-...",
        "email": "usuario@empresa.com",
        "roles": ["USER", "AGENT"],
        "companies": ["cmp-001"],
        "session_id": "sess_abc123"
    }
}
```

### Refresh Token Storage

- Almacenado en BD (`auth.refresh_tokens`)
- Hash SHA-256 para seguridad
- Asociado a dispositivo espec√≠fico
- Expiraci√≥n: 30 d√≠as (configurable)
- Un usuario puede tener m√∫ltiples refresh tokens (multi-device)

---

## üö® C√ìDIGOS DE ERROR

```typescript
enum AuthenticationErrors {
    INVALID_CREDENTIALS = 'INVALID_CREDENTIALS',
    USER_NOT_FOUND = 'USER_NOT_FOUND',
    EMAIL_ALREADY_EXISTS = 'EMAIL_ALREADY_EXISTS',
    EMAIL_NOT_VERIFIED = 'EMAIL_NOT_VERIFIED',
    USER_SUSPENDED = 'USER_SUSPENDED',
    INVALID_TOKEN = 'INVALID_TOKEN',
    TOKEN_EXPIRED = 'TOKEN_EXPIRED',
    INVALID_REFRESH_TOKEN = 'INVALID_REFRESH_TOKEN',
    RATE_LIMIT_EXCEEDED = 'RATE_LIMIT_EXCEEDED',
    GOOGLE_OAUTH_ERROR = 'GOOGLE_OAUTH_ERROR',
    PASSWORD_RESET_FAILED = 'PASSWORD_RESET_FAILED',
    EMAIL_VERIFICATION_FAILED = 'EMAIL_VERIFICATION_FAILED',
    SESSION_NOT_FOUND = 'SESSION_NOT_FOUND',
    CANNOT_REVOKE_CURRENT_SESSION = 'CANNOT_REVOKE_CURRENT_SESSION'
}
```

### Estructura de Error

```json
{
    "errors": [
        {
            "message": "Mensaje legible",
            "extensions": {
                "code": "ERROR_CODE",
                "field": "campo_invalido",
                "timestamp": "2025-10-03T16:30:00Z"
            },
            "path": ["mutation", "field"]
        }
    ],
    "data": null
}
```

---

## ‚è±Ô∏è RATE LIMITING

| Endpoint | M√°ximo | Ventana | Mensaje |
|----------|--------|---------|---------|
| `register` | 5 | 60 min | "Demasiados intentos de registro" |
| `login` | 5 | 15 min | "Demasiados intentos de login" |
| `loginWithGoogle` | 10 | 60 min | "L√≠mite de login con Google excedido" |
| `resetPassword` | 3 | 60 min | "Solo 3 intentos por hora" |
| `confirmPasswordReset` | 3 | 15 min | "Demasiados intentos" |
| `resendVerification` | 3 | 5 min | "Debes esperar antes de reenviar" |

---

## üí° CASOS DE USO COMPLETOS

### Caso 1: Flujo de Registro Completo

**1. Usuario se registra:**
```graphql
mutation Register {
    register(input: {
        email: "nuevo@empresa.com"
        password: "Pass123!"
        passwordConfirmation: "Pass123!"
        firstName: "Juan"
        lastName: "P√©rez"
        acceptsTerms: true
        acceptsPrivacyPolicy: true
    }) {
        accessToken
        user { email, emailVerified }
        roleContexts { roleCode, dashboardPath }
    }
}
```

**2. Response:**
- `emailVerified: false`
- `roleContexts: [{ roleCode: "USER", dashboardPath: "/tickets" }]`

**3. Frontend:**
- Guarda tokens
- Detecta `emailVerified: false`
- Redirige a `/verify-email`

**4. Usuario hace clic en link del email:**
```graphql
mutation VerifyEmail {
    verifyEmail(token: "verify_abc123...")
}
```

**5. Email verificado:**
- Usuario puede acceder completamente al sistema

---

3
```

**3. Frontend muestra selector:**
```
¬øCon qu√© rol quieres ingresar?

[üìã Cliente] ‚Üí /tickets
[üë®‚Äçüíº Agente - Universidad del Valle] ‚Üí /agent/dashboard
```

**4. Usuario selecciona rol:**
- Frontend redirige al dashboard correspondiente

---

### Caso 3: Refresh Token Autom√°tico

**1. Access token expira (15-60 min despu√©s):**
- Frontend detecta 401 en requests

**2. Frontend autom√°ticamente:**
```graphql
mutation RefreshToken {
    refreshToken {
        accessToken
        refreshToken
    }
}
```

**3. Tokens actualizados:**
- Nuevo access token guardado
- Nuevo refresh token guardado
- Request original se reintenta

**4. Transparente para el usuario:**
- No pierde contexto
- No necesita re-loguearse

---

### Caso 4: Gesti√≥n de Dispositivos

**1. Usuario ve sus sesiones:**
```graphql
query MySessions {
    mySessions {
        sessionId
        deviceName
        lastUsedAt
        isCurrent
    }
}
```

**2. Response:**
```json
[
    {
        "sessionId": "sess_123",
        "deviceName": "Chrome Windows",
        "lastUsedAt": "2025-10-03T15:30:00Z",
        "isCurrent": true
    },
    {
        "sessionId": "sess_456",
        "deviceName": "iPhone Safari",
        "lastUsedAt": "2025-10-02T10:00:00Z",
        "isCurrent": false
    }
]
```

**3. Usuario revoca sesi√≥n del iPhone:**
```graphql
mutation RevokeSession {
    revokeOtherSession(sessionId: "sess_456")
}
```

**4. iPhone debe re-loguearse:**
- Su refresh token fue revocado
- Su access token es inv√°lido

---

### Caso 5: Reset de Contrase√±a

**1. Usuario solicita reset:**
```graphql
mutation ResetPassword {
    resetPassword(email: "usuario@empresa.com")
}
```

**2. Response (siempre true):**
```json
{ "data": { "resetPassword": true } }
```

**3. Si email existe, recibe email con link:**
```
https://app.com/reset-password?token=reset_abc123...
```

**4. Usuario hace clic, frontend valida token:**
```graphql
query ValidateToken {
    passwordResetStatus(token: "reset_abc123...") {
        isValid
        canReset
    }
}
```

**5. Si v√°lido, muestra formulario y confirma:**
```graphql
mutation ConfirmReset {
    confirmPasswordReset(input: {
        token: "reset_abc123..."
        password: "NuevaPass123!"
        passwordConfirmation: "NuevaPass123!"
    }) {
        success
    }
}
```

**6. Contrase√±a actualizada:**
- TODAS las sesiones invalidadas
- Usuario debe loguearse nuevamente

---

## üìä EVENTOS DE AUDITOR√çA

Todos los eventos se registran autom√°ticamente:

- `user_register`: Registro de usuario
- `user_login`: Login exitoso
- `user_login.failed`: Intento fallido
- `user_login_google`: Login con Google
- `user_logout`: Logout manual
- `token_refresh`: Token renovado
- `password_reset_request`: Reset solicitado
- `password_reset_confirm`: Reset completado
- `email_verify`: Email verificado
- `email_verification_resend`: Reenv√≠o de verificaci√≥n
- `session_revoke`: Sesi√≥n revocada

**Metadata incluida:**
```json
{
    "event": "user_login",
    "userId": "550e8400-...",
    "timestamp": "2025-10-03T16:15:00Z",
    "ip": "192.168.1.100",
    "userAgent": "Mozilla/5.0...",
    "deviceName": "Chrome on Windows"
}
```

---

**Fin de la Documentaci√≥n de Authentication**

> Para implementaci√≥n backend, ver `app/Features/Authentication/`
> Para integraci√≥n con otros features, consultar documentaci√≥n de UserManagement
