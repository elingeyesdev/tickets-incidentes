# ğŸ« REGLAS MAESTRAS: SEEDERS DE TICKETS
## Enterprise Helpdesk System - Protocolo Definitivo de Calidad

---

## ğŸ¯ OBJETIVO

Crear tickets **100% realistas y coherentes** que simulen el funcionamiento real de un sistema de soporte empresarial, incluyendo distribuciÃ³n temporal basada en lÃ³gica de negocio, coherencia con la industria, y conexiÃ³n con todos los elementos del ecosistema (Ã¡reas, categorÃ­as, agentes, usuarios).

---

## âš™ï¸ CONFIGURACIÃ“N GENERAL

### Rango Temporal
```
INICIO:     5 de enero de 2025 (DÃ­a 1)
FIN:        10 de diciembre de 2025 (DÃ­a 341)
DURACIÃ“N:   341 dÃ­as (~11 meses)
```

### Idempotencia del Seeder (OBLIGATORIO)
```php
// VERIFICACIÃ“N OBLIGATORIA AL INICIO - NUNCA OMITIR
$existingTicketsCount = Ticket::where('company_id', $company->id)->count();
if ($existingTicketsCount >= EXPECTED_TICKET_COUNT) {
    $this->command->info('[OK] Seeder ya fue ejecutado anteriormente. Saltando para evitar duplicados.');
    return;
}
```

---

## ğŸ” PROTOCOLO DE INVESTIGACIÃ“N PRE-SEEDING (OBLIGATORIO)

### PASO 1: Investigar la Empresa

**ANTES de escribir cualquier lÃ­nea de cÃ³digo del seeder:**

```
â˜ 1. IDENTIFICAR EMPRESA
   - Nombre exacto de la empresa
   - Industria (industry_id del modelo Company)
   - TamaÃ±o (pequeÃ±a/mediana/grande)
   - Contexto de negocio real (si es empresa boliviana real, investigar)

â˜ 2. VERIFICAR AREAS_ENABLED
   - Consultar: $company->settings['areas_enabled'] ?? false
   - SI areas_enabled = TRUE: Los tickets DEBEN incluir area_id
   - SI areas_enabled = FALSE: Los tickets NO deben tener area_id

â˜ 3. OBTENER ÃREAS DISPONIBLES (si areas_enabled)
   - Consultar: Area::where('company_id', $company->id)->where('is_active', true)->get()
   - Documentar: ID y nombre de cada Ã¡rea activa
   - Asignar tickets coherentemente a Ã¡reas segÃºn contexto

â˜ 4. OBTENER CATEGORÃAS DISPONIBLES
   - Consultar: Category::where('company_id', $company->id)->where('is_active', true)->get()
   - Documentar: ID, nombre y descripciÃ³n de cada categorÃ­a
   - EVALUAR: Â¿Son suficientes las categorÃ­as para la industria?
   - SI NO SON SUFICIENTES: Crear categorÃ­as adicionales en el seeder ANTES de crear tickets

â˜ 5. OBTENER AGENTES DISPONIBLES
   - Consultar usuarios con rol AGENT para la empresa
   - Documentar: email, nombre de cada agente
   - Los tickets se distribuyen ENTRE agentes (ver volumen por agente)
```

### PASO 2: Evaluar y Crear CategorÃ­as (si es necesario)

**CategorÃ­as mÃ­nimas recomendadas por industria:**

```
BANKING (Banca):
- Cuentas y Accesos
- Tarjetas y Pagos
- Transferencias
- PrÃ©stamos y CrÃ©ditos
- Seguridad Financiera

TELECOMMUNICATIONS (Telecomunicaciones):
- Conectividad y SeÃ±al
- FacturaciÃ³n
- Planes y Servicios
- Equipos y Dispositivos
- Portabilidad

MANUFACTURING (Manufactura):
- Soporte TÃ©cnico
- Problema de ProducciÃ³n
- Control de Calidad
- LogÃ­stica y DistribuciÃ³n
- Seguridad Industrial

ENERGY (EnergÃ­a/Hidrocarburos):
- LogÃ­stica y DistribuciÃ³n
- Soporte TÃ©cnico
- Problema de ProducciÃ³n
- Control de Calidad
- Infraestructura

FOOD_AND_BEVERAGE (Alimentos):
- Control de Calidad
- Seguridad Alimentaria
- ProducciÃ³n
- DistribuciÃ³n
- Equipos
```

**CÃ³digo para crear categorÃ­as faltantes:**
```php
// Verificar y crear categorÃ­as si es necesario
$requiredCategories = [
    ['name' => 'CategorÃ­a X', 'description' => 'DescripciÃ³n completa'],
    // ... mÃ¡s categorÃ­as
];

foreach ($requiredCategories as $catData) {
    Category::firstOrCreate(
        ['company_id' => $company->id, 'name' => $catData['name']],
        [
            'description' => $catData['description'],
            'is_active' => true,
            'created_at' => now()->subMonths(11),
        ]
    );
}
```

---

## ğŸ“Š VOLUMEN DE TICKETS

### Por TamaÃ±o de Empresa

```
PEQUEÃ‘AS (1-50 empleados):
- Pool de usuarios: 3-5 clientes
- Tickets por agente: 8 tickets
- Total aproximado: (agentes Ã— 8)

MEDIANAS (51-200 empleados):
- Pool de usuarios: 7-14 clientes  
- Tickets por agente: 5 tickets
- Total aproximado: (agentes Ã— 5)

GRANDES (201+ empleados):
- Pool de usuarios: 16-25 clientes
- Tickets por agente: 5 tickets
- Total aproximado: (agentes Ã— 5)
```

### DistribuciÃ³n por Agente

**REGLA: Cada agente debe tener tickets asignados de forma equilibrada**

```php
// Ejemplo: Distribuir tickets entre agentes
$agents = [$agent1, $agent2, $agent3];
$ticketsPerAgent = $companySize === 'small' ? 8 : 5;

foreach ($agents as $agent) {
    for ($i = 0; $i < $ticketsPerAgent; $i++) {
        // Crear ticket asignado a este agente
    }
}
```

---

## ğŸ“… DISTRIBUCIÃ“N TEMPORAL (341 DÃ­as)

### LÃ³gica Real de Estados por PerÃ­odo

**La distribuciÃ³n de estados DEBE reflejar la antigÃ¼edad del ticket:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PERÃODO              â”‚ CLOSED â”‚ RESOLVED â”‚ PENDING â”‚ OPEN â”‚ LÃ“GICA      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Enero - Agosto       â”‚  100%  â”‚    0%    â”‚    0%   â”‚  0%  â”‚ 4-11 meses  â”‚
â”‚ (DÃ­a 1-243)          â”‚        â”‚          â”‚         â”‚      â”‚ = Cerrados  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Septiembre           â”‚   90%  â”‚   10%    â”‚    0%   â”‚  0%  â”‚ 2-3 meses   â”‚
â”‚ (DÃ­a 244-273)        â”‚        â”‚          â”‚         â”‚      â”‚             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Octubre              â”‚   70%  â”‚   20%    â”‚   10%   â”‚  0%  â”‚ 1-2 meses   â”‚
â”‚ (DÃ­a 274-304)        â”‚        â”‚          â”‚         â”‚      â”‚             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Noviembre            â”‚   40%  â”‚   30%    â”‚   25%   â”‚  5%  â”‚ 2-4 semanas â”‚
â”‚ (DÃ­a 305-334)        â”‚        â”‚          â”‚         â”‚      â”‚             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Diciembre 1-10       â”‚   20%  â”‚   30%    â”‚   35%   â”‚ 15%  â”‚ < 10 dÃ­as   â”‚
â”‚ (DÃ­a 335-341)        â”‚        â”‚          â”‚         â”‚      â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### DistribuciÃ³n Global Final Esperada

```
CLOSED:    65-70%  â† La mayorÃ­a (tickets antiguos cerrados)
RESOLVED:  15-20%  â† Esperando confirmaciÃ³n de cierre
PENDING:   10-12%  â† En atenciÃ³n activa
OPEN:       3-5%   â† Sin atender (muy recientes)
```

### CÃ³digo de ImplementaciÃ³n Temporal

```php
private function getStatusByDate(Carbon $createdAt): string
{
    $dayOfYear = $createdAt->dayOfYear;
    $rand = rand(1, 100);

    // Enero - Agosto (DÃ­a 1-243): 100% CLOSED
    if ($dayOfYear <= 243) {
        return 'closed';
    }

    // Septiembre (DÃ­a 244-273): 90% CLOSED, 10% RESOLVED
    if ($dayOfYear <= 273) {
        return $rand <= 90 ? 'closed' : 'resolved';
    }

    // Octubre (DÃ­a 274-304): 70% CLOSED, 20% RESOLVED, 10% PENDING
    if ($dayOfYear <= 304) {
        if ($rand <= 70) return 'closed';
        if ($rand <= 90) return 'resolved';
        return 'pending';
    }

    // Noviembre (DÃ­a 305-334): 40% CLOSED, 30% RESOLVED, 25% PENDING, 5% OPEN
    if ($dayOfYear <= 334) {
        if ($rand <= 40) return 'closed';
        if ($rand <= 70) return 'resolved';
        if ($rand <= 95) return 'pending';
        return 'open';
    }

    // Diciembre 1-10 (DÃ­a 335-341): 20% CLOSED, 30% RESOLVED, 35% PENDING, 15% OPEN
    if ($rand <= 20) return 'closed';
    if ($rand <= 50) return 'resolved';
    if ($rand <= 85) return 'pending';
    return 'open';
}
```

---

## ğŸ‘¥ POOL DE USUARIOS (CLIENTES)

### Reglas de CreaciÃ³n

```
â˜ Emails SIEMPRE con dominio @gmail.com
â˜ Nombres bolivianos realistas
â˜ Avatares usando AvatarHelper::getRandom()
â˜ Pool segÃºn tamaÃ±o de empresa
```

### TamaÃ±os de Pool

```php
// PequeÃ±as: 3-5 usuarios
$userPool = [
    ['first_name' => 'Carlos', 'last_name' => 'Mamani', 'email' => 'carlos.mamani.cliente@gmail.com'],
    ['first_name' => 'MarÃ­a', 'last_name' => 'Quispe', 'email' => 'maria.quispe.soporte@gmail.com'],
    ['first_name' => 'Juan', 'last_name' => 'Condori', 'email' => 'juan.condori.helpdesk@gmail.com'],
    // 3-5 usuarios total
];

// Medianas: 7-14 usuarios
// Grandes: 16-25 usuarios
```

### CÃ³digo de CreaciÃ³n de Usuarios

```php
private function createUsers(): void
{
    foreach ($this->userPoolData as $userData) {
        $user = User::where('email', $userData['email'])->first();

        if ($user) {
            $this->command->warn("âš  Usuario ya existe: {$userData['email']}");
            $this->users[$userData['first_name']] = $user;
            continue;
        }

        $user = User::create([
            'user_code' => 'USR-' . strtoupper(Str::random(8)),
            'email' => $userData['email'],
            'password_hash' => Hash::make('mklmklmkl'),
            'email_verified' => true,
            'email_verified_at' => now(),
            'status' => UserStatus::ACTIVE,
            'auth_provider' => 'local',
            'terms_accepted' => true,
            'terms_accepted_at' => now()->subDays(rand(30, 180)),
            'terms_version' => 'v2.1',
            'onboarding_completed_at' => now()->subDays(rand(30, 180)),
        ]);

        // Determinar gÃ©nero por nombre (terminaciÃ³n 'a' = femenino)
        $isFemale = str_ends_with(strtolower($userData['first_name']), 'a');
        
        $user->profile()->create([
            'first_name' => $userData['first_name'],
            'last_name' => $userData['last_name'],
            'avatar_url' => AvatarHelper::getRandom($isFemale ? 'female' : 'male'),
            'phone_number' => '+591' . rand(70000000, 79999999),
            'theme' => 'light',
            'language' => 'es',
            'timezone' => 'America/La_Paz',
        ]);

        UserRole::create([
            'user_id' => $user->id,
            'role_code' => 'USER',
            'company_id' => $this->company->id,
            'is_active' => true,
        ]);

        $this->users[$userData['first_name']] = $user;
    }
}
```

---

## ğŸ“ ATTACHMENTS (Adjuntos)

### Reglas de Attachments

```
â˜ Keyword requerida: LoremFlickr (para generar URLs de placeholder)
â˜ MÃ¡ximo: 5 adjuntos por ticket
â˜ Tipos coherentes con el contexto del ticket
â˜ Nombres de archivo descriptivos y realistas
```

### Tipos de Adjuntos por Industria

```
MANUFACTURING/ENERGY:
- Fotos de daÃ±os/equipos (image/jpeg)
- Reportes de anÃ¡lisis (application/pdf)
- Hojas de especificaciones (application/pdf)

BANKING/TELECOM:
- Capturas de pantalla de errores (image/png)
- Comprobantes de transacciÃ³n (application/pdf)
- Contratos/documentos (application/pdf)

GENERAL:
- Documentos de soporte (application/pdf)
- ImÃ¡genes del problema (image/jpeg, image/png)
```

### CÃ³digo de Attachments con LoremFlickr

```php
// Adjunto de imagen usando LoremFlickr
TicketAttachment::create([
    'ticket_id' => $ticket->id,
    'response_id' => null,
    'uploaded_by_user_id' => $user->id,
    'file_name' => 'foto_equipo_danado.jpg',
    'file_path' => 'tickets/' . $ticket->id . '/foto_equipo.jpg',
    'file_type' => 'image/jpeg',
    'file_size_bytes' => rand(100000, 800000),
    // URL placeholder: https://loremflickr.com/640/480/equipment,damage
    'created_at' => $ticket->created_at,
]);

// Adjunto de documento
TicketAttachment::create([
    'ticket_id' => $ticket->id,
    'response_id' => null,
    'uploaded_by_user_id' => $user->id,
    'file_name' => 'reporte_analisis_2025-11-24.pdf',
    'file_path' => 'tickets/' . $ticket->id . '/reporte_analisis.pdf',
    'file_type' => 'application/pdf',
    'file_size_bytes' => rand(50000, 500000),
    'created_at' => $ticket->created_at,
]);
```

---

## ğŸ”— COHERENCIA DE DATOS (CRÃTICO)

### Regla de Oro: Todo DEBE Ser Coherente

```
â˜ area_id â†” title â†” category_id â†” description â†’ COHERENTES 100%
â˜ El tÃ­tulo refleja el problema real
â˜ La categorÃ­a corresponde al tipo de problema
â˜ El Ã¡rea (si aplica) corresponde al departamento correcto
â˜ El contenido de description es detallado y realista
```

### Ejemplos de Coherencia

```php
// âœ… CORRECTO: Todo coherente
[
    'area_id' => $areas['produccion']->id,        // Ãrea de ProducciÃ³n
    'category_id' => $categories['equipment']->id, // CategorÃ­a: Equipos
    'title' => 'Falla en vÃ¡lvula de presiÃ³n lÃ­nea PLT-3000',
    'description' => 'Durante el turno de hoy detectÃ© fallas en la vÃ¡lvula...',
]

// âŒ INCORRECTO: Incoherente
[
    'area_id' => $areas['finanzas']->id,           // Ãrea: Finanzas
    'category_id' => $categories['equipment']->id, // CategorÃ­a: Equipos âŒ
    'title' => 'Problema de producciÃ³n',           // Vago âŒ
    'description' => 'Hay un problema',            // Sin detalle âŒ
]
```

### Contenido Realista

**TÃ­tulos (60-120 caracteres):**
```
âœ… "MÃ¡quina pasteurizadora PLT-3000 presenta fugas en vÃ¡lvulas de presiÃ³n"
âœ… "URGENTE: Crisis de importaciÃ³n - Stock de combustibles para 2-3 dÃ­as"
âœ… "Lote YG-2025-0234 con sabor anÃ³malo - InvestigaciÃ³n requerida"
âŒ "Problema con mÃ¡quina"
âŒ "Error"
âŒ "Ayuda por favor"
```

**Descripciones (200-1500 caracteres):**
```
âœ… Incluyen:
   - Contexto del problema
   - Datos especÃ­ficos (cÃ³digos, fechas, cantidades)
   - Impacto del problema
   - Pregunta clara o solicitud de acciÃ³n

âŒ Evitar:
   - Descripciones de una lÃ­nea
   - Sin datos concretos
   - Sin contexto de urgencia
```

---

## ğŸ“ CICLO DE VIDA DE TICKETS

### Estados y Transiciones

```
OPEN       â†’ Ticket reciÃ©n creado, sin respuesta de agente
PENDING    â†’ Agente respondiÃ³, esperando acciÃ³n del usuario
RESOLVED   â†’ Problema resuelto, esperando confirmaciÃ³n de cierre
CLOSED     â†’ Ticket finalizado completamente
```

### Campos segÃºn Estado

```php
// OPEN - Sin asignar o reciÃ©n asignado
[
    'status' => 'open',
    'owner_agent_id' => null, // o $agent->id si fue asignado
    'last_response_author_type' => 'none',
    'first_response_at' => null,
    'resolved_at' => null,
    'closed_at' => null,
]

// PENDING - Con respuestas activas
[
    'status' => 'pending',
    'owner_agent_id' => $agent->id,
    'last_response_author_type' => 'agent', // o 'user'
    'first_response_at' => $date->addHours(2),
    'resolved_at' => null,
    'closed_at' => null,
]

// RESOLVED - Problema solucionado
[
    'status' => 'resolved',
    'owner_agent_id' => $agent->id,
    'last_response_author_type' => 'agent',
    'first_response_at' => $date->addHours(2),
    'resolved_at' => $date->addDays(1),
    'closed_at' => null,
]

// CLOSED - Completamente finalizado
[
    'status' => 'closed',
    'owner_agent_id' => $agent->id,
    'last_response_author_type' => 'agent',
    'first_response_at' => $date->addHours(2),
    'resolved_at' => $date->addDays(1),
    'closed_at' => $date->addDays(2),
]
```

---

## ğŸ’¬ RESPUESTAS DE TICKETS

### Patrones de ConversaciÃ³n

```
OPEN:      0 respuestas (o 1 del sistema de confirmaciÃ³n)
PENDING:   1-4 respuestas (conversaciÃ³n activa)
RESOLVED:  2-5 respuestas (problema identificado y resuelto)
CLOSED:    2-6 respuestas (conversaciÃ³n completa con cierre)
```

### Estructura de Respuestas

```php
// Primera respuesta (Agente)
TicketResponse::create([
    'ticket_id' => $ticket->id,
    'author_id' => $agent->id,
    'author_type' => 'agent',
    'content' => "Gracias por reportar este problema.\n\n[AnÃ¡lisis inicial]\n\n[Acciones tomadas/propuestas]\n\n[Siguiente paso]",
    'created_at' => $ticket->created_at->addHours(rand(1, 4)),
]);

// Respuesta del usuario
TicketResponse::create([
    'ticket_id' => $ticket->id,
    'author_id' => $user->id,
    'author_type' => 'user',
    'content' => "[ConfirmaciÃ³n o informaciÃ³n adicional]",
    'created_at' => $previousResponse->created_at->addHours(rand(2, 8)),
]);

// Respuesta de resoluciÃ³n (Agente)
TicketResponse::create([
    'ticket_id' => $ticket->id,
    'author_id' => $agent->id,
    'author_type' => 'agent',
    'content' => "ActualizaciÃ³n:\n\nâœ“ [AcciÃ³n completada 1]\nâœ“ [AcciÃ³n completada 2]\n\n[Status final]",
    'created_at' => $previousResponse->created_at->addDays(rand(1, 3)),
]);
```

---

## ğŸ“‹ ESTRUCTURA DEL SEEDER

### Template Base

```php
<?php

declare(strict_types=1);

namespace App\Features\TicketManagement\Database\Seeders\Companies\[CompanyName];

use App\Features\CompanyManagement\Models\Company;
use App\Features\CompanyManagement\Models\Area;
use App\Features\TicketManagement\Models\Category;
use App\Features\TicketManagement\Models\Ticket;
use App\Features\TicketManagement\Models\TicketResponse;
use App\Features\TicketManagement\Models\TicketAttachment;
use App\Features\UserManagement\Models\User;
use App\Features\UserManagement\Models\UserRole;
use App\Shared\Enums\UserStatus;
use Illuminate\Database\Seeder;
use App\Shared\Helpers\AvatarHelper;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Str;

/**
 * [CompanyName] Tickets Seeder
 *
 * [DescripciÃ³n del contexto de la empresa]
 * [Tipos de tickets que se crearÃ¡n]
 * [Escenarios especÃ­ficos de la industria]
 */
class [CompanyName]TicketsSeeder extends Seeder
{
    private const PASSWORD = 'mklmklmkl';
    private const EXPECTED_TICKET_COUNT = XX; // Ajustar segÃºn volumen

    private Company $company;
    private array $areas = [];
    private array $categories = [];
    private array $agents = [];
    private array $users = [];

    public function run(): void
    {
        $this->command->info('ğŸ« Creando tickets para [CompanyName]...');

        // 1. Cargar empresa
        $this->loadCompany();
        if (!$this->company) return;

        // 2. Verificar idempotencia
        if ($this->alreadySeeded()) return;

        // 3. Cargar/verificar Ã¡reas (si areas_enabled)
        $this->loadAreas();

        // 4. Cargar/crear categorÃ­as
        $this->loadCategories();
        if (empty($this->categories)) return;

        // 5. Cargar agentes
        $this->loadAgents();

        // 6. Crear pool de usuarios
        $this->createUsers();

        // 7. Crear tickets
        $this->createTickets();

        $this->command->info('âœ… Seeder completado!');
    }

    private function loadCompany(): void
    {
        $this->company = Company::where('name', '[Company Name]')->first();
        
        if (!$this->company) {
            $this->command->error('âŒ Empresa no encontrada.');
        }
    }

    private function alreadySeeded(): bool
    {
        $count = Ticket::where('company_id', $this->company->id)->count();
        if ($count >= self::EXPECTED_TICKET_COUNT) {
            $this->command->info('[OK] Seeder ya ejecutado. Saltando.');
            return true;
        }
        return false;
    }

    private function loadAreas(): void
    {
        // Solo si areas_enabled es true
        $areasEnabled = $this->company->settings['areas_enabled'] ?? false;
        
        if (!$areasEnabled) {
            $this->command->info('â„¹ Ãreas no habilitadas para esta empresa.');
            return;
        }

        $areas = Area::where('company_id', $this->company->id)
            ->where('is_active', true)
            ->get();

        // Mapear Ã¡reas por nombre o slug
        $this->areas = [
            'produccion' => $areas->firstWhere('name', 'ProducciÃ³n'),
            'logistica' => $areas->firstWhere('name', 'LogÃ­stica'),
            // ... mÃ¡s Ã¡reas
        ];
    }

    private function loadCategories(): void
    {
        $categories = Category::where('company_id', $this->company->id)
            ->where('is_active', true)
            ->get();

        // Mapear categorÃ­as
        $this->categories = [
            'soporte_tecnico' => $categories->firstWhere('name', 'Soporte TÃ©cnico'),
            'produccion' => $categories->firstWhere('name', 'Problema de ProducciÃ³n'),
            // ... mÃ¡s categorÃ­as
        ];

        // Verificar categorÃ­as mÃ­nimas
        if (count(array_filter($this->categories)) < 3) {
            $this->command->error('âŒ CategorÃ­as insuficientes.');
        }
    }

    private function loadAgents(): void
    {
        $this->agents = [
            'agent1' => User::where('email', 'agent1@company.com')->first(),
            'agent2' => User::where('email', 'agent2@company.com')->first(),
        ];
    }

    private function createUsers(): void
    {
        // Pool de usuarios (ver secciÃ³n de Pool de Usuarios)
    }

    private function createTickets(): void
    {
        // Crear tickets distribuidos por agente
        // Ver secciÃ³n de Volumen de Tickets
    }
}
```

---

## âœ… CHECKLIST DE VALIDACIÃ“N

### Pre-GeneraciÃ³n
```
â˜ Empresa identificada correctamente
â˜ Industria confirmada (investigar contexto real)
â˜ Verificar que NO existan tickets previos (idempotencia)
â˜ areas_enabled verificado
â˜ Ãreas cargadas (si aplica)
â˜ CategorÃ­as verificadas y suficientes
â˜ Agentes identificados
â˜ Pool de usuarios definido segÃºn tamaÃ±o
```

### Durante GeneraciÃ³n
```
â˜ Volumen correcto por agente (8 pequeÃ±as, 5 medianas/grandes)
â˜ DistribuciÃ³n temporal correcta (ver tabla de perÃ­odos)
â˜ Estados coherentes con fechas
â˜ area_id coherente con tÃ­tulo/categorÃ­a
â˜ category_id coherente con problema
â˜ TÃ­tulos descriptivos (60-120 chars)
â˜ Descripciones detalladas (200-1500 chars)
â˜ Respuestas realistas
â˜ Attachments con LoremFlickr (max 5)
â˜ Usuarios con emails @gmail.com
â˜ Avatares usando AvatarHelper
```

### Post-GeneraciÃ³n
```
â˜ Total de tickets correcto
â˜ DistribuciÃ³n de estados correcta (65-70% CLOSED, etc.)
â˜ Sin tickets fuera del rango temporal
â˜ Coherencia narrativa verificada
â˜ Log de confirmaciÃ³n en consola
â˜ Ejecutar seeder en ambiente de prueba primero
```

---

## ğŸ¯ MÃ‰TRICAS DE Ã‰XITO

Al finalizar el seeder, validar:

```
âœ“ 100% de tickets tienen campos coherentes
âœ“ DistribuciÃ³n de estados: ~67% CLOSED, ~17% RESOLVED, ~11% PENDING, ~5% OPEN
âœ“ Todos los agentes tienen tickets asignados
âœ“ 0 tickets fuera del rango temporal (5 ene - 10 dic 2025)
âœ“ Areas_id asignado solo si areas_enabled = true
âœ“ Usuarios con dominio @gmail.com exclusivamente
âœ“ Avatares diversos (AvatarHelper)
âœ“ Attachments contextuales (LoremFlickr)
âœ“ Contenido 100% alineado con industria
âœ“ Seeder es idempotente (no duplica)
```

---

## ğŸ“š REFERENCIAS TÃ‰CNICAS

```
Base de datos:     ticketing.tickets
Modelo:            App\Features\TicketManagement\Models\Ticket
Estados vÃ¡lidos:   open, pending, resolved, closed
Rango temporal:    5 enero 2025 - 10 diciembre 2025
Helper avatares:   App\Shared\Helpers\AvatarHelper::getRandom()
Keyword adjuntos:  LoremFlickr
```

---

## ğŸš¨ ERRORES COMUNES A EVITAR

```
âŒ NO crear tickets sin verificar idempotencia
âŒ NO asignar area_id si areas_enabled = false
âŒ NO usar emails con dominios de empresa para usuarios
âŒ NO crear mÃ¡s de 5 attachments por ticket
âŒ NO dejar tickets OPEN para fechas antiguas (enero-octubre)
âŒ NO crear descripciones genÃ©ricas de una lÃ­nea
âŒ NO omitir el contexto de industria
âŒ NO hardcodear IDs de categorÃ­as/Ã¡reas
âŒ NO olvidar las respuestas para tickets PENDING/RESOLVED/CLOSED
```

---

**ÃšLTIMA ACTUALIZACIÃ“N:** 10 de Diciembre de 2025  
**VERSIÃ“N:** 2.0  
**ESTADO:** ProducciÃ³n âœ“