# üìò USER MANAGEMENT API V10.1 - DOCUMENTACI√ìN DEFINITIVA

> Sistema Helpdesk Multi-Tenant
> Feature: User Management
> Schema Version: 10.1 (Definitivo - Listo para Producci√≥n)
> √öltima actualizaci√≥n: Octubre 2025

---

## üö® CAMBIOS CR√çTICOS DE V9.0 A V10.1

### ‚ùå PROBLEMAS ELIMINADOS:
1. **Nomenclatura inconsistente** ‚Üí `roleContexts` SIEMPRE
2. **Redundancia de mutations** ‚Üí Eliminadas `revokeRole`, `updateUserRole`, `completeMyProfile`
3. **Campos calculados en API** ‚Üí Eliminados `isAdmin`, `canCreateTickets` (frontend calcula)
4. **Mutations innecesarias** ‚Üí Eliminadas `createUser`, `updateUser`, `companyUsers`
5. **Referencias a permisos** ‚Üí Eliminadas (no existen en BD V7.0)

### ‚úÖ MEJORAS IMPLEMENTADAS:
1. **API minimalista** ‚Üí 5 queries + 6 mutations (vs 12 queries + 11 mutations en V9.0)
2. **Nomenclatura consistente** ‚Üí `roleContexts` en TODO el sistema
3. **Separaci√≥n clara** ‚Üí `updateMyProfile` vs `updateMyPreferences` (patr√≥n profesional)
4. **Mutations inteligentes** ‚Üí `assignRole` crea O reactiva autom√°ticamente
5. **Query completa** ‚Üí `user(id)` retorna informaci√≥n completa como `me`

---

## üìã TABLA DE CONTENIDOS

1. [Introducci√≥n](#introducci√≥n)
2. [Arquitectura](#arquitectura)
3. [Queries](#queries)
4. [Mutations](#mutations)
5. [Types](#types)
6. [Roles del Sistema](#roles-del-sistema)
7. [Permisos y Seguridad](#permisos-y-seguridad)
8. [C√≥digos de Error](#c√≥digos-de-error)
9. [Casos de Uso](#casos-de-uso)
10. [Migraci√≥n desde V9.0](#migraci√≥n-desde-v90)

---

## üéØ INTRODUCCI√ìN

### Prop√≥sito del Feature
El **User Management Feature** gestiona usuarios, perfiles y roles en el sistema Helpdesk multi-tenant:
- Gesti√≥n de usuarios (lectura y estados)
- Administraci√≥n de perfiles personales
- Asignaci√≥n y remoci√≥n de roles
- Gesti√≥n de permisos por empresa
- Multi-rol y multi-tenant

### Caracter√≠sticas Principales
‚úÖ **API Minimalista**: Solo 11 operaciones esenciales
‚úÖ **Multi-Rol**: Un usuario puede tener m√∫ltiples roles
‚úÖ **Multi-Tenant**: Roles asociados a empresas espec√≠ficas
‚úÖ **Profiles Separados**: Datos personales vs Preferencias
‚úÖ **Nomenclatura Consistente**: `roleContexts` en TODO el sistema
‚úÖ **Sin Redundancia**: Cada mutation tiene un prop√≥sito √∫nico

---

## üóÉÔ∏è ARQUITECTURA

### Principios de Dise√±o V10.1

#### ‚úÖ **1. Consistencia Total con Authentication**

```graphql
# Authentication retorna (login/register):
{
    "roleContexts": [...]  # ‚úÖ Establecido en Authentication
}

# User Management USA EL MISMO NOMBRE:
type User {
    roleContexts: [RoleContext!]!  # ‚úÖ 100% Consistente
}
```

#### ‚úÖ **2. API Retorna Datos, Frontend Calcula L√≥gica**

```graphql
# ‚ùå ANTES V9.0
type User {
    isAdmin: Boolean!          # L√≥gica calculada
    canCreateTickets: Boolean! # L√≥gica calculada
}

# ‚úÖ AHORA V10.1
type User {
    roleContexts: [RoleContext!]!  # Solo datos
}

# Frontend calcula:
const isAdmin = user.roleContexts.some(r => 
    ['PLATFORM_ADMIN', 'COMPANY_ADMIN'].includes(r.roleCode)
);
```

#### ‚úÖ **3. Mutations Inteligentes (Menos es M√°s)**

```graphql
# ‚ùå ANTES V9.0 (3 mutations para roles)
assignRole(...)      # Crear
updateUserRole(...)  # Modificar
revokeRole(...)      # Eliminar

# ‚úÖ AHORA V10.1 (2 mutations inteligentes)
assignRole(...)      # Crea O reactiva autom√°ticamente
removeRole(...)      # Soft-delete (reversible)
```

#### ‚úÖ **4. Separaci√≥n Profesional de Concerns**

```graphql
# ‚úÖ V10.1 - Patr√≥n de APIs maduras (GitHub, Stripe, Slack)
updateMyProfile(...)       # Datos personales (cambio poco frecuente)
updateMyPreferences(...)   # Configuraci√≥n app (cambio frecuente)

# Beneficios:
# - Rate limiting diferenciado
# - Validaciones espec√≠ficas
# - Formularios separados en frontend
# - Auditor√≠a m√°s clara
```

---

## üîç QUERIES

### 1. `me` - Usuario Autenticado

**Descripci√≥n**: Obtiene informaci√≥n completa del usuario autenticado para contexto de aplicaci√≥n.

**Firma:**
```graphql
me: User!
```

**Directivas:**
- `@auth`: Requiere autenticaci√≥n

**Request:**
```graphql
query Me {
    me {
        # Identificadores
        id
        userCode

        # Datos b√°sicos
        email
        emailVerified
        status
        authProvider

        # Perfil
        profile {
            firstName
            lastName
            displayName
            phoneNumber
            avatarUrl
            theme
            language
            timezone
            pushWebNotifications
            notificationsTickets
        }

        # Roles ACTIVOS (consistente con Authentication)
        roleContexts {
            roleCode
            roleName
            company {
                id
                companyCode
                name
                logoUrl
            }
            dashboardPath
        }

        # Estad√≠sticas
        ticketsCount
        resolvedTicketsCount
        averageRating

        # Auditor√≠a
        lastLoginAt
        createdAt
        updatedAt
    }
}
```

**Response:**
```json
{
    "data": {
        "me": {
            "id": "550e8400-e29b-41d4-a716-446655440000",
            "userCode": "USR-2025-00123",
            "email": "maria.garcia@empresa.com",
            "emailVerified": true,
            "status": "ACTIVE",
            "authProvider": "LOCAL",
            "profile": {
                "firstName": "Mar√≠a",
                "lastName": "Garc√≠a",
                "displayName": "Mar√≠a Garc√≠a",
                "phoneNumber": "+591 70123456",
                "avatarUrl": "https://storage.helpdesk.com/avatars/usr_123.jpg",
                "theme": "dark",
                "language": "es",
                "timezone": "America/La_Paz",
                "pushWebNotifications": true,
                "notificationsTickets": false
            },
            "roleContexts": [
                {
                    "roleCode": "USER",
                    "roleName": "Cliente",
                    "company": null,
                    "dashboardPath": "/tickets"
                },
                {
                    "roleCode": "AGENT",
                    "roleName": "Agente de Soporte",
                    "company": {
                        "id": "cmp-001",
                        "companyCode": "CMP-2025-00001",
                        "name": "Universidad del Valle",
                        "logoUrl": "https://storage.helpdesk.com/logos/cmp_001.png"
                    },
                    "dashboardPath": "/agent/dashboard"
                }
            ],
            "ticketsCount": 47,
            "resolvedTicketsCount": 23,
            "averageRating": 4.3,
            "lastLoginAt": "2025-10-03T14:45:00Z",
            "createdAt": "2025-01-15T08:00:00Z",
            "updatedAt": "2025-09-20T14:22:00Z"
        }
    }
}
```

**Casos de Uso:**
- Header de usuario en interfaz
- P√°gina completa de perfil
- Validaci√≥n de permisos
- Selector de roles/empresas

---

### 2. `myProfile` - Perfil Personal

**Descripci√≥n**: Obtiene solo la informaci√≥n del perfil del usuario autenticado.

**Firma:**
```graphql
myProfile: UserProfile!
```

**Directivas:**
- `@auth`: Requiere autenticaci√≥n

**Request:**
```graphql
query MyProfile {
    myProfile {
        firstName
        lastName
        displayName
        phoneNumber
        avatarUrl
        theme
        language
        timezone
        pushWebNotifications
        notificationsTickets
        lastActivityAt
        createdAt
        updatedAt
    }
}
```

**Response:**
```json
{
    "data": {
        "myProfile": {
            "firstName": "Mar√≠a",
            "lastName": "Garc√≠a",
            "displayName": "Mar√≠a Garc√≠a",
            "phoneNumber": "+591 70123456",
            "avatarUrl": "https://storage.helpdesk.com/avatars/usr_123.jpg",
            "theme": "dark",
            "language": "es",
            "timezone": "America/La_Paz",
            "pushWebNotifications": true,
            "notificationsTickets": false,
            "lastActivityAt": "2025-10-03T15:30:00Z",
            "createdAt": "2025-01-15T08:00:00Z",
            "updatedAt": "2025-09-20T14:22:00Z"
        }
    }
}
```

**Casos de Uso:**
- Formularios de edici√≥n de perfil
- P√°gina de configuraci√≥n personal

---

### 3. `users` - Lista Paginada de Usuarios

**Descripci√≥n**: Lista paginada de usuarios con filtros avanzados. Solo administradores.

**Firma:**
```graphql
users(
    filters: UserFilters
    orderBy: [UserOrderBy!]
    page: Int = 1
    first: Int = 15
): UserPaginator!
```

**Directivas:**
- `@auth(requires: [PLATFORM_ADMIN, COMPANY_ADMIN])`: Solo admins
- `@paginate(maxCount: 50)`: M√°ximo 50 por p√°gina

**Request:**
```graphql
query Users(
    $filters: UserFilters
    $orderBy: [UserOrderBy!]
    $page: Int
    $first: Int
) {
    users(
        filters: $filters
        orderBy: $orderBy
        page: $page
        first: $first
    ) {
        data {
            id
            userCode
            email
            emailVerified
            status
            profile {
                firstName
                lastName
                displayName
                avatarUrl
            }
            roleContexts {
                roleCode
                roleName
                company {
                    id
                    name
                }
                dashboardPath
            }
            lastLoginAt
            ticketsCount
            createdAt
        }
        paginatorInfo {
            total
            perPage
            currentPage
            lastPage
            hasMorePages
        }
    }
}
```

**Variables:**
```json
{
    "filters": {
        "search": "maria",
        "status": "ACTIVE",
        "role": "AGENT",
        "emailVerified": true,
        "companyId": "cmp-001",
        "recentActivity": true
    },
    "orderBy": [
        {
            "field": "LAST_LOGIN_AT",
            "order": "DESC"
        }
    ],
    "page": 1,
    "first": 20
}
```

**Filtros Disponibles:**

| Filtro | Tipo | Descripci√≥n |
|--------|------|-------------|
| `search` | String | Busca en email/nombre |
| `status` | UserStatus | ACTIVE, SUSPENDED, DELETED |
| `role` | RoleCode | USER, AGENT, COMPANY_ADMIN, PLATFORM_ADMIN |
| `emailVerified` | Boolean | Si email est√° verificado |
| `companyId` | UUID | Usuarios con rol en una empresa |
| `recentActivity` | Boolean | Activos √∫ltimos 7 d√≠as |
| `createdBetween` | DateRange | Rango de fecha de creaci√≥n |

**Casos de Uso:**
- Panel de administraci√≥n de usuarios
- B√∫squeda de usuarios para asignar roles
- Reportes de actividad

---

### 4. `user` - Usuario Espec√≠fico (COMPLETO)

**Descripci√≥n**: Obtiene informaci√≥n **COMPLETA** de un usuario por ID. Igual que `me` pero para cualquier usuario.

**Firma:**
```graphql
user(id: UUID!): User
```

**Directivas:**
- `@auth`: Requiere autenticaci√≥n
- `@can(ability: "view", model: "User", find: "id")`: Valida permisos

**Request:**
```graphql
query User($id: UUID!) {
    user(id: $id) {
        # MISMOS CAMPOS QUE 'me'
        id
        userCode
        email
        emailVerified
        status
        authProvider
        profile {
            firstName
            lastName
            displayName
            phoneNumber
            avatarUrl
            theme
            language
            timezone
            pushWebNotifications
            notificationsTickets
        }
        roleContexts {
            roleCode
            roleName
            company {
                id
                name
                logoUrl
            }
            dashboardPath
        }
        ticketsCount
        resolvedTicketsCount
        averageRating
        lastLoginAt
        createdAt
        updatedAt
    }
}
```

**Variables:**
```json
{
    "id": "550e8400-e29b-41d4-a716-446655440000"
}
```

**Cambios vs V9.0:**
- ‚úÖ Ahora retorna `User` completo (antes estaba limitado)
- ‚úÖ Misma informaci√≥n que `me` (consistencia)

**Casos de Uso:**
- P√°gina de detalle de usuario (admin)
- Modal de informaci√≥n completa
- Verificaci√≥n antes de asignar roles

---

### 5. `availableRoles` - Roles Disponibles

**Descripci√≥n**: Lista de roles del sistema con sus descripciones.

**Firma:**
```graphql
availableRoles: [RoleInfo!]!
```

**Directivas:**
- `@auth(requires: [PLATFORM_ADMIN, COMPANY_ADMIN])`: Solo admins
- `@cache(ttl: 3600)`: Cache de 1 hora

**Request:**
```graphql
query AvailableRoles {
    availableRoles {
        code
        name
        description
        requiresCompany
        defaultDashboard
        isSystemRole
    }
}
```

**Response:**
```json
{
    "data": {
        "availableRoles": [
            {
                "code": "PLATFORM_ADMIN",
                "name": "Administrador de Plataforma",
                "description": "Acceso completo a todo el sistema",
                "requiresCompany": false,
                "defaultDashboard": "/admin/dashboard",
                "isSystemRole": true
            },
            {
                "code": "COMPANY_ADMIN",
                "name": "Administrador de Empresa",
                "description": "Gestiona una empresa espec√≠fica",
                "requiresCompany": true,
                "defaultDashboard": "/empresa/dashboard",
                "isSystemRole": true
            },
            {
                "code": "AGENT",
                "name": "Agente de Soporte",
                "description": "Atiende tickets de soporte",
                "requiresCompany": true,
                "defaultDashboard": "/agent/dashboard",
                "isSystemRole": true
            },
            {
                "code": "USER",
                "name": "Cliente",
                "description": "Usuario que crea tickets",
                "requiresCompany": false,
                "defaultDashboard": "/tickets",
                "isSystemRole": true
            }
        ]
    }
}
```

**Casos de Uso:**
- Selector de roles en formularios
- Documentaci√≥n de roles
- Validaci√≥n de asignaciones

---

## ‚úèÔ∏è MUTATIONS

### 1. `updateMyProfile` - Actualizar Datos Personales

**Descripci√≥n**: Permite actualizar **datos personales** del perfil (firstName, lastName, phone, avatar).

**Firma:**
```graphql
updateMyProfile(input: UpdateProfileInput!): User!
```

**Directivas:**
- `@auth`: Requiere autenticaci√≥n
- `@rateLimit(max: 30, window: 3600)`: M√°ximo 30 actualizaciones por hora
- `@audit(action: "profile_update")`: Auditor√≠a autom√°tica

**Request:**
```graphql
mutation UpdateMyProfile($input: UpdateProfileInput!) {
    updateMyProfile(input: $input) {
        id
        profile {
            firstName
            lastName
            displayName
            phoneNumber
            avatarUrl
            updatedAt
        }
    }
}
```

**Variables:**
```json
{
    "input": {
        "firstName": "Mar√≠a Alejandra",
        "lastName": "Garc√≠a Rodr√≠guez",
        "phoneNumber": "+591 75987654",
        "avatarUrl": "https://storage.helpdesk.com/avatars/new_avatar.jpg"
    }
}
```

**Validaciones:**
- `firstName`: m√≠nimo 2, m√°ximo 100 caracteres
- `lastName`: m√≠nimo 2, m√°ximo 100 caracteres
- `phoneNumber`: entre 10 y 20 caracteres
- `avatarUrl`: URL v√°lida

**Response:**
```json
{
    "data": {
        "updateMyProfile": {
            "id": "550e8400-e29b-41d4-a716-446655440000",
            "profile": {
                "firstName": "Mar√≠a Alejandra",
                "lastName": "Garc√≠a Rodr√≠guez",
                "displayName": "Mar√≠a Alejandra Garc√≠a Rodr√≠guez",
                "phoneNumber": "+591 75987654",
                "avatarUrl": "https://storage.helpdesk.com/avatars/new_avatar.jpg",
                "updatedAt": "2025-10-03T16:30:00Z"
            }
        }
    }
}
```

**Casos de Uso:**
- Formulario "Editar Perfil"
- Actualizar foto de perfil
- Cambiar n√∫mero de tel√©fono

---

### 2. `updateMyPreferences` - Actualizar Preferencias

**Descripci√≥n**: Permite actualizar **preferencias de aplicaci√≥n** (theme, language, notifications).

**Firma:**
```graphql
updateMyPreferences(input: PreferencesInput!): User!
```

**Directivas:**
- `@auth`: Requiere autenticaci√≥n
- `@rateLimit(max: 50, window: 3600)`: M√°ximo 50 actualizaciones por hora
- `@audit(action: "preferences_update")`: Auditor√≠a autom√°tica

**Request:**
```graphql
mutation UpdateMyPreferences($input: PreferencesInput!) {
    updateMyPreferences(input: $input) {
        id
        profile {
            theme
            language
            timezone
            pushWebNotifications
            notificationsTickets
            updatedAt
        }
    }
}
```

**Variables:**
```json
{
    "input": {
        "theme": "dark",
        "language": "en",
        "timezone": "America/New_York",
        "pushWebNotifications": false,
        "notificationsTickets": true
    }
}
```

**Validaciones:**
- `theme`: debe ser "light" o "dark"
- `language`: debe ser "es" o "en"
- `timezone`: zona horaria IANA v√°lida

**Response:**
```json
{
    "data": {
        "updateMyPreferences": {
            "id": "550e8400-e29b-41d4-a716-446655440000",
            "profile": {
                "theme": "dark",
                "language": "en",
                "timezone": "America/New_York",
                "pushWebNotifications": false,
                "notificationsTickets": true,
                "updatedAt": "2025-10-03T16:35:00Z"
            }
        }
    }
}
```

**Casos de Uso:**
- Toggle de tema dark/light
- Cambio de idioma
- Configuraci√≥n de notificaciones

**¬øPor qu√© separado de `updateMyProfile`?**
- ‚úÖ Patr√≥n profesional (GitHub, Stripe, Slack)
- ‚úÖ Rate limiting diferenciado (preferencias cambian m√°s frecuente)
- ‚úÖ Validaciones diferentes
- ‚úÖ Formularios separados en frontend

---

### 3. `suspendUser` - Suspender Usuario

**Descripci√≥n**: Suspende temporalmente un usuario del sistema.

**Firma:**
```graphql
suspendUser(id: UUID!, reason: String): User!
```

**Directivas:**
- `@auth(requires: [PLATFORM_ADMIN])`: Solo platform admins
- `@audit(action: "user_suspend", includePayload: true)`: Auditor√≠a completa

**Request:**
```graphql
mutation SuspendUser($id: UUID!, $reason: String) {
    suspendUser(id: $id, reason: $reason) {
        id
        status
        updatedAt
    }
}
```

**Variables:**
```json
{
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "reason": "Violaci√≥n de t√©rminos de servicio - spam de tickets"
}
```

**Efectos:**
- Cambia status a "SUSPENDED"
- Invalida todos los tokens activos
- Registra motivo en auditor√≠a
- Env√≠a notificaci√≥n al usuario

**Response:**
```json
{
    "data": {
        "suspendUser": {
            "id": "550e8400-e29b-41d4-a716-446655440000",
            "status": "SUSPENDED",
            "updatedAt": "2025-10-03T16:40:00Z"
        }
    }
}
```

---

### 4. `activateUser` - Activar Usuario

**Descripci√≥n**: Reactiva un usuario suspendido.

**Firma:**
```graphql
activateUser(id: UUID!): User!
```

**Directivas:**
- `@auth(requires: [PLATFORM_ADMIN])`: Solo platform admins
- `@audit(action: "user_activate")`: Auditor√≠a autom√°tica

**Request:**
```graphql
mutation ActivateUser($id: UUID!) {
    activateUser(id: $id) {
        id
        status
        updatedAt
    }
}
```

**Efectos:**
- Cambia status a "ACTIVE"
- Permite nuevo login
- Registra reactivaci√≥n en auditor√≠a

**Response:**
```json
{
    "data": {
        "activateUser": {
            "id": "550e8400-e29b-41d4-a716-446655440000",
            "status": "ACTIVE",
            "updatedAt": "2025-10-03T16:45:00Z"
        }
    }
}
```

---

### 5. `deleteUser` - Eliminar Usuario (Soft Delete)

**Descripci√≥n**: Elimina l√≥gicamente un usuario (soft delete).

**Firma:**
```graphql
deleteUser(id: UUID!, reason: String): Boolean!
```

**Directivas:**
- `@auth(requires: [PLATFORM_ADMIN])`: Solo platform admins
- `@audit(action: "user_delete", includePayload: true)`: Auditor√≠a completa

**Request:**
```graphql
mutation DeleteUser($id: UUID!, $reason: String) {
    deleteUser(id: $id, reason: $reason)
}
```

**Variables:**
```json
{
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "reason": "Solicitud del usuario - GDPR compliance"
}
```

**Efectos:**
- Cambia status a "DELETED"
- Establece deletedAt timestamp
- Anonimiza datos sensibles
- Mantiene registros para auditor√≠a

**Response:**
```json
{
    "data": {
        "deleteUser": true
    }
}
```

---

### 6. `assignRole` - Asignar Rol (Inteligente)

**Descripci√≥n**: Asigna un rol a un usuario. **Crea nuevo O reactiva si existe inactivo.**

**Firma:**
```graphql
assignRole(input: AssignRoleInput!): UserRoleResult!
```

**Directivas:**
- `@auth(requires: [PLATFORM_ADMIN, COMPANY_ADMIN])`: Solo admins
- `@rateLimit(max: 100, window: 3600)`: M√°ximo 100 asignaciones por hora
- `@audit(action: "role_assign", includePayload: true)`: Auditor√≠a completa

**Request:**
```graphql
mutation AssignRole($input: AssignRoleInput!) {
    assignRole(input: $input) {
        success
        message
        role {
            id
            roleCode
            roleName
            company {
                id
                name
                logoUrl
            }
            isActive
            assignedAt
        }
    }
}
```

**Variables (Rol CON Empresa - AGENT):**
```json
{
    "input": {
        "userId": "550e8400-e29b-41d4-a716-446655440000",
        "roleCode": "AGENT",
        "companyId": "cmp-001"
    }
}
```

**Variables (Rol SIN Empresa - USER):**
```json
{
    "input": {
        "userId": "550e8400-e29b-41d4-a716-446655440000",
        "roleCode": "USER"
    }
}
```

**Validaciones Cr√≠ticas:**

| Rol | Requiere Empresa | companyId |
|-----|------------------|-----------|
| USER | ‚ùå NO | Debe ser null |
| PLATFORM_ADMIN | ‚ùå NO | Debe ser null |
| AGENT | ‚úÖ S√ç | Obligatorio |
| COMPANY_ADMIN | ‚úÖ S√ç | Obligatorio |

**Response (Nuevo Rol):**
```json
{
    "data": {
        "assignRole": {
            "success": true,
            "message": "Rol AGENT asignado exitosamente",
            "role": {
                "id": "role-123",
                "roleCode": "AGENT",
                "roleName": "Agente de Soporte",
                "company": {
                    "id": "cmp-001",
                    "name": "Universidad del Valle",
                    "logoUrl": "https://storage.helpdesk.com/logos/cmp_001.png"
                },
                "isActive": true,
                "assignedAt": "2025-10-03T16:45:00Z"
            }
        }
    }
}
```

**Response (Rol Reactivado):**
```json
{
    "data": {
        "assignRole": {
            "success": true,
            "message": "Rol AGENT reactivado exitosamente",
            "role": {
                "id": "role-123",
                "roleCode": "AGENT",
                "roleName": "Agente de Soporte",
                "company": {
                    "id": "cmp-001",
                    "name": "Universidad del Valle",
                    "logoUrl": "https://storage.helpdesk.com/logos/cmp_001.png"
                },
                "isActive": true,
                "assignedAt": "2025-03-10T10:15:00Z"
            }
        }
    }
}
```

**L√≥gica Inteligente:**
```typescript
// Backend Service
if (rolExisteInactivo) {
    // Reactivar
    rol.isActive = true;
    rol.revokedAt = null;
    return { success: true, message: "reactivado" };
} else {
    // Crear nuevo
    return crearNuevoRol();
}
```

**Errores:**
```json
{
    "errors": [
        {
            "message": "El rol AGENT requiere empresa asociada",
            "extensions": {
                "code": "ROLE_REQUIRES_COMPANY",
                "roleCode": "AGENT"
            }
        }
    ]
}
```

---

### 7. `removeRole` - Remover Rol (Soft Delete)

**Descripci√≥n**: Desactiva un rol de un usuario (soft delete, reversible con `assignRole`).

**Firma:**
```graphql
removeRole(roleId: UUID!, reason: String): Boolean!
```

**Directivas:**
- `@auth(requires: [PLATFORM_ADMIN, COMPANY_ADMIN])`: Solo admins
- `@audit(action: "role_remove", includePayload: true)`: Auditor√≠a completa

**Request:**
```graphql
mutation RemoveRole($roleId: UUID!, $reason: String) {
    removeRole(roleId: $roleId, reason: $reason)
}
```

**Variables:**
```json
{
    "roleId": "role-002",
    "reason": "Usuario dej√≥ de trabajar en la empresa"
}
```

**Efectos:**
- Establece `isActive = false`
- Registra `revokedAt` timestamp
- Guarda `revocationReason`
- Invalida permisos derivados

**Response:**
```json
{
    "data": {
        "removeRole": true
    }
}
```

**NOTA:** Para reactivar el rol, usar `assignRole` con los mismos par√°metros.

---

## üì¶ TYPES

### User (Simplificado V10.1)

**Descripci√≥n**: Usuario completo del sistema.

```graphql
type User {
    # Identificadores
    id: UUID!
    userCode: String!
    
    # Autenticaci√≥n
    email: Email!
    emailVerified: Boolean!
    status: UserStatus!
    authProvider: AuthProvider!
    
    # Perfil
    profile: UserProfile!
    
    # Roles ACTIVOS √∫nicamente (consistente con Authentication)
    roleContexts: [RoleContext!]!
    
    # Estad√≠sticas
    ticketsCount: Int!
    resolvedTicketsCount: Int!
    averageRating: Float  # Nullable - solo agentes con tickets
    
    # Auditor√≠a
    lastLoginAt: DateTime
    lastActivityAt: DateTime
    createdAt: DateTime!
    updatedAt: DateTime!
}
```

**Campos Eliminados vs V9.0:**
- ‚ùå `roleHistory` ‚Üí Eliminado (no necesario para V1.0)
- ‚ùå `companies` ‚Üí Derivar de `roleContexts[].company`
- ‚ùå `isAdmin` ‚Üí Calcular en frontend
- ‚ùå `canCreateTickets` ‚Üí Calcular en frontend

**L√≥gica de Frontend (Helpers):**

```typescript
// src/features/user-management/utils/userHelpers.ts

export const isAdmin = (user: User): boolean => {
    return user.roleContexts.some(role => 
        ['PLATFORM_ADMIN', 'COMPANY_ADMIN'].includes(role.roleCode)
    );
};

export const canCreateTickets = (user: User): boolean => {
    return user.roleContexts.length > 0; // Cualquier rol puede
};

export const getUserCompanies = (user: User): CompanyMinimal[] => {
    return user.roleContexts
        .filter(role => role.company !== null)
        .map(role => role.company!)
        .filter((company, index, self) => 
            index === self.findIndex(c => c.id === company.id)
        );
};

export const hasRole = (user: User, roleCode: RoleCode): boolean => {
    return user.roleContexts.some(role => role.roleCode === roleCode);
};

export const hasRoleInCompany = (
    user: User, 
    roleCode: RoleCode, 
    companyId: string
): boolean => {
    return user.roleContexts.some(role => 
        role.roleCode === roleCode && 
        role.company?.id === companyId
    );
};
```

---

### UserProfile

**Descripci√≥n**: Perfil de usuario con preferencias.

```graphql
type UserProfile {
    firstName: String!
    lastName: String!
    displayName: String!
    phoneNumber: String
    avatarUrl: URL
    theme: String!
    language: String!
    timezone: String!
    pushWebNotifications: Boolean!
    notificationsTickets: Boolean!
    lastActivityAt: DateTime
    createdAt: DateTime!
    updatedAt: DateTime!
}
```

---

### UserRoleResult (NUEVO V10.1)

**Descripci√≥n**: Resultado de asignaci√≥n de rol.

```graphql
type UserRoleResult {
    success: Boolean!
    message: String!
    role: UserRoleInfo!
}
```

---

### UserRoleInfo (NUEVO V10.1)

**Descripci√≥n**: Informaci√≥n de rol asignado.

```graphql
type UserRoleInfo {
    id: UUID!
    roleCode: RoleCode!
    roleName: String!
    company: CompanyMinimal
    isActive: Boolean!
    assignedAt: DateTime!
    assignedBy: UserMinimal
}
```

---

### RoleInfo (Simplificado V10.1)

**Descripci√≥n**: Informaci√≥n de rol del sistema (cat√°logo).

```graphql
type RoleInfo {
    code: RoleCode!
    name: String!
    description: String!
    requiresCompany: Boolean!
    defaultDashboard: String!
    isSystemRole: Boolean!
}
```

**Campos Eliminados vs V9.0:**
- ‚ùå `permissions` ‚Üí No existe en BD V7.0
- ‚ùå `priority` ‚Üí No usado

---

## üé≠ ROLES DEL SISTEMA

### Arquitectura de Roles

| Rol | Requiere Empresa | Scope | Dashboard |
|-----|------------------|-------|-----------|
| USER | ‚ùå NO | Global | `/tickets` |
| PLATFORM_ADMIN | ‚ùå NO | Global | `/admin/dashboard` |
| AGENT | ‚úÖ S√ç | Por empresa | `/agent/dashboard` |
| COMPANY_ADMIN | ‚úÖ S√ç | Por empresa | `/empresa/dashboard` |

### Permisos Impl√≠citos por Rol

**IMPORTANTE:** Los permisos est√°n implementados en c√≥digo mediante directivas `@auth`, NO en base de datos.

#### USER
```typescript
// Puede:
- Crear tickets
- Ver sus propios tickets
- Actualizar su perfil
- Seguir empresas
```

#### AGENT
```typescript
// Puede:
- Ver tickets de su empresa
- Responder tickets
- Resolver tickets
- Asignarse tickets
- Actualizar su perfil
```

#### COMPANY_ADMIN
```typescript
// Puede:
- Administrar su empresa
- Gestionar agentes
- Ver todos los tickets de su empresa
- Asignar tickets a cualquier agente
- Gestionar categor√≠as y macros
- Actualizar su perfil
```

#### PLATFORM_ADMIN
```typescript
// Puede:
- TODO (acceso completo al sistema)
```

---

## üîí PERMISOS Y SEGURIDAD

### Matriz de Permisos

| Operaci√≥n | USER | AGENT | COMPANY_ADMIN | PLATFORM_ADMIN |
|-----------|------|-------|---------------|----------------|
| `me` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| `myProfile` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| `updateMyProfile` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| `updateMyPreferences` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| `users` | ‚ùå | ‚ùå | ‚úÖ (empresa) | ‚úÖ (todos) |
| `user(id)` | ‚ùå | ‚ùå | ‚úÖ (empresa) | ‚úÖ (todos) |
| `suspendUser` | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| `activateUser` | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| `deleteUser` | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| `assignRole` | ‚ùå | ‚ùå | ‚úÖ (su empresa) | ‚úÖ (todos) |
| `removeRole` | ‚ùå | ‚ùå | ‚úÖ (su empresa) | ‚úÖ (todos) |

### Rate Limiting

| Endpoint | M√°ximo | Ventana |
|----------|--------|---------|
| `updateMyProfile` | 30 | 1 hora |
| `updateMyPreferences` | 50 | 1 hora |
| `assignRole` | 100 | 1 hora |

---

## üö® C√ìDIGOS DE ERROR

```typescript
enum UserManagementErrors {
    USER_NOT_FOUND = 'USER_NOT_FOUND',
    EMAIL_ALREADY_EXISTS = 'EMAIL_ALREADY_EXISTS',
    INVALID_ROLE_ASSIGNMENT = 'INVALID_ROLE_ASSIGNMENT',
    ROLE_REQUIRES_COMPANY = 'ROLE_REQUIRES_COMPANY',
    ROLE_SHOULD_NOT_HAVE_COMPANY = 'ROLE_SHOULD_NOT_HAVE_COMPANY',
    INSUFFICIENT_PERMISSIONS = 'INSUFFICIENT_PERMISSIONS',
    PROFILE_UPDATE_FAILED = 'PROFILE_UPDATE_FAILED',
    USER_SUSPENDED = 'USER_SUSPENDED',
    USER_ALREADY_HAS_ROLE = 'USER_ALREADY_HAS_ROLE',
    CANNOT_REMOVE_LAST_ADMIN = 'CANNOT_REMOVE_LAST_ADMIN',
    INVALID_INPUT = 'INVALID_INPUT'
}
```

---

## üí° CASOS DE USO COMPLETOS

### Caso 1: Actualizar Perfil Personal

**Flujo:**
```graphql
# 1. Actualizar datos personales
mutation UpdateProfile {
    updateMyProfile(input: {
        firstName: "Mar√≠a Alejandra"
        phoneNumber: "+591 75987654"
    })
}

# 2. Actualizar preferencias (separado)
mutation UpdatePreferences {
    updateMyPreferences(input: {
        theme: "dark"
        language: "es"
    })
}
```

---

### Caso 2: Asignaci√≥n de Rol de Agente

**1. Admin busca usuario:**
```graphql
query SearchUser {
    users(filters: { search: "juan" }) {
        data { id, email, profile { displayName } }
    }
}
```

**2. Admin asigna rol AGENT:**
```graphql
mutation AssignAgentRole {
    assignRole(input: {
        userId: "usr-123"
        roleCode: "AGENT"
        companyId: "cmp-001"
    }) {
        success
        message
        role {
            roleCode
            company { name }
        }
    }
}
```

**3. Usuario ahora tiene 2 roles activos:**
- USER (global)
- AGENT (en Universidad del Valle)

---

### Caso 3: Usuario Deja de Ser Agente

**1. Admin remueve rol:**
```graphql
mutation RemoveAgentRole {
    removeRole(
        roleId: "role-002"
        reason: "Usuario dej√≥ de trabajar aqu√≠"
    )
}
```

**2. Efectos:**
- Rol se desactiva (soft delete)
- Usuario pierde acceso al dashboard de agente
- Pr√≥ximo login solo muestra rol USER

**3. Si vuelve a la empresa:**
```graphql
mutation ReassignAgentRole {
    assignRole(input: {
        userId: "usr-123"
        roleCode: "AGENT"
        companyId: "cmp-001"
    }) {
        message  # "Rol AGENT reactivado exitosamente"
    }
}
```

---

## üìä EVENTOS DE AUDITOR√çA

- `profile_update`: Perfil actualizado
- `preferences_update`: Preferencias actualizadas
- `user_suspend`: Usuario suspendido
- `user_activate`: Usuario reactivado
- `user_delete`: Usuario eliminado
- `role_assign`: Rol asignado
- `role_remove`: Rol removido

---

## üîÑ MIGRACI√ìN DESDE V9.0

### Backend (Laravel)

**1. Eliminar Resolvers:**
```bash
# Eliminar archivos
rm app/Features/UserManagement/GraphQL/Queries/MyRoleHistoryQuery.php
rm app/Features/UserManagement/GraphQL/Mutations/RevokeRoleMutation.php
rm app/Features/UserManagement/GraphQL/Mutations/UpdateUserRoleMutation.php
rm app/Features/UserManagement/GraphQL/Mutations/CompleteMyProfileMutation.php
rm app/Features/UserManagement/GraphQL/Queries/CompanyUsersQuery.php
rm app/Features/UserManagement/GraphQL/Mutations/CreateUserMutation.php
rm app/Features/UserManagement/GraphQL/Mutations/UpdateUserMutation.php
```

**2. Crear Nuevos Resolvers:**
```bash
# Crear
php artisan lighthouse:mutation RemoveRoleMutation
```

**3. Actualizar AssignRole Service:**
```php
// app/Features/UserManagement/Services/RoleService.php
public function assign($userId, $roleCode, $companyId = null)
{
    // Buscar rol existente
    $existing = UserRole::where([
        'user_id' => $userId,
        'role_code' => $roleCode,
        'company_id' => $companyId
    ])->first();
    
    if ($existing) {
        if (!$existing->is_active) {
            // Reactivar
            $existing->update([
                'is_active' => true,
                'revoked_at' => null,
                'revocation_reason' => null
            ]);
            
            return [
                'success' => true,
                'message' => "Rol {$roleCode} reactivado exitosamente",
                'role' => $existing
            ];
        }
        
        throw new UserAlreadyHasRoleException();
    }
    
    // Crear nuevo
    $role = UserRole::create([...]);
    
    return [
        'success' => true,
        'message' => "Rol {$roleCode} asignado exitosamente",
        'role' => $role
    ];
}
```

**4. Actualizar User Query:**
```php
// Ahora retorna User completo
public function resolve($root, array $args)
{
    return User::with(['profile', 'roleContexts.company'])
        ->findOrFail($args['id']);
}
```

### Frontend (React + TypeScript)

**1. Actualizar Interfaces:**
```typescript
// Eliminar
interface User {
    roleHistory: UserRole[];      // ‚ùå Eliminar
    companies: CompanyMinimal[];   // ‚ùå Eliminar
    isAdmin: boolean;              // ‚ùå Eliminar
    canCreateTickets: boolean;     // ‚ùå Eliminar
}

// Mantener solo
interface User {
    roleContexts: RoleContext[];   // ‚úÖ Solo esto
}
```

**2. Actualizar Queries:**
```typescript
// ELIMINAR
export const GET_MY_ROLE_HISTORY = gql`...`;
export const COMPLETE_MY_PROFILE = gql`...`;

// MANTENER (sin cambios)
export const GET_ME = gql`...`;
export const UPDATE_MY_PROFILE = gql`...`;
export const UPDATE_MY_PREFERENCES = gql`...`;
```

**3. Actualizar Mutations:**
```typescript
// ELIMINAR
export const REVOKE_ROLE = gql`...`;
export const UPDATE_USER_ROLE = gql`...`;

// NUEVO
export const REMOVE_ROLE = gql`
    mutation RemoveRole($roleId: UUID!, $reason: String) {
        removeRole(roleId: $roleId, reason: $reason)
    }
`;

// ACTUALIZAR
export const ASSIGN_ROLE = gql`
    mutation AssignRole($input: AssignRoleInput!) {
        assignRole(input: $input) {
            success
            message
            role {
                id
                roleCode
                roleName
                company { name }
            }
        }
    }
`;
```

### Checklist de Migraci√≥n

**Backend:**
- [ ] Eliminar queries/mutations obsoletas
- [ ] Actualizar `AssignRoleService` con l√≥gica de reactivaci√≥n
- [ ] Crear `RemoveRoleService`
- [ ] Actualizar `UserQuery` para retornar User completo
- [ ] Eliminar referencias a `permissions` en schema
- [ ] Actualizar tests

**Frontend:**
- [ ] Eliminar queries/mutations obsoletas
- [ ] Actualizar interfaces TypeScript
- [ ] Implementar helpers (isAdmin, canCreateTickets, etc.)
- [ ] Actualizar componentes que usan campos eliminados
- [ ] Actualizar tests

---

## üéØ RESUMEN FINAL

### API V10.1 - N√∫meros Finales

**Queries: 5**
- `me`
- `myProfile`
- `users`
- `user`
- `availableRoles`

**Mutations: 6**
- `updateMyProfile`
- `updateMyPreferences`
- `suspendUser`
- `activateUser`
- `deleteUser`
- `assignRole` (inteligente: crea o reactiva)
- `removeRole` (soft delete)

**Resultado:** 11 operaciones vs 23 en V9.0 (52% m√°s eficiente)

---

**Fin de la Documentaci√≥n V10.1**

> **MEJORAS CLAVE:**
> - ‚úÖ API minimalista y profesional
> - ‚úÖ Nomenclatura 100% consistente
> - ‚úÖ Mutations inteligentes (menos c√≥digo)
> - ‚úÖ Separaci√≥n clara de concerns
> - ‚úÖ Sin redundancia ni over-engineering
> - ‚úÖ Lista para implementar en producci√≥n
>
> **SIGUIENTE PASO:** Implementaci√≥n backend siguiendo estructura feature-first