================================================================================
-- SISTEMA HELPDESK - ESPECIFICACIÃ“N FUNCIONAL COMPLETA V8.0
-- ================================================================================
-- FECHA: 27 de Septiembre de 2025
-- VERSIÃ“N: 8.0 DEFINITIVA
-- DESCRIPCIÃ“N: Documento maestro definitivo y completamente autocontenido que
-- describe todas las funcionalidades, pantallas, campos, reglas de negocio y
-- flujos de usuario del sistema Helpdesk. Sincronizado con Base de Datos V7.0.
--
-- ESTE DOCUMENTO ES LA REFERENCIA ÃšNICA Y COMPLETA DEL SISTEMA
-- ================================================================================

## HISTORIAL DE EVOLUCIÃ“N Y FILOSOFÃA DE DISEÃ‘O

Este documento representa la consolidaciÃ³n definitiva del proyecto Helpdesk System, fusionando todos los aprendizajes y decisiones de diseÃ±o de las versiones anteriores. Las decisiones arquitecturales fundamentales son:

### Modelo HÃ­brido de Propiedad de Tickets
Los tickets nacen sin propietario para maximizar velocidad de respuesta. Se asignan automÃ¡ticamente al primer agente que responde mediante triggers de base de datos, garantizando responsabilidad clara y mÃ©tricas precisas.

### CalificaciÃ³n Centrada en la ResoluciÃ³n
El sistema de calificaciones se enfoca en la calidad de resoluciÃ³n del ticket completo, no en agentes individuales. Cada calificaciÃ³n se atribuye al agente propietario del ticket al momento de marcarlo como "Resuelto".

### ColaboraciÃ³n Inteligente
Sistema robusto de notas internas permite colaboraciÃ³n eficiente entre agentes, creando una base de conocimiento orgÃ¡nica para cada ticket.

### Arquitectura Multi-Tenant Flexible
Cada empresa tiene control total sobre su entorno: categorÃ­as personalizadas, macros de respuesta, centro de ayuda, branding y configuraciones operativas.

### Base de Datos Enterprise-Grade
Fundamento sÃ³lido con esquemas separados (auth, business, ticketing, audit), tipos ENUM para integridad, Ã­ndices optimizados, vistas calculadas y triggers automÃ¡ticos.

================================================================================
## 1. ARQUITECTURA CENTRAL DEL SISTEMA
================================================================================

### 1.1. ESTRUCTURA DE BASE DE DATOS V7.0

#### ESQUEMA AUTH - GestiÃ³n de Usuarios y AutenticaciÃ³n
```sql
-- Tabla Principal: auth.users
id (UUID) - Identificador Ãºnico
user_code (VARCHAR) - CÃ³digo Ãºnico: USR-2025-00001
email (CITEXT) - Email Ãºnico del usuario
email_verified (BOOLEAN) - Estado de verificaciÃ³n
password_hash (VARCHAR) - Hash de contraseÃ±a
auth_provider (VARCHAR) - local, google, microsoft
status (ENUM) - active, suspended, deleted
last_login_at (TIMESTAMPTZ) - Ãšltimo acceso
terms_accepted (BOOLEAN) - AceptaciÃ³n de tÃ©rminos
created_at, updated_at, deleted_at

-- Tabla de Perfiles: auth.user_profiles
user_id (UUID) - FK a auth.users
first_name (VARCHAR) - Nombre
last_name (VARCHAR) - Apellido
phone_number (VARCHAR) - TelÃ©fono opcional
avatar_url (VARCHAR) - URL de foto de perfil
theme (VARCHAR) - light, dark
language (VARCHAR) - es, en
timezone (VARCHAR) - Zona horaria
push_web_notifications (BOOLEAN) - Notificaciones web
notifications_tickets (BOOLEAN) - Notificaciones de tickets

-- Tabla de Roles: auth.roles
role_code (VARCHAR) - platform_admin, company_admin, agent, user
role_name (VARCHAR) - Nombre descriptivo
description (TEXT) - DescripciÃ³n del rol

-- Tabla de AsignaciÃ³n: auth.user_roles
user_id (UUID) - FK a auth.users
role_code (VARCHAR) - FK a auth.roles
company_id (UUID) - Contexto de empresa (NULL para platform_admin/user)
is_active (BOOLEAN) - Estado del rol
assigned_at (TIMESTAMPTZ) - Fecha de asignaciÃ³n

-- Tabla de Sesiones: auth.refresh_tokens
user_id (UUID) - FK a auth.users
token_hash (VARCHAR) - Hash del token
device_name (VARCHAR) - "Chrome on Windows"
ip_address (INET) - IP del dispositivo
expires_at (TIMESTAMPTZ) - ExpiraciÃ³n
is_revoked (BOOLEAN) - Estado del token
```

#### ESQUEMA BUSINESS - GestiÃ³n de Empresas
```sql
-- Solicitudes de Empresa: business.company_requests
request_code (VARCHAR) - REQ-2025-00001
company_name (VARCHAR) - Nombre solicitado
admin_email (CITEXT) - Email del administrador
business_description (TEXT) - DescripciÃ³n del negocio
website (VARCHAR) - Sitio web
industry_type (VARCHAR) - Tipo de industria
estimated_users (INT) - Usuarios estimados
contact_address, contact_city, contact_country, contact_postal_code
tax_id (VARCHAR) - RUT/NIT
status (ENUM) - pending, approved, rejected
reviewed_by (UUID) - Admin que revisÃ³
rejection_reason (TEXT) - Motivo de rechazo

-- Empresas Activas: business.companies
company_code (VARCHAR) - CMP-2025-00001
name (VARCHAR) - Nombre comercial
legal_name (VARCHAR) - RazÃ³n social
support_email (CITEXT) - Email pÃºblico de soporte
phone, website, contact_address, contact_city, contact_state
contact_country, contact_postal_code, tax_id
legal_representative (VARCHAR) - Representante legal
business_hours (JSONB) - Horarios por dÃ­a
timezone (VARCHAR) - Zona horaria
logo_url, favicon_url - URLs de branding
primary_color, secondary_color - Colores corporativos
status (VARCHAR) - active, suspended
admin_user_id (UUID) - Administrador principal

-- Seguidores de Empresas: business.user_company_followers
user_id (UUID) - Usuario que sigue
company_id (UUID) - Empresa seguida
followed_at (TIMESTAMPTZ) - Fecha de seguimiento

-- Macros de Respuesta: business.company_macros
company_id (UUID) - Empresa propietaria
name (VARCHAR) - Nombre de la macro
content (TEXT) - Contenido de respuesta predefinida
is_active (BOOLEAN) - Estado de la macro

-- Anuncios PÃºblicos: business.company_announcements
company_id (UUID) - Empresa que publica
author_id (UUID) - Quien escribiÃ³ el anuncio
title (VARCHAR) - TÃ­tulo del anuncio
content (TEXT) - Contenido completo
status (ENUM) - draft, published, archived
published_at (TIMESTAMPTZ) - Fecha de publicaciÃ³n

-- ArtÃ­culos de Ayuda: business.help_center_articles
company_id (UUID) - Empresa propietaria
author_id (UUID) - Autor del artÃ­culo
title (VARCHAR) - TÃ­tulo del artÃ­culo
content (TEXT) - Contenido completo
status (ENUM) - draft, published, archived
views_count (INT) - Contador de visualizaciones
```

#### ESQUEMA TICKETING - CorazÃ³n del Sistema
```sql
-- CategorÃ­as de Tickets: ticketing.categories
company_id (UUID) - Empresa propietaria
name (VARCHAR) - Nombre de categorÃ­a
description (TEXT) - DescripciÃ³n opcional
is_active (BOOLEAN) - Estado de la categorÃ­a

-- Tickets Principales: ticketing.tickets
ticket_code (VARCHAR) - TKT-2025-00001
created_by_user_id (UUID) - Usuario creador
company_id (UUID) - Empresa destinataria
category_id (UUID) - CategorÃ­a del ticket
title (VARCHAR) - TÃ­tulo del problema
initial_description (TEXT) - DescripciÃ³n inicial
status (ENUM) - open, pending, resolved, closed
owner_agent_id (UUID) - Agente propietario (NULL inicial)
first_response_at (TIMESTAMPTZ) - Primera respuesta
resolved_at (TIMESTAMPTZ) - Fecha de resoluciÃ³n
closed_at (TIMESTAMPTZ) - Fecha de cierre

-- Respuestas PÃºblicas: ticketing.ticket_responses
ticket_id (UUID) - Ticket al que pertenece
author_id (UUID) - Quien responde
response_content (TEXT) - Contenido de la respuesta
author_type (ENUM) - user, agent

-- Notas Internas: ticketing.ticket_internal_notes
ticket_id (UUID) - Ticket relacionado
agent_id (UUID) - Agente que escribe la nota
note_content (TEXT) - Contenido de la nota interna

-- Archivos Adjuntos: ticketing.ticket_attachments
ticket_id (UUID) - Ticket relacionado
response_id (UUID) - Respuesta especÃ­fica (opcional)
uploaded_by_user_id (UUID) - Quien subiÃ³ el archivo
file_name (VARCHAR) - Nombre del archivo
file_url (VARCHAR) - URL de almacenamiento
file_type (VARCHAR) - Tipo MIME
file_size_bytes (BIGINT) - TamaÃ±o en bytes

-- Calificaciones: ticketing.ticket_ratings
ticket_id (UUID) - Ticket calificado (Ãºnico)
customer_id (UUID) - Cliente que califica
rated_agent_id (UUID) - Agente evaluado (histÃ³rico)
rating (INT) - CalificaciÃ³n 1-5
comment (TEXT) - Comentario opcional
```

### 1.2. CICLO DE VIDA COMPLETO DEL TICKET

#### Estado 1: OPEN (Abierto)
- **CreaciÃ³n**: Usuario final crea ticket vÃ­a interfaz /create-ticket
- **Campos requeridos**: title, company_id, category_id, initial_description
- **Estado en BD**: status = 'open', owner_agent_id = NULL
- **Visibilidad**: Todos los agentes de la empresa ven el ticket en "Cola de Nuevos"
- **DuraciÃ³n**: Hasta que primer agente responde

#### Estado 2: PENDING (Pendiente)
- **ActivaciÃ³n**: Trigger automÃ¡tico cuando agente publica primera respuesta
- **Proceso del Trigger**:
  ```sql
  UPDATE ticketing.tickets SET
    owner_agent_id = [agente_que_respondio],
    first_response_at = NOW(),
    status = 'pending'
  WHERE id = [ticket_id] AND owner_agent_id IS NULL;
  ```
- **CaracterÃ­sticas**: Ticket tiene propietario definido, conversaciÃ³n activa
- **ColaboraciÃ³n**: Otros agentes pueden aÃ±adir notas internas
- **DuraciÃ³n**: Durante todo el intercambio de mensajes

#### Estado 3: RESOLVED (Resuelto)
- **ActivaciÃ³n**: Agente propietario marca manualmente como resuelto
- **Campo actualizado**: resolved_at = NOW()
- **Funcionalidad habilitada**: Cliente puede calificar el servicio
- **Opciones del cliente**: Confirmar resoluciÃ³n o reabrir ticket
- **DuraciÃ³n**: Hasta cierre manual o automÃ¡tico (7 dÃ­as)

#### Estado 4: CLOSED (Cerrado)
- **ActivaciÃ³n automÃ¡tica**: Proceso programado cierra tickets resolved > 7 dÃ­as
- **ActivaciÃ³n manual**: Agente o administrador cierra explÃ­citamente
- **Campo actualizado**: closed_at = NOW()
- **Estado final**: Inmutable, no permite mÃ¡s modificaciones
- **Archivo**: Ticket pasa a histÃ³rico para reportes

### 1.3. SISTEMA DE AUTENTICACIÃ“N Y ROLES

#### Tipos de AutenticaciÃ³n
1. **Local**: Email/contraseÃ±a con hash bcrypt
2. **OAuth**: Google, Microsoft (external_auth_id)
3. **InvitaciÃ³n**: Via email para roles de agente

#### Matriz de Roles y Permisos
```
PLATFORM_ADMIN:
- GestiÃ³n completa de empresas y usuarios
- AprobaciÃ³n de solicitudes de empresa
- MÃ©tricas globales del sistema
- Acceso a auditorÃ­a completa

COMPANY_ADMIN:
- GestiÃ³n de agentes de su empresa
- ConfiguraciÃ³n completa de su empresa
- VisualizaciÃ³n de todos los tickets de su empresa
- CreaciÃ³n de contenido (anuncios, artÃ­culos)
- GestiÃ³n de categorÃ­as y macros

AGENT:
- GestiÃ³n de tickets de su empresa
- Toma de propiedad de tickets
- Respuestas pÃºblicas y notas internas
- Uso de macros predefinidas
- MÃ©tricas personales

USER:
- CreaciÃ³n de tickets
- VisualizaciÃ³n de sus propios tickets
- Respuestas en sus tickets
- CalificaciÃ³n de servicio
- Acceso a centro de ayuda
```

================================================================================
## 2. ADMINISTRADOR DE PLATAFORMA (PLATFORM_ADMIN)
================================================================================

### ACCESO Y CREDENCIALES
- **URL de acceso**: /admin/
- **Email de prueba**: admin@helpdesk.com, super@helpdesk.com
- **ContraseÃ±a**: [cualquier contraseÃ±a en desarrollo]
- **Rol en BD**: auth.user_roles con role_code = 'platform_admin'

### PANTALLA 1: DASHBOARD PRINCIPAL (/admin/dashboard)

#### SECCIÃ“N SUPERIOR - KPIs GLOBALES
**Tarjetas de MÃ©tricas (4 columnas)**:

1. **Total de Empresas**
   - NÃºmero: COUNT(business.companies)
   - Subtexto: "+X nuevas este mes"
   - Color: Azul corporativo
   - Clic: Redirige a /admin/companies

2. **Usuarios Activos**
   - NÃºmero: COUNT(auth.users WHERE status = 'active')
   - Subtexto: "XX% de crecimiento mensual"
   - Color: Verde
   - Clic: Redirige a /admin/users

3. **Solicitudes Pendientes**
   - NÃºmero: COUNT(business.company_requests WHERE status = 'pending')
   - Subtexto: "Requieren revisiÃ³n"
   - Color: Naranja (si > 0), Verde (si = 0)
   - Clic: Redirige a /admin/requests

4. **Tickets Totales**
   - NÃºmero: COUNT(ticketing.tickets)
   - Subtexto: "Across all companies"
   - Color: Morado
   - Clic: Redirige a vista global de tickets

#### SECCIÃ“N CENTRAL - GRÃFICOS Y TENDENCIAS
**Fila 1 - GrÃ¡ficos Principales (2 columnas)**:

1. **GrÃ¡fico de Empresas por Estado** (Dona)
   - Activas: business.companies WHERE status = 'active'
   - Suspendidas: business.companies WHERE status = 'suspended'
   - Colores: Verde para activas, Rojo para suspendidas
   - Leyenda con nÃºmeros absolutos

2. **Tendencia de Registros** (LÃ­neas)
   - Usuarios por mes: GROUP BY MONTH(created_at)
   - Empresas por mes: GROUP BY MONTH(created_at)
   - Rango: Ãšltimos 12 meses
   - Dos lÃ­neas con colores diferenciados

**Fila 2 - Actividad Reciente**:

3. **Tabla de Actividad del Sistema** (Ancho completo)
   - Columnas: Fecha, Evento, Usuario, Empresa, Detalles
   - Eventos: Nuevos registros, aprobaciones, suspensiones
   - Ãšltimas 20 actividades
   - PaginaciÃ³n: 20 registros por pÃ¡gina

#### SECCIÃ“N INFERIOR - ACCIONES RÃPIDAS
**Solicitudes Pendientes de RevisiÃ³n**:
- Lista de Ãºltimas 5 solicitudes pendientes
- Por cada solicitud:
  - company_name (business.company_requests.company_name)
  - admin_email (business.company_requests.admin_email)
  - industry_type (business.company_requests.industry_type)
  - created_at (formato: "hace X dÃ­as")
  - Botones: [Ver Detalles] [Aprobar] [Rechazar]

### PANTALLA 2: GESTIÃ“N DE EMPRESAS (/admin/companies)

#### HEADER DE PÃGINA
- TÃ­tulo: "GestiÃ³n de Empresas"
- Breadcrumb: Admin > Empresas
- BotÃ³n principal: [+ Nueva Empresa] (modal de creaciÃ³n manual)

#### FILTROS Y BÃšSQUEDA
**Barra de Filtros (Fila superior)**:
- Selector de Estado: [Todas] [Activas] [Suspendidas]
- Campo de bÃºsqueda: "Buscar por nombre o cÃ³digo..."
- Selector de Industria: [Todas] + lista de industry_type Ãºnicos
- Rango de fechas: "Registradas entre [fecha] y [fecha]"

#### TABLA PRINCIPAL DE EMPRESAS
**Columnas de la tabla**:
1. **CÃ³digo**: company_code (CMP-2025-00001)
2. **Nombre**: name + logo pequeÃ±o si existe
3. **Administrador**:
   - auth.users.email WHERE id = admin_user_id
   - + auth.user_profiles.first_name + last_name
4. **Industria**: industry_type
5. **Usuarios**: COUNT(auth.user_roles WHERE company_id = X)
6. **Tickets**: COUNT(ticketing.tickets WHERE company_id = X)
7. **Estado**:
   - Badge verde "Activa" o rojo "Suspendida"
   - status field de business.companies
8. **Registro**: created_at (formato: DD/MM/YYYY)
9. **Acciones**: [Ver] [Editar] [Suspender/Activar] [Eliminar]

**Funciones de Tabla**:
- Ordenamiento por cualquier columna
- PaginaciÃ³n: 25 empresas por pÃ¡gina
- SelecciÃ³n mÃºltiple para acciones en lote
- ExportaciÃ³n a CSV/Excel

#### MODAL DE DETALLES DE EMPRESA
**Trigger**: Clic en botÃ³n [Ver] de cualquier empresa

**PestaÃ±a 1: InformaciÃ³n General**
- Datos de business.companies:
  - name, legal_name, support_email, phone, website
  - contact_address, contact_city, contact_state, contact_country
  - tax_id, legal_representative
  - business_hours (formato legible)
  - timezone
- Branding:
  - logo_url (imagen preview)
  - primary_color, secondary_color (swatches)

**PestaÃ±a 2: EstadÃ­sticas**
- Usuarios por rol:
  - Administradores: COUNT WHERE role_code = 'company_admin'
  - Agentes: COUNT WHERE role_code = 'agent'
  - Clientes: COUNT WHERE role_code = 'user'
- Tickets:
  - Total: COUNT(ticketing.tickets)
  - Por estado: COUNT por cada status
  - CalificaciÃ³n promedio: AVG(ticketing.ticket_ratings.rating)
- Actividad:
  - Primer ticket: MIN(created_at)
  - Ãšltimo ticket: MAX(created_at)
  - Tickets por mes: GrÃ¡fico de barras Ãºltimos 6 meses

**PestaÃ±a 3: ConfiguraciÃ³n**
- CategorÃ­as: Lista de ticketing.categories
- Macros: Lista de business.company_macros
- ArtÃ­culos: COUNT(business.help_center_articles)
- Anuncios: COUNT(business.company_announcements)

#### ACCIONES DE GESTIÃ“N
**BotÃ³n [Suspender/Activar]**:
- Cambia business.companies.status entre 'active' y 'suspended'
- Modal de confirmaciÃ³n con campo de motivo
- NotificaciÃ³n automÃ¡tica al admin_user_id

**BotÃ³n [Eliminar]** (Solo si 0 tickets):
- VerificaciÃ³n: COUNT(ticketing.tickets WHERE company_id = X) = 0
- Modal de confirmaciÃ³n con texto de verificaciÃ³n
- EliminaciÃ³n en cascada de registros relacionados

### PANTALLA 3: GESTIÃ“N DE SOLICITUDES (/admin/requests)

#### HEADER Y FILTROS
- TÃ­tulo: "Solicitudes de Empresa"
- Filtros: [Todas] [Pendientes] [Aprobadas] [Rechazadas]
- Ordenamiento: [MÃ¡s recientes] [MÃ¡s antiguas] [Por industria]

#### LISTA DE SOLICITUDES
**Card Layout** (en lugar de tabla para mejor legibilidad):
- Una card por solicitud de business.company_requests
- Altura fija, scroll interno si hay mucho contenido

**Estructura de cada Card**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ REQ-2025-00001          Pendiente         hace 3 dÃ­as      â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ Nombre Empresa: [company_name]                             â”‚
â”‚ Email Admin: [admin_email]                                 â”‚
â”‚ Industria: [industry_type]                                 â”‚
â”‚ Usuarios Est: [estimated_users]                            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ [Ver Detalles] [Aprobar] [Rechazar]                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### MODAL DE DETALLES DE SOLICITUD
**Trigger**: Clic en [Ver Detalles]

**InformaciÃ³n Completa** (2 columnas):
- Columna Izquierda:
  - company_name, legal_name
  - admin_email (verificar si ya existe en auth.users)
  - business_description (Ã¡rea de texto expandida)
  - website (enlace clickeable si vÃ¡lido)
  - industry_type
  - estimated_users

- Columna Derecha:
  - contact_address completa
  - contact_city, contact_country
  - contact_postal_code
  - tax_id
  - created_at (fecha y hora completa)
  - Campos de revisiÃ³n si status != 'pending':
    - reviewed_by (nombre del admin)
    - reviewed_at
    - rejection_reason (si aplica)

#### PROCESO DE APROBACIÃ“N
**BotÃ³n [Aprobar]**:
1. Modal de confirmaciÃ³n:
   - "Â¿Aprobar solicitud REQ-2025-00001?"
   - "Se crearÃ¡ la empresa y se enviarÃ¡n credenciales a [admin_email]"
   - Checkbox: "Enviar email de bienvenida"
   - [Cancelar] [Confirmar AprobaciÃ³n]

2. **Proceso automÃ¡tico backend**:
   - Actualizar: status = 'approved', reviewed_by = [admin_actual], reviewed_at = NOW()
   - Crear en business.companies con datos de la solicitud
   - Verificar si admin_email existe en auth.users:
     - Si existe: AÃ±adir role 'company_admin' en auth.user_roles
     - Si no existe: Crear user completo + profile + role
   - Generar credenciales temporales si es usuario nuevo
   - Enviar email con credenciales y enlace de primer acceso

**BotÃ³n [Rechazar]**:
1. Modal con formulario:
   - "Rechazar solicitud REQ-2025-00001"
   - "Motivo del rechazo:" (campo de texto obligatorio)
   - [Cancelar] [Confirmar Rechazo]

2. **Proceso automÃ¡tico backend**:
   - Actualizar: status = 'rejected', reviewed_by = [admin_actual], reviewed_at = NOW(), rejection_reason = [texto]
   - Enviar email al admin_email con el motivo del rechazo
   - Incluir informaciÃ³n sobre cÃ³mo corregir problemas comunes

### PANTALLA 4: GESTIÃ“N DE USUARIOS (/admin/users)

#### FILTROS AVANZADOS
**Barra de Filtros Expandible**:
- BÃºsqueda: "Email, nombre o cÃ³digo de usuario..."
- Estado: [Todos] [Activos] [Suspendidos] [Eliminados]
- Rol: [Todos] [Platform Admin] [Company Admin] [Agent] [User]
- Empresa: Selector con todas las empresas
- VerificaciÃ³n: [Todos] [Email Verificado] [Email Pendiente]
- Registro: "Entre [fecha] y [fecha]"

#### TABLA DE USUARIOS
**Columnas detalladas**:
1. **Usuario**:
   - user_code (USR-2025-00001)
   - email
   - avatar_url (imagen pequeÃ±a)
2. **Nombre**: first_name + last_name
3. **Roles**:
   - Lista de roles activos
   - Si es company_admin/agent: nombre de empresa
4. **Estado**:
   - status (active/suspended/deleted)
   - email_verified (âœ“ o âœ—)
5. **Ãšltimo Acceso**: last_login_at
6. **Empresa Principal**:
   - Para company_admin/agent
   - business.companies.name
7. **Registro**: created_at
8. **Acciones**: [Ver Perfil] [Suspender] [Eliminar]

#### MODAL DE PERFIL DE USUARIO
**PestaÃ±a 1: InformaciÃ³n Personal**
- Datos de auth.users + auth.user_profiles:
  - email, first_name, last_name, phone_number
  - theme, language, timezone
  - push_web_notifications, notifications_tickets
  - terms_accepted, terms_accepted_at
  - avatar_url (imagen completa)

**PestaÃ±a 2: Roles y Permisos**
- Tabla de auth.user_roles para este usuario:
  - role_code, company_id (nombre si aplica)
  - is_active, assigned_at, assigned_by
- Historial de cambios de roles
- BotÃ³n [+ Asignar Rol] para platform_admin

**PestaÃ±a 3: Actividad**
- Tickets creados: COUNT(ticketing.tickets WHERE created_by_user_id = X)
- Tickets respondidos: COUNT(ticketing.ticket_responses WHERE author_id = X)
- Ãšltima actividad: MAX de created_at en tickets/responses
- Sesiones activas: auth.refresh_tokens WHERE user_id = X AND is_revoked = false
- Historial de login (Ãºltimos 30 dÃ­as)

================================================================================
## 3. ADMINISTRADOR DE EMPRESA (COMPANY_ADMIN)
================================================================================

### ACCESO Y CREDENCIALES
- **URL de acceso**: /empresa/
- **Email de prueba**: empresa@helpdesk.com, company@helpdesk.com
- **ContraseÃ±a**: [cualquier contraseÃ±a en desarrollo]
- **Rol en BD**: auth.user_roles con role_code = 'company_admin' Y company_id especÃ­fico

### PANTALLA 1: DASHBOARD EJECUTIVO (/empresa/dashboard)

#### HEADER PERSONALIZADO
- Logo de la empresa: business.companies.logo_url
- Nombre de empresa: business.companies.name
- Colores corporativos: primary_color, secondary_color
- MenÃº breadcrumb: Empresa > Dashboard

#### SECCIÃ“N KPIs EMPRESARIALES (4 tarjetas)
1. **Total de Tickets**
   - NÃºmero: COUNT(ticketing.tickets WHERE company_id = [empresa])
   - Subtexto: "+X esta semana"
   - GrÃ¡fico sparkline de tickets por dÃ­a (Ãºltimos 7 dÃ­as)
   - Color: primary_color de la empresa

2. **Tasa de ResoluciÃ³n**
   - CÃ¡lculo: (COUNT(status='resolved')/COUNT(total)) * 100
   - Subtexto: "XX% esta semana"
   - Indicador visual: Barra de progreso
   - Color: Verde si >80%, Amarillo si 60-80%, Rojo si <60%

3. **Tiempo Promedio de Respuesta**
   - CÃ¡lculo: AVG(first_response_at - created_at) en horas
   - Subtexto: "Mejora de XX% vs mes anterior"
   - Meta visual: ComparaciÃ³n con objetivo (ej: 4 horas)
   - Color: Verde si mejor, Rojo si peor

4. **SatisfacciÃ³n del Cliente**
   - CÃ¡lculo: AVG(ticketing.ticket_ratings.rating)
   - Subtexto: "Basado en XX calificaciones"
   - Estrellas visuales: â˜…â˜…â˜…â˜…â˜† (4.2/5)
   - Color: Amarillo estrella

#### SECCIÃ“N GRÃFICOS (2 columnas)
**Columna Izquierda - Tendencias de Tickets**:
- GrÃ¡fico de lÃ­neas: Tickets por dÃ­a (Ãºltimos 30 dÃ­as)
- Series mÃºltiples por estado: open, pending, resolved, closed
- Colores diferenciados para cada estado
- Hover con datos exactos
- BotÃ³n [Ver Detalles] -> /empresa/tickets

**Columna Derecha - DistribuciÃ³n por CategorÃ­a**:
- GrÃ¡fico de dona: Tickets por ticketing.categories
- Solo categorÃ­as con tickets > 0
- Porcentajes en las etiquetas
- Hover con nÃºmeros absolutos
- BotÃ³n [Gestionar CategorÃ­as] -> /empresa/settings

#### SECCIÃ“N EQUIPO Y ACTIVIDAD
**Tarjeta de Agentes**:
- TÃ­tulo: "Equipo de Soporte"
- Total de agentes: COUNT(auth.user_roles WHERE role_code='agent' AND company_id=[empresa])
- Agentes online: COUNT con last_login_at en Ãºltimas 4 horas
- Lista de top 3 agentes por tickets resueltos esta semana
- Por cada agente:
  - Nombre: first_name + last_name
  - Avatar: avatar_url
  - Tickets esta semana: COUNT(owner_agent_id = X)
  - CalificaciÃ³n promedio: AVG(rating)
- BotÃ³n [Gestionar Equipo] -> /empresa/agents

#### SECCIÃ“N ACCIONES RÃPIDAS
**Botones de AcciÃ³n Principal**:
- [Ver Todos los Tickets] -> /empresa/tickets
- [Crear Anuncio] -> /empresa/content (tab anuncios)
- [Invitar Agente] -> /empresa/agents (modal)
- [Configurar Empresa] -> /empresa/settings

**Alertas y Notificaciones**:
- Tickets sin respuesta > 24 horas
- Agentes inactivos > 7 dÃ­as
- Calificaciones bajas esta semana
- Solicitudes de agente pendientes

### PANTALLA 2: GESTIÃ“N DE TICKETS (/empresa/tickets)

#### ESTRUCTURA DE PANTALLA (3 paneles)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SIDEBAR    â”‚    LISTA TICKETS   â”‚   DETALLE       â”‚
â”‚  (Filtros)  â”‚   (Resultados)     â”‚   (Ticket)      â”‚
â”‚             â”‚                    â”‚                 â”‚
â”‚  200px      â”‚     400px          â”‚   Resto         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### PANEL IZQUIERDO - NAVEGACIÃ“N Y FILTROS
**SecciÃ³n Estados**:
- Todos los tickets (COUNT total)
- ðŸ†• Nuevos (status = 'open') - Badge con nÃºmero
- â³ Pendientes (status = 'pending') - Badge con nÃºmero
- âœ… Resueltos (status = 'resolved') - Badge con nÃºmero
- ðŸ”’ Cerrados (status = 'closed') - Badge con nÃºmero

**SecciÃ³n Filtros Avanzados**:
- **Por Agente**:
  - Sin asignar (owner_agent_id IS NULL)
  - Lista de agentes con nombres y conteos
- **Por CategorÃ­a**:
  - Lista de ticketing.categories activas
  - Conteo de tickets por categorÃ­a
- **Por Fecha**:
  - Hoy, Esta semana, Este mes
  - Rango personalizado
- **Por Cliente**:
  - Campo de bÃºsqueda de email/nombre
  - Lista de clientes frecuentes

#### PANEL CENTRAL - LISTA DE TICKETS
**Header de Lista**:
- Ordenamiento: [MÃ¡s recientes] [MÃ¡s antiguos] [Sin responder] [Prioridad]
- Vista: [Lista] [Cards]
- SelecciÃ³n mÃºltiple para acciones en lote

**Item de Ticket** (formato card compacto):
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TKT-2025-00001     ðŸ†• NUEVO        hace 2 horas        â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ Problema con acceso al sistema de notas                â”‚
â”‚ Por: juan.perez@universidad.edu.bo                     â”‚
â”‚ CategorÃ­a: Acceso y Login                              â”‚
â”‚ Sin agente asignado                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Estados visuales**:
- ðŸ†• NUEVO: Borde izquierdo azul, badge azul
- â³ PENDIENTE: Borde izquierdo amarillo, badge amarillo
- âœ… RESUELTO: Borde izquierdo verde, badge verde
- ðŸ”’ CERRADO: Borde izquierdo gris, badge gris

#### PANEL DERECHO - DETALLE DEL TICKET
**Header del Ticket**:
- ticket_code (TKT-2025-00001)
- title (tamaÃ±o grande)
- Status badge
- MenÃº de acciones: [Asignar] [Cambiar Estado] [Archivar]

**InformaciÃ³n del Ticket**:
- Creado por: first_name + last_name + email
- Empresa: business.companies.name (automÃ¡tico)
- CategorÃ­a: ticketing.categories.name
- Creado: created_at (formato completo)
- Propietario: owner_agent_id (nombre o "Sin asignar")
- Primera respuesta: first_response_at
- Resuelto: resolved_at (si aplica)

**PestaÃ±as de Contenido**:

**PestaÃ±a 1: ConversaciÃ³n PÃºblica**
- initial_description (mensaje original del usuario)
- Lista chronolÃ³gica de ticketing.ticket_responses
- Por cada respuesta:
  - Avatar del autor
  - Nombre: first_name + last_name
  - Rol badge: USER o AGENT
  - response_content
  - created_at (relativo: "hace 3 horas")
  - Archivos adjuntos si existen

**PestaÃ±a 2: Notas Internas** (Solo agentes/admin)
- Lista de ticketing.ticket_internal_notes
- Por cada nota:
  - Avatar del agente
  - Nombre del agente
  - note_content
  - created_at
- Formulario para nueva nota interna
- Dropdown de agentes para mencionar (@agent)

**PestaÃ±a 3: Historial**
- Timeline completo de cambios:
  - CreaciÃ³n del ticket
  - Cada respuesta (pÃºblica)
  - Cada nota interna
  - Cambios de estado
  - Asignaciones de agente
  - Calificaciones (si existen)
- Cada evento con timestamp y responsable

**PestaÃ±a 4: Archivos**
- Lista de ticketing.ticket_attachments
- Agrupados por response_id
- Preview para imÃ¡genes
- Download directo para otros archivos
- InformaciÃ³n: file_name, file_size_bytes, uploaded_by_user_id

#### ACCIONES EN TICKETS
**Como Company Admin puede**:
- Ver todos los tickets de su empresa
- Responder en nombre de la empresa
- AÃ±adir notas internas
- Cambiar estado de tickets
- Asignar/reasignar agentes
- Ver estadÃ­sticas detalladas
- Exportar datos de tickets

### PANTALLA 3: GESTIÃ“N DE AGENTES (/empresa/agents)

#### HEADER Y ACCIONES PRINCIPALES
- TÃ­tulo: "Equipo de Soporte"
- EstadÃ­stica: "X agentes activos"
- BotÃ³n principal: [+ Invitar Agente]
- Filtros: [Todos] [Activos] [Pendientes] [Inactivos]

#### LISTA DE AGENTES ACTUALES
**Card de Agente**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ðŸ‘¤ [avatar]  MarÃ­a GarcÃ­a RodrÃ­guez                     â”‚
â”‚              maria.garcia@empresa.com                   â”‚
â”‚              Agente desde: 15/09/2025                   â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ Tickets esta semana: 12    CalificaciÃ³n: â˜…â˜…â˜…â˜…â˜† 4.3    â”‚
â”‚ Ãšltimo acceso: hace 2 horas                             â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ [Ver Perfil] [Desactivar] [Eliminar]                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**InformaciÃ³n de cada agente**:
- Datos personales: auth.user_profiles
- Estado del rol: is_active en auth.user_roles
- MÃ©tricas de rendimiento:
  - Tickets asignados: COUNT(owner_agent_id = X)
  - Tickets resueltos: COUNT(owner_agent_id = X AND status = 'resolved')
  - CalificaciÃ³n promedio: AVG(rating WHERE rated_agent_id = X)
  - Tiempo promedio de respuesta
- Ãšltima actividad: last_login_at

#### PROCESO DE INVITACIÃ“N DE AGENTES
**Modal de InvitaciÃ³n** (trigger: botÃ³n [+ Invitar Agente]):

**Paso 1 - InformaciÃ³n del Invitado**:
- Email: (requerido, validaciÃ³n de formato)
- Mensaje personalizado: (opcional, textarea)
- Rol: "Agente de Soporte" (fijo)
- Empresa: [nombre empresa] (automÃ¡tico)

**Paso 2 - VerificaciÃ³n**:
- Sistema verifica si email existe en auth.users
- **Si existe**: Mostrar perfil existente y confirmar invitaciÃ³n
- **Si no existe**: Indicar que se enviarÃ¡ invitaciÃ³n de registro

**Paso 3 - EnvÃ­o**:
- Crear registro en tabla de invitaciones (nueva tabla requerida)
- Enviar email con link personalizado
- Mostrar confirmaciÃ³n con tracking de estado

#### GESTIÃ“N DE INVITACIONES PENDIENTES
**SecciÃ³n separada**: "Invitaciones Pendientes"
- Lista de invitaciones enviadas sin aceptar
- Por cada invitaciÃ³n:
  - Email invitado
  - Fecha de envÃ­o
  - Estado: [Enviada] [Vista] [Expirada]
  - Acciones: [Reenviar] [Cancelar]

#### ESTADÃSTICAS DEL EQUIPO
**Panel de MÃ©tricas**:
- Rendimiento general del equipo
- GrÃ¡fico de tickets por agente
- DistribuciÃ³n de calificaciones
- Tendencia de respuesta por semana

### PANTALLA 4: GESTIÃ“N DE CONTENIDO (/empresa/content)

#### ESTRUCTURA DE PESTAÃ‘AS
**PestaÃ±a 1: Anuncios PÃºblicos**
**PestaÃ±a 2: Centro de Ayuda**

#### PESTAÃ‘A 1: ANUNCIOS PÃšBLICOS

**Header**:
- TÃ­tulo: "Anuncios para Usuarios"
- DescripciÃ³n: "Comunica mantenimientos, problemas conocidos y novedades"
- BotÃ³n: [+ Nuevo Anuncio]

**Lista de Anuncios**:
- Tabla con columnas:
  - TÃ­tulo (title)
  - Estado (status): Draft, Published, Archived
  - Autor (author_id -> nombre)
  - Publicado (published_at)
  - Acciones: [Editar] [Publicar/Despublicar] [Eliminar]

**Modal de Crear/Editar Anuncio**:
- **Campos**:
  - TÃ­tulo: (requerido, max 255 chars)
  - Contenido: (editor rich text)
  - Estado: [Borrador] [Publicado]
  - Programar publicaciÃ³n: (fecha/hora futuras)
- **Preview**: Vista previa de cÃ³mo lo verÃ¡n los usuarios
- **Botones**: [Guardar Borrador] [Publicar Ahora] [Programar]

**Funcionalidades Avanzadas**:
- Templates predefinidos:
  - "Mantenimiento programado"
  - "Problema conocido"
  - "Nueva funcionalidad"
  - "Comunicado general"
- Editor con formato:
  - Negrita, cursiva, listas
  - Enlaces, imÃ¡genes
  - CÃ³digo/texto preformateado
- Vista previa responsive

#### PESTAÃ‘A 2: CENTRO DE AYUDA

**Header**:
- TÃ­tulo: "ArtÃ­culos del Centro de Ayuda"
- DescripciÃ³n: "Crea documentaciÃ³n para problemas frecuentes"
- BotÃ³n: [+ Nuevo ArtÃ­culo]

**OrganizaciÃ³n por CategorÃ­as**:
- Sidebar con categorÃ­as personalizables:
  - "Primeros Pasos"
  - "Problemas Comunes"
  - "Preguntas Frecuentes"
  - "Tutoriales"
  - [+ Nueva CategorÃ­a]

**Lista de ArtÃ­culos**:
- Vista de cards con:
  - TÃ­tulo del artÃ­culo
  - CategorÃ­a
  - NÃºmero de visualizaciones (views_count)
  - Ãšltima actualizaciÃ³n
  - Estado de publicaciÃ³n

**Editor de ArtÃ­culos**:
- **Metadatos**:
  - TÃ­tulo: (requerido)
  - CategorÃ­a: (selector)
  - Tags: (palabras clave separadas por comas)
  - Resumen: (descripciÃ³n corta)
- **Contenido**:
  - Editor rich text avanzado
  - Soporte para:
    - Headings (H1-H6)
    - Listas numeradas y con viÃ±etas
    - ImÃ¡genes con captions
    - Bloques de cÃ³digo
    - Tablas
    - Enlaces internos y externos
    - Videos embedded
- **SEO y BÃºsqueda**:
  - URL amigable auto-generada
  - Meta descripciÃ³n
  - Keywords para bÃºsqueda interna

**EstadÃ­sticas de ArtÃ­culos**:
- ArtÃ­culos mÃ¡s vistos
- BÃºsquedas sin resultados (para identificar gaps)
- Tiempo promedio de lectura
- Feedback de utilidad (thumbs up/down)

### PANTALLA 5: CONFIGURACIÃ“N DE EMPRESA (/empresa/settings)

#### ESTRUCTURA DE PESTAÃ‘AS COMPLETA
**PestaÃ±a 1: InformaciÃ³n General**
**PestaÃ±a 2: Branding y Apariencia**
**PestaÃ±a 3: CategorÃ­as de Tickets**
**PestaÃ±a 4: Macros de Respuesta**
**PestaÃ±a 5: ConfiguraciÃ³n Operativa**
**PestaÃ±a 6: Integraciones**

#### PESTAÃ‘A 1: INFORMACIÃ“N GENERAL

**Formulario de Empresa** (2 columnas):
- **Columna Izquierda - InformaciÃ³n BÃ¡sica**:
  - Nombre comercial: name (requerido)
  - RazÃ³n social: legal_name
  - Email de soporte: support_email (pÃºblico)
  - TelÃ©fono: phone
  - Sitio web: website (validaciÃ³n URL)

- **Columna Derecha - InformaciÃ³n Legal**:
  - RUT/NIT: tax_id
  - Representante legal: legal_representative
  - DirecciÃ³n: contact_address (textarea)
  - Ciudad: contact_city
  - Estado/Provincia: contact_state
  - PaÃ­s: contact_country (selector)
  - CÃ³digo postal: contact_postal_code

**Validaciones**:
- Email Ãºnico en el sistema
- Formato de RUT/NIT segÃºn paÃ­s
- ValidaciÃ³n de URL para website
- Campos requeridos marcados con asterisco

#### PESTAÃ‘A 2: BRANDING Y APARIENCIA

**SecciÃ³n Logos**:
- **Logo principal**: logo_url
  - Upload directo con preview
  - Formatos: PNG, JPG, SVG
  - TamaÃ±o mÃ¡ximo: 2MB
  - Dimensiones recomendadas: 200x60px
- **Favicon**: favicon_url
  - Upload con preview en pestaÃ±a simulada
  - Formato: ICO, PNG
  - Dimensiones: 32x32px o 64x64px

**SecciÃ³n Colores Corporativos**:
- **Color primario**: primary_color
  - Color picker con preview
  - Usado en botones, enlaces, headers
- **Color secundario**: secondary_color
  - Color picker con preview
  - Usado en elementos de soporte

**Preview en Tiempo Real**:
- Mockup de interface de tickets con los colores aplicados
- Ejemplo de email con branding
- Vista previa de centro de ayuda

#### PESTAÃ‘A 3: CATEGORÃAS DE TICKETS

**Header**:
- TÃ­tulo: "CategorÃ­as de Problemas"
- DescripciÃ³n: "Define las categorÃ­as que verÃ¡n los usuarios al crear tickets"
- BotÃ³n: [+ Nueva CategorÃ­a]

**Lista de CategorÃ­as**:
- Tabla con drag-and-drop para reordenar
- Columnas:
  - **Orden**: NumeraciÃ³n visual (1, 2, 3...)
  - **Nombre**: name (editable inline)
  - **DescripciÃ³n**: description (tooltip hover)
  - **Tickets**: COUNT de tickets en esta categorÃ­a
  - **Estado**: is_active (toggle switch)
  - **Acciones**: [Editar] [Eliminar]

**Modal de Crear/Editar CategorÃ­a**:
- **Nombre**: (requerido, max 100 chars)
- **DescripciÃ³n**: (opcional, ayuda para usuarios)
- **Color**: (opcional, para identificaciÃ³n visual)
- **Estado**: Activa/Inactiva
- **Orden**: PosiciÃ³n en la lista

**CategorÃ­as Predeterminadas** (sugerencias para nuevas empresas):
- "Acceso y Login"
- "Problemas TÃ©cnicos"
- "Solicitudes de InformaciÃ³n"
- "Reportar Error"
- "Sugerencias"

#### PESTAÃ‘A 4: MACROS DE RESPUESTA

**Header**:
- TÃ­tulo: "Respuestas Predefinidas"
- DescripciÃ³n: "Crea plantillas para respuestas comunes de tus agentes"
- BotÃ³n: [+ Nueva Macro]

**Lista de Macros**:
- Vista de cards para mejor legibilidad
- Por cada macro:
  - **Nombre**: name
  - **Preview**: Primeras 100 chars de content
  - **Ãšltima modificaciÃ³n**: updated_at
  - **Estado**: is_active
  - **Acciones**: [Editar] [Duplicar] [Eliminar]

**Editor de Macros**:
- **Nombre**: (requerido, para identificaciÃ³n interna)
- **Contenido**: (editor de texto con variables)
- **Variables disponibles**:
  - {{cliente_nombre}} -> first_name + last_name
  - {{cliente_email}} -> email del usuario
  - {{ticket_numero}} -> ticket_code
  - {{empresa_nombre}} -> business.companies.name
  - {{agente_nombre}} -> nombre del agente actual
  - {{fecha_actual}} -> fecha de hoy
- **Preview**: Vista previa con datos de ejemplo
- **CategorÃ­a**: (opcional, para organizar macros)

**Macros Predeterminadas** (templates iniciales):
- "Saludo inicial"
- "Solicitar mÃ¡s informaciÃ³n"
- "Problema resuelto"
- "EscalaciÃ³n a tÃ©cnico"
- "Cierre de ticket"

#### PESTAÃ‘A 5: CONFIGURACIÃ“N OPERATIVA

**Horarios de AtenciÃ³n**:
- Campo business_hours (JSONB)
- Interface visual por dÃ­a de semana:
```
Lunes:    [âœ“] [09:00] a [18:00]
Martes:   [âœ“] [09:00] a [18:00]
MiÃ©rcoles:[âœ“] [09:00] a [18:00]
Jueves:   [âœ“] [09:00] a [18:00]
Viernes:  [âœ“] [09:00] a [18:00]
SÃ¡bado:   [  ] [09:00] a [13:00]
Domingo:  [  ] Cerrado
```

**Zona Horaria**:
- Selector: timezone
- Lista completa de zonas horarias
- Preview: "Hora actual en tu zona: [XX:XX]"

**Configuraciones de Tickets**:
- **Auto-cierre**: DÃ­as para cerrar tickets resueltos (default: 7)
- **Notificaciones**: Email a clientes en cada respuesta
- **Respuesta automÃ¡tica**: Enviar confirmaciÃ³n al crear ticket
- **LÃ­mite de archivos**: TamaÃ±o mÃ¡ximo para attachments

**SLA (Service Level Agreement)**:
- **Tiempo objetivo de primera respuesta**: En horas
- **Tiempo objetivo de resoluciÃ³n**: Por categorÃ­a
- **EscalaciÃ³n automÃ¡tica**: Si no hay respuesta en X horas

#### PESTAÃ‘A 6: INTEGRACIONES

**Email**:
- **Email de respuestas**: Configurar email desde el cual se envÃ­an respuestas
- **Firma de email**: Template para emails automÃ¡ticos
- **SMTP personalizado**: (opcional, para empresas grandes)

**Webhooks**:
- **URL de notificaciÃ³n**: Para integraciones externas
- **Eventos**: Seleccionar quÃ© eventos notificar
  - Nuevo ticket
  - Ticket resuelto
  - Ticket cerrado
  - Nueva respuesta

**API Access**:
- **API Key**: Generar/regenerar clave de API
- **Rate Limiting**: Configurar lÃ­mites por minuto
- **IPs permitidas**: (opcional, para seguridad)

**Integraciones Populares** (futuro):
- Slack: Notificaciones de tickets
- Microsoft Teams: Notificaciones
- Jira: SincronizaciÃ³n de issues
- Zapier: Automatizaciones

================================================================================
## 4. AGENTE DE SOPORTE (AGENT)
================================================================================

### ACCESO Y CREDENCIALES
- **URL de acceso**: /agent/
- **Email de prueba**: agent@helpdesk.com, soporte@helpdesk.com
- **ContraseÃ±a**: [cualquier contraseÃ±a en desarrollo]
- **Rol en BD**: auth.user_roles con role_code = 'agent' Y company_id especÃ­fico

### PANTALLA 1: DASHBOARD DE AGENTE (/agent/dashboard)

#### HEADER PERSONALIZADO CON CONTEXTO
- Avatar personal: auth.user_profiles.avatar_url
- Bienvenida: "Buenos dÃ­as, [first_name]"
- Empresa actual: business.companies.name con logo
- Indicador de estado: [Online] [Ausente] [Ocupado]

#### MÃ‰TRICAS PERSONALES (4 tarjetas)

**1. Mis Tickets Activos**
- NÃºmero: COUNT(ticketing.tickets WHERE owner_agent_id = [mi_id] AND status IN ('pending', 'resolved'))
- Subtexto: "XX pendientes de cierre"
- Color: Azul
- AcciÃ³n: Click -> /agent/tickets filtrado por "Mis tickets"

**2. Tickets Sin Propietario**
- NÃºmero: COUNT(ticketing.tickets WHERE owner_agent_id IS NULL AND company_id = [mi_empresa])
- Subtexto: "Disponibles para tomar"
- Color: Naranja (si > 0), Verde (si = 0)
- AcciÃ³n: Click -> /agent/tickets filtrado por "Sin asignar"

**3. Mi CalificaciÃ³n**
- NÃºmero: AVG(ticketing.ticket_ratings.rating WHERE rated_agent_id = [mi_id])
- Formato: "4.3/5.0 â­"
- Subtexto: "Basado en XX calificaciones"
- Color: Amarillo dorado
- AcciÃ³n: Click -> Modal con detalle de calificaciones

**4. Respuesta Promedio**
- CÃ¡lculo: AVG(first_response_at - created_at WHERE owner_agent_id = [mi_id])
- Formato: "2.4 horas"
- Subtexto: "Meta: <4 horas"
- Color: Verde si <4h, Amarillo si 4-8h, Rojo si >8h
- Meta visual: Barra de progreso vs objetivo

#### SECCIÃ“N DE ACTIVIDAD RECIENTE (2 columnas)

**Columna Izquierda - Tickets Urgentes**:
- TÃ­tulo: "Requieren AtenciÃ³n"
- Lista de tickets con prioridad:
  - Sin respuesta >24 horas
  - Reabiertos por clientes
  - Con calificaciones bajas
  - Escalados por company_admin

**Formato de cada item urgente**:
```
ðŸš¨ TKT-2025-00001 - hace 36 horas
   "Problema crÃ­tico con base de datos"
   Por: admin@universidad.edu.bo
   [Tomar Ticket]
```

**Columna Derecha - Mi Actividad Reciente**:
- TÃ­tulo: "Mis Ãšltimas Acciones"
- Timeline de actividades:
  - Tickets tomados
  - Respuestas enviadas
  - Tickets resueltos
  - Notas internas aÃ±adidas

**Formato de actividad**:
```
hace 2 horas - Respondiste TKT-2025-00015
hace 4 horas - Resolviste TKT-2025-00013 â­4.5
hace 6 horas - Tomaste TKT-2025-00017
```

#### SECCIÃ“N DE HERRAMIENTAS RÃPIDAS

**Accesos Directos**:
- [Tomar Siguiente Ticket] -> Toma automÃ¡ticamente el ticket mÃ¡s antiguo sin asignar
- [Mis Tickets Pendientes] -> Lista filtrada
- [Crear Nota RÃ¡pida] -> Modal para nota sin ticket especÃ­fico
- [Centro de Ayuda] -> Acceso rÃ¡pido para consultar documentaciÃ³n

**Widget de Macros Favoritas**:
- Lista de business.company_macros mÃ¡s usadas por este agente
- Click rÃ¡pido para copiar contenido
- [Ver Todas las Macros]

### PANTALLA 2: GESTIÃ“N DE TICKETS (/agent/tickets)

#### ESTRUCTURA DE 3 PANELES (Optimizada para Agentes)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FILTROS   â”‚    LISTA TICKETS     â”‚   DETALLE       â”‚
â”‚ Y ACCIONES â”‚    (Con Preview)     â”‚   COMPLETO      â”‚
â”‚            â”‚                      â”‚                 â”‚
â”‚   250px    â”‚       450px          â”‚    Resto        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### PANEL IZQUIERDO - NAVEGACIÃ“N ESPECIALIZADA

**SecciÃ³n Cola de Trabajo**:
- ðŸ†• **Nuevos Tickets** (owner_agent_id IS NULL)
  - Badge con conteo
  - Ordenados por antigÃ¼edad
  - BotÃ³n [Tomar Siguiente]
- ðŸ‘¤ **Mis Tickets** (owner_agent_id = [mi_id])
  - Todos mis tickets activos
  - Incluye pending y resolved
- âš¡ **Urgentes**
  - Sin respuesta >24h
  - Reabiertos
  - Escalados

**SecciÃ³n Estados**:
- â³ Pendientes (status = 'pending')
- âœ… Resueltos (status = 'resolved')
- ðŸ”’ Cerrados (status = 'closed')
- ðŸ”„ Todos los estados

**SecciÃ³n Filtros Avanzados**:
- **Por Agente Propietario**:
  - Lista de agentes con conteos
  - [Sin asignar] siempre visible arriba
- **Por CategorÃ­a**:
  - ticketing.categories con conteos
- **Por Tiempo de Espera**:
  - <1 hora, 1-4 horas, 4-24 horas, >24 horas
- **Por Cliente**:
  - BÃºsqueda rÃ¡pida por email/nombre

#### PANEL CENTRAL - LISTA INTELIGENTE

**Header con Acciones**:
- Total de tickets en vista actual
- BotÃ³n [Tomar MÃºltiples] para selecciÃ³n en lote
- Ordenamiento: [MÃ¡s urgentes] [MÃ¡s antiguos] [Por categorÃ­a]
- ActualizaciÃ³n automÃ¡tica cada 30 segundos

**Card de Ticket Expandida** (formato optimizado para agentes):
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TKT-2025-00001    ðŸ†• NUEVO    â° hace 6 horas          â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ ðŸ“§ Sistema no permite enviar documentos adjuntos       â”‚
â”‚ ðŸ‘¤ MarÃ­a GonzÃ¡lez (maria.gonzalez@universidad.edu.bo)  â”‚
â”‚ ðŸ“‚ Problemas TÃ©cnicos                                  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ "Al intentar adjuntar un PDF en el formulario de..."   â”‚
â”‚ [Ver completo] [Tomar Ticket] [+ Nota RÃ¡pida]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Indicadores Visuales**:
- **Prioridad por Color**:
  - Rojo: >24h sin respuesta
  - Naranja: >8h sin respuesta
  - Verde: <4h sin respuesta
- **Iconos de Estado**:
  - ðŸ“Ž Tiene archivos adjuntos
  - ðŸ”„ Reabierto por cliente
  - â­ Ya tiene calificaciÃ³n
  - ðŸ“ Tiene notas internas

#### PANEL DERECHO - WORKSPACE COMPLETO

**Header Contextual del Ticket**:
- ticket_code + title
- Status badge con tiempo en estado actual
- Botones de acciÃ³n principal:
  - [Tomar Ticket] (si no es mÃ­o)
  - [Cambiar Estado]
  - [Asignar a Otro]
  - [+ Nota Interna]

**InformaciÃ³n del Cliente**:
- Foto: avatar_url si existe
- Nombre: first_name + last_name
- Email: email (clickeable para ver historial)
- Empresa: business.companies.name
- Tickets previos: COUNT de tickets anteriores

**PestaÃ±as de Trabajo**:

**PestaÃ±a 1: ConversaciÃ³n**
- Hilo completo de ticket_responses
- Editor de respuesta con:
  - Toolbar de formato bÃ¡sico
  - InserciÃ³n de macros (dropdown)
  - Adjuntar archivos
  - Mencionar otros agentes (@nombre)
- Botones de acciÃ³n:
  - [Enviar Respuesta]
  - [Enviar y Resolver]
  - [Usar Macro] (dropdown)

**PestaÃ±a 2: Notas Internas**
- Hilo de ticket_internal_notes
- Solo visible para agentes y company_admin
- Editor para nueva nota con:
  - Menciones de agentes (@)
  - CategorizaciÃ³n de notas:
    - ðŸ” InvestigaciÃ³n
    - ðŸ’¡ SoluciÃ³n encontrada
    - â“ Necesito ayuda
    - âœ… InformaciÃ³n importante
- Timeline integrado con conversaciÃ³n pÃºblica

**PestaÃ±a 3: InformaciÃ³n TÃ©cnica**
- Detalles completos del ticket
- Metadatos:
  - Creado: created_at
  - Primera respuesta: first_response_at
  - Ãšltima actualizaciÃ³n: updated_at
  - Tiempo total activo
- Historial de cambios:
  - Asignaciones de agente
  - Cambios de estado
  - Modificaciones de categorÃ­a
- Archivos adjuntos con preview

**PestaÃ±a 4: Cliente**
- Perfil completo del usuario
- Historial de tickets:
  - Tickets previos con esta empresa
  - Patrones de problemas
  - Calificaciones histÃ³ricas
- Notas del cliente (informaciÃ³n persistente)

#### FUNCIONES ESPECIALES PARA AGENTES

**Toma AutomÃ¡tica de Tickets**:
- BotÃ³n [Tomar Siguiente] en dashboard
- Algoritmo: Ticket mÃ¡s antiguo sin propietario
- NotificaciÃ³n: "Has tomado TKT-2025-00001"
- RedirecciÃ³n automÃ¡tica al ticket

**Sistema de Macros Integrado**:
- Dropdown en editor de respuesta
- Preview antes de insertar
- Variables reemplazadas automÃ¡ticamente
- Historial de macros mÃ¡s usadas

**ColaboraciÃ³n Entre Agentes**:
- Menciones en notas internas: @juan.perez
- Transferencia de tickets: [Asignar a Otro Agente]
- Solicitud de ayuda: BotÃ³n [Pedir Ayuda] que notifica a company_admin

### PANTALLA 3: CENTRO DE CONOCIMIENTO (/agent/knowledge)

#### ACCESO RÃPIDO A INFORMACIÃ“N

**Buscador Inteligente**:
- BÃºsqueda en business.help_center_articles de su empresa
- Filtros: [Por categorÃ­a] [MÃ¡s visitados] [Actualizados recientemente]
- Resultados con highlighting de tÃ©rminos
- Acceso directo desde cualquier ticket

**ArtÃ­culos Frecuentes**:
- Los 10 artÃ­culos mÃ¡s consultados por agentes
- Tiempo promedio de lectura
- Ãšltima actualizaciÃ³n
- Rating de utilidad

**Mis Contribuciones**:
- ArtÃ­culos creados por este agente
- Propuestas de nuevos artÃ­culos
- Sugerencias de mejora enviadas

### PANTALLA 4: MIS ESTADÃSTICAS (/agent/stats)

#### DASHBOARD PERSONAL DE RENDIMIENTO

**MÃ©tricas del PerÃ­odo** (selector: Semana/Mes/Trimestre):

**Productividad**:
- Tickets tomados: COUNT(owner_agent_id = [mi_id])
- Tickets resueltos: COUNT(status = 'resolved')
- Promedio diario: CÃ¡lculo automÃ¡tico
- Tendencia: GrÃ¡fico de lÃ­neas

**Calidad del Servicio**:
- CalificaciÃ³n promedio: AVG(rating)
- DistribuciÃ³n de calificaciones: GrÃ¡fico de barras
- Comentarios positivos vs negativos
- Tickets reabiertos: COUNT (indicador de calidad)

**Eficiencia Temporal**:
- Tiempo promedio de primera respuesta
- Tiempo promedio de resoluciÃ³n
- ComparaciÃ³n con el equipo
- Mejora mensual

**GrÃ¡ficos Detallados**:
- Tickets por dÃ­a de la semana
- Tickets por hora del dÃ­a
- DistribuciÃ³n por categorÃ­as
- EvoluciÃ³n temporal de mÃ©tricas

================================================================================
## 5. USUARIO FINAL (USER)
================================================================================

### ACCESO Y CREDENCIALES
- **URL de acceso**: / (sistema general, sin subdirectorio)
- **Email de prueba**: user@helpdesk.com, cliente@helpdesk.com
- **ContraseÃ±a**: [cualquier contraseÃ±a en desarrollo]
- **Rol en BD**: auth.user_roles con role_code = 'user' (no requiere company_id)

### PANTALLA 1: MIS TICKETS (/tickets)

#### HEADER Y NAVEGACIÃ“N
- TÃ­tulo personalizado: "Mis Tickets de Soporte"
- Breadcrumb: Inicio > Mis Tickets
- Usuario info: Avatar + "Hola, [first_name]"
- BotÃ³n principal: [+ Crear Nuevo Ticket] (flotante, siempre visible)

#### ESTRUCTURA DE 2 PANELES
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   FILTROS       â”‚        LISTA DE TICKETS             â”‚
â”‚  Y ESTADÃSTICAS â”‚                                     â”‚
â”‚                 â”‚                                     â”‚
â”‚     300px       â”‚            Resto                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### PANEL IZQUIERDO - NAVEGACIÃ“N PERSONAL

**Resumen Personal**:
- Foto de perfil: avatar_url
- Nombre: first_name + last_name
- Email: email
- Miembro desde: created_at

**EstadÃ­sticas RÃ¡pidas**:
- Total de tickets: COUNT(created_by_user_id = [mi_id])
- Tickets abiertos: COUNT(status IN ('open', 'pending'))
- Tickets resueltos: COUNT(status = 'resolved')
- CalificaciÃ³n promedio dada: AVG(rating WHERE customer_id = [mi_id])

**Filtros de Estado**:
- ðŸ†• Abiertos (status = 'open') - Badge con nÃºmero
- â³ Pendientes (status = 'pending') - Badge con nÃºmero
- âœ… Resueltos (status = 'resolved') - Badge con nÃºmero
- ðŸ”’ Cerrados (status = 'closed') - Badge con nÃºmero
- ðŸ“„ Todos mis tickets

**Filtros por Empresa**:
- Lista de empresas para las que he creado tickets
- business.companies.name con logo
- COUNT de tickets por empresa

**Filtros por Tiempo**:
- Esta semana
- Este mes
- Ãšltimos 3 meses
- Todos los tiempos

#### PANEL PRINCIPAL - LISTA DE TICKETS

**Header de Lista**:
- Ordenamiento: [MÃ¡s recientes] [MÃ¡s antiguos] [Por estado] [Por empresa]
- Vista: [Lista] [Cards detalladas]
- BÃºsqueda: "Buscar en mis tickets..."

**Card de Ticket de Usuario** (formato amplio):
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TKT-2025-00001                    â³ PENDIENTE    hace 3 dÃ­as  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ ðŸ“§ No puedo acceder al sistema de calificaciones             â”‚
â”‚ ðŸ¢ Universidad del Valle - Facultad de IngenierÃ­a            â”‚
â”‚ ðŸ“‚ Acceso y Login                                            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ Ãšltima respuesta de: MarÃ­a GarcÃ­a (Agente de Soporte)        â”‚
â”‚ "Hemos identificado el problema, estamos trabajando..."       â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ [Ver ConversaciÃ³n] [Responder] [Calificar] â­â­â­â­â­          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Elementos Visuales por Estado**:
- ðŸ†• **ABIERTO**: Borde azul, "Esperando respuesta"
- â³ **PENDIENTE**: Borde amarillo, "ConversaciÃ³n activa"
- âœ… **RESUELTO**: Borde verde, botÃ³n "Calificar" destacado
- ðŸ”’ **CERRADO**: Borde gris, solo lectura

**InformaciÃ³n Rica en Cards**:
- TÃ­tulo completo del ticket
- Empresa destinataria con logo
- CategorÃ­a asignada
- Ãšltima actualizaciÃ³n con timestamp relativo
- Preview de Ãºltima respuesta (100 chars)
- Indicadores: ðŸ“Ž (archivos), ðŸ”„ (actualizado), â­ (calificado)

### PANTALLA 2: CREAR NUEVO TICKET (/create-ticket)

#### PROCESO GUIADO EN PASOS

**Paso 1: SelecciÃ³n de Empresa**
- TÃ­tulo: "Â¿A quÃ© empresa diriges tu consulta?"
- Lista de empresas disponibles:
  - Grid de cards con logos
  - business.companies WHERE status = 'active'
  - Por cada empresa:
    - Logo: logo_url
    - Nombre: name
    - DescripciÃ³n breve: industry_type
    - Horario de atenciÃ³n: business_hours (formato amigable)
    - Tiempo promedio de respuesta
- Buscador: "Buscar empresa..."
- OpciÃ³n: "Â¿No encuentras tu empresa?" -> Link a solicitud

**Paso 2: Consulta el Centro de Ayuda**
- TÃ­tulo: "Antes de crear el ticket, revisa si ya existe una soluciÃ³n"
- Buscador en business.help_center_articles de la empresa seleccionada
- ArtÃ­culos sugeridos segÃºn keywords comunes
- Anuncios recientes de la empresa
- BotÃ³n: [Continuar con el Ticket] si no encontrÃ³ soluciÃ³n

**Paso 3: Formulario de CreaciÃ³n**

**InformaciÃ³n del Ticket**:
- **TÃ­tulo**: (requerido, max 255 chars)
  - Placeholder: "Describe brevemente tu problema"
  - Contador de caracteres
- **CategorÃ­a**: (requerido)
  - Selector con ticketing.categories de la empresa
  - DescripciÃ³n de cada categorÃ­a en tooltip
- **DescripciÃ³n Detallada**: (requerido)
  - Editor de texto rico
  - GuÃ­as de formato: "Describe quÃ© esperabas que pasara y quÃ© pasÃ³ realmente"
  - Plantillas sugeridas: "Problema tÃ©cnico", "Solicitud de informaciÃ³n"

**Archivos Adjuntos**:
- Drag & drop area
- Formatos permitidos: ImÃ¡genes, PDFs, documentos
- TamaÃ±o mÃ¡ximo por archivo: 10MB
- LÃ­mite total: 50MB
- Preview de archivos seleccionados

**InformaciÃ³n Adicional** (opcional):
- **Urgencia**: [Baja] [Media] [Alta] [CrÃ­tica]
- **Dispositivo**: [Escritorio] [MÃ³vil] [Tablet]
- **Navegador**: Auto-detectado pero editable
- **Pasos ya intentados**: Textarea libre

**Vista Previa**:
- Panel lateral con preview del ticket
- ActualizaciÃ³n en tiempo real mientras escribe
- EstimaciÃ³n de respuesta segÃºn categorÃ­a

### PANTALLA 3: DETALLE DE TICKET (/tickets/[id])

#### HEADER DETALLADO
- ticket_code prominente: "Ticket TKT-2025-00001"
- Estado visual grande con descripciÃ³n:
  - ðŸ†• "Tu ticket ha sido creado y estÃ¡ en cola"
  - â³ "Un agente estÃ¡ trabajando en tu ticket"
  - âœ… "Tu ticket ha sido marcado como resuelto"
  - ðŸ”’ "Tu ticket estÃ¡ cerrado"
- Timeline visual del progreso

#### INFORMACIÃ“N DEL TICKET (Card superior)
**Columna Izquierda - Detalles**:
- TÃ­tulo completo: title
- Empresa: business.companies.name + logo
- CategorÃ­a: ticketing.categories.name
- Creado: created_at (formato completo)
- Ãšltima actualizaciÃ³n: updated_at

**Columna Derecha - Estado y Agente**:
- Estado actual con tiempo en estado
- Agente asignado:
  - Si owner_agent_id: nombre + avatar + "estÃ¡ atendiendo tu ticket"
  - Si NULL: "Esperando ser asignado a un agente"
- Tiempo estimado de respuesta segÃºn SLA

#### CONVERSACIÃ“N COMPLETA

**Mensaje Inicial** (destacado):
- Avatar del usuario
- Nombre completo
- Timestamp de creaciÃ³n
- initial_description con formato completo
- Archivos adjuntos con previews/downloads

**Hilo de Respuestas**:
- Lista cronolÃ³gica de ticket_responses
- **Mensajes del Usuario**:
  - Avatar personal
  - Nombre: "TÃº"
  - response_content
  - created_at relativo
  - Archivos adjuntos si existen
- **Mensajes del Agente**:
  - Avatar del agente
  - Nombre: first_name + last_name
  - Rol badge: "Agente de Soporte"
  - response_content
  - created_at relativo
  - Badge de "Respuesta oficial"

#### INTERACCIONES DISPONIBLES

**Si Estado = 'open' o 'pending'**:

**Formulario de Respuesta**:
- Editor de texto rico
- BotÃ³n [Adjuntar Archivos]
- BotÃ³n [Enviar Respuesta]
- Auto-save de borradores cada 30 segundos

**Acciones Adicionales**:
- [Agregar MÃ¡s InformaciÃ³n] (archivos adicionales)
- [Cerrar Ticket] (si problema ya resuelto)

**Si Estado = 'resolved'**:

**Sistema de CalificaciÃ³n**:
- TÃ­tulo: "Â¿CÃ³mo calificas la soluciÃ³n recibida?"
- 5 estrellas interactivas
- Comentario opcional: "CuÃ©ntanos sobre tu experiencia"
- Botones: [Confirmar ResoluciÃ³n] [Necesito MÃ¡s Ayuda]

**Opciones Post-ResoluciÃ³n**:
- [Calificar Servicio] (si no calificado)
- [Reabrir Ticket] (si problema persiste)
- [Crear Ticket Relacionado]

### PANTALLA 4: CENTRO DE AYUDA (/help-center)

#### BÃšSQUEDA INTELIGENTE
- Buscador principal: "Â¿En quÃ© podemos ayudarte?"
- Sugerencias populares: Links a bÃºsquedas frecuentes
- Filtros:
  - Por empresa (si sigue mÃºltiples)
  - Por categorÃ­a
  - Por fecha de publicaciÃ³n

#### CONTENIDO ORGANIZADO

**Empresas que Sigo**:
- Lista de business.user_company_followers para mi user_id
- Por cada empresa:
  - Logo y nombre
  - COUNT de artÃ­culos disponibles
  - Ãšltimos artÃ­culos publicados
  - BotÃ³n [Ver Todos los ArtÃ­culos]

**ArtÃ­culos Destacados**:
- business.help_center_articles mÃ¡s visitados
- Solo artÃ­culos con status = 'published'
- Card con:
  - TÃ­tulo
  - Empresa origen
  - Resumen (primeros 200 chars)
  - views_count
  - Tiempo estimado de lectura

**BÃºsquedas Sugeridas**:
- "CÃ³mo crear una cuenta"
- "Problemas de acceso"
- "Recuperar contraseÃ±a"
- "Reportar un error"

#### ARTÃCULO INDIVIDUAL (/help-center/[id])

**Header del ArtÃ­culo**:
- Empresa: Logo + nombre
- TÃ­tulo completo
- Autor: "Por [first_name last_name]"
- Fecha de publicaciÃ³n: published_at
- Tiempo de lectura estimado
- views_count

**Contenido Rico**:
- Contenido completo con formato HTML
- Tabla de contenidos generada automÃ¡ticamente
- ImÃ¡genes con zoom
- Videos embedded
- CÃ³digo con syntax highlighting

**Interacciones**:
- Rating de utilidad: [ðŸ‘ Ãštil] [ðŸ‘Ž No Ãºtil]
- BotÃ³n [Â¿AÃºn necesitas ayuda?] -> Crear ticket pre-rellenado
- Compartir: Copiar enlace
- ArtÃ­culos relacionados

### PANTALLA 5: ANUNCIOS Y NOVEDADES (/announcements)

#### FEED DE ANUNCIOS
- Lista de business.company_announcements de empresas seguidas
- Solo anuncios con status = 'published'
- Ordenados por published_at (mÃ¡s recientes primero)

**Card de Anuncio**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ðŸ¢ Universidad del Valle              hace 2 dÃ­as      â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ ðŸ”§ Mantenimiento Programado del Sistema de Notas       â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ El prÃ³ximo sÃ¡bado 30 de septiembre realizaremos...     â”‚
â”‚ [Leer Completo] [Marcar como LeÃ­do]                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**CategorÃ­as de Anuncios**:
- ðŸ”§ Mantenimientos
- ðŸš¨ Problemas conocidos
- âœ¨ Nuevas funcionalidades
- ðŸ“¢ Comunicados generales

**Si no sigue empresas**:
- Mensaje amigable: "Â¡Comienza siguiendo empresas!"
- BotÃ³n [Explorar Empresas]
- Lista de empresas populares

### PANTALLA 6: PERFIL PERSONAL (/profile)

#### INFORMACIÃ“N PERSONAL

**Foto de Perfil**:
- avatar_url actual (grande)
- BotÃ³n [Cambiar Foto]
- Upload con crop circular
- Formatos: JPG, PNG
- TamaÃ±o mÃ¡ximo: 5MB

**Datos BÃ¡sicos** (formulario editable):
- **Nombre**: first_name (requerido)
- **Apellido**: last_name (requerido)
- **Email**: email (solo lectura, verificado)
- **TelÃ©fono**: phone_number (opcional)
- **Zona horaria**: timezone (selector)

**Verificaciones de Cuenta**:
- âœ… Email verificado (email_verified)
- Fecha de verificaciÃ³n: email_verified_at
- BotÃ³n [Reenviar VerificaciÃ³n] si no verificado

#### ESTADÃSTICAS PERSONALES

**Mi Actividad**:
- Miembro desde: created_at
- Total de tickets creados: COUNT
- Tickets resueltos: COUNT(status = 'resolved')
- CalificaciÃ³n promedio dada: AVG(rating)
- Ãšltima actividad: MAX(updated_at) de tickets

**Empresas que Sigo**:
- Lista de business.user_company_followers
- Por cada empresa:
  - Logo + nombre
  - Fecha de seguimiento: followed_at
  - Tickets creados para esta empresa: COUNT
  - BotÃ³n [Dejar de Seguir]

### PANTALLA 7: CONFIGURACIONES (/settings)

#### PREFERENCIAS DE INTERFAZ

**Apariencia**:
- **Tema**: theme
  - [ðŸŒž Claro] [ðŸŒ™ Oscuro] [âš™ï¸ AutomÃ¡tico]
  - Preview en tiempo real
- **Idioma**: language
  - [ðŸ‡ªðŸ‡¸ EspaÃ±ol] [ðŸ‡ºðŸ‡¸ English]
  - AplicaciÃ³n inmediata

**Zona Horaria**:
- timezone con buscador
- Preview: "Hora actual: [XX:XX]"
- Afecta timestamps en tickets

#### NOTIFICACIONES

**Notificaciones Web**:
- push_web_notifications (toggle)
- "Recibir notificaciones del navegador"
- BotÃ³n [Probar NotificaciÃ³n]

**Notificaciones de Tickets**:
- notifications_tickets (toggle)
- "Email cuando haya respuestas a mis tickets"
- Frecuencia: [Inmediata] [Resumen diario]

#### PRIVACIDAD Y SEGURIDAD

**Cambio de ContraseÃ±a**:
- Campo: ContraseÃ±a actual
- Campo: Nueva contraseÃ±a
- Campo: Confirmar contraseÃ±a
- ValidaciÃ³n en tiempo real de fortaleza

**Sesiones Activas**:
- Lista de auth.refresh_tokens activos
- Por cada sesiÃ³n:
  - device_name
  - ip_address (ciudad aproximada)
  - last_used_at
  - BotÃ³n [Cerrar SesiÃ³n]
- BotÃ³n [Cerrar Todas las Sesiones]

**TÃ©rminos y Condiciones**:
- terms_accepted: Estado actual
- terms_accepted_at: Fecha de aceptaciÃ³n
- terms_version: VersiÃ³n aceptada
- Enlace: [Ver TÃ©rminos Actuales]
- NotificaciÃ³n si hay nuevas versiones

================================================================================
## 6. FLUJOS DE NEGOCIO PRINCIPALES
================================================================================

### 6.1. FLUJO COMPLETO DE CREACIÃ“N Y RESOLUCIÃ“N DE TICKET

#### FASE 1: CREACIÃ“N DEL TICKET
1. **Usuario accede** a /create-ticket
2. **Selecciona empresa** de business.companies activas
3. **Revisa centro de ayuda** para verificar si existe soluciÃ³n
4. **Completa formulario**:
   - title (requerido)
   - category_id (de ticketing.categories de la empresa)
   - initial_description (requerido)
   - ticket_attachments (opcional)
5. **Sistema crea ticket**:
   - Genera ticket_code Ãºnico (TKT-YYYY-NNNNN)
   - status = 'open'
   - owner_agent_id = NULL
   - created_at = NOW()
6. **Notificaciones automÃ¡ticas**:
   - Email al usuario con nÃºmero de ticket
   - NotificaciÃ³n a agentes de la empresa

#### FASE 2: ASIGNACIÃ“N AUTOMÃTICA
1. **Agente** ve ticket en cola "Nuevos Tickets"
2. **Agente decide responder** y escribe en pestaÃ±a "ConversaciÃ³n"
3. **Sistema recibe respuesta**:
   - Crea registro en ticket_responses con author_type = 'agent'
4. **Trigger automÃ¡tico** se ejecuta:
   ```sql
   UPDATE ticketing.tickets SET
     owner_agent_id = [agente_que_respondio],
     first_response_at = NOW(),
     status = 'pending'
   WHERE id = [ticket_id] AND owner_agent_id IS NULL;
   ```
5. **NotificaciÃ³n al usuario**: Email con la respuesta del agente

#### FASE 3: CONVERSACIÃ“N ACTIVA
1. **Usuario recibe email** y puede responder desde interfaz web
2. **Usuario aÃ±ade respuesta** en /tickets/[id]
3. **Sistema crea** nuevo ticket_responses con author_type = 'user'
4. **Agente propietario** recibe notificaciÃ³n
5. **Ciclo continÃºa** hasta resoluciÃ³n

#### FASE 4: RESOLUCIÃ“N Y CALIFICACIÃ“N
1. **Agente marca ticket** como status = 'resolved'
2. **Sistema registra** resolved_at = NOW()
3. **Usuario recibe notificaciÃ³n** de resoluciÃ³n
4. **Usuario accede** a /tickets/[id] y ve opciÃ³n de calificar
5. **Usuario califica** (1-5 estrellas + comentario opcional)
6. **Sistema crea** registro en ticket_ratings con:
   - rated_agent_id = owner_agent_id (histÃ³rico)
   - rating y comment del usuario
7. **Ticket permanece** en 'resolved' hasta cierre automÃ¡tico

#### FASE 5: CIERRE AUTOMÃTICO
1. **Proceso programado** ejecuta diariamente
2. **Busca tickets** con status = 'resolved' y updated_at > 7 dÃ­as
3. **Actualiza** status = 'closed', closed_at = NOW()
4. **Ticket entra** en histÃ³rico para reportes

### 6.2. FLUJO DE REGISTRO Y GESTIÃ“N DE USUARIOS

#### REGISTRO DE USUARIO NORMAL
1. **Acceso** a /register
2. **Formulario bÃ¡sico**:
   - email (Ãºnico en sistema)
   - password (hasheado con bcrypt)
   - first_name, last_name
   - terms_accepted = true (requerido)
3. **Sistema crea**:
   - Registro en auth.users con status = 'active'
   - Registro en auth.user_profiles
   - Registro en auth.user_roles con role_code = 'user'
4. **Email de verificaciÃ³n** enviado
5. **Usuario puede usar** sistema inmediatamente

#### INVITACIÃ“N DE AGENTE
1. **Company Admin** accede a /empresa/agents
2. **Hace clic** en [+ Invitar Agente]
3. **Ingresa email** del candidato
4. **Sistema verifica** si email existe en auth.users:

**Si usuario existe**:
- Crea registro en auth.user_roles con role_code = 'agent'
- EnvÃ­a notificaciÃ³n de nueva asignaciÃ³n
- Usuario ve nuevo rol en prÃ³ximo login

**Si usuario no existe**:
- EnvÃ­a email de invitaciÃ³n con link especial
- Link lleva a formulario de registro pre-completado
- Al registrarse, obtiene roles 'user' + 'agent' automÃ¡ticamente

### 6.3. FLUJO DE SOLICITUD Y APROBACIÃ“N DE EMPRESAS

#### SOLICITUD PÃšBLICA
1. **Acceso** a /solicitar-empresa (pÃºblico, sin login)
2. **Formulario extenso**:
   - company_name, legal_name, admin_email
   - business_description, website, industry_type
   - contact_address completa, tax_id
   - estimated_users
3. **Sistema crea** registro en business.company_requests
4. **Email automÃ¡tico** al solicitante confirmando recepciÃ³n

#### REVISIÃ“N POR ADMIN PLATAFORMA
1. **Platform Admin** ve solicitudes en /admin/requests
2. **Revisa informaciÃ³n** completa de la solicitud
3. **Toma decisiÃ³n**:

**Si APRUEBA**:
- status = 'approved', reviewed_by = admin_actual
- Crea business.companies con datos de solicitud
- Verifica si admin_email existe:
  - Si existe: AÃ±ade role 'company_admin'
  - Si no: Crea usuario completo + role
- EnvÃ­a credenciales por email
- Empresa puede operar inmediatamente

**Si RECHAZA**:
- status = 'rejected', rejection_reason obligatorio
- Email al solicitante con motivos
- Posibilidad de re-aplicar corrigiendo problemas

### 6.4. FLUJO DE COLABORACIÃ“N ENTRE AGENTES

#### NOTAS INTERNAS COLABORATIVAS
1. **Agente A** toma ticket complejo
2. **Investiga** pero necesita ayuda especÃ­fica
3. **AÃ±ade nota interna**: "Problema requiere conocimiento de bases de datos"
4. **Agente B** (experto en BD) ve nota en lista de tickets
5. **Agente B aÃ±ade** nota con soluciÃ³n: "El problema es X, soluciÃ³n Y"
6. **Agente A** implementa soluciÃ³n y responde al cliente
7. **CalificaciÃ³n** se atribuye al Agente A (propietario)

#### TRANSFERENCIA DE TICKETS
1. **Agente A** no puede resolver ticket
2. **Accede** a /agent/tickets/[id]
3. **Hace clic** en [Asignar a Otro]
4. **Selecciona** Agente B de la lista
5. **Sistema actualiza** owner_agent_id = Agente B
6. **NotificaciÃ³n** a Agente B
7. **Nota automÃ¡tica** registra la transferencia

================================================================================
## 7. CONFIGURACIONES TÃ‰CNICAS Y REGLAS DE NEGOCIO
================================================================================

### 7.1. TRIGGERS Y AUTOMATIZACIONES

#### Trigger de AsignaciÃ³n de Propietario
```sql
CREATE TRIGGER trigger_assign_ticket_owner
AFTER INSERT ON ticketing.ticket_responses
FOR EACH ROW
EXECUTE FUNCTION ticketing.assign_ticket_owner_function();
```

**Funcionalidad**:
- Se ejecuta automÃ¡ticamente al insertar respuesta
- Solo asigna si author_type = 'agent' y owner_agent_id IS NULL
- Actualiza owner_agent_id, first_response_at, status atÃ³micamente

#### Trigger de Updated_At
- Se aplica a todas las tablas principales
- Actualiza campo updated_at = NOW() en cada UPDATE
- Mantiene trazabilidad de modificaciones

#### Proceso de Cierre AutomÃ¡tico
- Cron job ejecuta diariamente a las 02:00
- Busca tickets resolved > 7 dÃ­as sin actividad
- Actualiza status = 'closed', closed_at = NOW()
- EnvÃ­a email de notificaciÃ³n al cliente

### 7.2. ÃNDICES DE PERFORMANCE

#### Ãndices CrÃ­ticos para Tickets
```sql
-- Para consultas por empresa y estado
CREATE INDEX idx_tickets_company_id_status
ON ticketing.tickets(company_id, status);

-- Para consultas por agente propietario
CREATE INDEX idx_tickets_owner_agent_id
ON ticketing.tickets(owner_agent_id)
WHERE owner_agent_id IS NOT NULL;

-- Para reportes y mÃ©tricas
CREATE INDEX idx_tickets_created_at
ON ticketing.tickets(created_at DESC);
```

#### Ãndices para AutenticaciÃ³n
```sql
-- Login optimizado
CREATE INDEX idx_users_email_password
ON auth.users(email, password_hash)
WHERE status = 'active';

-- GestiÃ³n de sesiones
CREATE INDEX idx_refresh_tokens_expires
ON auth.refresh_tokens(expires_at)
WHERE is_revoked = FALSE;
```

### 7.3. VISTAS CALCULADAS

#### Vista de Tickets con InformaciÃ³n Completa
```sql
CREATE VIEW ticketing.v_tickets_detail AS
SELECT
    t.*,
    c.name as company_name,
    u.email as created_by_email,
    concat(up.first_name, ' ', up.last_name) as created_by_name,
    a.email as owner_email,
    concat(ap.first_name, ' ', ap.last_name) as owner_name,
    cat.name as category_name
FROM ticketing.tickets t
JOIN business.companies c ON t.company_id = c.id
JOIN auth.users u ON t.created_by_user_id = u.id
LEFT JOIN auth.user_profiles up ON u.id = up.user_id
LEFT JOIN auth.users a ON t.owner_agent_id = a.id
LEFT JOIN auth.user_profiles ap ON a.id = ap.user_id
LEFT JOIN ticketing.categories cat ON t.category_id = cat.id;
```

#### Vista de MÃ©tricas de Agentes
```sql
CREATE VIEW ticketing.v_agent_metrics AS
SELECT
    t.owner_agent_id as agent_id,
    COUNT(DISTINCT t.id) as total_tickets,
    COUNT(DISTINCT CASE WHEN t.status = 'resolved' THEN t.id END) as resolved_tickets,
    AVG(EXTRACT(EPOCH FROM (t.first_response_at - t.created_at))/3600) as avg_first_response_hours,
    AVG(tr.rating) as avg_rating
FROM ticketing.tickets t
LEFT JOIN ticketing.ticket_ratings tr ON t.id = tr.ticket_id
WHERE t.owner_agent_id IS NOT NULL
GROUP BY t.owner_agent_id;
```

### 7.4. VALIDACIONES DE NEGOCIO

#### Roles Contextuales
- `platform_admin`: Sin company_id (gestiona todo)
- `user`: Sin company_id (puede crear tickets a cualquier empresa)
- `company_admin` y `agent`: Requieren company_id obligatorio
- Un usuario puede tener mÃºltiples roles con diferentes empresas

#### Estados de Ticket VÃ¡lidos
- **Transiciones permitidas**:
  - open â†’ pending (automÃ¡tico con primera respuesta de agente)
  - pending â†’ resolved (manual por agente)
  - resolved â†’ closed (automÃ¡tico despuÃ©s de 7 dÃ­as o manual)
  - resolved â†’ pending (si cliente reabre)
  - pending â†’ open (solo admin, casos excepcionales)

#### Restricciones de Acceso por Rol
- **Platform Admin**: Acceso total a todo el sistema
- **Company Admin**: Solo datos de su empresa (company_id = [su empresa])
- **Agent**: Solo tickets de su empresa + funciones de respuesta
- **User**: Solo sus propios tickets (created_by_user_id = [su id])

#### Validaciones de Email
- Ãšnicos en todo el sistema (auth.users.email)
- Formato RFC5322 vÃ¡lido
- VerificaciÃ³n obligatoria para ciertas acciones
- No permitir emails temporales/desechables

#### LÃ­mites del Sistema
- **Archivos adjuntos**: 10MB por archivo, 50MB total por ticket
- **Longitud de textos**: title max 255 chars, description ilimitada
- **Tickets por usuario**: Sin lÃ­mite, pero rate limiting para prevenir spam
- **Sesiones simultÃ¡neas**: MÃ¡ximo 10 por usuario

### 7.5. CONFIGURACIONES DE SEGURIDAD

#### AutenticaciÃ³n JWT
```json
{
  "access_token": {
    "algorithm": "HS256",
    "expiration": "15 minutes",
    "payload": {
      "user_id": "uuid",
      "email": "user@example.com",
      "roles": ["user", "agent"],
      "company_context": "uuid_if_applicable"
    }
  },
  "refresh_token": {
    "expiration": "30 days",
    "storage": "database_hashed",
    "rotation": "on_every_use"
  }
}
```

#### Rate Limiting
- **Login**: 5 intentos por IP cada 15 minutos
- **Registro**: 3 registros por IP cada hora
- **API calls**: 1000 requests por usuario por hora
- **File uploads**: 10 archivos por usuario por minuto

#### Audit Logging
- Todas las acciones crÃ­ticas se registran en audit.audit_logs
- Incluye: user_id, action, table_name, old_values, new_values
- RetenciÃ³n: 2 aÃ±os para cumplimiento legal
- Acceso: Solo platform_admin

#### EncriptaciÃ³n
- **Passwords**: bcrypt con cost factor 12
- **Tokens**: SHA-256 hash antes de almacenar
- **Datos sensibles**: tax_id encriptado en aplicaciÃ³n (AES-256)
- **ComunicaciÃ³n**: HTTPS obligatorio en producciÃ³n

================================================================================
## 8. NOTIFICACIONES Y COMUNICACIONES
================================================================================

### 8.1. SISTEMA DE NOTIFICACIONES EN TIEMPO REAL

#### Canales de NotificaciÃ³n
1. **Web Push**: Notificaciones del navegador
2. **Email**: Templates personalizados por empresa
3. **In-App**: Notificaciones dentro de la interfaz
4. **SMS**: Para casos crÃ­ticos (futuro)

#### Eventos que Generan Notificaciones

**Para Usuarios**:
- Nuevo ticket creado (confirmaciÃ³n)
- Respuesta de agente recibida
- Ticket marcado como resuelto
- Ticket cerrado automÃ¡ticamente
- Nuevo anuncio de empresa seguida

**Para Agentes**:
- Nuevo ticket sin asignar en su empresa
- Respuesta de cliente en sus tickets
- Ticket escalado por admin
- MenciÃ³n en nota interna (@agent)
- Ticket sin respuesta >24 horas

**Para Company Admins**:
- Nuevos agentes se unen al equipo
- Tickets sin respuesta >48 horas
- Calificaciones bajas recibidas
- MÃ©tricas semanales del equipo

**Para Platform Admins**:
- Nueva solicitud de empresa
- Empresa suspendida por problemas
- MÃ©tricas globales semanales
- Errores crÃ­ticos del sistema

### 8.2. TEMPLATES DE EMAIL

#### Template Base Corporativo
```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>
        .header { background: {{company.primary_color}}; }
        .logo { max-height: 60px; }
        .content { font-family: Arial, sans-serif; }
    </style>
</head>
<body>
    <div class="header">
        <img src="{{company.logo_url}}" class="logo" alt="{{company.name}}">
    </div>
    <div class="content">
        {{email_body}}
    </div>
    <footer>
        <p>{{company.name}} - Sistema de Soporte</p>
        <p>{{company.support_email}}</p>
    </footer>
</body>
</html>
```

#### Template: Nuevo Ticket Creado
```
Asunto: Ticket {{ticket.code}} creado exitosamente

Hola {{user.first_name}},

Tu ticket ha sido creado exitosamente:

NÃºmero de ticket: {{ticket.code}}
TÃ­tulo: {{ticket.title}}
Empresa: {{company.name}}
CategorÃ­a: {{category.name}}

DescripciÃ³n:
{{ticket.initial_description}}

Tiempo estimado de respuesta: {{company.sla_response_time}} horas

Puedes seguir el progreso en: {{ticket_url}}

Saludos,
Equipo de {{company.name}}
```

#### Template: Respuesta de Agente
```
Asunto: Respuesta a tu ticket {{ticket.code}}

Hola {{user.first_name}},

{{agent.first_name}} {{agent.last_name}} ha respondido a tu ticket:

{{response.content}}

{% if response.attachments %}
Archivos adjuntos:
{% for file in response.attachments %}
- {{file.name}} ({{file.size}})
{% endfor %}
{% endif %}

Responder: {{ticket_url}}

Saludos,
{{agent.first_name}} - {{company.name}}
```

#### Template: Ticket Resuelto
```
Asunto: Tu ticket {{ticket.code}} ha sido resuelto

Hola {{user.first_name}},

Â¡Buenas noticias! Tu ticket ha sido marcado como resuelto.

SoluciÃ³n proporcionada por: {{agent.first_name}} {{agent.last_name}}

Â¿Te ayudÃ³ esta soluciÃ³n? CalifÃ­canos:
{{rating_url}}

Si el problema persiste, puedes reabrir el ticket:
{{ticket_url}}

Gracias por usar nuestro servicio de soporte.

Equipo de {{company.name}}
```

### 8.3. CONFIGURACIÃ“N DE NOTIFICACIONES POR USUARIO

#### Preferencias Granulares
Cada usuario puede configurar en /settings:

**Notificaciones Web**:
- push_web_notifications (BOOLEAN)
- Respuestas a mis tickets
- Anuncios de empresas que sigo
- Recordatorios de tickets pendientes

**Notificaciones Email**:
- notifications_tickets (BOOLEAN)
- Frecuencia: [Inmediata] [Resumen diario] [Resumen semanal]
- Horario preferido para resÃºmenes

**Notificaciones In-App**:
- Siempre habilitadas
- Badge con contador en navbar
- Lista desplegable con Ãºltimas 10 notificaciones
- Marcar como leÃ­das individual o masivamente

================================================================================
## 9. REPORTES Y ANALÃTICAS
================================================================================

### 9.1. DASHBOARD DE MÃ‰TRICAS POR ROL

#### Platform Admin - MÃ©tricas Globales
**KPIs Principales**:
- Total de empresas activas/inactivas
- Crecimiento mensual de usuarios
- Total de tickets procesados
- Tiempo promedio de resoluciÃ³n global
- SatisfacciÃ³n promedio del sistema

**GrÃ¡ficos Detallados**:
- Tendencia de registro de empresas (por mes)
- DistribuciÃ³n de tickets por empresa
- Ranking de empresas por volumen
- Mapa de calor por paÃ­ses/regiones
- Uso de almacenamiento por empresa

#### Company Admin - MÃ©tricas Empresariales
**Dashboard Ejecutivo**:
- Tickets totales vs resueltos
- Tiempo promedio de primera respuesta
- DistribuciÃ³n por categorÃ­as
- Tendencia de volumen mensual
- CalificaciÃ³n promedio del equipo

**AnÃ¡lisis del Equipo**:
- Productividad por agente
- DistribuciÃ³n de carga de trabajo
- Agentes con mejor calificaciÃ³n
- Tiempo de respuesta por agente
- Tickets escalados o transferidos

#### Agent - MÃ©tricas Personales
**Performance Individual**:
- Tickets tomados vs resueltos
- Tiempo promedio de respuesta
- CalificaciÃ³n promedio recibida
- Tendencia de mejora mensual
- ComparaciÃ³n con promedio del equipo

### 9.2. REPORTES EXPORTABLES

#### Reporte de Tickets Detallado
**Filtros Disponibles**:
- Rango de fechas
- Estado de tickets
- Empresa (para platform_admin)
- Agente asignado
- CategorÃ­a
- CalificaciÃ³n mÃ­nima

**Columnas del Reporte**:
- Ticket Code, TÃ­tulo, Estado
- Cliente (nombre y email)
- Empresa, CategorÃ­a
- Agente Asignado
- Fechas: Creado, Primera Respuesta, Resuelto, Cerrado
- CalificaciÃ³n y Comentarios
- Tiempo Total de ResoluciÃ³n

#### Reporte de SatisfacciÃ³n del Cliente
**MÃ©tricas Incluidas**:
- CalificaciÃ³n promedio por perÃ­odo
- DistribuciÃ³n de calificaciones (1-5 estrellas)
- Comentarios positivos vs negativos
- Tendencia de satisfacciÃ³n mensual
- Top agentes por calificaciÃ³n
- CategorÃ­as con menor satisfacciÃ³n

#### Reporte de Productividad de Agentes
**Para Company Admin**:
- Tickets por agente por perÃ­odo
- Tiempo promedio de resoluciÃ³n
- Tickets reabiertos (indicador calidad)
- Uso de macros predefinidas
- ColaboraciÃ³n (notas internas aÃ±adidas)

### 9.3. ANALÃTICAS AVANZADAS

#### AnÃ¡lisis de Tendencias
- PredicciÃ³n de volumen de tickets
- IdentificaciÃ³n de patrones estacionales
- CategorÃ­as con crecimiento acelerado
- Horarios pico de creaciÃ³n de tickets
- Tiempo Ã³ptimo de respuesta por categorÃ­a

#### MÃ©tricas de Calidad
- CorrelaciÃ³n entre tiempo de respuesta y satisfacciÃ³n
- Impacto del uso de macros en calificaciones
- Efectividad del centro de ayuda (reducciÃ³n de tickets)
- Tasa de escalaciÃ³n por agente
- Tickets solucionados en primera respuesta

================================================================================
## 10. INTEGRACIONES Y API
================================================================================

### 10.1. API GRAPHQL PÃšBLICA

#### Endpoints Principales
```graphql
# AutenticaciÃ³n
mutation Login($email: String!, $password: String!) {
    login(email: $email, password: $password) {
        access_token
        refresh_token
        user {
            id
            email
            roles {
                code
                companyId
            }
        }
    }
}

# Crear Ticket
mutation CreateTicket($input: CreateTicketInput!) {
    createTicket(input: $input) {
        id
        ticketCode
        title
        status
        company {
            name
        }
    }
}

# Listar Tickets (con paginaciÃ³n)
query Tickets($filters: TicketFilters, $pagination: PaginationInput) {
    tickets(filters: $filters, pagination: $pagination) {
        edges {
            node {
                id
                ticketCode
                title
                status
                createdAt
                responses {
                    content
                    authorType
                    createdAt
                }
            }
        }
        pageInfo {
            hasNextPage
            endCursor
        }
    }
}
```

#### AutenticaciÃ³n API
- Bearer token en header Authorization
- Rate limiting: 1000 requests/hour por token
- Scopes por rol: read, write, admin
- API keys para integraciones externas

### 10.2. WEBHOOKS

#### Eventos Disponibles
```json
{
    "ticket.created": {
        "payload": {
            "ticket": {...},
            "company": {...},
            "customer": {...}
        }
    },
    "ticket.responded": {
        "payload": {
            "ticket": {...},
            "response": {...},
            "agent": {...}
        }
    },
    "ticket.resolved": {
        "payload": {
            "ticket": {...},
            "agent": {...},
            "resolution_time": "4.5 hours"
        }
    },
    "ticket.rated": {
        "payload": {
            "ticket": {...},
            "rating": {...},
            "agent": {...}
        }
    }
}
```

#### ConfiguraciÃ³n de Webhooks
En /empresa/settings, pestaÃ±a Integraciones:
- URL de destino
- Eventos a notificar (checkboxes)
- Secreto para verificaciÃ³n HMAC
- Reintentos automÃ¡ticos (3 veces con backoff)
- Logs de entregas exitosas/fallidas

### 10.3. INTEGRACIONES POPULARES

#### Slack Integration
**ConfiguraciÃ³n**:
- Webhook URL de Slack channel
- Mapeo de eventos a notificaciones
- Templates personalizables de mensajes

**Ejemplo de notificaciÃ³n**:
```
ðŸŽ« Nuevo ticket urgente
TKT-2025-00001: "Sistema de notas no funciona"
Cliente: MarÃ­a GonzÃ¡lez
Empresa: Universidad del Valle
ðŸ‘† Tomar ticket
```

#### Zapier/Make Integration
- Triggers: ticket_created, ticket_resolved, rating_received
- Actions: create_ticket, add_response, assign_agent
- Workflows populares:
  - Crear tickets desde emails
  - Notificar en Teams cuando hay ratings bajos
  - Crear tareas en Trello para tickets complejos

================================================================================
## 11. CONFIGURACIÃ“N Y DEPLOYMENT
================================================================================

### 11.1. VARIABLES DE ENTORNO

#### ConfiguraciÃ³n de Base de Datos
```env
# Database
DB_CONNECTION=pgsql
DB_HOST=localhost
DB_PORT=5432
DB_DATABASE=helpdesk_prod
DB_USERNAME=helpdesk_user
DB_PASSWORD=secure_password

# Esquemas personalizados
DB_SCHEMA_AUTH=auth
DB_SCHEMA_BUSINESS=business
DB_SCHEMA_TICKETING=ticketing
DB_SCHEMA_AUDIT=audit
```

#### ConfiguraciÃ³n de Email
```env
# Email Service
MAIL_MAILER=smtp
MAIL_HOST=smtp.empresa.com
MAIL_PORT=587
MAIL_USERNAME=soporte@helpdesk.com
MAIL_PASSWORD=email_password
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS=soporte@helpdesk.com
MAIL_FROM_NAME="Sistema Helpdesk"
```

#### ConfiguraciÃ³n de Archivos
```env
# File Storage
FILESYSTEM_DISK=s3
AWS_ACCESS_KEY_ID=your_access_key
AWS_SECRET_ACCESS_KEY=your_secret_key
AWS_DEFAULT_REGION=us-east-1
AWS_BUCKET=helpdesk-attachments
AWS_URL=https://helpdesk-attachments.s3.amazonaws.com

# File Limits
MAX_FILE_SIZE=10485760  # 10MB in bytes
MAX_TOTAL_SIZE=52428800 # 50MB in bytes
ALLOWED_FILE_TYPES=jpg,jpeg,png,pdf,doc,docx,txt
```

#### ConfiguraciÃ³n de Seguridad
```env
# JWT Configuration
JWT_SECRET=your-super-secure-jwt-secret-key
JWT_TTL=15  # Access token TTL in minutes
JWT_REFRESH_TTL=43200  # Refresh token TTL in minutes (30 days)

# Rate Limiting
RATE_LIMIT_LOGIN=5    # Login attempts per 15 minutes
RATE_LIMIT_API=1000   # API calls per hour
RATE_LIMIT_UPLOAD=10  # File uploads per minute

# Security
APP_ENV=production
APP_DEBUG=false
APP_KEY=base64:generated-key
```

### 11.2. CONFIGURACIÃ“N DE SERVIDOR

#### Nginx Configuration
```nginx
server {
    listen 80;
    server_name helpdesk.empresa.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name helpdesk.empresa.com;

    ssl_certificate /path/to/certificate.crt;
    ssl_certificate_key /path/to/private.key;

    root /var/www/helpdesk/public;
    index index.php;

    # GraphQL endpoint
    location /graphql {
        try_files $uri $uri/ /index.php?$query_string;
        client_max_body_size 50M;
    }

    # File uploads
    location /storage/attachments {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # PHP processing
    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
        client_max_body_size 50M;
    }
}
```

#### PHP Configuration (php.ini)
```ini
; File uploads
upload_max_filesize = 50M
post_max_size = 50M
max_file_uploads = 20

; Memory and execution
memory_limit = 256M
max_execution_time = 300
max_input_time = 300

; Sessions
session.lifetime = 1440
session.gc_maxlifetime = 1440

; Timezone
date.timezone = "America/La_Paz"
```

### 11.3. SCRIPTS DE DEPLOYMENT

#### Production Deployment Script
```bash
#!/bin/bash
# deploy.sh

echo "ðŸš€ Deploying Helpdesk System..."

# Backup database
pg_dump helpdesk_prod > backups/backup_$(date +%Y%m%d_%H%M%S).sql

# Pull latest code
git pull origin main

# Install dependencies
composer install --no-dev --optimize-autoloader
npm ci && npm run build

# Run migrations
php artisan migrate --force

# Clear caches
php artisan config:cache
php artisan route:cache
php artisan view:cache

# Restart services
sudo systemctl reload nginx
sudo systemctl restart php8.2-fpm

# Restart queue workers
php artisan queue:restart

echo "âœ… Deployment completed successfully!"
```

#### Database Backup Script
```bash
#!/bin/bash
# backup.sh

BACKUP_DIR="/var/backups/helpdesk"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/helpdesk_backup_$DATE.sql"

# Create backup directory if not exists
mkdir -p $BACKUP_DIR

# Create database backup
pg_dump -h localhost -U helpdesk_user -d helpdesk_prod > $BACKUP_FILE

# Compress backup
gzip $BACKUP_FILE

# Remove backups older than 30 days
find $BACKUP_DIR -name "*.sql.gz" -mtime +30 -delete

echo "âœ… Backup created: $BACKUP_FILE.gz"
```

================================================================================
## 12. MANTENIMIENTO Y MONITOREO
================================================================================

### 12.1. COMANDOS ARTISAN PERSONALIZADOS

#### Limpiar Datos Obsoletos
```bash
# Limpiar tokens expirados
php artisan helpdesk:clean-expired-tokens

# Cerrar tickets resueltos automÃ¡ticamente
php artisan helpdesk:auto-close-tickets

# Limpiar archivos huÃ©rfanos
php artisan helpdesk:clean-orphaned-files

# Generar reportes automÃ¡ticos
php artisan helpdesk:generate-weekly-reports
```

#### Comandos de Mantenimiento
```bash
# Verificar integridad de datos
php artisan helpdesk:verify-data-integrity

# Recalcular mÃ©tricas de agentes
php artisan helpdesk:recalculate-agent-metrics

# Optimizar base de datos
php artisan helpdesk:optimize-database

# Enviar notificaciones pendientes
php artisan helpdesk:send-pending-notifications
```

### 12.2. CRON JOBS

#### ProgramaciÃ³n de Tareas
```bash
# /etc/crontab

# Cerrar tickets resueltos cada dÃ­a a las 2 AM
0 2 * * * www-data php /var/www/helpdesk/artisan helpdesk:auto-close-tickets

# Limpiar tokens expirados cada hora
0 * * * * www-data php /var/www/helpdesk/artisan helpdesk:clean-expired-tokens

# Backup diario a las 3 AM
0 3 * * * www-data /var/www/helpdesk/scripts/backup.sh

# Reportes semanales los lunes a las 8 AM
0 8 * * 1 www-data php /var/www/helpdesk/artisan helpdesk:generate-weekly-reports

# Verificar salud del sistema cada 15 minutos
*/15 * * * * www-data php /var/www/helpdesk/artisan helpdesk:health-check
```

### 12.3. MONITOREO Y ALERTAS

#### MÃ©tricas de Sistema
**Performance**:
- Tiempo de respuesta promedio de API
- Uso de memoria y CPU
- Espacio en disco disponible
- Conexiones activas a base de datos

**AplicaciÃ³n**:
- Tickets creados por hora
- Tiempo promedio de resoluciÃ³n
- Errores 500 por minuto
- Usuarios activos simultÃ¡neos

**Base de Datos**:
- Tiempo de consultas lentas (>1s)
- Bloqueos de transacciones
- TamaÃ±o de logs de transacciones
- Ãndices no utilizados

#### Alertas Configuradas
```yaml
# alerts.yml
alerts:
  - name: "High Response Time"
    condition: "avg_response_time > 2000ms"
    severity: "warning"
    notification: "slack"

  - name: "Database Connection Pool Full"
    condition: "db_connections > 80%"
    severity: "critical"
    notification: "email,slack"

  - name: "High Error Rate"
    condition: "error_rate > 5%"
    severity: "critical"
    notification: "email,sms"

  - name: "Disk Space Low"
    condition: "disk_usage > 85%"
    severity: "warning"
    notification: "email"
```

================================================================================
## 13. PRUEBAS Y CALIDAD
================================================================================

### 13.1. ESTRATEGIA DE TESTING

#### Tests Unitarios
**Coverage Objetivo**: 85% mÃ­nimo

**Ãreas CrÃ­ticas**:
- Services de cada feature (100% coverage)
- Modelos Eloquent y relaciones
- Helpers y utilidades
- Validaciones de negocio
- Transformaciones de datos

**Ejemplo de Test**:
```php
// tests/Unit/Features/Authentication/AuthServiceTest.php
class AuthServiceTest extends TestCase
{
    public function test_login_with_valid_credentials()
    {
        $user = User::factory()->create([
            'email_verified' => true,
            'status' => 'active'
        ]);

        $result = $this->authService->login($user->email, 'password');

        $this->assertArrayHasKey('access_token', $result);
        $this->assertArrayHasKey('user', $result);
        $this->assertEquals($user->id, $result['user']['id']);
    }

    public function test_login_fails_with_unverified_email()
    {
        $user = User::factory()->create([
            'email_verified' => false
        ]);

        $this->expectException(EmailNotVerifiedException::class);

        $this->authService->login($user->email, 'password');
    }
}
```

#### Tests de Feature
**Endpoints GraphQL**: 100% coverage de mutations y queries crÃ­ticas

```php
// tests/Feature/Authentication/LoginTest.php
class LoginTest extends TestCase
{
    public function test_login_mutation_success()
    {
        $user = User::factory()->create(['email_verified' => true]);

        $response = $this->graphQL(/** @lang GraphQL */ '
            mutation {
                login(email: "' . $user->email . '", password: "password") {
                    access_token
                    user {
                        id
                        email
                    }
                }
            }
        ');

        $response->assertJson([
            'data' => [
                'login' => [
                    'user' => [
                        'email' => $user->email
                    ]
                ]
            ]
        ]);
    }
}
```

#### Tests de IntegraciÃ³n
**Flujos Completos**:
- Registro â†’ VerificaciÃ³n â†’ Login â†’ Crear Ticket â†’ Responder â†’ Resolver â†’ Calificar
- Solicitud Empresa â†’ AprobaciÃ³n â†’ ConfiguraciÃ³n â†’ Invitar Agentes
- EscalaciÃ³n de tickets entre agentes
- Notificaciones end-to-end

### 13.2. TESTS DE PERFORMANCE

#### Load Testing
```javascript
// k6-load-test.js
import http from 'k6/http';
import { check } from 'k6';

export let options = {
    stages: [
        { duration: '2m', target: 100 }, // Ramp up
        { duration: '5m', target: 100 }, // Stay at 100 users
        { duration: '2m', target: 200 }, // Ramp up to 200 users
        { duration: '5m', target: 200 }, // Stay at 200 users
        { duration: '2m', target: 0 },   // Ramp down
    ],
};

export default function() {
    // Test login endpoint
    let loginResponse = http.post('https://api.helpdesk.com/graphql', {
        query: `
            mutation {
                login(email: "test@example.com", password: "password") {
                    access_token
                }
            }
        `
    });

    check(loginResponse, {
        'login status is 200': (r) => r.status === 200,
        'response time < 500ms': (r) => r.timings.duration < 500,
    });
}
```

#### Stress Testing
- Concurrencia mÃ¡xima soportada
- Punto de quiebre del sistema
- RecuperaciÃ³n despuÃ©s de sobrecarga
- Comportamiento con base de datos bajo estrÃ©s

### 13.3. CALIDAD DE CÃ“DIGO

#### Code Standards
```json
// phpcs.xml
{
    "standard": "PSR-12",
    "files": ["app/", "tests/"],
    "exclude": ["vendor/", "storage/"],
    "rules": {
        "complexity": 10,
        "max_line_length": 120,
        "method_length": 50
    }
}
```

#### Static Analysis
```bash
# PHPStan configuration
composer require --dev phpstan/phpstan

# AnÃ¡lisis estÃ¡tico nivel 8 (mÃ¡ximo)
./vendor/bin/phpstan analyse app/ --level=8

# Larastan para Laravel especÃ­fico
composer require --dev nunomaduro/larastan
```

#### Code Review Checklist
- [ ] Seguimiento de principios SOLID
- [ ] Cobertura de tests adecuada
- [ ] DocumentaciÃ³n PHPDoc completa
- [ ] ValidaciÃ³n de inputs usuario
- [ ] Manejo apropiado de errores
- [ ] Performance optimizado (N+1 queries)
- [ ] Seguridad evaluada
- [ ] Compatibilidad con DB schema V7.0

================================================================================
## 14. CASOS DE USO AVANZADOS
================================================================================

### 14.1. ESCALACIÃ“N AUTOMÃTICA DE TICKETS

#### Reglas de EscalaciÃ³n
**Tiempo de Respuesta**:
- Ticket sin respuesta >24h: Notificar company_admin
- Ticket sin respuesta >48h: Escalar a platform_admin
- Ticket resolved sin calificaciÃ³n >7 dÃ­as: Auto-cerrar

**CalificaciÃ³n Baja**:
- Rating â‰¤2 estrellas: Notificar company_admin inmediatamente
- 3 ratings bajos del mismo agente en 1 semana: Suspender temporalmente
- Promedio de empresa <3.5: ReuniÃ³n obligatoria con platform_admin

#### ImplementaciÃ³n TÃ©cnica
```php
// app/Jobs/TicketEscalationJob.php
class TicketEscalationJob implements ShouldQueue
{
    public function handle()
    {
        // Tickets sin respuesta >24h
        $unrespondedTickets = Ticket::where('status', 'open')
            ->where('created_at', '<', now()->subHours(24))
            ->with('company.admin')
            ->get();

        foreach ($unrespondedTickets as $ticket) {
            // Notificar company_admin
            $ticket->company->admin->notify(
                new TicketEscalationNotification($ticket, '24_hours')
            );

            // Crear nota interna automÃ¡tica
            TicketInternalNote::create([
                'ticket_id' => $ticket->id,
                'agent_id' => null, // Sistema
                'note_content' => 'ðŸš¨ Escalado automÃ¡ticamente: Sin respuesta por 24 horas'
            ]);
        }
    }
}
```

### 14.2. SISTEMA DE PRIORIDADES INTELIGENTE

#### Algoritmo de PriorizaciÃ³n
**Factores de Peso**:
- Tiempo sin respuesta: 40%
- Tipo de cliente (empresa premium): 25%
- CategorÃ­a del problema: 20%
- Historial del cliente: 15%

**CÃ¡lculo de Prioridad**:
```php
public function calculatePriority(Ticket $ticket): int
{
    $priority = 0;

    // Tiempo sin respuesta (0-40 puntos)
    $hoursWithoutResponse = $ticket->created_at->diffInHours(now());
    $priority += min(40, $hoursWithoutResponse * 2);

    // Tipo de empresa (0-25 puntos)
    if ($ticket->company->subscription_tier === 'premium') {
        $priority += 25;
    } elseif ($ticket->company->subscription_tier === 'business') {
        $priority += 15;
    }

    // CategorÃ­a crÃ­tica (0-20 puntos)
    $criticalCategories = ['sistema_caido', 'seguridad', 'perdida_datos'];
    if (in_array($ticket->category->slug, $criticalCategories)) {
        $priority += 20;
    }

    // Historial del cliente (0-15 puntos)
    $userTicketCount = $ticket->customer->tickets()->count();
    if ($userTicketCount === 1) { // Primer ticket
        $priority += 15;
    } elseif ($userTicketCount > 10) { // Cliente frecuente
        $priority += 10;
    }

    return min(100, $priority);
}
```

### 14.3. COLABORACIÃ“N AVANZADA ENTRE AGENTES

#### Sistema de Expertise Tags
**ConfiguraciÃ³n por Agente**:
```json
{
    "agent_id": "uuid",
    "expertise_tags": [
        "database", "frontend", "api", "mobile", "security"
    ],
    "availability": {
        "monday": {"start": "09:00", "end": "17:00"},
        "tuesday": {"start": "09:00", "end": "17:00"}
    },
    "workload_limit": 15
}
```

#### Auto-AsignaciÃ³n Inteligente
```php
public function findBestAgent(Ticket $ticket): ?Agent
{
    $categoryKeywords = $this->extractKeywords($ticket->title . ' ' . $ticket->description);

    return Agent::where('company_id', $ticket->company_id)
        ->where('is_active', true)
        ->where('current_workload', '<', 'workload_limit')
        ->whereJsonContains('expertise_tags', $categoryKeywords)
        ->orderBy('avg_rating', 'desc')
        ->orderBy('current_workload', 'asc')
        ->first();
}
```

### 14.4. INTEGRACIÃ“N CON HERRAMIENTAS EXTERNAS

#### Slack Bot Integration
```javascript
// slack-bot.js
const { WebClient } = require('@slack/web-api');

class HelpdeskSlackBot {
    constructor(token) {
        this.client = new WebClient(token);
    }

    async notifyNewTicket(ticket) {
        await this.client.chat.postMessage({
            channel: '#support',
            blocks: [
                {
                    type: 'section',
                    text: {
                        type: 'mrkdwn',
                        text: `ðŸŽ« *Nuevo ticket urgente*\n*${ticket.code}*: ${ticket.title}`
                    }
                },
                {
                    type: 'section',
                    fields: [
                        {
                            type: 'mrkdwn',
                            text: `*Cliente:*\n${ticket.customer.name}`
                        },
                        {
                            type: 'mrkdwn',
                            text: `*Empresa:*\n${ticket.company.name}`
                        }
                    ]
                },
                {
                    type: 'actions',
                    elements: [
                        {
                            type: 'button',
                            text: {
                                type: 'plain_text',
                                text: 'Tomar Ticket'
                            },
                            url: `https://helpdesk.com/agent/tickets/${ticket.id}`,
                            style: 'primary'
                        }
                    ]
                }
            ]
        });
    }
}
```

#### Microsoft Teams Integration
```csharp
// TeamsWebhook.cs
public class TeamsWebhook
{
    public async Task SendTicketNotification(Ticket ticket)
    {
        var webhook = new TeamsWebhookClient(webhookUrl);

        var card = new MessageCard
        {
            Title = $"Nuevo ticket: {ticket.Code}",
            Text = ticket.Title,
            ThemeColor = "FF6D00",
            Sections = new List<MessageCardSection>
            {
                new MessageCardSection
                {
                    ActivityTitle = ticket.Customer.Name,
                    ActivitySubtitle = ticket.Company.Name,
                    Facts = new List<MessageCardFact>
                    {
                        new MessageCardFact("CategorÃ­a", ticket.Category.Name),
                        new MessageCardFact("Creado", ticket.CreatedAt.ToString("dd/MM/yyyy HH:mm"))
                    }
                }
            },
            PotentialAction = new List<MessageCardAction>
            {
                new MessageCardOpenUriAction
                {
                    Name = "Ver Ticket",
                    Targets = new List<MessageCardActionTarget>
                    {
                        new MessageCardActionTarget
                        {
                            Os = "default",
                            Uri = $"https://helpdesk.com/agent/tickets/{ticket.Id}"
                        }
                    }
                }
            }
        };

        await webhook.SendMessageAsync(card);
    }
}
```

================================================================================
## 15. SEGURIDAD AVANZADA
================================================================================

### 15.1. PROTECCIÃ“N CONTRA ATAQUES COMUNES

#### Rate Limiting Granular
```php
// config/rate-limiting.php
return [
    'login' => [
        'max_attempts' => 5,
        'decay_minutes' => 15,
        'lockout_duration' => 60, // minutos
    ],
    'password_reset' => [
        'max_attempts' => 3,
        'decay_minutes' => 60,
    ],
    'api_calls' => [
        'per_minute' => 60,
        'per_hour' => 1000,
        'burst_allowance' => 10,
    ],
    'file_uploads' => [
        'per_minute' => 10,
        'max_size_mb' => 50,
        'allowed_types' => ['jpg', 'png', 'pdf', 'doc', 'docx'],
    ]
];
```

#### SQL Injection Prevention
- Uso exclusivo de Eloquent ORM
- Prepared statements para consultas raw
- ValidaciÃ³n estricta de inputs
- SanitizaciÃ³n de parÃ¡metros de consulta

#### XSS Protection
```php
// Middleware/XSSProtection.php
class XSSProtection
{
    public function handle($request, Closure $next)
    {
        // Sanitizar todos los inputs
        $input = $request->all();
        array_walk_recursive($input, function(&$input) {
            $input = strip_tags($input);
        });

        $request->merge($input);

        return $next($request);
    }
}
```

### 15.2. AuditorÃ­a y Compliance

#### GDPR Compliance
**Derechos del Usuario**:
- **Acceso**: Export completo de datos personales
- **RectificaciÃ³n**: EdiciÃ³n de perfil y datos
- **EliminaciÃ³n**: Soft delete con anonimizaciÃ³n
- **Portabilidad**: Export en formato JSON/CSV
- **RestricciÃ³n**: Opt-out de notificaciones

**ImplementaciÃ³n**:
```php
// app/Services/GDPRService.php
class GDPRService
{
    public function exportUserData(User $user): array
    {
        return [
            'personal_data' => $user->profile->toArray(),
            'tickets' => $user->tickets()->with('responses')->get(),
            'ratings' => $user->ratings()->get(),
            'notifications' => $user->notifications()->get(),
            'audit_logs' => AuditLog::where('user_id', $user->id)->get(),
        ];
    }

    public function anonymizeUser(User $user): void
    {
        DB::transaction(function() use ($user) {
            // Anonimizar datos personales
            $user->update([
                'email' => 'deleted_' . $user->id . '@deleted.com',
            ]);

            $user->profile->update([
                'first_name' => 'Usuario',
                'last_name' => 'Eliminado',
                'phone_number' => null,
                'avatar_url' => null,
            ]);

            // Mantener tickets para integridad, pero anonimizar
            $user->tickets()->update([
                'created_by_user_id' => null, // Usuario anÃ³nimo
            ]);
        });
    }
}
```

#### SOX Compliance (para empresas pÃºblicas)
**Controles Internos**:
- SegregaciÃ³n de funciones: SeparaciÃ³n entre creaciÃ³n y aprobaciÃ³n
- AuditorÃ­a completa: Todos los cambios loggeados
- Acceso basado en roles: Principio de menor privilegio
- RevisiÃ³n periÃ³dica: AuditorÃ­as trimestrales de accesos

### 15.3. Backup y Disaster Recovery

#### Estrategia de Backup 3-2-1
- **3 copias** de datos crÃ­ticos
- **2 medios** diferentes (local + cloud)
- **1 copia offsite** (geogrÃ¡ficamente separada)

#### Automated Backup System
```bash
#!/bin/bash
# disaster-recovery.sh

# Variables
BACKUP_DIR="/var/backups/helpdesk"
S3_BUCKET="helpdesk-dr-backups"
ENCRYPTION_KEY="/etc/helpdesk/backup.key"

# Database backup
pg_dump -h $DB_HOST -U $DB_USER $DB_NAME | \
    gzip | \
    gpg --cipher-algo AES256 --compress-algo 1 --symmetric --output \
    "$BACKUP_DIR/db_$(date +%Y%m%d_%H%M%S).sql.gz.gpg" \
    --passphrase-file $ENCRYPTION_KEY

# File storage backup
tar -czf "$BACKUP_DIR/files_$(date +%Y%m%d_%H%M%S).tar.gz" \
    /var/www/helpdesk/storage/app/attachments

# Upload to S3
aws s3 sync $BACKUP_DIR s3://$S3_BUCKET/$(date +%Y/%m/%d)/ \
    --delete --storage-class GLACIER

# Cleanup local backups older than 7 days
find $BACKUP_DIR -name "*.gz.gpg" -mtime +7 -delete
```

#### Recovery Procedures
```sql
-- restore-database.sql
-- 1. Create new database
CREATE DATABASE helpdesk_restored;

-- 2. Restore from backup
-- psql helpdesk_restored < backup_file.sql

-- 3. Verify data integrity
SELECT
    'users' as table_name,
    count(*) as record_count
FROM auth.users
UNION ALL
SELECT
    'tickets' as table_name,
    count(*) as record_count
FROM ticketing.tickets;

-- 4. Update configuration if needed
UPDATE business.companies
SET status = 'maintenance'
WHERE status = 'active';
```

================================================================================
## CONCLUSIÃ“N Y PRÃ“XIMOS PASOS
================================================================================

### RESUMEN EJECUTIVO

Este documento representa la especificaciÃ³n funcional definitiva del Sistema Helpdesk V8.0, un sistema enterprise-grade diseÃ±ado para manejar operaciones de soporte multi-tenant a escala. La arquitectura feature-first garantiza escalabilidad horizontal, mientras que la base de datos PostgreSQL V7.0 con esquemas separados proporciona una fundaciÃ³n sÃ³lida para crecimiento futuro.

### CARACTERÃSTICAS PRINCIPALES IMPLEMENTADAS

âœ… **Sistema Multi-Tenant Completo**: Empresas independientes con configuraciones personalizadas
âœ… **Roles Granulares**: Platform Admin, Company Admin, Agent, User con permisos contextuales
âœ… **Ciclo de Vida Automatizado**: AsignaciÃ³n automÃ¡tica de tickets via triggers de BD
âœ… **ColaboraciÃ³n Inteligente**: Notas internas y transferencia de tickets entre agentes
âœ… **Sistema de Calificaciones**: Feedback centrado en resoluciÃ³n, no en agentes individuales
âœ… **Centro de Ayuda DinÃ¡mico**: Contenido personalizado por empresa
âœ… **Notificaciones Multi-Canal**: Email, web push, in-app notifications
âœ… **API GraphQL Completa**: Endpoints optimizados con DataLoaders
âœ… **Seguridad Enterprise**: JWT, rate limiting, audit logs, GDPR compliance
âœ… **Reportes y AnalÃ­ticas**: Dashboards por rol con mÃ©tricas en tiempo real
