# ================================================================================
# COMPANY MANAGEMENT FEATURE SCHEMA - Sistema Helpdesk V8.0
# Schema BÁSICO para soportar UserManagement sin loops infinitos
# Solo funcionalidades esenciales para validar roles de agentes
# ================================================================================

extend type Query {
    """
    Lista de empresas públicas disponibles
    Para registro de usuarios y selección de contexto
    """
    publicCompanies(
        """Filtros de búsqueda básicos"""
        search: String
        """Solo empresas activas"""
        activeOnly: Boolean = true
        """Paginación"""
        first: Int = 20
    ): [CompanyPublicInfo!]!
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Queries\\PublicCompaniesQuery")
        @cache(ttl: 300, key: "public_companies")

    """
    Información básica de una empresa específica
    Accesible por usuarios que tienen relación con la empresa
    """
    company(id: UUID!): Company
        @auth
        @can(ability: "view", model: "Company", find: "id")
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Queries\\CompanyQuery")

    """
    Empresas donde el usuario actual tiene roles
    Útil para selector de contexto empresarial
    """
    myCompanies: [CompanyBasicInfo!]!
        @auth
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Queries\\MyCompaniesQuery")

    """
    Lista completa de empresas (solo admins)
    Para gestión administrativa del sistema
    """
    companies(
        """Filtros administrativos"""
        filters: CompanyFilters
        """Ordenamiento"""
        orderBy: [CompanyOrderBy!]
        """Paginación"""
        page: Int = 1
        first: Int = 15
    ): CompanyPaginator!
        @auth(requires: [PLATFORM_ADMIN])
        @paginate(maxCount: 50)
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Queries\\CompaniesQuery")

    """
    Solicitudes pendientes de empresas
    Solo para administradores de plataforma
    """
    companyRequests(
        """Filtrar por estado"""
        status: CompanyRequestStatus
        """Paginación"""
        first: Int = 15
    ): [CompanyRequest!]!
        @auth(requires: [PLATFORM_ADMIN])
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Queries\\CompanyRequestsQuery")
}

extend type Mutation {
    # ===== SOLICITUD PÚBLICA DE EMPRESA =====
    """
    Solicitar creación de nueva empresa
    Proceso público que requiere aprobación admin
    """
    requestCompany(input: CompanyRequestInput!): CompanyRequest!
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Mutations\\RequestCompanyMutation")
        @rateLimit(max: 3, window: 3600, message: "Solo 3 solicitudes por hora")

    # ===== GESTIÓN ADMIN DE SOLICITUDES =====
    """
    Aprobar solicitud de empresa
    Crea automáticamente la empresa y asigna admin
    """
    approveCompanyRequest(requestId: UUID!): Company!
        @auth(requires: [PLATFORM_ADMIN])
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Mutations\\ApproveCompanyRequestMutation")
        @audit(action: "approve_company_request", includePayload: true)

    """
    Rechazar solicitud de empresa
    Requiere motivo para feedback al solicitante
    """
    rejectCompanyRequest(requestId: UUID!, reason: String!): Boolean!
        @auth(requires: [PLATFORM_ADMIN])
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Mutations\\RejectCompanyRequestMutation")
        @audit(action: "reject_company_request", includePayload: true)

    # ===== GESTIÓN BÁSICA DE EMPRESAS =====
    """
    Crear empresa directamente (solo platform admin)
    Para casos especiales sin proceso de solicitud
    """
    createCompany(input: CreateCompanyInput!): Company!
        @auth(requires: [PLATFORM_ADMIN])
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Mutations\\CreateCompanyMutation")
        @audit(action: "create_company", includePayload: true)
        @rateLimit(max: 10, window: 3600)

    """
    Actualizar información básica de empresa
    Solo company admin de esa empresa o platform admin
    """
    updateCompany(id: UUID!, input: UpdateCompanyInput!): Company!
        @auth(requires: [PLATFORM_ADMIN, COMPANY_ADMIN])
        @can(ability: "update", model: "Company", find: "id")
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Mutations\\UpdateCompanyMutation")
        @audit(action: "update_company", includePayload: true)

    """
    Suspender empresa temporalmente
    Desactiva todos los agentes y bloquea operaciones
    """
    suspendCompany(id: UUID!, reason: String!): Company!
        @auth(requires: [PLATFORM_ADMIN])
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Mutations\\SuspendCompanyMutation")
        @audit(action: "suspend_company", includePayload: true)

    """
    Reactivar empresa suspendida
    Restaura operaciones normales
    """
    activateCompany(id: UUID!): Company!
        @auth(requires: [PLATFORM_ADMIN])
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Mutations\\ActivateCompanyMutation")
        @audit(action: "activate_company")
}

# ================================================================================
# TYPES PRINCIPALES - Empresa completa SIN loops infinitos
# ================================================================================

"""
Empresa completa para gestión administrativa
NO incluye listas de usuarios/tickets para evitar loops infinitos
Usa contadores y referencias básicas únicamente
"""
type Company implements Node & Timestamped & BelongsToCompany {
    # ===== IDENTIFICADORES =====
    """ID único de la empresa"""
    id: UUID!

    """Código único legible (CMP-2025-00001)"""
    companyCode: String!

    # ===== INFORMACIÓN BÁSICA =====
    """Nombre comercial de la empresa"""
    name: String!

    """Razón social completa"""
    legalName: String

    """Email público de soporte"""
    supportEmail: Email

    """Teléfono de contacto"""
    phone: PhoneNumber

    """Sitio web oficial"""
    website: URL

    # ===== INFORMACIÓN DE CONTACTO =====
    """Dirección completa de contacto"""
    contactAddress: String

    """Ciudad de ubicación"""
    contactCity: String

    """Estado o departamento"""
    contactState: String

    """País de ubicación"""
    contactCountry: String

    """Código postal"""
    contactPostalCode: String

    # ===== INFORMACIÓN LEGAL =====
    """RUT, NIT o identificador fiscal"""
    taxId: String

    """Representante legal de la empresa"""
    legalRepresentative: String

    # ===== CONFIGURACIÓN OPERATIVA =====
    """Horarios de atención por día (JSON)"""
    businessHours: JSON!

    """Zona horaria de operación"""
    timezone: String!

    # ===== BRANDING =====
    """URL del logo principal"""
    logoUrl: URL

    """URL del favicon"""
    faviconUrl: URL

    """Color primario de la marca"""
    primaryColor: HexColor!

    """Color secundario de la marca"""
    secondaryColor: HexColor!

    # ===== ESTADO Y CONFIGURACIÓN =====
    """Estado actual de la empresa"""
    status: CompanyStatus!

    """Configuraciones adicionales (JSON)"""
    settings: JSON

    # ===== RELACIONES BÁSICAS (SIN LOOPS) =====
    """Administrador principal de la empresa"""
    admin: UserBasicInfo!

    """Información básica para cumplir interfaz BelongsToCompany"""
    companyId: UUID!
    companyInfo: CompanyBasicInfo!

    # ===== ESTADÍSTICAS (EVITA LOOPS) =====
    """Total de agentes activos"""
    activeAgentsCount: Int!

    """Total de usuarios con roles en esta empresa"""
    totalUsersCount: Int!

    """Total de tickets creados"""
    totalTicketsCount: Int!

    """Total de tickets abiertos actualmente"""
    openTicketsCount: Int!

    """Calificación promedio de servicio"""
    averageRating: Float

    """Total de categorías de tickets"""
    categoriesCount: Int!

    """Total de macros de respuesta"""
    macrosCount: Int!

    # ===== AUDITORÍA =====
    """Cuándo se creó la empresa"""
    createdAt: DateTime!

    """Última modificación"""
    updatedAt: DateTime!

    """Solicitud original que generó esta empresa"""
    originRequest: CompanyRequest
}

"""
Información pública de empresa
Para mostrar en listas públicas y registro de usuarios
"""
type CompanyPublicInfo {
    """ID único de la empresa"""
    id: UUID!

    """Código único de la empresa"""
    companyCode: String!

    """Nombre comercial"""
    name: String!

    """Email público de soporte"""
    supportEmail: Email

    """Sitio web"""
    website: URL

    """Logo de la empresa"""
    logoUrl: URL

    """Descripción breve del negocio"""
    description: String

    """Sector o industria"""
    industry: String

    """Ciudad de ubicación"""
    city: String

    """País de ubicación"""
    country: String

    """Si acepta nuevos usuarios"""
    acceptsPublicUsers: Boolean!

    """Horarios de atención (formato legible)"""
    businessHoursDisplay: String
}

"""
Solicitud de creación de empresa
Para proceso de aprobación administrativa
"""
type CompanyRequest implements Node & Timestamped {
    """ID único de la solicitud"""
    id: UUID!

    """Código único de la solicitud (REQ-2025-00001)"""
    requestCode: String!

    # ===== INFORMACIÓN SOLICITADA =====
    """Nombre comercial solicitado"""
    companyName: String!

    """Razón social"""
    legalName: String

    """Email del administrador solicitante"""
    adminEmail: Email!

    """Descripción del negocio"""
    businessDescription: String!

    """Sitio web de la empresa"""
    website: URL

    """Tipo de industria o sector"""
    industryType: String!

    """Número estimado de usuarios"""
    estimatedUsers: Int

    # ===== INFORMACIÓN DE CONTACTO =====
    """Dirección de contacto"""
    contactAddress: String

    """Ciudad"""
    contactCity: String

    """País"""
    contactCountry: String

    """Código postal"""
    contactPostalCode: String

    """Identificador fiscal"""
    taxId: String

    # ===== ESTADO DE LA SOLICITUD =====
    """Estado actual de la solicitud"""
    status: CompanyRequestStatus!

    """Administrador que revisó la solicitud"""
    reviewedBy: UserBasicInfo

    """Fecha de revisión"""
    reviewedAt: DateTime

    """Motivo de rechazo (si aplica)"""
    rejectionReason: String

    """Empresa creada (si fue aprobada)"""
    createdCompany: CompanyBasicInfo

    # ===== AUDITORÍA =====
    """Fecha de creación de la solicitud"""
    createdAt: DateTime!

    """Última modificación"""
    updatedAt: DateTime!
}

# ================================================================================
# TYPES DE PAGINACIÓN
# ================================================================================

"""
Resultado paginado de empresas
"""
type CompanyPaginator {
    """Lista de empresas en la página actual"""
    data: [Company!]!

    """Información de paginación"""
    paginatorInfo: PaginatorInfo!
}

# ================================================================================
# ENUMS
# ================================================================================

"""
Estados posibles de una solicitud de empresa
"""
enum CompanyRequestStatus {
    """Solicitud pendiente de revisión"""
    PENDING @enum(value: "pending")

    """Solicitud aprobada y empresa creada"""
    APPROVED @enum(value: "approved")

    """Solicitud rechazada"""
    REJECTED @enum(value: "rejected")
}

# ================================================================================
# INPUTS
# ================================================================================

"""
Input para solicitar creación de empresa
"""
input CompanyRequestInput {
    # ===== INFORMACIÓN BÁSICA =====
    """Nombre comercial deseado"""
    companyName: String!
        @rules(apply: ["required", "min:2", "max:200"])

    """Razón social completa"""
    legalName: String
        @rules(apply: ["max:250"])

    """Email del administrador"""
    adminEmail: Email!
        @rules(apply: ["required", "email"])

    """Descripción detallada del negocio"""
    businessDescription: String!
        @rules(apply: ["required", "min:50", "max:1000"])

    """Sitio web de la empresa"""
    website: URL
        @rules(apply: ["url"])

    """Sector o industria"""
    industryType: String!
        @rules(apply: ["required", "max:100"])

    """Número estimado de usuarios"""
    estimatedUsers: Int
        @rules(apply: ["min:1", "max:10000"])

    # ===== INFORMACIÓN DE CONTACTO =====
    """Dirección completa"""
    contactAddress: String
        @rules(apply: ["max:500"])

    """Ciudad"""
    contactCity: String
        @rules(apply: ["max:100"])

    """País"""
    contactCountry: String
        @rules(apply: ["max:100"])

    """Código postal"""
    contactPostalCode: String
        @rules(apply: ["max:20"])

    """RUT, NIT o identificador fiscal"""
    taxId: String
        @rules(apply: ["max:50"])
}

"""
Input para crear empresa directamente
"""
input CreateCompanyInput {
    """Nombre comercial"""
    name: String!
        @rules(apply: ["required", "min:2", "max:200"])

    """Razón social"""
    legalName: String
        @rules(apply: ["max:250"])

    """Email de administrador existente"""
    adminUserId: UUID!
        @rules(apply: ["required", "exists:auth.users,id"])

    """Email público de soporte"""
    supportEmail: Email
        @rules(apply: ["email"])

    """Teléfono de contacto"""
    phone: PhoneNumber

    """Sitio web"""
    website: URL
        @rules(apply: ["url"])

    """Información de contacto"""
    contactInfo: ContactInfoInput

    """Configuración inicial"""
    initialConfig: CompanyConfigInput
}

"""
Input para actualizar empresa
"""
input UpdateCompanyInput {
    """Nuevo nombre comercial"""
    name: String
        @rules(apply: ["min:2", "max:200"])

    """Nueva razón social"""
    legalName: String
        @rules(apply: ["max:250"])

    """Nuevo email de soporte"""
    supportEmail: Email
        @rules(apply: ["email"])

    """Nuevo teléfono"""
    phone: PhoneNumber

    """Nuevo sitio web"""
    website: URL
        @rules(apply: ["url"])

    """Actualizar información de contacto"""
    contactInfo: ContactInfoInput

    """Actualizar configuración"""
    config: CompanyConfigInput

    """Actualizar branding"""
    branding: CompanyBrandingInput
}

"""
Información de contacto de empresa
"""
input ContactInfoInput {
    """Dirección completa"""
    address: String
        @rules(apply: ["max:500"])

    """Ciudad"""
    city: String
        @rules(apply: ["max:100"])

    """Estado o departamento"""
    state: String
        @rules(apply: ["max:100"])

    """País"""
    country: String
        @rules(apply: ["max:100"])

    """Código postal"""
    postalCode: String
        @rules(apply: ["max:20"])

    """Identificador fiscal"""
    taxId: String
        @rules(apply: ["max:50"])

    """Representante legal"""
    legalRepresentative: String
        @rules(apply: ["max:200"])
}

"""
Configuración operativa de empresa
"""
input CompanyConfigInput {
    """Horarios de atención (JSON)"""
    businessHours: JSON

    """Zona horaria"""
    timezone: String
        @rules(apply: ["timezone"])

    """Configuraciones adicionales"""
    settings: JSON
}

"""
Branding de empresa
"""
input CompanyBrandingInput {
    """URL del logo"""
    logoUrl: URL
        @rules(apply: ["url"])

    """URL del favicon"""
    faviconUrl: URL
        @rules(apply: ["url"])

    """Color primario"""
    primaryColor: HexColor

    """Color secundario"""
    secondaryColor: HexColor
}

# ================================================================================
# INPUTS DE FILTROS
# ================================================================================

"""
Filtros para búsqueda de empresas
"""
input CompanyFilters {
    """Buscar por nombre o código"""
    search: String

    """Filtrar por estado"""
    status: CompanyStatus

    """Filtrar por sector"""
    industry: String

    """Filtrar por país"""
    country: String

    """Solo empresas con actividad reciente"""
    recentActivity: Boolean

    """Rango de fechas de creación"""
    createdBetween: DateRange
}

"""
Ordenamiento de empresas
"""
input CompanyOrderBy {
    """Campo por el cual ordenar"""
    field: CompanyOrderField!

    """Dirección del ordenamiento"""
    order: SortOrder!
}

"""
Campos disponibles para ordenar empresas
"""
enum CompanyOrderField {
    """Ordenar por fecha de creación"""
    CREATED_AT

    """Ordenar por nombre"""
    NAME

    """Ordenar por estado"""
    STATUS

    """Ordenar por número de agentes"""
    AGENTS_COUNT

    """Ordenar por número de tickets"""
    TICKETS_COUNT

    """Ordenar por calificación"""
    RATING
}
