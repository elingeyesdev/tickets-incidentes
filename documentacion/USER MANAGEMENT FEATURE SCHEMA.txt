# ================================================================================
# USER MANAGEMENT FEATURE SCHEMA V9.0 - Sistema Helpdesk
# REFACTORIZADO: Reutiliza shared types, sin nested innecesario
# ================================================================================

extend type Query {
    """
    Usuario autenticado con información completa
    Incluye perfil, roles activos y empresas relacionadas
    """
    me: User!
        @auth
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Queries\\MeQuery")

    """
    Perfil completo del usuario autenticado
    Para páginas de configuración y edición
    """
    myProfile: UserProfile!
        @auth
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Queries\\MyProfileQuery")

    """
    Lista paginada de usuarios del sistema
    Solo accesible por administradores
    """
    users(
        """Filtros de búsqueda"""
        filters: UserFilters
        """Ordenamiento de resultados"""
        orderBy: [UserOrderBy!]
        """Número de página"""
        page: Int = 1
        """Registros por página"""
        first: Int = 15
    ): UserPaginator!
        @auth(requires: [PLATFORM_ADMIN, COMPANY_ADMIN])
        @paginate(maxCount: 50)
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Queries\\UsersQuery")

    """
    Usuario específico por ID
    Acceso según permisos del usuario autenticado
    """
    user(id: UUID!): User
        @auth
        @can(ability: "view", model: "User", find: "id")
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Queries\\UserQuery")

    """
    Usuarios de una empresa específica
    Solo accesible por admin/agentes de esa empresa
    """
    companyUsers(
        """ID de la empresa"""
        companyId: UUID!
        """Filtros adicionales"""
        filters: CompanyUserFilters
        """Registros máximos"""
        first: Int = 50
    ): [UserCompanyInfo!]!
        @auth(requires: [COMPANY_ADMIN, AGENT])
        @company(requireOwnership: true)
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Queries\\CompanyUsersQuery")

    """
    Roles disponibles en el sistema
    Lista estática de roles con sus descripciones
    """
    availableRoles: [RoleInfo!]!
        @auth(requires: [PLATFORM_ADMIN, COMPANY_ADMIN])
        @cache(ttl: 3600, key: "available_roles")
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Queries\\AvailableRolesQuery")
}

extend type Mutation {
    # ===== GESTIÓN DE PERFIL PROPIO =====

    """
    Actualiza el perfil del usuario autenticado
    Cualquier usuario puede modificar su propio perfil
    """
    updateMyProfile(input: UpdateProfileInput!): User!
        @auth
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Mutations\\UpdateMyProfileMutation")
        @rateLimit(max: 30, window: 3600)
        @audit(action: "profile_update")

    """
    Actualiza preferencias de interfaz y notificaciones
    """
    updateMyPreferences(input: PreferencesInput!): User!
        @auth
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Mutations\\UpdateMyPreferencesMutation")
        @rateLimit(max: 50, window: 3600)
        @audit(action: "preferences_update")

    """
    Completa información del perfil después del registro
    Para flujo de onboarding
    """
    completeMyProfile(input: CompleteProfileInput!): User!
        @auth
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Mutations\\CompleteMyProfileMutation")
        @audit(action: "profile_complete")

    # ===== GESTIÓN DE USUARIOS (ADMIN) =====

    """
    Crea un nuevo usuario en el sistema
    Solo accesible por platform admins
    """
    createUser(input: CreateUserInput!): User!
        @auth(requires: [PLATFORM_ADMIN])
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Mutations\\CreateUserMutation")
        @rateLimit(max: 10, window: 3600)
        @audit(action: "user_create", includePayload: true)

    """
    Actualiza información de un usuario específico
    Admins pueden editar usuarios
    """
    updateUser(id: UUID!, input: UpdateUserInput!): User!
        @auth(requires: [PLATFORM_ADMIN, COMPANY_ADMIN])
        @can(ability: "update", model: "User", find: "id")
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Mutations\\UpdateUserMutation")
        @audit(action: "user_update", includePayload: true)

    """
    Suspende temporalmente un usuario
    Invalida todas sus sesiones activas
    """
    suspendUser(id: UUID!, reason: String): User!
        @auth(requires: [PLATFORM_ADMIN])
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Mutations\\SuspendUserMutation")
        @audit(action: "user_suspend", includePayload: true)

    """
    Reactiva un usuario suspendido
    """
    activateUser(id: UUID!): User!
        @auth(requires: [PLATFORM_ADMIN])
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Mutations\\ActivateUserMutation")
        @audit(action: "user_activate")

    """
    Elimina lógicamente un usuario (soft delete)
    Anonimiza datos sensibles
    """
    deleteUser(id: UUID!, reason: String): Boolean!
        @auth(requires: [PLATFORM_ADMIN])
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Mutations\\DeleteUserMutation")
        @audit(action: "user_delete", includePayload: true)

    # ===== GESTIÓN DE ROLES =====

    """
    Asigna un rol específico a un usuario
    Si el rol requiere empresa, companyId es obligatorio
    """
    assignRole(input: AssignRoleInput!): UserRole!
        @auth(requires: [PLATFORM_ADMIN, COMPANY_ADMIN])
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Mutations\\AssignRoleMutation")
        @rateLimit(max: 100, window: 3600)
        @audit(action: "role_assign", includePayload: true)

    """
    Revoca un rol específico de un usuario
    Establece isActive = false
    """
    revokeRole(userRoleId: UUID!, reason: String): Boolean!
        @auth(requires: [PLATFORM_ADMIN, COMPANY_ADMIN])
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Mutations\\RevokeRoleMutation")
        @audit(action: "role_revoke", includePayload: true)

    """
    Actualiza configuración de un rol específico
    Permite cambiar estado o empresa asociada
    """
    updateUserRole(userRoleId: UUID!, input: UpdateUserRoleInput!): UserRole!
        @auth(requires: [PLATFORM_ADMIN, COMPANY_ADMIN])
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Mutations\\UpdateUserRoleMutation")
        @audit(action: "role_update", includePayload: true)
}

# ================================================================================
# TYPES - Response types
# ================================================================================

"""
Usuario completo del sistema
"""
type User implements Node & Timestamped {
    # ===== IDENTIFICADORES =====
    id: UUID!
    userCode: String!

    # ===== DATOS BÁSICOS =====
    email: Email!
    emailVerified: Boolean!
    emailVerifiedAt: DateTime
    status: UserStatus!
    authProvider: AuthProvider!

    # ===== PERFIL =====
    profile: UserProfile!

    # ===== ROLES (CONSISTENTE con Authentication) =====
    """
    Contextos de roles activos
    Misma estructura que login para consistencia
    Usado para selector de roles y permisos
    """
    roleContexts: [RoleContext!]!

    """
    Historial completo de roles (activos e inactivos)
    Para auditoría y gestión administrativa
    """
    roleHistory: [UserRole!]!

    # ===== EMPRESAS RELACIONADAS =====
    """
    Empresas donde tiene roles activos
    Reutiliza CompanyMinimal de shared types
    """
    companies: [CompanyMinimal!]!

    # ===== ESTADOS CALCULADOS =====
    """Si es admin de plataforma o empresa (calculado)"""
    isAdmin: Boolean!

    """Si puede crear tickets públicos (calculado)"""
    canCreateTickets: Boolean!

    # ===== ACTIVIDAD Y SEGURIDAD =====
    lastLoginAt: DateTime
    lastLoginIp: String
    lastActivityAt: DateTime

    # ===== TÉRMINOS =====
    termsAccepted: Boolean!
    termsAcceptedAt: DateTime
    termsVersion: String

    # ===== ESTADÍSTICAS =====
    ticketsCount: Int!
    resolvedTicketsCount: Int!

    """
    Rating promedio (solo para agentes con tickets resueltos)
    Null para usuarios sin rating
    """
    averageRating: Float

    # ===== AUDITORÍA =====
    createdAt: DateTime!
    updatedAt: DateTime!
    deletedAt: DateTime
}

"""
Perfil de usuario
Información personal y preferencias
"""
type UserProfile {
    # Información personal
    firstName: String!
    lastName: String!
    displayName: String!
    phoneNumber: String
    avatarUrl: URL

    # Preferencias de interfaz
    theme: String!
    language: String!
    timezone: String!

    # Preferencias de notificaciones
    pushWebNotifications: Boolean!
    notificationsTickets: Boolean!

    # Actividad
    lastActivityAt: DateTime

    # Auditoría
    createdAt: DateTime!
    updatedAt: DateTime!
}

"""
Rol asignado a un usuario
Estructura CLARA: company estará presente según el tipo de rol
"""
type UserRole {
    """ID único del registro de rol"""
    id: UUID!

    # ===== ROL (campos planos, NO nested) =====
    """Código del rol"""
    roleCode: RoleCode!

    """Nombre del rol"""
    roleName: String!

    """Descripción del rol"""
    roleDescription: String!

    """Dashboard path por defecto"""
    dashboardPath: String!

    # ===== EMPRESA (opcional, reutiliza CompanyMinimal) =====
    """
    Empresa asociada al rol
    Presente para AGENT y COMPANY_ADMIN
    Null para USER y PLATFORM_ADMIN
    Reutiliza CompanyMinimal de shared types
    """
    company: CompanyMinimal

    # ===== ESTADO =====
    """Si el rol está activo"""
    isActive: Boolean!

    # ===== METADATA =====
    """Cuándo fue asignado el rol"""
    assignedAt: DateTime!

    """
    Quién asignó el rol
    Reutiliza UserMinimal de shared types
    """
    assignedBy: UserMinimal

    # ===== AUDITORÍA =====
    """Cuándo fue revocado (null si activo)"""
    revokedAt: DateTime

    """Quién revocó el rol"""
    revokedBy: UserMinimal

    """Motivo de revocación"""
    revocationReason: String
}

"""
Información de rol disponible en el sistema
Para listado de roles y sus permisos
"""
type RoleInfo {
    """Código único del rol"""
    code: RoleCode!

    """Nombre legible"""
    name: String!

    """Descripción completa"""
    description: String!

    """Si requiere empresa asociada"""
    requiresCompany: Boolean!

    """Dashboard por defecto"""
    defaultDashboard: String!

    """Lista de permisos"""
    permissions: [String!]!

    """Prioridad (1 = mayor)"""
    priority: Int!

    """Si es rol del sistema (no personalizado)"""
    isSystemRole: Boolean!
}

"""
Información de usuario en contexto de empresa
Para listados de usuarios de una empresa
"""
type UserCompanyInfo {
    """Usuario (reutiliza UserMinimal)"""
    user: UserMinimal!

    """Rol en esta empresa"""
    roleCode: RoleCode!

    """Nombre del rol"""
    roleName: String!

    """Si el rol está activo"""
    isActive: Boolean!

    """Cuándo se unió a la empresa"""
    joinedAt: DateTime!

    """Tickets asignados en esta empresa"""
    ticketsAssigned: Int!

    """Tickets resueltos en esta empresa"""
    ticketsResolved: Int!

    """Última actividad"""
    lastActivityAt: DateTime
}

# ===== PAGINACIÓN =====

type UserPaginator {
    data: [User!]!
    paginatorInfo: PaginatorInfo!
}

# ================================================================================
# ENUMS
# ================================================================================

"""
Códigos de roles del sistema
"""
enum RoleCode {
    """Usuario final que crea tickets"""
    USER @enum(value: "USER")

    """Agente que responde tickets de una empresa"""
    AGENT @enum(value: "AGENT")

    """Administrador de una empresa específica"""
    COMPANY_ADMIN @enum(value: "COMPANY_ADMIN")

    """Administrador de toda la plataforma"""
    PLATFORM_ADMIN @enum(value: "PLATFORM_ADMIN")
}

"""
Estado del usuario
"""
enum UserStatus {
    """Usuario activo"""
    ACTIVE @enum(value: "active")

    """Usuario suspendido temporalmente"""
    SUSPENDED @enum(value: "suspended")

    """Usuario eliminado (soft delete)"""
    DELETED @enum(value: "deleted")
}

"""
Campo de ordenamiento de usuarios
"""
enum UserOrderField {
    CREATED_AT
    UPDATED_AT
    LAST_LOGIN_AT
    EMAIL
    STATUS
    TICKETS_COUNT
}

# ================================================================================
# INPUTS
# ================================================================================

"""
Input para actualizar perfil propio
"""
input UpdateProfileInput {
    firstName: String
        @rules(apply: ["min:2", "max:100"])

    lastName: String
        @rules(apply: ["min:2", "max:100"])

    phoneNumber: String
        @rules(apply: ["min:10", "max:20"])

    avatarUrl: URL
        @rules(apply: ["url"])
}

"""
Input para actualizar preferencias
"""
input PreferencesInput {
    theme: String
        @rules(apply: ["in:light,dark"])

    language: String
        @rules(apply: ["in:es,en"])

    timezone: String
        @rules(apply: ["timezone"])

    pushWebNotifications: Boolean

    notificationsTickets: Boolean
}

"""
Input para completar perfil (onboarding)
"""
input CompleteProfileInput {
    phoneNumber: String
        @rules(apply: ["min:10", "max:20"])

    avatarUrl: URL
        @rules(apply: ["url"])

    theme: String
        @rules(apply: ["in:light,dark"])

    language: String
        @rules(apply: ["in:es,en"])

    timezone: String
        @rules(apply: ["required", "timezone"])

    pushWebNotifications: Boolean

    notificationsTickets: Boolean
}

"""
Input para crear usuario (admin)
"""
input CreateUserInput {
    email: Email!
        @rules(apply: ["required", "email", "unique:auth.users,email"])

    password: String!
        @rules(apply: ["required", "min:8"])

    firstName: String!
        @rules(apply: ["required", "min:2", "max:100"])

    lastName: String!
        @rules(apply: ["required", "min:2", "max:100"])

    status: UserStatus = ACTIVE

    """Roles iniciales a asignar"""
    initialRoles: [AssignRoleInput!]

    """Si enviar email de bienvenida"""
    sendWelcomeEmail: Boolean = true
}

"""
Input para actualizar usuario
"""
input UpdateUserInput {
    email: Email
        @rules(apply: ["email"])

    status: UserStatus

    profile: UpdateProfileInput

    """Si forzar reverificación de email"""
    forceEmailVerification: Boolean = false
}

"""
Input para asignar rol a usuario
"""
input AssignRoleInput {
    """ID del usuario"""
    userId: UUID!
        @rules(apply: ["required", "exists:auth.users,id"])

    """Código del rol a asignar"""
    roleCode: RoleCode!
        @rules(apply: ["required"])

    """
    ID de empresa (requerido solo si el rol requiere empresa)
    AGENT y COMPANY_ADMIN requieren companyId
    USER y PLATFORM_ADMIN no requieren companyId
    """
    companyId: UUID

    """Si el rol está activo desde el inicio"""
    isActive: Boolean = true
}

"""
Input para actualizar un rol de usuario
"""
input UpdateUserRoleInput {
    """Cambiar estado activo/inactivo"""
    isActive: Boolean

    """Cambiar empresa asociada (solo si el rol requiere empresa)"""
    companyId: UUID
}

"""
Filtros para query users
"""
input UserFilters {
    """Búsqueda de texto en email/nombre"""
    search: String

    """Filtrar por estado"""
    status: UserStatus

    """Filtrar por rol específico"""
    role: RoleCode

    """Filtrar por email verificado"""
    emailVerified: Boolean

    """Filtrar por empresa"""
    companyId: UUID

    """Filtrar por actividad reciente (últimos 7 días)"""
    recentActivity: Boolean

    """Filtrar por rango de creación"""
    createdBetween: DateRange
}

"""
Filtros para usuarios de empresa
"""
input CompanyUserFilters {
    """Búsqueda de texto"""
    search: String

    """Filtrar por rol en la empresa"""
    role: RoleCode

    """Solo usuarios activos"""
    activeOnly: Boolean = true
}

"""
Ordenamiento de usuarios
"""
input UserOrderBy {
    field: UserOrderField!
    order: SortOrder!
}

# ================================================================================
# NOTAS DE IMPLEMENTACIÓN
# ================================================================================

"""
ARQUITECTURA DE ROLES:

1. ROLES SIN EMPRESA:
   - USER: No requiere empresa
     roleContext: { roleCode: "USER", company: null }

   - PLATFORM_ADMIN: No requiere empresa
     roleContext: { roleCode: "PLATFORM_ADMIN", company: null }

2. ROLES CON EMPRESA:
   - AGENT: REQUIERE empresa
     roleContext: {
       roleCode: "AGENT",
       company: { id, name, logo }
     }

   - COMPANY_ADMIN: REQUIERE empresa
     roleContext: {
       roleCode: "COMPANY_ADMIN",
       company: { id, name, logo }
     }

ASIGNACIÓN DE ROLES:
- assignRole valida que:
  * Si rol requiere empresa: companyId es obligatorio
  * Si rol NO requiere empresa: companyId debe ser null
  * Usuario no tenga ya ese rol activo para esa empresa

QUERY ME:
- Retorna usuario completo
- roles: lista TODOS los roles (activos e inactivos)
- activeRoles: filtra solo isActive = true
- companies: empresas donde tiene roles activos
- isAdmin: true si tiene PLATFORM_ADMIN o COMPANY_ADMIN activo

PERMISOS:
- updateMyProfile: Cualquier usuario autenticado
- createUser: Solo PLATFORM_ADMIN
- assignRole: PLATFORM_ADMIN (todos) o COMPANY_ADMIN (su empresa)
- suspendUser: Solo PLATFORM_ADMIN
"""
