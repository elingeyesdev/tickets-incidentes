# ğŸ“˜ USER MANAGEMENT API V10.1 - DOCUMENTACIÃ“N DEFINITIVA

> Sistema Helpdesk Multi-Tenant
> Feature: User Management
> Schema Version: 10.1 (Definitivo - Listo para ProducciÃ³n)
> Ãšltima actualizaciÃ³n: Octubre 2025

---

## ğŸš¨ CAMBIOS CRÃTICOS DE V9.0 A V10.1

### âŒ PROBLEMAS ELIMINADOS:
1. **Nomenclatura inconsistente** â†’ `roleContexts` SIEMPRE
2. **Redundancia de mutations** â†’ Eliminadas `revokeRole`, `updateUserRole`, `completeMyProfile`
3. **Campos calculados en API** â†’ Eliminados `isAdmin`, `canCreateTickets` (frontend calcula)
4. **Mutations innecesarias** â†’ Eliminadas `createUser`, `updateUser`, `companyUsers`
5. **Referencias a permisos** â†’ Eliminadas (no existen en BD V7.0)
6. **Tipos genÃ©ricos en mutations** â†’ Reemplazados por Payloads especÃ­ficos

### âœ… MEJORAS IMPLEMENTADAS:
1. **API minimalista** â†’ 5 queries + 7 mutations
2. **Nomenclatura consistente** â†’ `roleContexts` en TODO el sistema
3. **SeparaciÃ³n clara** â†’ `updateMyProfile` vs `updateMyPreferences`
4. **Mutations inteligentes** â†’ `assignRole` crea O reactiva automÃ¡ticamente
5. **Payloads especÃ­ficos** â†’ Cada mutation retorna solo lo relevante
6. **Sin over-fetching** â†’ No se permite solicitar datos irrelevantes

---

## ğŸ“‹ TABLA DE CONTENIDOS

1. [IntroducciÃ³n](#introducciÃ³n)
2. [Arquitectura](#arquitectura)
3. [Queries](#queries)
4. [Mutations](#mutations)
5. [Types](#types)
6. [Inputs](#inputs)
7. [Roles del Sistema](#roles-del-sistema)
8. [Permisos y Seguridad](#permisos-y-seguridad)
9. [CÃ³digos de Error](#cÃ³digos-de-error)
10. [Casos de Uso](#casos-de-uso)
11. [MigraciÃ³n desde V9.0](#migraciÃ³n-desde-v90)

---

## ğŸ¯ INTRODUCCIÃ“N

### PropÃ³sito del Feature
El **User Management Feature** gestiona usuarios, perfiles y roles en el sistema Helpdesk multi-tenant:
- GestiÃ³n de usuarios (lectura y estados)
- AdministraciÃ³n de perfiles personales
- AsignaciÃ³n y remociÃ³n de roles
- GestiÃ³n de permisos por empresa
- Multi-rol y multi-tenant

### CaracterÃ­sticas Principales
âœ… **API Minimalista**: Solo 12 operaciones esenciales
âœ… **Multi-Rol**: Un usuario puede tener mÃºltiples roles
âœ… **Multi-Tenant**: Roles asociados a empresas especÃ­ficas
âœ… **Profiles Separados**: Datos personales vs Preferencias
âœ… **Nomenclatura Consistente**: `roleContexts` en TODO el sistema
âœ… **Payloads EspecÃ­ficos**: Sin over-fetching innecesario
âœ… **Type-Safe**: Respuestas semÃ¡nticamente correctas

---

## ğŸ—ƒï¸ ARQUITECTURA

### Principios de DiseÃ±o V10.1

#### âœ… **1. Payloads EspecÃ­ficos (Pattern Profesional)**

```graphql
# âŒ ANTI-PATTERN V9.0
updateMyProfile(...): User!  # Permite pedir roleContexts innecesariamente

# âœ… PATTERN CORRECTO V10.1
updateMyProfile(...): ProfileUpdatePayload!  # Solo datos del perfil

# Beneficios:
# - SemÃ¡nticamente correcto
# - No permite over-fetching
# - Backend carga solo lo necesario
# - Pattern de GitHub, Shopify, Stripe
```

#### âœ… **2. SeparaciÃ³n de Datos Personales y Preferencias**

```graphql
# Datos personales (cambio poco frecuente)
type UserProfile {
    firstName: String!
    lastName: String!
    displayName: String!
    phoneNumber: String
    avatarUrl: URL
}

# Preferencias (cambio frecuente)
type UserPreferences {
    theme: String!
    language: String!
    timezone: String!
    pushWebNotifications: Boolean!
    notificationsTickets: Boolean!
}
```

#### âœ… **3. User! Solo para InformaciÃ³n Completa**

```graphql
# âœ… User! completo SOLO en queries de lectura
type Query {
    me: User!           # Info completa del usuario autenticado
    user(id: UUID!): User  # Info completa de cualquier usuario
}

# âœ… Payloads especÃ­ficos en mutations de actualizaciÃ³n
type Mutation {
    updateMyProfile(...): ProfileUpdatePayload!
    updateMyPreferences(...): PreferencesUpdatePayload!
    suspendUser(...): UserStatusPayload!
    activateUser(...): UserStatusPayload!
}
```

---

## ğŸ” QUERIES

### 1. `me` - Usuario Autenticado

**DescripciÃ³n**: Obtiene informaciÃ³n completa del usuario autenticado.

**Firma:**
```graphql
me: User!
```

**Directivas:**
- `@auth`: Requiere autenticaciÃ³n

**Request:**
```graphql
query Me {
    me {
        id
        userCode
        email
        emailVerified
        status
        authProvider
        profile {
            firstName
            lastName
            displayName
            phoneNumber
            avatarUrl
        }
        preferences {
            theme
            language
            timezone
            pushWebNotifications
            notificationsTickets
        }
        roleContexts {
            roleCode
            roleName
            company {
                id
                companyCode
                name
                logoUrl
            }
            dashboardPath
        }
        ticketsCount
        resolvedTicketsCount
        averageRating
        lastLoginAt
        createdAt
        updatedAt
    }
}
```

**Casos de Uso:**
- Header de usuario en interfaz
- PÃ¡gina completa de perfil
- ValidaciÃ³n de permisos
- Selector de roles/empresas

---

### 2. `myProfile` - Perfil Personal

**DescripciÃ³n**: Obtiene solo datos personales del perfil.

**Firma:**
```graphql
myProfile: UserProfile!
```

**Directivas:**
- `@auth`: Requiere autenticaciÃ³n

**Request:**
```graphql
query MyProfile {
    myProfile {
        firstName
        lastName
        displayName
        phoneNumber
        avatarUrl
        createdAt
        updatedAt
    }
}
```

---

### 3. `myPreferences` - Preferencias

**DescripciÃ³n**: Obtiene solo preferencias de aplicaciÃ³n.

**Firma:**
```graphql
myPreferences: UserPreferences!
```

**Directivas:**
- `@auth`: Requiere autenticaciÃ³n

**Request:**
```graphql
query MyPreferences {
    myPreferences {
        theme
        language
        timezone
        pushWebNotifications
        notificationsTickets
        updatedAt
    }
}
```

---

### 4. `users` - Lista Paginada de Usuarios

**DescripciÃ³n**: Lista paginada de usuarios con filtros avanzados. Solo administradores.

**Firma:**
```graphql
users(
    filters: UserFilters
    orderBy: [UserOrderBy!]
    page: Int = 1
    first: Int = 15
): UserPaginator!
```

**Directivas:**
- `@auth(requires: [PLATFORM_ADMIN, COMPANY_ADMIN])`: Solo admins
- `@paginate(maxCount: 50)`: MÃ¡ximo 50 por pÃ¡gina

**Filtros Disponibles:**

| Filtro | Tipo | DescripciÃ³n |
|--------|------|-------------|
| `search` | String | Busca en email/nombre |
| `status` | UserStatus | ACTIVE, SUSPENDED, DELETED |
| `role` | RoleCode | USER, AGENT, COMPANY_ADMIN, PLATFORM_ADMIN |
| `emailVerified` | Boolean | Si email estÃ¡ verificado |
| `companyId` | UUID | Usuarios con rol en una empresa |
| `recentActivity` | Boolean | Activos Ãºltimos 7 dÃ­as |
| `createdBetween` | DateRange | Rango de fecha de creaciÃ³n |

---

### 5. `user` - Usuario EspecÃ­fico

**DescripciÃ³n**: Obtiene informaciÃ³n completa de un usuario por ID.

**Firma:**
```graphql
user(id: UUID!): User
```

**Directivas:**
- `@auth`: Requiere autenticaciÃ³n
- `@can(ability: "view", model: "User", find: "id")`: Valida permisos

**Casos de Uso:**
- PÃ¡gina de detalle de usuario (admin)
- Modal de informaciÃ³n completa
- VerificaciÃ³n antes de asignar roles

---

### 6. `availableRoles` - Roles Disponibles

**DescripciÃ³n**: Lista de roles del sistema con sus descripciones.

**Firma:**
```graphql
availableRoles: [RoleInfo!]!
```

**Directivas:**
- `@auth(requires: [PLATFORM_ADMIN, COMPANY_ADMIN])`: Solo admins
- `@cache(ttl: 3600)`: Cache de 1 hora

---

## âœï¸ MUTATIONS

### 1. `updateMyProfile` - Actualizar Datos Personales

**DescripciÃ³n**: Actualiza datos personales del perfil (nombre, telÃ©fono, avatar).

**Firma:**
```graphql
updateMyProfile(input: UpdateProfileInput!): ProfileUpdatePayload!
```

**Directivas:**
- `@auth`: Requiere autenticaciÃ³n
- `@rateLimit(max: 30, window: 3600)`: MÃ¡ximo 30 actualizaciones por hora
- `@audit(action: "profile_update")`: AuditorÃ­a automÃ¡tica

**Request:**
```graphql
mutation UpdateMyProfile($input: UpdateProfileInput!) {
    updateMyProfile(input: $input) {
        userId
        profile {
            firstName
            lastName
            displayName
            phoneNumber
            avatarUrl
            updatedAt
        }
        updatedAt
    }
}
```

**Variables:**
```json
{
    "input": {
        "firstName": "MarÃ­a Alejandra",
        "lastName": "GarcÃ­a RodrÃ­guez",
        "phoneNumber": "+591 75987654",
        "avatarUrl": "https://storage.helpdesk.com/avatars/new_avatar.jpg"
    }
}
```

**Response:**
```json
{
    "data": {
        "updateMyProfile": {
            "userId": "550e8400-e29b-41d4-a716-446655440000",
            "profile": {
                "firstName": "MarÃ­a Alejandra",
                "lastName": "GarcÃ­a RodrÃ­guez",
                "displayName": "MarÃ­a Alejandra GarcÃ­a RodrÃ­guez",
                "phoneNumber": "+591 75987654",
                "avatarUrl": "https://storage.helpdesk.com/avatars/new_avatar.jpg",
                "updatedAt": "2025-10-03T16:30:00Z"
            },
            "updatedAt": "2025-10-03T16:30:00Z"
        }
    }
}
```

**Â¿Por quÃ© ProfileUpdatePayload y no User!?**
- âœ… Solo retorna lo que cambiÃ³ (profile)
- âœ… No permite solicitar roleContexts (no cambiÃ³)
- âœ… No permite solicitar ticketsCount (no cambiÃ³)
- âœ… Backend carga solo profile (mÃ¡s rÃ¡pido)
- âœ… Pattern profesional (GitHub, Shopify, Stripe)

---

### 2. `updateMyPreferences` - Actualizar Preferencias

**DescripciÃ³n**: Actualiza preferencias de aplicaciÃ³n (tema, idioma, notificaciones).

**Firma:**
```graphql
updateMyPreferences(input: PreferencesInput!): PreferencesUpdatePayload!
```

**Directivas:**
- `@auth`: Requiere autenticaciÃ³n
- `@rateLimit(max: 50, window: 3600)`: MÃ¡ximo 50 actualizaciones por hora
- `@audit(action: "preferences_update")`: AuditorÃ­a automÃ¡tica

**Request:**
```graphql
mutation UpdateMyPreferences($input: PreferencesInput!) {
    updateMyPreferences(input: $input) {
        userId
        preferences {
            theme
            language
            timezone
            pushWebNotifications
            notificationsTickets
            updatedAt
        }
        updatedAt
    }
}
```

**Variables:**
```json
{
    "input": {
        "theme": "dark",
        "language": "en",
        "timezone": "America/New_York",
        "pushWebNotifications": false,
        "notificationsTickets": true
    }
}
```

**Response:**
```json
{
    "data": {
        "updateMyPreferences": {
            "userId": "550e8400-e29b-41d4-a716-446655440000",
            "preferences": {
                "theme": "dark",
                "language": "en",
                "timezone": "America/New_York",
                "pushWebNotifications": false,
                "notificationsTickets": true,
                "updatedAt": "2025-10-03T16:35:00Z"
            },
            "updatedAt": "2025-10-03T16:35:00Z"
        }
    }
}
```

**Â¿Por quÃ© separado de updateMyProfile?**
- âœ… Rate limiting diferenciado (preferencias cambian mÃ¡s frecuente)
- âœ… Validaciones diferentes
- âœ… Formularios separados en frontend
- âœ… AuditorÃ­a mÃ¡s clara

---

### 3. `suspendUser` - Suspender Usuario

**DescripciÃ³n**: Suspende temporalmente un usuario del sistema.

**Firma:**
```graphql
suspendUser(id: UUID!, reason: String): UserStatusPayload!
```

**Directivas:**
- `@auth(requires: [PLATFORM_ADMIN])`: Solo platform admins
- `@audit(action: "user_suspend", includePayload: true)`: AuditorÃ­a completa

**Request:**
```graphql
mutation SuspendUser($id: UUID!, $reason: String) {
    suspendUser(id: $id, reason: $reason) {
        userId
        status
        reason
        updatedAt
    }
}
```

**Variables:**
```json
{
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "reason": "ViolaciÃ³n de tÃ©rminos de servicio - spam de tickets"
}
```

**Response:**
```json
{
    "data": {
        "suspendUser": {
            "userId": "550e8400-e29b-41d4-a716-446655440000",
            "status": "SUSPENDED",
            "reason": "ViolaciÃ³n de tÃ©rminos de servicio - spam de tickets",
            "updatedAt": "2025-10-03T16:40:00Z"
        }
    }
}
```

**Efectos:**
- Cambia status a "SUSPENDED"
- Invalida todos los tokens activos
- Registra motivo en auditorÃ­a
- EnvÃ­a notificaciÃ³n al usuario

---

### 4. `activateUser` - Activar Usuario

**DescripciÃ³n**: Reactiva un usuario suspendido.

**Firma:**
```graphql
activateUser(id: UUID!): UserStatusPayload!
```

**Directivas:**
- `@auth(requires: [PLATFORM_ADMIN])`: Solo platform admins
- `@audit(action: "user_activate")`: AuditorÃ­a automÃ¡tica

**Request:**
```graphql
mutation ActivateUser($id: UUID!) {
    activateUser(id: $id) {
        userId
        status
        updatedAt
    }
}
```

**Response:**
```json
{
    "data": {
        "activateUser": {
            "userId": "550e8400-e29b-41d4-a716-446655440000",
            "status": "ACTIVE",
            "updatedAt": "2025-10-03T16:45:00Z"
        }
    }
}
```

**Efectos:**
- Cambia status a "ACTIVE"
- Permite nuevo login
- Registra reactivaciÃ³n en auditorÃ­a

---

### 5. `deleteUser` - Eliminar Usuario

**DescripciÃ³n**: Elimina lÃ³gicamente un usuario (soft delete).

**Firma:**
```graphql
deleteUser(id: UUID!, reason: String): Boolean!
```

**Directivas:**
- `@auth(requires: [PLATFORM_ADMIN])`: Solo platform admins
- `@audit(action: "user_delete", includePayload: true)`: AuditorÃ­a completa

**Request:**
```graphql
mutation DeleteUser($id: UUID!, $reason: String) {
    deleteUser(id: $id, reason: $reason)
}
```

**Efectos:**
- Cambia status a "DELETED"
- Establece deletedAt timestamp
- Anonimiza datos sensibles
- Mantiene registros para auditorÃ­a

---

### 6. `assignRole` - Asignar Rol

**DescripciÃ³n**: Asigna un rol a un usuario. Crea nuevo O reactiva si existe inactivo.

**Firma:**
```graphql
assignRole(input: AssignRoleInput!): UserRoleResult!
```

**Directivas:**
- `@auth(requires: [PLATFORM_ADMIN, COMPANY_ADMIN])`: Solo admins
- `@rateLimit(max: 100, window: 3600)`: MÃ¡ximo 100 asignaciones por hora
- `@audit(action: "role_assign", includePayload: true)`: AuditorÃ­a completa

**Request:**
```graphql
mutation AssignRole($input: AssignRoleInput!) {
    assignRole(input: $input) {
        success
        message
        role {
            id
            roleCode
            roleName
            company {
                id
                name
                logoUrl
            }
            isActive
            assignedAt
        }
    }
}
```

**Validaciones CrÃ­ticas:**

| Rol | Requiere Empresa | companyId |
|-----|------------------|-----------|
| USER | âŒ NO | Debe ser null |
| PLATFORM_ADMIN | âŒ NO | Debe ser null |
| AGENT | âœ… SÃ | Obligatorio |
| COMPANY_ADMIN | âœ… SÃ | Obligatorio |

---

### 7. `removeRole` - Remover Rol

**DescripciÃ³n**: Desactiva un rol de un usuario (soft delete, reversible con assignRole).

**Firma:**
```graphql
removeRole(roleId: UUID!, reason: String): Boolean!
```

**Directivas:**
- `@auth(requires: [PLATFORM_ADMIN, COMPANY_ADMIN])`: Solo admins
- `@audit(action: "role_remove", includePayload: true)`: AuditorÃ­a completa

**Request:**
```graphql
mutation RemoveRole($roleId: UUID!, $reason: String) {
    removeRole(roleId: $roleId, reason: $reason)
}
```

**Efectos:**
- Establece `isActive = false`
- Registra `revokedAt` timestamp
- Guarda `revocationReason`
- Invalida permisos derivados

---

## ğŸ“¦ TYPES

### User (Completo)

```graphql
type User {
    # Identificadores
    id: UUID!
    userCode: String!

    # AutenticaciÃ³n
    email: Email!
    emailVerified: Boolean!
    status: UserStatus!
    authProvider: AuthProvider!

    # Perfil (datos personales)
    profile: UserProfile!

    # Preferencias (configuraciÃ³n app)
    preferences: UserPreferences!

    # Roles ACTIVOS
    roleContexts: [RoleContext!]!

    # EstadÃ­sticas
    ticketsCount: Int!
    resolvedTicketsCount: Int!
    averageRating: Float

    # AuditorÃ­a
    lastLoginAt: DateTime
    lastActivityAt: DateTime
    createdAt: DateTime!
    updatedAt: DateTime!
}
```

---

### UserProfile (Datos Personales)

```graphql
type UserProfile {
    firstName: String!
    lastName: String!
    displayName: String!
    phoneNumber: String
    avatarUrl: URL
    createdAt: DateTime!
    updatedAt: DateTime!
}
```

---

### UserPreferences (ConfiguraciÃ³n App)

```graphql
type UserPreferences {
    theme: String!
    language: String!
    timezone: String!
    pushWebNotifications: Boolean!
    notificationsTickets: Boolean!
    updatedAt: DateTime!
}
```

---

### ProfileUpdatePayload

```graphql
type ProfileUpdatePayload {
    userId: UUID!
    profile: UserProfile!
    updatedAt: DateTime!
}
```

---

### PreferencesUpdatePayload

```graphql
type PreferencesUpdatePayload {
    userId: UUID!
    preferences: UserPreferences!
    updatedAt: DateTime!
}
```

---

### UserStatusPayload

```graphql
type UserStatusPayload {
    userId: UUID!
    status: UserStatus!
    reason: String
    updatedAt: DateTime!
}
```

---

### UserRoleResult

```graphql
type UserRoleResult {
    success: Boolean!
    message: String!
    role: UserRoleInfo!
}
```

---

### UserRoleInfo

```graphql
type UserRoleInfo {
    id: UUID!
    roleCode: RoleCode!
    roleName: String!
    company: CompanyMinimal
    isActive: Boolean!
    assignedAt: DateTime!
    assignedBy: UserMinimal
}
```

---

### RoleInfo

```graphql
type RoleInfo {
    code: RoleCode!
    name: String!
    description: String!
    requiresCompany: Boolean!
    defaultDashboard: String!
    isSystemRole: Boolean!
}
```

---

## ğŸ“ INPUTS

### UpdateProfileInput

```graphql
input UpdateProfileInput {
    firstName: String
    lastName: String
    phoneNumber: String
    avatarUrl: String
}
```

**Validaciones:**
- `firstName`: mÃ­nimo 2, mÃ¡ximo 100 caracteres
- `lastName`: mÃ­nimo 2, mÃ¡ximo 100 caracteres
- `phoneNumber`: entre 10 y 20 caracteres
- `avatarUrl`: URL vÃ¡lida

---

### PreferencesInput

```graphql
input PreferencesInput {
    theme: String
    language: String
    timezone: String
    pushWebNotifications: Boolean
    notificationsTickets: Boolean
}
```

**Validaciones:**
- `theme`: debe ser "light" o "dark"
- `language`: debe ser "es" o "en"
- `timezone`: zona horaria IANA vÃ¡lida

---

### AssignRoleInput

```graphql
input AssignRoleInput {
    userId: UUID!
    roleCode: RoleCode!
    companyId: UUID
}
```

---

### UserFilters

```graphql
input UserFilters {
    search: String
    status: UserStatus
    role: RoleCode
    emailVerified: Boolean
    companyId: UUID
    recentActivity: Boolean
    createdBetween: DateRange
}
```

---

## ğŸ­ ROLES DEL SISTEMA

### Arquitectura de Roles

| Rol | Requiere Empresa | Scope | Dashboard |
|-----|------------------|-------|-----------|
| USER | âŒ NO | Global | `/tickets` |
| PLATFORM_ADMIN | âŒ NO | Global | `/admin/dashboard` |
| AGENT | âœ… SÃ | Por empresa | `/agent/dashboard` |
| COMPANY_ADMIN | âœ… SÃ | Por empresa | `/empresa/dashboard` |

---

## ğŸ”’ PERMISOS Y SEGURIDAD

### Matriz de Permisos

| OperaciÃ³n | USER | AGENT | COMPANY_ADMIN | PLATFORM_ADMIN |
|-----------|------|-------|---------------|----------------|
| `me` | âœ… | âœ… | âœ… | âœ… |
| `myProfile` | âœ… | âœ… | âœ… | âœ… |
| `myPreferences` | âœ… | âœ… | âœ… | âœ… |
| `updateMyProfile` | âœ… | âœ… | âœ… | âœ… |
| `updateMyPreferences` | âœ… | âœ… | âœ… | âœ… |
| `users` | âŒ | âŒ | âœ… (empresa) | âœ… (todos) |
| `user(id)` | âŒ | âŒ | âœ… (empresa) | âœ… (todos) |
| `suspendUser` | âŒ | âŒ | âŒ | âœ… |
| `activateUser` | âŒ | âŒ | âŒ | âœ… |
| `deleteUser` | âŒ | âŒ | âŒ | âœ… |
| `assignRole` | âŒ | âŒ | âœ… (su empresa) | âœ… (todos) |
| `removeRole` | âŒ | âŒ | âœ… (su empresa) | âœ… (todos) |

---

## ğŸš¨ CÃ“DIGOS DE ERROR

```typescript
enum UserManagementErrors {
    USER_NOT_FOUND = 'USER_NOT_FOUND',
    EMAIL_ALREADY_EXISTS = 'EMAIL_ALREADY_EXISTS',
    INVALID_ROLE_ASSIGNMENT = 'INVALID_ROLE_ASSIGNMENT',
    ROLE_REQUIRES_COMPANY = 'ROLE_REQUIRES_COMPANY',
    ROLE_SHOULD_NOT_HAVE_COMPANY = 'ROLE_SHOULD_NOT_HAVE_COMPANY',
    INSUFFICIENT_PERMISSIONS = 'INSUFFICIENT_PERMISSIONS',
    PROFILE_UPDATE_FAILED = 'PROFILE_UPDATE_FAILED',
    USER_SUSPENDED = 'USER_SUSPENDED',
    USER_ALREADY_HAS_ROLE = 'USER_ALREADY_HAS_ROLE',
    CANNOT_REMOVE_LAST_ADMIN = 'CANNOT_REMOVE_LAST_ADMIN',
    INVALID_INPUT = 'INVALID_INPUT'
}
```

---

## ğŸ’¡ CASOS DE USO

### Caso 1: Actualizar Perfil Personal

```graphql
# 1. Actualizar datos personales
mutation UpdateProfile {
    updateMyProfile(input: {
        firstName: "MarÃ­a Alejandra"
        phoneNumber: "+591 75987654"
    }) {
        userId
        profile {
            firstName
            lastName
            displayName
            phoneNumber
        }
    }
}

# 2. Actualizar preferencias (separado)
mutation UpdatePreferences {
    updateMyPreferences(input: {
        theme: "dark"
        language: "es"
    }) {
        userId
        preferences {
            theme
            language
        }
    }
}
```

---

### Caso 2: Cache Frontend con Payloads EspecÃ­ficos

```typescript
// âœ… Apollo actualiza cache automÃ¡ticamente
const [updateProfile] = useMutation(UPDATE_MY_PROFILE, {
    update(cache, { data: { updateMyProfile } }) {
        cache.modify({
            id: cache.identify({ __typename: 'User', id: userId }),
            fields: {
                profile() {
                    return updateMyProfile.profile;
                },
                updatedAt() {
                    return updateMyProfile.updatedAt;
                }
            }
        });
        // roleContexts, ticketsCount permanecen sin cambios âœ…
    }
});
```

---

## ğŸ”„ MIGRACIÃ“N DESDE V9.0

### Schema GraphQL

```graphql
# âŒ ANTES V9.0
type Mutation {
    updateMyProfile(input: UpdateProfileInput!): User!
    updateMyPreferences(input: PreferencesInput!): User!
    suspendUser(id: UUID!, reason: String): User!
    activateUser(id: UUID!): User!
}

# âœ… AHORA V10.1
type Mutation {
    updateMyProfile(input: UpdateProfileInput!): ProfileUpdatePayload!
    updateMyPreferences(input: PreferencesInput!): PreferencesUpdatePayload!
    suspendUser(id: UUID!, reason: String): UserStatusPayload!
    activateUser(id: UUID!): UserStatusPayload!
}

# Agregar nuevos tipos
type ProfileUpdatePayload {
    userId: UUID!
    profile: UserProfile!
    updatedAt: DateTime!
}

type PreferencesUpdatePayload {
    userId: UUID!
    preferences: UserPreferences!
    updatedAt: DateTime!
}

type UserStatusPayload {
    userId: UUID!
    status: UserStatus!
    reason: String
    updatedAt: DateTime!
}

# Separar preferencias
type UserProfile {
    firstName: String!
    lastName: String!
    displayName: String!
    phoneNumber: String
    avatarUrl: URL
    createdAt: DateTime!
    updatedAt: DateTime!
}

type UserPreferences {
    theme: String!
    language: String!
    timezone: String!
    pushWebNotifications: Boolean!
    notificationsTickets: Boolean!
    updatedAt: DateTime!
}
```

---

### Backend (Laravel) - Resolvers

```php
// UpdateMyProfile.php
public function __invoke($root, array $args, $context)
{
    $user = $context->user();
    $user->profile->update($args['input']);
    $user->touch();

    // âœ… Retornar solo lo necesario
    return [
        'userId' => $user->id,
        'profile' => $user->profile->fresh(),
        'updatedAt' => $user->fresh()->updated_at,
    ];
}
```

```php
// ActivateUser.php
public function __invoke($root, array $args)
{
    $user = User::findOrFail($args['id']);
    $user->update(['status' => 'ACTIVE']);

    // âœ… Retornar solo lo relevante
    return [
        'userId' => $user->id,
        'status' => $user->status,
        'updatedAt' => $user->updated_at,
    ];
}
```

---

### Frontend (React + TypeScript)

```typescript
// âŒ ANTES V9.0
const UPDATE_MY_PROFILE = gql`
    mutation UpdateMyProfile($input: UpdateProfileInput!) {
        updateMyProfile(input: $input) {
            id
            profile { ... }
            roleContexts { ... }  # âŒ Innecesario
            ticketsCount          # âŒ Innecesario
        }
    }
`;

// âœ… AHORA V10.1
const UPDATE_MY_PROFILE = gql`
    mutation UpdateMyProfile($input: UpdateProfileInput!) {
        updateMyProfile(input: $input) {
            userId
            profile {
                firstName
                lastName
                displayName
                phoneNumber
                avatarUrl
                updatedAt
            }
            updatedAt
        }
    }
`;
```

---

## ğŸ¯ RESUMEN FINAL

### ComparaciÃ³n V9.0 vs V10.1

| Aspecto | V9.0 | V10.1 |
|---------|------|-------|
| Mutations con User! | 4 | 0 |
| Payloads especÃ­ficos | 1 | 4 |
| Queries | 5 | 6 |
| Mutations | 7 | 7 |
| SeparaciÃ³n Profile/Preferences | âŒ | âœ… |
| Over-fetching | âœ… Posible | âŒ Imposible |
| Pattern profesional | âŒ | âœ… |

### API V10.1 - NÃºmeros Finales

**Queries: 6**
- `me` (User! completo)
- `myProfile` (solo datos personales)
- `myPreferences` (solo preferencias)
- `users` (paginado)
- `user(id)` (User! completo)
- `availableRoles`

**Mutations: 7**
- `updateMyProfile` â†’ `ProfileUpdatePayload!`
- `updateMyPreferences` â†’ `PreferencesUpdatePayload!`
- `suspendUser` â†’ `UserStatusPayload!`
- `activateUser` â†’ `UserStatusPayload!`
- `deleteUser` â†’ `Boolean!`
- `assignRole` â†’ `UserRoleResult!`
- `removeRole` â†’ `Boolean!`

**Resultado:** 13 operaciones totales, 100% sin over-fetching

---

## âœ… CHECKLIST DE IMPLEMENTACIÃ“N

**Backend:**
- [ ] Crear tipos `ProfileUpdatePayload`, `PreferencesUpdatePayload`, `UserStatusPayload`
- [ ] Separar `UserProfile` y `UserPreferences` en schema
- [ ] Actualizar resolvers para retornar payloads especÃ­ficos
- [ ] Agregar query `myPreferences`
- [ ] Actualizar tests

**Frontend:**
- [ ] Actualizar mutations para usar nuevos payloads
- [ ] Crear query `myPreferences`
- [ ] Actualizar cache management de Apollo
- [ ] Actualizar interfaces TypeScript
- [ ] Actualizar tests

---

**Fin de la DocumentaciÃ³n V10.1 Corregida**

> **CAMBIOS PROFESIONALES APLICADOS:**
> - âœ… Payloads especÃ­ficos en todas las mutations de actualizaciÃ³n
> - âœ… SeparaciÃ³n de UserProfile y UserPreferences
> - âœ… User! solo en queries de lectura completa
> - âœ… Sin posibilidad de over-fetching
> - âœ… Pattern de GitHub, Shopify, Stripe
> - âœ… Backend carga solo datos necesarios
> - âœ… Type-safe y semÃ¡nticamente correcto
