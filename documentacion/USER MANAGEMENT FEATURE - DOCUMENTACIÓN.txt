# üìò USER MANAGEMENT API V9.0 - DOCUMENTACI√ìN COMPLETA

> Sistema Helpdesk Multi-Tenant
> Feature: User Management
> Schema Version: 9.0 (Refactorizado - Sin Nested Innecesario)
> √öltima actualizaci√≥n: 2025

---

## üìë TABLA DE CONTENIDOS

1. [Introducci√≥n](#introducci√≥n)
2. [Arquitectura](#arquitectura)
3. [Queries](#queries)
4. [Mutations](#mutations)
5. [Types](#types)
6. [Roles del Sistema](#roles-del-sistema)
7. [Permisos y Seguridad](#permisos-y-seguridad)
8. [C√≥digos de Error](#c√≥digos-de-error)
9. [Casos de Uso](#casos-de-uso)

---

## üéØ INTRODUCCI√ìN

### Prop√≥sito del Feature
El **User Management Feature** gestiona usuarios, perfiles y roles en el sistema Helpdesk multi-tenant:
- Gesti√≥n completa de usuarios (CRUD)
- Administraci√≥n de perfiles personales
- Asignaci√≥n y revocaci√≥n de roles
- Gesti√≥n de permisos por empresa
- Multi-rol y multi-tenant

### Caracter√≠sticas Principales
‚úÖ **Multi-Rol**: Un usuario puede tener m√∫ltiples roles
‚úÖ **Multi-Tenant**: Roles asociados a empresas espec√≠ficas
‚úÖ **Perfiles Personalizados**: Preferencias de interfaz y notificaciones
‚úÖ **Gesti√≥n Granular**: Permisos espec√≠ficos por rol y empresa
‚úÖ **Reutilizaci√≥n de Types**: Usa shared types para evitar duplicaci√≥n

---

## üèóÔ∏è ARQUITECTURA

### Cambios Clave en V9.0

#### ‚úÖ **Eliminaci√≥n de Nested Innecesario**

```graphql
# Antes V8.0 (nested confuso)
type UserRole {
    roleInfo {
        code: String!
        name: String!
        description: String!
    }
    companyInfo {
        id: UUID!
        name: String!
        # ... muchos campos
    }
}

# Ahora V9.0 (flat y claro)
type UserRole {
    roleCode: RoleCode!
    roleName: String!
    roleDescription: String!
    company: CompanyMinimal  # Reutiliza shared type
}
```

#### ‚úÖ **Roles SIN Over-Fetching**

```graphql
# Antes V8.0 (campos siempre presentes)
type UserRole {
    companyId: UUID        # null para USER
    companyName: String    # null para USER
}

# Ahora V9.0 (opcional cuando aplica)
type UserRole {
    requiresCompany: Boolean!
    company: CompanyMinimal  # Presente SOLO si requiresCompany = true
}
```

#### ‚úÖ **Reutilizaci√≥n de Shared Types**

```graphql
# UserRole usa:
- CompanyMinimal (de shared/types.graphql)
- UserMinimal (de shared/types.graphql)

# User usa:
- CompanyMinimal[] para companies
```

---

## üîç QUERIES

### 1. `me` - Usuario Autenticado Completo

**Descripci√≥n**: Obtiene informaci√≥n completa del usuario autenticado.

**Firma:**
```graphql
me: User!
```

**Directivas:**
- `@auth`: Requiere autenticaci√≥n

**Request:**
```graphql
query Me {
    me {
        # Identificadores
        id
        userCode

        # Datos b√°sicos
        email
        emailVerified
        status
        authProvider

        # Perfil
        profile {
            firstName
            lastName
            displayName
            phoneNumber
            avatarUrl
            theme
            language
            timezone
            pushWebNotifications
            notificationsTickets
        }

        # Roles (consistente con Authentication)
        roleContexts {
            roleCode
            roleName
            company {
                id
                companyCode
                name
                logoUrl
            }
            dashboardPath
        }

        # Historial completo de roles
        roleHistory {
            id
            roleCode
            roleName
            company {
                id
                name
            }
            isActive
            assignedAt
        }

        # Empresas relacionadas
        companies {
            id
            companyCode
            name
            logoUrl
        }

        # Estados calculados
        isAdmin
        canCreateTickets

        # Estad√≠sticas
        ticketsCount
        resolvedTicketsCount
        averageRating

        # Auditor√≠a
        createdAt
        updatedAt
    }
}
```

**Response:**
```json
{
    "data": {
        "me": {
            "id": "550e8400-e29b-41d4-a716-446655440000",
            "userCode": "USR-2025-00123",
            "email": "maria.garcia@empresa.com",
            "emailVerified": true,
            "status": "ACTIVE",
            "authProvider": "LOCAL",
            "profile": {
                "firstName": "Mar√≠a",
                "lastName": "Garc√≠a",
                "displayName": "Mar√≠a Garc√≠a",
                "phoneNumber": "+591 70123456",
                "avatarUrl": "https://storage.helpdesk.com/avatars/usr_123.jpg",
                "theme": "dark",
                "language": "es",
                "timezone": "America/La_Paz",
                "pushWebNotifications": true,
                "notificationsTickets": false
            },
            "roleContexts": [
                {
                    "roleCode": "USER",
                    "roleName": "Cliente",
                    "company": null,
                    "dashboardPath": "/tickets"
                },
                {
                    "roleCode": "AGENT",
                    "roleName": "Agente de Soporte",
                    "company": {
                        "id": "cmp-001",
                        "name": "Universidad del Valle",
                        "logoUrl": "https://storage.helpdesk.com/logos/cmp_001.png"
                    },
                    "dashboardPath": "/agent/dashboard"
                }
            ],
            "roleHistory": [
                {
                    "id": "role-001",
                    "roleCode": "USER",
                    "roleName": "Cliente",
                    "company": null,
                    "isActive": true,
                    "assignedAt": "2025-01-15T08:00:00Z"
                },
                {
                    "id": "role-002",
                    "roleCode": "AGENT",
                    "roleName": "Agente de Soporte",
                    "company": {
                        "id": "cmp-001",
                        "name": "Universidad del Valle"
                    },
                    "isActive": true,
                    "assignedAt": "2025-03-10T10:15:00Z"
                }
            ],
            "companies": [
                {
                    "id": "cmp-001",
                    "companyCode": "CMP-2025-00001",
                    "name": "Universidad del Valle",
                    "logoUrl": "https://storage.helpdesk.com/logos/cmp_001.png"
                }
            ],
            "isAdmin": false,
            "canCreateTickets": true,
            "ticketsCount": 47,
            "resolvedTicketsCount": 23,
            "averageRating": 4.3,
            "createdAt": "2025-01-15T08:00:00Z",
            "updatedAt": "2025-09-20T14:22:00Z"
        }
    }
}
```

**Casos de Uso:**
- Header de usuario en interfaz
- P√°gina completa de perfil
- Validaci√≥n de permisos
- Selector de roles/empresas
- Dashboard personalizado

---

### 2. `myProfile` - Perfil Personal

**Descripci√≥n**: Obtiene solo la informaci√≥n del perfil del usuario autenticado.

**Firma:**
```graphql
myProfile: UserProfile!
```

**Directivas:**
- `@auth`: Requiere autenticaci√≥n

**Request:**
```graphql
query MyProfile {
    myProfile {
        firstName
        lastName
        displayName
        phoneNumber
        avatarUrl
        theme
        language
        timezone
        pushWebNotifications
        notificationsTickets
        lastActivityAt
        createdAt
        updatedAt
    }
}
```

**Response:**
```json
{
    "data": {
        "myProfile": {
            "firstName": "Mar√≠a",
            "lastName": "Garc√≠a",
            "displayName": "Mar√≠a Garc√≠a",
            "phoneNumber": "+591 70123456",
            "avatarUrl": "https://storage.helpdesk.com/avatars/usr_123.jpg",
            "theme": "dark",
            "language": "es",
            "timezone": "America/La_Paz",
            "pushWebNotifications": true,
            "notificationsTickets": false,
            "lastActivityAt": "2025-10-03T15:30:00Z",
            "createdAt": "2025-01-15T08:00:00Z",
            "updatedAt": "2025-09-20T14:22:00Z"
        }
    }
}
```

**Casos de Uso:**
- Formularios de edici√≥n de perfil
- P√°gina de configuraci√≥n personal
- Sincronizaci√≥n de preferencias

---

### 3. `users` - Lista Paginada de Usuarios

**Descripci√≥n**: Lista paginada de usuarios con filtros avanzados. Solo administradores.

**Firma:**
```graphql
users(
    filters: UserFilters
    orderBy: [UserOrderBy!]
    page: Int = 1
    first: Int = 15
): UserPaginator!
```

**Directivas:**
- `@auth(requires: [PLATFORM_ADMIN, COMPANY_ADMIN])`: Solo admins
- `@paginate(maxCount: 50)`: M√°ximo 50 por p√°gina

**Request:**
```graphql
query Users(
    $filters: UserFilters
    $orderBy: [UserOrderBy!]
    $page: Int
    $first: Int
) {
    users(
        filters: $filters
        orderBy: $orderBy
        page: $page
        first: $first
    ) {
        data {
            id
            userCode
            email
            emailVerified
            status
            profile {
                firstName
                lastName
                displayName
                avatarUrl
            }
            activeRoles {
                roleCode
                company {
                    name
                }
            }
            lastLoginAt
            ticketsCount
            createdAt
        }
        paginatorInfo {
            total
            perPage
            currentPage
            lastPage
            hasMorePages
        }
    }
}
```

**Variables:**
```json
{
    "filters": {
        "search": "maria",
        "status": "ACTIVE",
        "role": "AGENT",
        "emailVerified": true,
        "companyId": "cmp-001",
        "recentActivity": true
    },
    "orderBy": [
        {
            "field": "LAST_LOGIN_AT",
            "order": "DESC"
        }
    ],
    "page": 1,
    "first": 20
}
```

**Response:**
```json
{
    "data": {
        "users": {
            "data": [
                {
                    "id": "550e8400-e29b-41d4-a716-446655440000",
                    "userCode": "USR-2025-00123",
                    "email": "maria.garcia@empresa.com",
                    "emailVerified": true,
                    "status": "ACTIVE",
                    "profile": {
                        "firstName": "Mar√≠a",
                        "lastName": "Garc√≠a",
                        "displayName": "Mar√≠a Garc√≠a",
                        "avatarUrl": "https://storage.helpdesk.com/avatars/usr_123.jpg"
                    },
                    "activeRoles": [
                        {
                            "roleCode": "AGENT",
                            "company": {
                                "name": "Universidad del Valle"
                            }
                        }
                    ],
                    "lastLoginAt": "2025-10-03T14:45:00Z",
                    "ticketsCount": 47,
                    "createdAt": "2025-01-15T08:00:00Z"
                }
            ],
            "paginatorInfo": {
                "total": 156,
                "perPage": 20,
                "currentPage": 1,
                "lastPage": 8,
                "hasMorePages": true
            }
        }
    }
}
```

**Filtros Disponibles:**

| Filtro | Tipo | Descripci√≥n |
|--------|------|-------------|
| `search` | String | Busca en email/nombre |
| `status` | UserStatus | ACTIVE, SUSPENDED, DELETED |
| `role` | RoleCode | USER, AGENT, COMPANY_ADMIN, PLATFORM_ADMIN |
| `emailVerified` | Boolean | Si email est√° verificado |
| `companyId` | UUID | Usuarios de una empresa |
| `recentActivity` | Boolean | Activos √∫ltimos 7 d√≠as |
| `createdBetween` | DateRange | Rango de fecha de creaci√≥n |

**Casos de Uso:**
- Panel de administraci√≥n de usuarios
- B√∫squeda de usuarios para asignar roles
- Reportes de actividad

---

### 4. `user` - Usuario Espec√≠fico

**Descripci√≥n**: Obtiene informaci√≥n completa de un usuario por ID.

**Firma:**
```graphql
user(id: UUID!): User
```

**Directivas:**
- `@auth`: Requiere autenticaci√≥n
- `@can(ability: "view", model: "User", find: "id")`: Valida permisos

**Request:**
```graphql
query User($id: UUID!) {
    user(id: $id) {
        id
        userCode
        email
        status
        profile {
            firstName
            lastName
            displayName
        }
        roles {
            roleCode
            roleName
            company {
                name
            }
            isActive
        }
        ticketsCount
        createdAt
    }
}
```

**Variables:**
```json
{
    "id": "550e8400-e29b-41d4-a716-446655440000"
}
```

**Casos de Uso:**
- P√°gina de detalle de usuario
- Modal de informaci√≥n de usuario
- Verificaci√≥n antes de asignar roles

---

### 5. `companyUsers` - Usuarios de Empresa

**Descripci√≥n**: Lista usuarios de una empresa espec√≠fica con su rol en esa empresa.

**Firma:**
```graphql
companyUsers(
    companyId: UUID!
    filters: CompanyUserFilters
    first: Int = 50
): [UserCompanyInfo!]!
```

**Directivas:**
- `@auth(requires: [COMPANY_ADMIN, AGENT])`: Solo admin/agentes de empresa
- `@company(requireOwnership: true)`: Valida ownership de empresa

**Request:**
```graphql
query CompanyUsers(
    $companyId: UUID!
    $filters: CompanyUserFilters
) {
    companyUsers(
        companyId: $companyId
        filters: $filters
    ) {
        user {
            id
            userCode
            email
            displayName
            avatarUrl
        }
        roleCode
        roleName
        isActive
        joinedAt
        ticketsAssigned
        ticketsResolved
        lastActivityAt
    }
}
```

**Variables:**
```json
{
    "companyId": "cmp-001",
    "filters": {
        "search": "juan",
        "role": "AGENT",
        "activeOnly": true
    }
}
```

**Response:**
```json
{
    "data": {
        "companyUsers": [
            {
                "user": {
                    "id": "550e8400-e29b-41d4-a716-446655440010",
                    "userCode": "USR-2025-00234",
                    "email": "juan.perez@empresa.com",
                    "displayName": "Juan P√©rez",
                    "avatarUrl": "https://storage.helpdesk.com/avatars/usr_234.jpg"
                },
                "roleCode": "AGENT",
                "roleName": "Agente de Soporte",
                "isActive": true,
                "joinedAt": "2025-02-10T09:00:00Z",
                "ticketsAssigned": 45,
                "ticketsResolved": 38,
                "lastActivityAt": "2025-10-03T14:30:00Z"
            }
        ]
    }
}
```

**Casos de Uso:**
- Panel de gesti√≥n de equipo
- Asignaci√≥n de tickets por agente
- Estad√≠sticas del equipo

---

### 6. `availableRoles` - Roles Disponibles

**Descripci√≥n**: Lista de roles del sistema con sus descripciones.

**Firma:**
```graphql
availableRoles: [RoleInfo!]!
```

**Directivas:**
- `@auth(requires: [PLATFORM_ADMIN, COMPANY_ADMIN])`: Solo admins
- `@cache(ttl: 3600)`: Cache de 1 hora

**Request:**
```graphql
query AvailableRoles {
    availableRoles {
        code
        name
        description
        requiresCompany
        defaultDashboard
        permissions
        priority
        isSystemRole
    }
}
```

**Response:**
```json
{
    "data": {
        "availableRoles": [
            {
                "code": "PLATFORM_ADMIN",
                "name": "Administrador de Plataforma",
                "description": "Acceso completo a todo el sistema",
                "requiresCompany": false,
                "defaultDashboard": "/admin/dashboard",
                "permissions": ["*"],
                "priority": 1,
                "isSystemRole": true
            },
            {
                "code": "COMPANY_ADMIN",
                "name": "Administrador de Empresa",
                "description": "Gestiona una empresa espec√≠fica",
                "requiresCompany": true,
                "defaultDashboard": "/empresa/dashboard",
                "permissions": ["company.manage", "agents.manage", "tickets.view"],
                "priority": 2,
                "isSystemRole": true
            },
            {
                "code": "AGENT",
                "name": "Agente de Soporte",
                "description": "Atiende tickets de soporte",
                "requiresCompany": true,
                "defaultDashboard": "/agent/dashboard",
                "permissions": ["tickets.respond", "tickets.resolve"],
                "priority": 3,
                "isSystemRole": true
            },
            {
                "code": "USER",
                "name": "Cliente",
                "description": "Usuario que crea tickets",
                "requiresCompany": false,
                "defaultDashboard": "/tickets",
                "permissions": ["tickets.create", "tickets.view.own"],
                "priority": 4,
                "isSystemRole": true
            }
        ]
    }
}
```

**Casos de Uso:**
- Selector de roles en formularios
- Documentaci√≥n de permisos
- Validaci√≥n de asignaciones

---

## ‚úèÔ∏è MUTATIONS

### 1. `updateMyProfile` - Actualizar Perfil Propio

**Descripci√≥n**: Permite a cualquier usuario actualizar su propio perfil.

**Firma:**
```graphql
updateMyProfile(input: UpdateProfileInput!): User!
```

**Directivas:**
- `@auth`: Requiere autenticaci√≥n
- `@rateLimit(max: 30, window: 3600)`: M√°ximo 30 actualizaciones por hora
- `@audit(action: "profile_update")`: Auditor√≠a autom√°tica

**Request:**
```graphql
mutation UpdateMyProfile($input: UpdateProfileInput!) {
    updateMyProfile(input: $input) {
        id
        profile {
            firstName
            lastName
            displayName
            phoneNumber
            avatarUrl
            updatedAt
        }
    }
}
```

**Variables:**
```json
{
    "input": {
        "firstName": "Mar√≠a Alejandra",
        "lastName": "Garc√≠a Rodr√≠guez",
        "phoneNumber": "+591 75987654",
        "avatarUrl": "https://storage.helpdesk.com/avatars/new_avatar.jpg"
    }
}
```

**Validaciones:**
- `firstName`: m√≠nimo 2, m√°ximo 100 caracteres
- `lastName`: m√≠nimo 2, m√°ximo 100 caracteres
- `phoneNumber`: entre 10 y 20 caracteres
- `avatarUrl`: URL v√°lida

**Response:**
```json
{
    "data": {
        "updateMyProfile": {
            "id": "550e8400-e29b-41d4-a716-446655440000",
            "profile": {
                "firstName": "Mar√≠a Alejandra",
                "lastName": "Garc√≠a Rodr√≠guez",
                "displayName": "Mar√≠a Alejandra Garc√≠a Rodr√≠guez",
                "phoneNumber": "+591 75987654",
                "avatarUrl": "https://storage.helpdesk.com/avatars/new_avatar.jpg",
                "updatedAt": "2025-10-03T16:30:00Z"
            }
        }
    }
}
```

---

### 2. `updateMyPreferences` - Actualizar Preferencias

**Descripci√≥n**: Actualiza preferencias de interfaz y notificaciones.

**Firma:**
```graphql
updateMyPreferences(input: PreferencesInput!): User!
```

**Directivas:**
- `@auth`: Requiere autenticaci√≥n
- `@rateLimit(max: 50, window: 3600)`: M√°ximo 50 actualizaciones por hora
- `@audit(action: "preferences_update")`: Auditor√≠a autom√°tica

**Request:**
```graphql
mutation UpdateMyPreferences($input: PreferencesInput!) {
    updateMyPreferences(input: $input) {
        id
        profile {
            theme
            language
            timezone
            pushWebNotifications
            notificationsTickets
            updatedAt
        }
    }
}
```

**Variables:**
```json
{
    "input": {
        "theme": "dark",
        "language": "en",
        "timezone": "America/New_York",
        "pushWebNotifications": false,
        "notificationsTickets": true
    }
}
```

**Validaciones:**
- `theme`: debe ser "light" o "dark"
- `language`: debe ser "es" o "en"
- `timezone`: zona horaria IANA v√°lida

**Response:**
```json
{
    "data": {
        "updateMyPreferences": {
            "id": "550e8400-e29b-41d4-a716-446655440000",
            "profile": {
                "theme": "dark",
                "language": "en",
                "timezone": "America/New_York",
                "pushWebNotifications": false,
                "notificationsTickets": true,
                "updatedAt": "2025-10-03T16:35:00Z"
            }
        }
    }
}
```

---

### 3. `completeMyProfile` - Completar Perfil

**Descripci√≥n**: Completa informaci√≥n adicional del perfil despu√©s del registro.

**Firma:**
```graphql
completeMyProfile(input: CompleteProfileInput!): User!
```

**Directivas:**
- `@auth`: Requiere autenticaci√≥n
- `@audit(action: "profile_complete")`: Auditor√≠a autom√°tica

**Request:**
```graphql
mutation CompleteMyProfile($input: CompleteProfileInput!) {
    completeMyProfile(input: $input) {
        id
        profile {
            phoneNumber
            avatarUrl
            theme
            language
            timezone
            pushWebNotifications
            notificationsTickets
        }
    }
}
```

**Variables:**
```json
{
    "input": {
        "phoneNumber": "+591 70123456",
        "avatarUrl": "https://storage.helpdesk.com/avatars/completed.jpg",
        "theme": "dark",
        "language": "es",
        "timezone": "America/La_Paz",
        "pushWebNotifications": true,
        "notificationsTickets": false
    }
}
```

**Casos de Uso:**
- Flujo de onboarding post-registro
- Completar informaci√≥n faltante
- Configuraci√≥n inicial de preferencias

---

### 4. `createUser` - Crear Usuario (Admin)

**Descripci√≥n**: Crea un nuevo usuario. Solo platform admins.

**Firma:**
```graphql
createUser(input: CreateUserInput!): User!
```

**Directivas:**
- `@auth(requires: [PLATFORM_ADMIN])`: Solo platform admins
- `@rateLimit(max: 10, window: 3600)`: M√°ximo 10 usuarios por hora
- `@audit(action: "user_create", includePayload: true)`: Auditor√≠a completa

**Request:**
```graphql
mutation CreateUser($input: CreateUserInput!) {
    createUser(input: $input) {
        id
        userCode
        email
        status
        profile {
            firstName
            lastName
            displayName
        }
        roles {
            roleCode
            company {
                name
            }
        }
        createdAt
    }
}
```

**Variables:**
```json
{
    "input": {
        "email": "nuevo.agente@empresa.com",
        "password": "TempPassword123!",
        "firstName": "Juan",
        "lastName": "P√©rez",
        "status": "ACTIVE",
        "initialRoles": [
            {
                "userId": "550e8400-e29b-41d4-a716-446655440000",
                "roleCode": "AGENT",
                "companyId": "cmp-001",
                "isActive": true
            }
        ],
        "sendWelcomeEmail": true
    }
}
```

**Validaciones:**
- `email`: √∫nico en sistema, formato v√°lido
- `password`: m√≠nimo 8 caracteres
- `firstName`, `lastName`: entre 2 y 100 caracteres
- `initialRoles`: roles v√°lidos con permisos adecuados

**Flujo de Proceso:**
1. Validar email √∫nico
2. Crear usuario con password hasheado
3. Crear perfil asociado
4. Asignar roles iniciales
5. Enviar email de bienvenida (si solicitado)
6. Registrar en auditor√≠a

---

### 5. `updateUser` - Actualizar Usuario

**Descripci√≥n**: Actualiza informaci√≥n de un usuario espec√≠fico. Solo admins.

**Firma:**
```graphql
updateUser(id: UUID!, input: UpdateUserInput!): User!
```

**Directivas:**
- `@auth(requires: [PLATFORM_ADMIN, COMPANY_ADMIN])`: Solo admins
- `@can(ability: "update", model: "User", find: "id")`: Valida permisos
- `@audit(action: "user_update", includePayload: true)`: Auditor√≠a completa

**Request:**
```graphql
mutation UpdateUser($id: UUID!, $input: UpdateUserInput!) {
    updateUser(id: $id, input: $input) {
        id
        email
        status
        profile {
            firstName
            lastName
        }
        updatedAt
    }
}
```

**Variables:**
```json
{
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "input": {
        "email": "nuevo.email@empresa.com",
        "status": "SUSPENDED",
        "profile": {
            "firstName": "Juan Carlos",
            "lastName": "P√©rez Silva"
        },
        "forceEmailVerification": true
    }
}
```

---

### 6. `suspendUser` - Suspender Usuario

**Descripci√≥n**: Suspende temporalmente un usuario del sistema.

**Firma:**
```graphql
suspendUser(id: UUID!, reason: String): User!
```

**Directivas:**
- `@auth(requires: [PLATFORM_ADMIN])`: Solo platform admins
- `@audit(action: "user_suspend", includePayload: true)`: Auditor√≠a completa

**Request:**
```graphql
mutation SuspendUser($id: UUID!, $reason: String) {
    suspendUser(id: $id, reason: $reason) {
        id
        status
        updatedAt
    }
}
```

**Variables:**
```json
{
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "reason": "Violaci√≥n de t√©rminos de servicio - spam de tickets"
}
```

**Efectos:**
- Cambia status a "SUSPENDED"
- Invalida todos los tokens activos
- Registra motivo en auditor√≠a
- Env√≠a notificaci√≥n al usuario

---

### 7. `activateUser` - Activar Usuario

**Descripci√≥n**: Reactiva un usuario suspendido.

**Firma:**
```graphql
activateUser(id: UUID!): User!
```

**Directivas:**
- `@auth(requires: [PLATFORM_ADMIN])`: Solo platform admins
- `@audit(action: "user_activate")`: Auditor√≠a autom√°tica

**Request:**
```graphql
mutation ActivateUser($id: UUID!) {
    activateUser(id: $id) {
        id
        status
        updatedAt
    }
}
```

**Efectos:**
- Cambia status a "ACTIVE"
- Permite nuevo login
- Registra reactivaci√≥n en auditor√≠a

---

### 8. `deleteUser` - Eliminar Usuario

**Descripci√≥n**: Elimina l√≥gicamente un usuario (soft delete).

**Firma:**
```graphql
deleteUser(id: UUID!, reason: String): Boolean!
```

**Directivas:**
- `@auth(requires: [PLATFORM_ADMIN])`: Solo platform admins
- `@audit(action: "user_delete", includePayload: true)`: Auditor√≠a completa

**Request:**
```graphql
mutation DeleteUser($id: UUID!, $reason: String) {
    deleteUser(id: $id, reason: $reason)
}
```

**Variables:**
```json
{
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "reason": "Solicitud del usuario - GDPR compliance"
}
```

**Efectos:**
- Cambia status a "DELETED"
- Establece deletedAt timestamp
- Anonimiza datos sensibles
- Mantiene registros para auditor√≠a

---

### 9. `assignRole` - Asignar Rol

**Descripci√≥n**: Asigna un rol espec√≠fico a un usuario.

**Firma:**
```graphql
assignRole(input: AssignRoleInput!): UserRole!
```

**Directivas:**
- `@auth(requires: [PLATFORM_ADMIN, COMPANY_ADMIN])`: Solo admins
- `@rateLimit(max: 100, window: 3600)`: M√°ximo 100 asignaciones por hora
- `@audit(action: "role_assign", includePayload: true)`: Auditor√≠a completa

**Request:**
```graphql
mutation AssignRole($input: AssignRoleInput!) {
    assignRole(input: $input) {
        id
        roleCode
        roleName
        roleDescription
        requiresCompany
        company {
            id
            name
            logoUrl
        }
        isActive
        assignedAt
        assignedBy {
            displayName
        }
    }
}
```

**Variables (Rol CON Empresa - AGENT):**
```json
{
    "input": {
        "userId": "550e8400-e29b-41d4-a716-446655440000",
        "roleCode": "AGENT",
        "companyId": "cmp-001",
        "isActive": true
    }
}
```

**Variables (Rol SIN Empresa - USER):**
```json
{
    "input": {
        "userId": "550e8400-e29b-41d4-a716-446655440000",
        "roleCode": "USER",
        "isActive": true
    }
}
```

**Validaciones Cr√≠ticas:**

| Rol | Requiere Empresa | companyId |
|-----|------------------|-----------|
| USER | ‚ùå NO | Debe ser null |
| PLATFORM_ADMIN | ‚ùå NO | Debe ser null |
| AGENT | ‚úÖ S√ç | Obligatorio |
| COMPANY_ADMIN | ‚úÖ S√ç | Obligatorio |

**Response (AGENT con empresa):**
```json
{
    "data": {
        "assignRole": {
            "id": "role-123",
            "roleCode": "AGENT",
            "roleName": "Agente de Soporte",
            "roleDescription": "Atiende tickets de soporte",
            "requiresCompany": true,
            "company": {
                "id": "cmp-001",
                "name": "Universidad del Valle",
                "logoUrl": "https://storage.helpdesk.com/logos/cmp_001.png"
            },
            "isActive": true,
            "assignedAt": "2025-10-03T16:45:00Z",
            "assignedBy": {
                "displayName": "Admin Sistema"
            }
        }
    }
}
```

**Response (USER sin empresa):**
```json
{
    "data": {
        "assignRole": {
            "id": "role-124",
            "roleCode": "USER",
            "roleName": "Cliente",
            "roleDescription": "Usuario que crea tickets",
            "requiresCompany": false,
            "company": null,
            "isActive": true,
            "assignedAt": "2025-10-03T16:45:00Z",
            "assignedBy": {
                "displayName": "Admin Sistema"
            }
        }
    }
}
```

**Errores:**
```json
{
    "errors": [
        {
            "message": "El rol AGENT requiere empresa asociada",
            "extensions": {
                "code": "ROLE_REQUIRES_COMPANY",
                "roleCode": "AGENT"
            }
        }
    ]
}
```

```json
{
    "errors": [
        {
            "message": "El rol USER no debe tener empresa asociada",
            "extensions": {
                "code": "ROLE_SHOULD_NOT_HAVE_COMPANY",
                "roleCode": "USER"
            }
        }
    ]
}
```

---

### 10. `revokeRole` - Revocar Rol

**Descripci√≥n**: Revoca un rol espec√≠fico de un usuario.

**Firma:**
```graphql
revokeRole(userRoleId: UUID!, reason: String): Boolean!
```

**Directivas:**
- `@auth(requires: [PLATFORM_ADMIN, COMPANY_ADMIN])`: Solo admins
- `@audit(action: "role_revoke", includePayload: true)`: Auditor√≠a completa

**Request:**
```graphql
mutation RevokeRole($userRoleId: UUID!, $reason: String) {
    revokeRole(userRoleId: $userRoleId, reason: $reason)
}
```

**Variables:**
```json
{
    "userRoleId": "role-002",
    "reason": "Cambio de empresa - ya no es agente aqu√≠"
}
```

**Efectos:**
- Establece isActive = false
- Registra revokedAt timestamp
- Guarda motivo de revocaci√≥n
- Invalida permisos derivados

---

### 11. `updateUserRole` - Actualizar Rol

**Descripci√≥n**: Actualiza configuraci√≥n de un rol espec√≠fico.

**Firma:**
```graphql
updateUserRole(userRoleId: UUID!, input: UpdateUserRoleInput!): UserRole!
```

**Directivas:**
- `@auth(requires: [PLATFORM_ADMIN, COMPANY_ADMIN])`: Solo admins
- `@audit(action: "role_update", includePayload: true)`: Auditor√≠a completa

**Request:**
```graphql
mutation UpdateUserRole($userRoleId: UUID!, $input: UpdateUserRoleInput!) {
    updateUserRole(userRoleId: $userRoleId, input: $input) {
        id
        isActive
        company {
            name
        }
        updatedAt
    }
}
```

**Variables:**
```json
{
    "userRoleId": "role-002",
    "input": {
        "isActive": false,
        "companyId": "cmp-002"
    }
}
```

---

## üì¶ TYPES

### User (Completo)

**Descripci√≥n**: Usuario completo del sistema.

```graphql
type User {
    id: UUID!
    userCode: String!
    email: Email!
    emailVerified: Boolean!
    status: UserStatus!
    authProvider: AuthProvider!
    profile: UserProfile!
    roleContexts: [RoleContext!]!
    roleHistory: [UserRole!]!
    companies: [CompanyMinimal!]!
    isAdmin: Boolean!
    canCreateTickets: Boolean!
    lastLoginAt: DateTime
    lastActivityAt: DateTime
    ticketsCount: Int!
    resolvedTicketsCount: Int!
    averageRating: Float  # Nullable - solo agentes con tickets resueltos
    createdAt: DateTime!
    updatedAt: DateTime!
}
```

**Campos Calculados:**
- `isAdmin`: true si tiene PLATFORM_ADMIN o COMPANY_ADMIN activo
- `canCreateTickets`: true si tiene rol USER o superior
- `companies`: empresas donde tiene roles activos

**Estructura de Roles:**
- `roleContexts`: Roles activos en formato simple (para selector/permisos) - Reutiliza RoleContext de shared types
- `roleHistory`: Historial completo de roles asignados (activos e inactivos) - Para auditor√≠a

---

### UserProfile

**Descripci√≥n**: Perfil de usuario con preferencias.

```graphql
type UserProfile {
    firstName: String!
    lastName: String!
    displayName: String!
    phoneNumber: String
    avatarUrl: URL
    theme: String!
    language: String!
    timezone: String!
    pushWebNotifications: Boolean!
    notificationsTickets: Boolean!
    lastActivityAt: DateTime
    createdAt: DateTime!
    updatedAt: DateTime!
}
```

---

### UserRole (V9.0 - Refactorizado)

**Descripci√≥n**: Rol asignado a un usuario. Estructura CLARA sin campos redundantes.

```graphql
type UserRole {
    id: UUID!

    # Rol (campos planos)
    roleCode: RoleCode!
    roleName: String!
    roleDescription: String!
    dashboardPath: String!

    # Empresa (opcional, reutiliza CompanyMinimal)
    company: CompanyMinimal

    # Estado
    isActive: Boolean!

    # Metadata
    assignedAt: DateTime!
    assignedBy: UserMinimal

    # Auditor√≠a
    revokedAt: DateTime
    revokedBy: UserMinimal
    revocationReason: String
}
```

**Campo Especial:**
- `company`: Presente para AGENT y COMPANY_ADMIN, null para USER y PLATFORM_ADMIN

**Diferencia vs RoleContext:**
- `UserRole`: Historial completo con metadata de auditor√≠a (qui√©n asign√≥, cu√°ndo, por qu√© se revoc√≥)
- `RoleContext`: Versi√≥n simplificada para selector/permisos (usado en login y me.roleContexts)

**Ejemplos:**

```json
// USER (sin empresa)
{
    "roleCode": "USER",
    "requiresCompany": false,
    "company": null
}

// AGENT (con empresa)
{
    "roleCode": "AGENT",
    "requiresCompany": true,
    "company": {
        "id": "cmp-001",
        "name": "Universidad del Valle"
    }
}
```

---

### UserCompanyInfo

**Descripci√≥n**: Info de usuario en contexto de empresa.

```graphql
type UserCompanyInfo {
    user: UserMinimal!
    roleCode: RoleCode!
    roleName: String!
    isActive: Boolean!
    joinedAt: DateTime!
    ticketsAssigned: Int!
    ticketsResolved: Int!
    lastActivityAt: DateTime
}
```

**Uso:** Query `companyUsers` para listar equipo de una empresa.

---

## üé≠ ROLES DEL SISTEMA

### Arquitectura de Roles

| Rol | Requiere Empresa | Scope | Dashboard |
|-----|------------------|-------|-----------|
| USER | ‚ùå NO | Global | `/tickets` |
| PLATFORM_ADMIN | ‚ùå NO | Global | `/admin/dashboard` |
| AGENT | ‚úÖ S√ç | Por empresa | `/agent/dashboard` |
| COMPANY_ADMIN | ‚úÖ S√ç | Por empresa | `/empresa/dashboard` |

### Permisos por Rol

#### USER
```json
{
    "permissions": [
        "tickets.create",
        "tickets.view.own",
        "profile.update",
        "companies.follow"
    ]
}
```

#### AGENT
```json
{
    "permissions": [
        "tickets.view.company",
        "tickets.respond",
        "tickets.resolve",
        "tickets.assign.self",
        "profile.update"
    ]
}
```

#### COMPANY_ADMIN
```json
{
    "permissions": [
        "company.manage",
        "agents.manage",
        "tickets.view.all",
        "tickets.assign.any",
        "categories.manage",
        "macros.manage",
        "profile.update"
    ]
}
```

#### PLATFORM_ADMIN
```json
{
    "permissions": ["*"]
}
```

---

## üîí PERMISOS Y SEGURIDAD

### Matriz de Permisos

| Operaci√≥n | USER | AGENT | COMPANY_ADMIN | PLATFORM_ADMIN |
|-----------|------|-------|---------------|----------------|
| `me` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| `myProfile` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| `updateMyProfile` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| `updateMyPreferences` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| `users` | ‚ùå | ‚ùå | ‚úÖ (empresa) | ‚úÖ (todos) |
| `companyUsers` | ‚ùå | ‚úÖ (su empresa) | ‚úÖ (su empresa) | ‚úÖ (todas) |
| `createUser` | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| `updateUser` | ‚ùå | ‚ùå | ‚úÖ (su empresa) | ‚úÖ (todos) |
| `suspendUser` | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| `assignRole` | ‚ùå | ‚ùå | ‚úÖ (su empresa) | ‚úÖ (todos) |
| `revokeRole` | ‚ùå | ‚ùå | ‚úÖ (su empresa) | ‚úÖ (todos) |

### Rate Limiting

| Endpoint | M√°ximo | Ventana |
|----------|--------|---------|
| `updateMyProfile` | 30 | 1 hora |
| `updateMyPreferences` | 50 | 1 hora |
| `createUser` | 10 | 1 hora |
| `assignRole` | 100 | 1 hora |

---

## üö® C√ìDIGOS DE ERROR

```typescript
enum UserManagementErrors {
    USER_NOT_FOUND = 'USER_NOT_FOUND',
    EMAIL_ALREADY_EXISTS = 'EMAIL_ALREADY_EXISTS',
    INVALID_ROLE_ASSIGNMENT = 'INVALID_ROLE_ASSIGNMENT',
    ROLE_REQUIRES_COMPANY = 'ROLE_REQUIRES_COMPANY',
    ROLE_SHOULD_NOT_HAVE_COMPANY = 'ROLE_SHOULD_NOT_HAVE_COMPANY',
    INSUFFICIENT_PERMISSIONS = 'INSUFFICIENT_PERMISSIONS',
    PROFILE_UPDATE_FAILED = 'PROFILE_UPDATE_FAILED',
    USER_SUSPENDED = 'USER_SUSPENDED',
    USER_ALREADY_HAS_ROLE = 'USER_ALREADY_HAS_ROLE',
    CANNOT_REVOKE_LAST_ADMIN = 'CANNOT_REVOKE_LAST_ADMIN',
    INVALID_INPUT = 'INVALID_INPUT'
}
```

---

## üí° CASOS DE USO COMPLETOS

### Caso 1: Perfil Personal Completo

**1. Cargar perfil:**
```graphql
query Me {
    me {
        profile { ... }
        roles { ... }
        companies { ... }
    }
}
```

**2. Actualizar informaci√≥n:**
```graphql
mutation UpdateProfile {
    updateMyProfile(input: {
        firstName: "Mar√≠a Alejandra"
        phoneNumber: "+591 75987654"
    })
}
```

**3. Actualizar preferencias:**
```graphql
mutation UpdatePreferences {
    updateMyPreferences(input: {
        theme: "dark"
        language: "es"
    })
}
```

---

### Caso 2: Asignaci√≥n de Rol de Agente

**1. Admin busca usuario:**
```graphql
query SearchUser {
    users(filters: { search: "juan" }) {
        data { id, email, displayName }
    }
}
```

**2. Admin asigna rol AGENT:**
```graphql
mutation AssignAgentRole {
    assignRole(input: {
        userId: "usr-123"
        roleCode: "AGENT"
        companyId: "cmp-001"  # OBLIGATORIO para AGENT
    }) {
        roleCode
        company { name }
    }
}
```

**3. Usuario ahora tiene 2 roles en roleHistory:**
- USER (global)
- AGENT (en Universidad del Valle)

**4. Pr√≥ximo login, roleContexts muestra:**
```json
{
    "roleContexts": [
        {
            "roleCode": "USER",
            "roleName": "Cliente",
            "company": null,
            "dashboardPath": "/tickets"
        },
        {
            "roleCode": "AGENT",
            "roleName": "Agente",
            "company": {
                "id": "cmp-001",
                "name": "Universidad del Valle"
            },
            "dashboardPath": "/agent/dashboard"
        }
    ]
}
```

**5. Selector muestra:**
```
¬øCon qu√© rol quieres ingresar?
[Cliente] o [Agente - Universidad del Valle]
```

---

### Caso 3: Gesti√≥n de Equipo de Empresa

**1. Company Admin lista su equipo:**
```graphql
query TeamMembers {
    companyUsers(
        companyId: "cmp-001"
        filters: { activeOnly: true }
    ) {
        user { displayName, avatarUrl }
        roleCode
        ticketsAssigned
        ticketsResolved
    }
}
```

**2. Ve que un agente es inactivo:**
```graphql
mutation DeactivateAgent {
    updateUserRole(
        userRoleId: "role-456"
        input: { isActive: false }
    )
}
```

**3. Agente pierde acceso al dashboard de agente:**
- Pr√≥ximo login solo muestra rol USER

---

### Caso 4: Multi-Rol con M√∫ltiples Empresas

**Usuario es agente en 2 empresas:**

```json
{
    "roleContexts": [
        {
            "roleCode": "USER",
            "roleName": "Cliente",
            "company": null,
            "dashboardPath": "/tickets"
        },
        {
            "roleCode": "AGENT",
            "roleName": "Agente de Soporte",
            "company": {
                "id": "cmp-001",
                "name": "Universidad del Valle"
            },
            "dashboardPath": "/agent/dashboard"
        },
        {
            "roleCode": "AGENT",
            "roleName": "Agente de Soporte",
            "company": {
                "id": "cmp-002",
                "name": "Hospital San Juan"
            },
            "dashboardPath": "/agent/dashboard"
        }
    ]
}
```

**Login muestra selector:**
```
¬øCon qu√© rol quieres ingresar?

[üìã Cliente]
[üë®‚Äçüíº Agente - Universidad del Valle]
[üë®‚Äçüíº Agente - Hospital San Juan]
```

**Usuario elige empresa y trabaja en ese contexto.**

---

## üìä EVENTOS DE AUDITOR√çA

- `user_create`: Usuario creado
- `user_update`: Usuario actualizado
- `user_suspend`: Usuario suspendido
- `user_activate`: Usuario reactivado
- `user_delete`: Usuario eliminado
- `profile_update`: Perfil actualizado
- `preferences_update`: Preferencias actualizadas
- `profile_complete`: Perfil completado
- `role_assign`: Rol asignado
- `role_revoke`: Rol revocado
- `role_update`: Rol actualizado

---

**Fin de la Documentaci√≥n de User Management**

> Para implementaci√≥n backend, ver `app/Features/UserManagement/`
> Para integraci√≥n con Authentication, consultar documentaci√≥n de Authentication Feature
