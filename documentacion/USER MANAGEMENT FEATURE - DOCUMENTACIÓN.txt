# üìö USER MANAGEMENT FEATURE - DOCUMENTACI√ìN COMPLETA

## üéØ OVERVIEW DEL FEATURE

El **UserManagement Feature** es responsable de la gesti√≥n completa de usuarios, perfiles y roles en el sistema Helpdesk. Proporciona operaciones CRUD para usuarios, gesti√≥n de perfiles personales, asignaci√≥n de roles y administraci√≥n de permisos.

### üèóÔ∏è ARQUITECTURA DEL FEATURE

```
UserManagement/
‚îú‚îÄ‚îÄ Services/           # L√≥gica de negocio
‚îú‚îÄ‚îÄ GraphQL/           # API Layer
‚îú‚îÄ‚îÄ Models/            # Entidades de dominio
‚îú‚îÄ‚îÄ Events/            # Comunicaci√≥n entre features
‚îú‚îÄ‚îÄ Tests/             # Tests espec√≠ficos
‚îî‚îÄ‚îÄ Database/          # Persistencia
```

### üé≠ TIPOS DE USUARIOS

1. **Usuario Final (USER)**: Crea tickets, gestiona su perfil
2. **Agente (AGENT)**: Responde tickets de su empresa
3. **Admin Empresa (COMPANY_ADMIN)**: Gestiona usuarios de su empresa
4. **Admin Plataforma (PLATFORM_ADMIN)**: Gesti√≥n completa del sistema

---

## üìñ QUERIES - OPERACIONES DE LECTURA

### 1. ME - Usuario Autenticado Completo

**Descripci√≥n**: Obtiene informaci√≥n completa del usuario autenticado incluyendo perfil, roles y estad√≠sticas.

```graphql
query Me {
    me {
        # Identificadores
        id
        userCode

        # Datos b√°sicos
        email
        emailVerified
        emailVerifiedAt
        status
        authProvider

        # Perfil completo
        profile {
            firstName
            lastName
            displayName
            phoneNumber
            avatarUrl
            theme
            language
            timezone
            pushWebNotifications
            notificationsTickets
            lastActivityAt
            createdAt
            updatedAt
        }

        # Roles y permisos
        roles {
            id
            roleCode
            roleInfo {
                code
                name
                description
                requiresCompany
                defaultDashboard
            }
            companyId
            companyInfo {
                id
                companyCode
                name
                logoUrl
                primaryColor
                status
            }
            isActive
            assignedAt
        }

        activeRoles {
            id
            roleCode
            companyId
            isActive
        }

        # Estados calculados
        isAdmin
        canCreateTickets

        # Empresas relacionadas
        companies {
            id
            companyCode
            name
            logoUrl
            primaryColor
            status
        }

        # Actividad y seguridad
        lastLoginAt
        lastLoginIp
        lastActivityAt
        termsAccepted
        termsAcceptedAt
        termsVersion

        # Estad√≠sticas
        ticketsCount
        resolvedTicketsCount
        averageRating

        # Auditor√≠a
        createdAt
        updatedAt
        deletedAt
    }
}
```

**Respuesta de Ejemplo**:
```json
{
    "data": {
        "me": {
            "id": "550e8400-e29b-41d4-a716-446655440000",
            "userCode": "USR-2025-00123",
            "email": "maria.garcia@empresa.com",
            "emailVerified": true,
            "emailVerifiedAt": "2025-01-15T09:30:00Z",
            "status": "ACTIVE",
            "authProvider": "local",
            "profile": {
                "firstName": "Mar√≠a",
                "lastName": "Garc√≠a",
                "displayName": "Mar√≠a Garc√≠a",
                "phoneNumber": "+591 70123456",
                "avatarUrl": "https://storage.helpdesk.com/avatars/usr_123.jpg",
                "theme": "dark",
                "language": "es",
                "timezone": "America/La_Paz",
                "pushWebNotifications": true,
                "notificationsTickets": false,
                "lastActivityAt": "2025-09-21T15:30:00Z",
                "createdAt": "2025-01-15T08:00:00Z",
                "updatedAt": "2025-09-20T14:22:00Z"
            },
            "roles": [
                {
                    "id": "role-001",
                    "roleCode": "USER",
                    "roleInfo": {
                        "code": "USER",
                        "name": "Cliente",
                        "description": "Usuario que crea y gestiona tickets",
                        "requiresCompany": false,
                        "defaultDashboard": "/tickets"
                    },
                    "companyId": null,
                    "companyInfo": null,
                    "isActive": true,
                    "assignedAt": "2025-01-15T08:00:00Z"
                },
                {
                    "id": "role-002",
                    "roleCode": "AGENT",
                    "roleInfo": {
                        "code": "AGENT",
                        "name": "Agente de Soporte",
                        "description": "Agente que responde tickets de una empresa",
                        "requiresCompany": true,
                        "defaultDashboard": "/agent/dashboard"
                    },
                    "companyId": "cmp-001",
                    "companyInfo": {
                        "id": "cmp-001",
                        "companyCode": "CMP-2025-00001",
                        "name": "Universidad del Valle",
                        "logoUrl": "https://storage.helpdesk.com/logos/cmp_001.png",
                        "primaryColor": "#007bff",
                        "status": "ACTIVE"
                    },
                    "isActive": true,
                    "assignedAt": "2025-03-10T10:15:00Z"
                }
            ],
            "activeRoles": [
                {
                    "id": "role-001",
                    "roleCode": "USER",
                    "companyId": null,
                    "isActive": true
                },
                {
                    "id": "role-002",
                    "roleCode": "AGENT",
                    "companyId": "cmp-001",
                    "isActive": true
                }
            ],
            "isAdmin": false,
            "canCreateTickets": true,
            "companies": [
                {
                    "id": "cmp-001",
                    "companyCode": "CMP-2025-00001",
                    "name": "Universidad del Valle",
                    "logoUrl": "https://storage.helpdesk.com/logos/cmp_001.png",
                    "primaryColor": "#007bff",
                    "status": "ACTIVE"
                }
            ],
            "lastLoginAt": "2025-09-21T14:45:00Z",
            "lastLoginIp": "192.168.1.100",
            "lastActivityAt": "2025-09-21T15:30:00Z",
            "termsAccepted": true,
            "termsAcceptedAt": "2025-01-15T08:00:00Z",
            "termsVersion": "v2.1",
            "ticketsCount": 47,
            "resolvedTicketsCount": 23,
            "averageRating": 4.3,
            "createdAt": "2025-01-15T08:00:00Z",
            "updatedAt": "2025-09-20T14:22:00Z",
            "deletedAt": null
        }
    }
}
```

**Casos de Uso**:
- Header de usuario en interfaz
- P√°gina completa de perfil
- Validaci√≥n de permisos
- Selector de roles/empresas
- Dashboard personalizado

---

### 2. MY_PROFILE - Perfil Personal

**Descripci√≥n**: Obtiene √∫nicamente la informaci√≥n del perfil del usuario autenticado.

```graphql
query MyProfile {
    myProfile {
        firstName
        lastName
        displayName
        phoneNumber
        avatarUrl
        theme
        language
        timezone
        pushWebNotifications
        notificationsTickets
        lastActivityAt
        createdAt
        updatedAt
    }
}
```

**Respuesta de Ejemplo**:
```json
{
    "data": {
        "myProfile": {
            "firstName": "Mar√≠a",
            "lastName": "Garc√≠a",
            "displayName": "Mar√≠a Garc√≠a",
            "phoneNumber": "+591 70123456",
            "avatarUrl": "https://storage.helpdesk.com/avatars/usr_123.jpg",
            "theme": "dark",
            "language": "es",
            "timezone": "America/La_Paz",
            "pushWebNotifications": true,
            "notificationsTickets": false,
            "lastActivityAt": "2025-09-21T15:30:00Z",
            "createdAt": "2025-01-15T08:00:00Z",
            "updatedAt": "2025-09-20T14:22:00Z"
        }
    }
}
```

**Casos de Uso**:
- Formularios de edici√≥n de perfil
- P√°gina de configuraci√≥n personal
- Sincronizaci√≥n de preferencias

---

### 3. USERS - Lista Paginada de Usuarios

**Descripci√≥n**: Lista paginada de usuarios del sistema con filtros avanzados. Solo accesible por administradores.

```graphql
query Users(
    $filters: UserFilters
    $orderBy: [UserOrderBy!]
    $page: Int = 1
    $first: Int = 15
) {
    users(
        filters: $filters
        orderBy: $orderBy
        page: $page
        first: $first
    ) {
        data {
            id
            userCode
            email
            emailVerified
            status
            profile {
                firstName
                lastName
                displayName
                avatarUrl
            }
            activeRoles {
                roleCode
                companyInfo {
                    name
                }
            }
            lastLoginAt
            ticketsCount
            createdAt
        }
        paginatorInfo {
            total
            perPage
            currentPage
            lastPage
            hasMorePages
        }
    }
}
```

**Variables de Ejemplo**:
```json
{
    "filters": {
        "search": "maria",
        "status": "ACTIVE",
        "role": "AGENT",
        "emailVerified": true,
        "createdBetween": {
            "from": "2025-01-01T00:00:00Z",
            "to": "2025-12-31T23:59:59Z"
        },
        "recentActivity": true
    },
    "orderBy": [
        {
            "field": "LAST_LOGIN_AT",
            "order": "DESC"
        }
    ],
    "page": 1,
    "first": 20
}
```

**Respuesta de Ejemplo**:
```json
{
    "data": {
        "users": {
            "data": [
                {
                    "id": "550e8400-e29b-41d4-a716-446655440000",
                    "userCode": "USR-2025-00123",
                    "email": "maria.garcia@empresa.com",
                    "emailVerified": true,
                    "status": "ACTIVE",
                    "profile": {
                        "firstName": "Mar√≠a",
                        "lastName": "Garc√≠a",
                        "displayName": "Mar√≠a Garc√≠a",
                        "avatarUrl": "https://storage.helpdesk.com/avatars/usr_123.jpg"
                    },
                    "activeRoles": [
                        {
                            "roleCode": "AGENT",
                            "companyInfo": {
                                "name": "Universidad del Valle"
                            }
                        }
                    ],
                    "lastLoginAt": "2025-09-21T14:45:00Z",
                    "ticketsCount": 47,
                    "createdAt": "2025-01-15T08:00:00Z"
                }
            ],
            "paginatorInfo": {
                "total": 156,
                "perPage": 20,
                "currentPage": 1,
                "lastPage": 8,
                "hasMorePages": true
            }
        }
    }
}
```

**Casos de Uso**:
- Panel de administraci√≥n de usuarios
- B√∫squeda de usuarios para asignar roles
- Reportes de actividad de usuarios

---

### 4. USER - Usuario Espec√≠fico

**Descripci√≥n**: Obtiene informaci√≥n completa de un usuario espec√≠fico por ID.

```graphql
query User($id: UUID!) {
    user(id: $id) {
        id
        userCode
        email
        emailVerified
        status
        profile {
            firstName
            lastName
            displayName
            phoneNumber
            avatarUrl
            theme
            language
            timezone
        }
        roles {
            id
            roleCode
            roleInfo {
                name
                description
            }
            companyInfo {
                name
                logoUrl
            }
            isActive
            assignedAt
            assignedBy {
                displayName
            }
        }
        lastLoginAt
        ticketsCount
        resolvedTicketsCount
        averageRating
        createdAt
    }
}
```

**Variables**:
```json
{
    "id": "550e8400-e29b-41d4-a716-446655440000"
}
```

**Casos de Uso**:
- P√°gina de detalle de usuario
- Modal de informaci√≥n de usuario
- Verificaci√≥n antes de asignar roles

---

### 5. COMPANY_USERS - Usuarios de Empresa

**Descripci√≥n**: Lista usuarios de una empresa espec√≠fica. Solo accesible por admin/agentes de esa empresa.

```graphql
query CompanyUsers(
    $companyId: UUID!
    $filters: CompanyUserFilters
    $first: Int = 15
) {
    companyUsers(
        companyId: $companyId
        filters: $filters
        first: $first
    ) {
        id
        userCode
        email
        profile {
            firstName
            lastName
            displayName
            avatarUrl
        }
        roles {
            roleCode
            roleInfo {
                name
            }
            isActive
        }
        lastLoginAt
        ticketsCount
    }
}
```

**Variables**:
```json
{
    "companyId": "cmp-001",
    "filters": {
        "search": "juan",
        "role": "AGENT",
        "activeOnly": true
    },
    "first": 25
}
```

**Casos de Uso**:
- Panel de gesti√≥n de equipo
- Asignaci√≥n de tickets por agente
- Estad√≠sticas del equipo

---

### 6. AVAILABLE_ROLES - Roles Disponibles

**Descripci√≥n**: Lista de roles disponibles en el sistema con sus descripciones.

```graphql
query AvailableRoles {
    availableRoles {
        code
        name
        description
        requiresCompany
        defaultDashboard
        permissions
        priority
        isSystemRole
    }
}
```

**Respuesta de Ejemplo**:
```json
{
    "data": {
        "availableRoles": [
            {
                "code": "PLATFORM_ADMIN",
                "name": "Administrador de Plataforma",
                "description": "Acceso completo a todo el sistema",
                "requiresCompany": false,
                "defaultDashboard": "/admin/dashboard",
                "permissions": ["*"],
                "priority": 1,
                "isSystemRole": true
            },
            {
                "code": "COMPANY_ADMIN",
                "name": "Administrador de Empresa",
                "description": "Gestiona una empresa espec√≠fica",
                "requiresCompany": true,
                "defaultDashboard": "/empresa/dashboard",
                "permissions": ["company.manage", "agents.manage", "tickets.view"],
                "priority": 2,
                "isSystemRole": true
            },
            {
                "code": "AGENT",
                "name": "Agente de Soporte",
                "description": "Atiende tickets de soporte",
                "requiresCompany": true,
                "defaultDashboard": "/agent/dashboard",
                "permissions": ["tickets.respond", "tickets.resolve"],
                "priority": 3,
                "isSystemRole": true
            },
            {
                "code": "USER",
                "name": "Cliente",
                "description": "Usuario que crea tickets",
                "requiresCompany": false,
                "defaultDashboard": "/tickets",
                "permissions": ["tickets.create", "tickets.view.own"],
                "priority": 4,
                "isSystemRole": true
            }
        ]
    }
}
```

**Casos de Uso**:
- Selector de roles en formularios
- Documentaci√≥n de permisos
- Validaci√≥n de asignaciones

---

## ‚úèÔ∏è MUTATIONS - OPERACIONES DE ESCRITURA

### 1. UPDATE_MY_PROFILE - Actualizar Perfil Propio

**Descripci√≥n**: Permite a cualquier usuario actualizar su propio perfil.

```graphql
mutation UpdateMyProfile($input: UpdateProfileInput!) {
    updateMyProfile(input: $input) {
        id
        profile {
            firstName
            lastName
            displayName
            phoneNumber
            avatarUrl
            updatedAt
        }
    }
}
```

**Input Variables**:
```json
{
    "input": {
        "firstName": "Mar√≠a Alejandra",
        "lastName": "Garc√≠a Rodr√≠guez",
        "phoneNumber": "+591 75987654",
        "avatarUrl": "https://storage.helpdesk.com/avatars/new_avatar.jpg"
    }
}
```

**Validaciones**:
- `firstName`: m√≠nimo 2, m√°ximo 100 caracteres
- `lastName`: m√≠nimo 2, m√°ximo 100 caracteres
- `phoneNumber`: entre 10 y 20 caracteres
- `avatarUrl`: URL v√°lida

**Respuesta de Ejemplo**:
```json
{
    "data": {
        "updateMyProfile": {
            "id": "550e8400-e29b-41d4-a716-446655440000",
            "profile": {
                "firstName": "Mar√≠a Alejandra",
                "lastName": "Garc√≠a Rodr√≠guez",
                "displayName": "Mar√≠a Alejandra Garc√≠a Rodr√≠guez",
                "phoneNumber": "+591 75987654",
                "avatarUrl": "https://storage.helpdesk.com/avatars/new_avatar.jpg",
                "updatedAt": "2025-09-21T16:30:00Z"
            }
        }
    }
}
```

**Eventos Disparados**:
- `UserProfileUpdated`: Para sincronizaci√≥n en otros features

---

### 2. UPDATE_MY_PREFERENCES - Actualizar Preferencias

**Descripci√≥n**: Actualiza preferencias de interfaz y notificaciones del usuario.

```graphql
mutation UpdateMyPreferences($input: PreferencesInput!) {
    updateMyPreferences(input: $input) {
        id
        profile {
            theme
            language
            timezone
            pushWebNotifications
            notificationsTickets
            updatedAt
        }
    }
}
```

**Input Variables**:
```json
{
    "input": {
        "theme": "dark",
        "language": "en",
        "timezone": "America/New_York",
        "pushWebNotifications": false,
        "notificationsTickets": true
    }
}
```

**Validaciones**:
- `theme`: debe ser "light" o "dark"
- `language`: debe ser "es" o "en"
- `timezone`: zona horaria v√°lida
- Booleanos para notificaciones

---

### 3. COMPLETE_MY_PROFILE - Completar Perfil

**Descripci√≥n**: Completa informaci√≥n adicional del perfil despu√©s del registro.

```graphql
mutation CompleteMyProfile($input: CompleteProfileInput!) {
    completeMyProfile(input: $input) {
        id
        profile {
            firstName
            lastName
            phoneNumber
            avatarUrl
            theme
            language
            timezone
            pushWebNotifications
            notificationsTickets
        }
    }
}
```

**Input Variables**:
```json
{
    "input": {
        "phoneNumber": "+591 70123456",
        "avatarUrl": "https://storage.helpdesk.com/avatars/completed.jpg",
        "theme": "dark",
        "language": "es",
        "timezone": "America/La_Paz",
        "pushWebNotifications": true,
        "notificationsTickets": false
    }
}
```

**Casos de Uso**:
- Flujo de onboarding post-registro
- Completar informaci√≥n faltante
- Configuraci√≥n inicial de preferencias

---

### 4. CREATE_USER - Crear Usuario (Admin)

**Descripci√≥n**: Crea un nuevo usuario en el sistema. Solo accesible por platform admins.

```graphql
mutation CreateUser($input: CreateUserInput!) {
    createUser(input: $input) {
        id
        userCode
        email
        status
        profile {
            firstName
            lastName
            displayName
        }
        roles {
            roleCode
            companyInfo {
                name
            }
            isActive
        }
        createdAt
    }
}
```

**Input Variables**:
```json
{
    "input": {
        "email": "nuevo.agente@empresa.com",
        "password": "TempPassword123!",
        "firstName": "Juan",
        "lastName": "P√©rez",
        "status": "ACTIVE",
        "initialRoles": [
            {
                "userId": "550e8400-e29b-41d4-a716-446655440000",
                "roleCode": "USER",
                "isActive": true
            },
            {
                "userId": "550e8400-e29b-41d4-a716-446655440000",
                "roleCode": "AGENT",
                "companyId": "cmp-001",
                "isActive": true
            }
        ],
        "sendWelcomeEmail": true
    }
}
```

**Validaciones**:
- `email`: √∫nico en el sistema, formato v√°lido
- `password`: m√≠nimo 8 caracteres
- `firstName`, `lastName`: entre 2 y 100 caracteres
- `initialRoles`: roles v√°lidos y permisos adecuados

**Flujo de Proceso**:
1. Validar email √∫nico
2. Crear usuario con password hasheado
3. Crear perfil asociado
4. Asignar roles iniciales
5. Enviar email de bienvenida (si solicitado)
6. Registrar en auditor√≠a

---

### 5. UPDATE_USER - Actualizar Usuario

**Descripci√≥n**: Actualiza informaci√≥n de un usuario espec√≠fico. Solo admins.

```graphql
mutation UpdateUser($id: UUID!, $input: UpdateUserInput!) {
    updateUser(id: $id, input: $input) {
        id
        email
        status
        profile {
            firstName
            lastName
            displayName
        }
        updatedAt
    }
}
```

**Input Variables**:
```json
{
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "input": {
        "email": "nuevo.email@empresa.com",
        "status": "SUSPENDED",
        "profile": {
            "firstName": "Juan Carlos",
            "lastName": "P√©rez Silva"
        },
        "forceEmailVerification": true
    }
}
```

---

### 6. SUSPEND_USER - Suspender Usuario

**Descripci√≥n**: Suspende temporalmente un usuario del sistema.

```graphql
mutation SuspendUser($id: UUID!, $reason: String) {
    suspendUser(id: $id, reason: $reason) {
        id
        status
        updatedAt
    }
}
```

**Input Variables**:
```json
{
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "reason": "Violaci√≥n de t√©rminos de servicio - spam de tickets"
}
```

**Efectos**:
- Cambia status a "SUSPENDED"
- Invalida todos los tokens activos
- Registra motivo en auditor√≠a
- Env√≠a notificaci√≥n al usuario

---

### 7. ACTIVATE_USER - Activar Usuario

**Descripci√≥n**: Reactiva un usuario suspendido.

```graphql
mutation ActivateUser($id: UUID!) {
    activateUser(id: $id) {
        id
        status
        updatedAt
    }
}
```

**Efectos**:
- Cambia status a "ACTIVE"
- Permite nuevo login
- Registra reactivaci√≥n en auditor√≠a

---

### 8. DELETE_USER - Eliminar Usuario

**Descripci√≥n**: Elimina l√≥gicamente un usuario (soft delete).

```graphql
mutation DeleteUser($id: UUID!, $reason: String) {
    deleteUser(id: $id, reason: $reason)
}
```

**Input Variables**:
```json
{
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "reason": "Solicitud del usuario - GDPR compliance"
}
```

**Efectos**:
- Cambia status a "DELETED"
- Establece deletedAt timestamp
- Anonimiza datos sensibles
- Mantiene registros para auditor√≠a

---

### 9. ASSIGN_ROLE - Asignar Rol

**Descripci√≥n**: Asigna un rol espec√≠fico a un usuario.

```graphql
mutation AssignRole($input: AssignRoleInput!) {
    assignRole(input: $input) {
        id
        user {
            displayName
        }
        roleCode
        roleInfo {
            name
            description
        }
        companyInfo {
            name
        }
        isActive
        assignedAt
        assignedBy {
            displayName
        }
    }
}
```

**Input Variables**:
```json
{
    "input": {
        "userId": "550e8400-e29b-41d4-a716-446655440000",
        "roleCode": "AGENT",
        "companyId": "cmp-001",
        "isActive": true
    }
}
```

**Validaciones**:
- Usuario debe existir y estar activo
- Rol debe ser v√°lido
- Si rol requiere empresa, companyId es obligatorio
- Usuario asignador debe tener permisos
- No duplicar asignaciones activas

---

### 10. REVOKE_ROLE - Revocar Rol

**Descripci√≥n**: Revoca un rol espec√≠fico de un usuario.

```graphql
mutation RevokeRole($userRoleId: UUID!, $reason: String) {
    revokeRole(userRoleId: $userRoleId, reason: $reason)
}
```

**Input Variables**:
```json
{
    "userRoleId": "role-002",
    "reason": "Cambio de empresa - ya no es agente aqu√≠"
}
```

**Efectos**:
- Establece isActive = false
- Registra revokedAt timestamp
- Guarda motivo de revocaci√≥n
- Invalida permisos derivados

---

### 11. UPDATE_USER_ROLE - Actualizar Rol

**Descripci√≥n**: Actualiza configuraci√≥n de un rol espec√≠fico.

```graphql
mutation UpdateUserRole($userRoleId: UUID!, $input: UpdateUserRoleInput!) {
    updateUserRole(userRoleId: $userRoleId, input: $input) {
        id
        isActive
        companyInfo {
            name
        }
        updatedAt
    }
}
```

**Input Variables**:
```json
{
    "userRoleId": "role-002",
    "input": {
        "isActive": false,
        "companyId": "cmp-002"
    }
}
```

---

## üîí SEGURIDAD Y PERMISOS

### Directivas de Seguridad Aplicadas

1. **@auth**: Requiere usuario autenticado
2. **@auth(requires: [ROLE])**: Requiere rol espec√≠fico
3. **@can(ability, model)**: Verifica capacidad espec√≠fica
4. **@company(requireOwnership)**: Verifica acceso a empresa
5. **@rateLimit(max, window)**: Limita requests por tiempo

### Matriz de Permisos

| Operaci√≥n | USER | AGENT | COMPANY_ADMIN | PLATFORM_ADMIN |
|-----------|------|-------|---------------|----------------|
| me | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| myProfile | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| updateMyProfile | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| updateMyPreferences | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| users | ‚ùå | ‚ùå | ‚úÖ (empresa) | ‚úÖ (todos) |
| createUser | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| suspendUser | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| assignRole | ‚ùå | ‚ùå | ‚úÖ (empresa) | ‚úÖ (todos) |

### Rate Limiting

- **createUser**: 10 requests/hora
- **updateMyProfile**: 30 requests/hora
- **assignRole**: 100 requests/hora
- **Queries**: 1000 requests/hora

---

## üß™ EJEMPLOS DE USO FRONTEND

### React Hook para Gesti√≥n de Perfil

```typescript
// useProfile.ts
import { useMutation, useQuery } from '@apollo/client';
import { ME_QUERY, UPDATE_MY_PROFILE_MUTATION } from '../graphql';

export const useProfile = () => {
    const { data, loading, error, refetch } = useQuery(ME_QUERY);
    const [updateProfile] = useMutation(UPDATE_MY_PROFILE_MUTATION);

    const handleUpdateProfile = async (input: UpdateProfileInput) => {
        try {
            const result = await updateProfile({
                variables: { input },
                update: (cache, { data }) => {
                    cache.writeQuery({
                        query: ME_QUERY,
                        data: { me: data.updateMyProfile }
                    });
                }
            });
            return result.data.updateMyProfile;
        } catch (error) {
            throw new Error(error.message);
        }
    };

    return {
        user: data?.me,
        loading,
        error,
        updateProfile: handleUpdateProfile,
        refetch
    };
};
```

### Componente de Edici√≥n de Perfil

```typescript
// ProfileForm.tsx
import React from 'react';
import { useForm } from 'react-hook-form';
import { useProfile } from '../hooks/useProfile';

interface ProfileFormData {
    firstName: string;
    lastName: string;
    phoneNumber?: string;
}

export const ProfileForm: React.FC = () => {
    const { user, updateProfile, loading } = useProfile();
    const { register, handleSubmit, formState: { errors } } = useForm<ProfileFormData>({
        defaultValues: {
            firstName: user?.profile?.firstName || '',
            lastName: user?.profile?.lastName || '',
            phoneNumber: user?.profile?.phoneNumber || ''
        }
    });

    const onSubmit = async (data: ProfileFormData) => {
        try {
            await updateProfile(data);
            alert('Perfil actualizado exitosamente');
        } catch (error) {
            alert('Error al actualizar perfil: ' + error.message);
        }
    };

    return (
        <form onSubmit={handleSubmit(onSubmit)}>
            <div>
                <label>Nombre:</label>
                <input
                    {...register('firstName', { required: 'Nombre es requerido' })}
                    disabled={loading}
                />
                {errors.firstName && <span>{errors.firstName.message}</span>}
            </div>

            <div>
                <label>Apellido:</label>
                <input
                    {...register('lastName', { required: 'Apellido es requerido' })}
                    disabled={loading}
                />
                {errors.lastName && <span>{errors.lastName.message}</span>}
            </div>

            <div>
                <label>Tel√©fono:</label>
                <input
                    {...register('phoneNumber')}
                    disabled={loading}
                />
            </div>

            <button type="submit" disabled={loading}>
                {loading ? 'Guardando...' : 'Guardar Cambios'}
            </button>
        </form>
    );
};
```

---

## üö® MANEJO DE ERRORES

### C√≥digos de Error Est√°ndar

```typescript
enum UserManagementErrors {
    USER_NOT_FOUND = 'USER_NOT_FOUND',
    EMAIL_ALREADY_EXISTS = 'EMAIL_ALREADY_EXISTS',
    INVALID_ROLE_ASSIGNMENT = 'INVALID_ROLE_ASSIGNMENT',
    INSUFFICIENT_PERMISSIONS = 'INSUFFICIENT_PERMISSIONS',
    PROFILE_UPDATE_FAILED = 'PROFILE_UPDATE_FAILED',
    ROLE_REQUIRES_COMPANY = 'ROLE_REQUIRES_COMPANY',
    USER_SUSPENDED = 'USER_SUSPENDED',
    INVALID_INPUT = 'INVALID_INPUT'
}
```

### Estructura de Error GraphQL

```json
{
    "errors": [
        {
            "message": "El email ya existe en el sistema",
            "extensions": {
                "code": "EMAIL_ALREADY_EXISTS",
                "field": "email",
                "value": "usuario@empresa.com"
            },
            "path": ["createUser"]
        }
    ],
    "data": null
}
```

---

## üìä M√âTRICAS Y MONITORING

### Eventos de Auditor√≠a

- `user.created`: Usuario creado
- `user.updated`: Usuario actualizado
- `user.suspended`: Usuario suspendido
- `user.activated`: Usuario reactivado
- `user.deleted`: Usuario eliminado
- `profile.updated`: Perfil actualizado
- `role.assigned`: Rol asignado
- `role.revoked`: Rol revocado

### M√©tricas de Performance

- Tiempo de respuesta de queries
- N√∫mero de usuarios por empresa
- Actividad de usuarios por d√≠a/semana
- Distribuci√≥n de roles en el sistema
- Tasa de uso de features por usuario

---

## üîÑ INTEGRACI√ìN CON OTROS FEATURES

### Authentication Feature

- Comparte modelo User
- Sincroniza tokens y sesiones
- Valida permisos en tiempo real

### CompanyManagement Feature

- Referencias a empresas v√≠a CompanyBasicInfo
- Validaci√≥n de roles por empresa
- Gesti√≥n de agentes por empresa

### TicketManagement Feature

- Estad√≠sticas de tickets por usuario
- Validaci√≥n de permisos para tickets
- Asignaci√≥n de agentes a tickets

### Notifications Feature

- Configuraci√≥n de notificaciones por usuario
- Env√≠o de notificaciones de cambios
- Preferencias personalizadas

---

Esta documentaci√≥n cubre completamente el **UserManagement Feature**, proporcionando ejemplos detallados, casos de uso, manejo de errores y patrones de integraci√≥n. Es la referencia definitiva para desarrolladores frontend y backend trabajando con gesti√≥n de usuarios en el sistema Helpdesk.
