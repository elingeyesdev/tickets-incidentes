# ================================================================================
# AUTHENTICATION FEATURE SCHEMA V9.0 - Sistema Helpdesk
# REFACTORIZADO: Reutiliza shared types, minimalista, sin over-fetching
# ================================================================================

extend type Query {
    """
    Estado completo de autenticación del usuario actual
    Incluye información de sesión y token
    """
    authStatus: AuthStatus!
        @guard
        @field(resolver: "App\\Features\\Authentication\\GraphQL\\Queries\\AuthStatusQuery")

    """
    Lista de sesiones activas del usuario autenticado
    Para gestión de dispositivos conectados
    """
    mySessions: [SessionInfo!]!
        @guard
        @field(resolver: "App\\Features\\Authentication\\GraphQL\\Queries\\MySessionsQuery")

    """
    Valida el estado de un token de reset de contraseña
    Verifica si el token es válido antes de mostrar formulario
    """
    passwordResetStatus(token: String!): PasswordResetStatus!
        @field(resolver: "App\\Features\\Authentication\\GraphQL\\Queries\\PasswordResetStatusQuery")

    """
    Estado de verificación de email del usuario actual
    """
    emailVerificationStatus: EmailVerificationStatus!
        @guard
        @field(resolver: "App\\Features\\Authentication\\GraphQL\\Queries\\EmailVerificationStatusQuery")
}

extend type Mutation {
    # ===== REGISTRO Y LOGIN =====

    """
    Registra un nuevo usuario en el sistema
    Genera tokens automáticamente tras registro exitoso
    """
    register(input: RegisterInput!): AuthPayload!
        @field(resolver: "App\\Features\\Authentication\\GraphQL\\Mutations\\RegisterMutation")
        @rateLimit(max: 5, window: 60, message: "Demasiados intentos de registro")
        @audit(action: "user_register", includePayload: false)

    """
    Autentica usuario con email y contraseña
    Retorna tokens y roles disponibles para selector
    """
    login(input: LoginInput!): AuthPayload!
        @field(resolver: "App\\Features\\Authentication\\GraphQL\\Mutations\\LoginMutation")
        @rateLimit(max: 5, window: 15, message: "Demasiados intentos de login")
        @audit(action: "user_login", includePayload: false)

    """
    Autentica usuario con token de Google OAuth
    Crea cuenta automáticamente si no existe
    """
    loginWithGoogle(input: GoogleLoginInput!): AuthPayload!
        @field(resolver: "App\\Features\\Authentication\\GraphQL\\Mutations\\GoogleLoginMutation")
        @rateLimit(max: 10, window: 60)
        @audit(action: "user_login_google", includePayload: false)

    # ===== GESTIÓN DE TOKENS =====

    """
    Genera nuevo access token usando refresh token válido
    Invalida refresh token anterior por seguridad
    """
    refreshToken: RefreshPayload!
        @guard
        @field(resolver: "App\\Features\\Authentication\\GraphQL\\Mutations\\RefreshTokenMutation")
        @audit(action: "token_refresh")

    """
    Cierra sesión del usuario
    everywhere=false: solo sesión actual
    everywhere=true: todas las sesiones
    """
    logout(everywhere: Boolean = false): Boolean!
        @guard
        @field(resolver: "App\\Features\\Authentication\\GraphQL\\Mutations\\LogoutMutation")
        @audit(action: "user_logout")

    """
    Revoca una sesión específica de otro dispositivo
    No puede revocar su propia sesión actual
    """
    revokeOtherSession(sessionId: String!): Boolean!
        @guard
        @field(resolver: "App\\Features\\Authentication\\GraphQL\\Mutations\\RevokeOtherSessionMutation")
        @audit(action: "session_revoke")

    # ===== PASSWORD MANAGEMENT =====

    """
    Solicita reset de contraseña
    Envía email con token. Siempre retorna true por seguridad
    """
    resetPassword(email: Email!): Boolean!
        @field(resolver: "App\\Features\\Authentication\\GraphQL\\Mutations\\ResetPasswordMutation")
        @rateLimit(max: 3, window: 3600, message: "Solo 3 intentos por hora")
        @audit(action: "password_reset_request")

    """
    Confirma reset de contraseña con token válido
    Establece nueva contraseña e invalida todas las sesiones
    """
    confirmPasswordReset(input: PasswordResetInput!): PasswordResetResult!
        @field(resolver: "App\\Features\\Authentication\\GraphQL\\Mutations\\ConfirmPasswordResetMutation")
        @rateLimit(max: 3, window: 900, message: "Demasiados intentos")
        @audit(action: "password_reset_confirm", includePayload: false)

    # ===== EMAIL VERIFICATION =====

    """
    Verifica email del usuario usando token
    """
    verifyEmail(token: String!): EmailVerificationResult!
        @field(resolver: "App\\Features\\Authentication\\GraphQL\\Mutations\\VerifyEmailMutation")
        @audit(action: "email_verify")

    """
    Reenvía email de verificación al usuario autenticado
    Rate limiting: 3 intentos cada 5 minutos
    """
    resendVerification: EmailVerificationResult!
        @guard
        @field(resolver: "App\\Features\\Authentication\\GraphQL\\Mutations\\ResendVerificationMutation")
        @rateLimit(max: 3, window: 300, message: "Debes esperar antes de reenviar")
        @audit(action: "email_verification_resend")
}

# ================================================================================
# TYPES - Response types
# ================================================================================

"""
Response de login/register
Contiene SOLO lo necesario para autenticación inicial
"""
type AuthPayload {
    """Token de acceso JWT (corta duración: 15-60 min)"""
    accessToken: String!

    """Token de refresh (larga duración: 30 días)"""
    refreshToken: String!

    """Tipo de token (siempre "Bearer")"""
    tokenType: String!

    """Tiempo de expiración del access token en segundos"""
    expiresIn: Int!

    """Información básica del usuario autenticado"""
    user: UserAuthInfo!

    """
    Contextos de roles disponibles
    Para selector de roles si tiene más de uno
    """
    roleContexts: [RoleContext!]!

    """ID de sesión único"""
    sessionId: String!

    """Timestamp del login"""
    loginTimestamp: DateTime!
}

"""
Response de refresh token
Versión minimalista sin información de usuario
"""
type RefreshPayload {
    """Nuevo token de acceso JWT"""
    accessToken: String!

    """Nuevo token de refresh"""
    refreshToken: String!

    """Tipo de token"""
    tokenType: String!

    """Tiempo de expiración en segundos"""
    expiresIn: Int!
}

"""
Estado de autenticación del usuario actual
"""
type AuthStatus {
    """Si está autenticado"""
    isAuthenticated: Boolean!

    """Información del usuario (null si no autenticado)"""
    user: UserAuthInfo

    """Sesión actual (null si no autenticado)"""
    currentSession: SessionInfo

    """Info del token actual"""
    tokenInfo: TokenInfo
}

"""
Información del token JWT actual
"""
type TokenInfo {
    """Segundos hasta expiración"""
    expiresIn: Int!

    """Cuándo fue emitido"""
    issuedAt: DateTime!

    """Tipo de token"""
    tokenType: String!
}

"""
Información de sesión activa
"""
type SessionInfo {
    """ID único de sesión"""
    sessionId: String!

    """Nombre del dispositivo"""
    deviceName: String

    """IP de acceso"""
    ipAddress: String

    """User agent del navegador"""
    userAgent: String

    """Último uso de la sesión"""
    lastUsedAt: DateTime!

    """Cuándo expira la sesión"""
    expiresAt: DateTime!

    """Si es la sesión actual"""
    isCurrent: Boolean!

    """Ubicación estimada (opcional)"""
    location: SessionLocation
}

"""
Ubicación de la sesión (estimada por IP)
"""
type SessionLocation {
    """Ciudad"""
    city: String

    """País"""
    country: String
}

"""
Estado de un token de reset de contraseña
"""
type PasswordResetStatus {
    """Si el token es válido"""
    isValid: Boolean!

    """Email asociado (parcialmente oculto)"""
    email: String

    """Cuándo expira el token"""
    expiresAt: DateTime

    """Si puede resetear la contraseña"""
    canReset: Boolean!

    """Intentos restantes"""
    attemptsRemaining: Int!
}

"""
Resultado de reset de contraseña
"""
type PasswordResetResult {
    """Si la operación fue exitosa"""
    success: Boolean!

    """Mensaje descriptivo"""
    message: String!

    """Usuario (solo si exitoso)"""
    user: UserMinimal
}

"""
Estado de verificación de email
"""
type EmailVerificationStatus {
    """Si el email está verificado"""
    isVerified: Boolean!

    """Email del usuario"""
    email: Email!

    """Cuándo se envió la última verificación"""
    verificationSentAt: DateTime

    """Si puede reenviar verificación"""
    canResend: Boolean!

    """Cuándo puede reenviar nuevamente"""
    resendAvailableAt: DateTime

    """Intentos de reenvío restantes"""
    attemptsRemaining: Int!
}

"""
Resultado de verificación de email
"""
type EmailVerificationResult {
    """Si la operación fue exitosa"""
    success: Boolean!

    """Mensaje descriptivo"""
    message: String!

    """Si puede reenviar (en caso de fallo)"""
    canResend: Boolean!

    """Cuándo puede reenviar"""
    resendAvailableAt: DateTime
}

# ================================================================================
# INPUTS
# ================================================================================

"""
Input para registro de nuevo usuario
"""
input RegisterInput {
    """Email único del usuario"""
    email: Email!
        @rules(apply: ["required", "email", "unique:auth.users,email"])

    """Contraseña (mínimo 8 caracteres)"""
    password: String!
        @rules(apply: ["required", "min:8", "confirmed"])

    """Confirmación de contraseña"""
    passwordConfirmation: String!
        @rules(apply: ["required"])

    """Nombre del usuario"""
    firstName: String!
        @rules(apply: ["required", "min:2", "max:100"])

    """Apellido del usuario"""
    lastName: String!
        @rules(apply: ["required", "min:2", "max:100"])

    """Acepta términos y condiciones"""
    acceptsTerms: Boolean!
        @rules(apply: ["required", "accepted"])

    """Acepta política de privacidad"""
    acceptsPrivacyPolicy: Boolean!
        @rules(apply: ["required", "accepted"])
}

"""
Input para login con email/password
"""
input LoginInput {
    """Email del usuario"""
    email: Email!
        @rules(apply: ["required", "email"])

    """Contraseña"""
    password: String!
        @rules(apply: ["required"])

    """Recordar sesión por más tiempo"""
    rememberMe: Boolean = false

    """Nombre del dispositivo (para tracking)"""
    deviceName: String
}

"""
Input para login con Google OAuth
"""
input GoogleLoginInput {
    """Token de Google OAuth"""
    googleToken: String!
        @rules(apply: ["required"])

    """Nombre del dispositivo"""
    deviceName: String
}

"""
Input para confirmar reset de contraseña
"""
input PasswordResetInput {
    """Token de reset"""
    token: String!
        @rules(apply: ["required"])

    """Nueva contraseña"""
    password: String!
        @rules(apply: ["required", "min:8", "confirmed"])

    """Confirmación de nueva contraseña"""
    passwordConfirmation: String!
        @rules(apply: ["required"])
}
