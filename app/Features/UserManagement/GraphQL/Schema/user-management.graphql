# ================================================================================
# USER MANAGEMENT FEATURE SCHEMA V10.1 - Sistema Helpdesk
# CORREGIDO: Payloads específicos, API profesional, sin over-fetching
# ================================================================================

extend type Query {
    """
    Usuario autenticado con información completa
    Incluye perfil, roles activos (roleContexts) y estadísticas
    """
    me: User!
        @guard
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Queries\\MeQuery")

    """
    Perfil completo del usuario autenticado
    Para páginas de configuración y edición
    """
    myProfile: UserProfile!
        @guard
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Queries\\MyProfileQuery")

    """
    Lista paginada de usuarios del sistema
    Solo accesible por administradores
    Máximo 50 registros por página
    """
    users(
        """Filtros de búsqueda"""
        filters: UserFilters
        """Ordenamiento de resultados"""
        orderBy: [UserOrderBy!]
        """Número de página"""
        page: Int = 1
        """Registros por página"""
        first: Int = 15
    ): UserPaginator!
        @guard(requires: [PLATFORM_ADMIN, COMPANY_ADMIN])
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Queries\\UsersQuery")

    """
    Usuario específico por ID con información COMPLETA
    Misma estructura que 'me' para consistencia
    Acceso según permisos del usuario autenticado
    """
    user(id: UUID!): User
        @guard
        @can(ability: "view", model: "User", find: "id")
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Queries\\UserQuery")

    """
    Roles disponibles en el sistema
    Lista estática de roles con sus descripciones
    Cache de 1 hora para performance
    """
    availableRoles: [RoleInfo!]!
        @guard(requires: [PLATFORM_ADMIN, COMPANY_ADMIN])
        @cache(ttl: 3600, key: "available_roles")
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Queries\\AvailableRolesQuery")
}

extend type Mutation {
    # ===== GESTIÓN DE PERFIL PROPIO =====

    """
    Actualiza DATOS PERSONALES del perfil (firstName, lastName, phone, avatar)
    Retorna SOLO el perfil actualizado (sin roleContexts, tickets, etc.)
    Rate limit: 30 actualizaciones por hora
    """
    updateMyProfile(input: UpdateProfileInput!): ProfileUpdatePayload!
        @guard
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Mutations\\UpdateMyProfileMutation")
        @rateLimit(max: 30, window: 3600)
        @audit(action: "profile_update")

    """
    Actualiza PREFERENCIAS de interfaz y notificaciones (theme, language, notifications)
    Retorna SOLO las preferencias actualizadas
    Rate limit: 50 actualizaciones por hora (más frecuente que perfil)
    """
    updateMyPreferences(input: PreferencesInput!): PreferencesUpdatePayload!
        @guard
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Mutations\\UpdateMyPreferencesMutation")
        @rateLimit(max: 50, window: 3600)
        @audit(action: "preferences_update")

    # ===== GESTIÓN DE USUARIOS (ADMIN) =====

    """
    Suspende temporalmente un usuario
    Invalida todas sus sesiones activas
    Retorna SOLO userId y status actualizado
    Solo accesible por platform admins
    """
    suspendUser(id: UUID!, reason: String): UserStatusPayload!
        @guard(requires: [PLATFORM_ADMIN])
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Mutations\\SuspendUserMutation")
        @audit(action: "user_suspend", includePayload: true)

    """
    Reactiva un usuario suspendido
    Retorna SOLO userId y status actualizado
    Solo accesible por platform admins
    """
    activateUser(id: UUID!): UserStatusPayload!
        @guard(requires: [PLATFORM_ADMIN])
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Mutations\\ActivateUserMutation")
        @audit(action: "user_activate")

    """
    Elimina lógicamente un usuario (soft delete)
    Anonimiza datos sensibles según GDPR
    Solo accesible por platform admins
    """
    deleteUser(id: UUID!, reason: String): Boolean!
        @guard(requires: [PLATFORM_ADMIN])
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Mutations\\DeleteUserMutation")
        @audit(action: "user_delete", includePayload: true)

    # ===== GESTIÓN DE ROLES =====

    """
    Asigna un rol a un usuario de manera INTELIGENTE:
    - Si el rol existe inactivo: lo REACTIVA
    - Si el rol no existe: lo CREA
    - Si el rol requiere empresa, companyId es obligatorio
    - Retorna información completa del resultado
    """
    assignRole(input: AssignRoleInput!): UserRoleResult!
        @guard(requires: [PLATFORM_ADMIN, COMPANY_ADMIN])
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Mutations\\AssignRoleMutation")
        @rateLimit(max: 100, window: 3600)
        @audit(action: "role_assign", includePayload: true)

    """
    Remueve un rol de un usuario (soft delete - reversible)
    Establece isActive = false, registra revokedAt y reason
    Para reactivarlo, usar assignRole con los mismos parámetros
    """
    removeRole(roleId: UUID!, reason: String): Boolean!
        @guard(requires: [PLATFORM_ADMIN, COMPANY_ADMIN])
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Mutations\\RemoveRoleMutation")
        @audit(action: "role_remove", includePayload: true)
}

# ================================================================================
# TYPES - Response types
# ================================================================================

"""
Usuario completo del sistema V10.1
SOLO para queries: me, user(id)
NO usado en mutations (usan Payloads específicos)
"""
type User implements Node & Timestamped {
    # ===== IDENTIFICADORES =====
    id: UUID!
    userCode: String! @rename(attribute: "user_code")

    # ===== AUTENTICACIÓN =====
    email: Email!
    emailVerified: Boolean! @rename(attribute: "email_verified")
    status: UserStatus!
    authProvider: AuthProvider! @rename(attribute: "auth_provider")

    # ===== PERFIL =====
    """
    Perfil del usuario con información personal y preferencias
    Usa DataLoader para prevenir N+1 queries
    """
    profile: UserProfile!
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Types\\UserFieldResolvers@profile")

    # ===== ROLES (CONSISTENTE con Authentication) =====
    """
    Contextos de roles ACTIVOS únicamente
    Misma estructura que login/register para consistencia 100%
    Reutiliza RoleContext de shared types
    Usa DataLoader para prevenir N+1 queries
    """
    roleContexts: [RoleContext!]!
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Types\\UserFieldResolvers@roleContexts")

    # ===== ESTADÍSTICAS =====
    """
    Total de tickets creados por el usuario
    TODO: Implementar DataLoader cuando exista feature Ticketing
    """
    ticketsCount: Int!
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Types\\UserFieldResolvers@ticketsCount")

    """
    Total de tickets resueltos (solo agentes)
    TODO: Implementar DataLoader cuando exista feature Ticketing
    """
    resolvedTicketsCount: Int!
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Types\\UserFieldResolvers@resolvedTicketsCount")

    """
    Rating promedio (solo para agentes con tickets resueltos)
    Null para usuarios sin rating
    TODO: Implementar DataLoader cuando exista feature Ratings
    """
    averageRating: Float
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Types\\UserFieldResolvers@averageRating")

    # ===== ACTIVIDAD =====
    """Última vez que el usuario inició sesión"""
    lastLoginAt: DateTime @rename(attribute: "last_login_at")

    """Última actividad registrada en el sistema"""
    lastActivityAt: DateTime @rename(attribute: "last_activity_at")

    # ===== AUDITORÍA =====
    createdAt: DateTime! @rename(attribute: "created_at")
    updatedAt: DateTime! @rename(attribute: "updated_at")

    """Fecha de eliminación (soft delete)"""
    deletedAt: DateTime @rename(attribute: "deleted_at")
}

"""
Perfil de usuario V10.1
Solo DATOS PERSONALES (sin preferencias)
"""
type UserProfile {
    # ===== INFORMACIÓN PERSONAL =====
    firstName: String! @rename(attribute: "first_name")
    lastName: String! @rename(attribute: "last_name")
    displayName: String! @rename(attribute: "display_name")
    phoneNumber: String @rename(attribute: "phone_number")
    avatarUrl: URL @rename(attribute: "avatar_url")

    # ===== PREFERENCIAS (SEPARADAS en UserPreferences) =====
    # Nota: Para obtener preferencias, usar UserPreferences
    # Este type solo contiene datos personales
    theme: String!
    language: String!
    timezone: String!
    pushWebNotifications: Boolean! @rename(attribute: "push_web_notifications")
    notificationsTickets: Boolean! @rename(attribute: "notifications_tickets")

    # ===== AUDITORÍA =====
    createdAt: DateTime! @rename(attribute: "created_at")
    updatedAt: DateTime! @rename(attribute: "updated_at")
}

"""
Preferencias de usuario V10.1
Solo PREFERENCIAS de interfaz y notificaciones
Separado de UserProfile para claridad en mutations
"""
type UserPreferences {
    # ===== PREFERENCIAS DE INTERFAZ =====
    theme: String!
    language: String!
    timezone: String!

    # ===== PREFERENCIAS DE NOTIFICACIONES =====
    pushWebNotifications: Boolean!
    notificationsTickets: Boolean!

    # ===== AUDITORÍA =====
    updatedAt: DateTime!
}

# ===== PAYLOADS ESPECÍFICOS (Retornos de mutations) =====

"""
Resultado de updateMyProfile
Retorna SOLO el perfil actualizado (sin roleContexts, tickets, etc.)
"""
type ProfileUpdatePayload {
    """ID del usuario"""
    userId: UUID! @rename(attribute: "userId")

    """Perfil actualizado con datos personales"""
    profile: UserProfile!

    """Timestamp de la actualización"""
    updatedAt: DateTime! @rename(attribute: "updatedAt")
}

"""
Resultado de updateMyPreferences
Retorna SOLO las preferencias actualizadas
"""
type PreferencesUpdatePayload {
    """ID del usuario"""
    userId: UUID!

    """Preferencias actualizadas"""
    preferences: UserPreferences!

    """Timestamp de la actualización"""
    updatedAt: DateTime!
}

"""
Resultado de suspendUser/activateUser
Retorna SOLO userId y status actualizado
"""
type UserStatusPayload {
    """ID del usuario"""
    userId: UUID!

    """Estado actualizado del usuario"""
    status: UserStatus!

    """Timestamp de la actualización"""
    updatedAt: DateTime!
}

"""
Resultado de asignación de rol V10.1
Indica si fue creado o reactivado
"""
type UserRoleResult {
    """Si la operación fue exitosa"""
    success: Boolean!

    """Mensaje descriptivo del resultado ('asignado' o 'reactivado')"""
    message: String!

    """Información del rol asignado/reactivado"""
    role: UserRoleInfo!
}

"""
Información de rol asignado a un usuario V10.1
Estructura CLARA: company estará presente según el tipo de rol
Reutiliza CompanyMinimal y UserMinimal de shared types
"""
type UserRoleInfo {
    """ID único del registro de rol"""
    id: UUID!

    # ===== ROL (campos planos, NO nested) =====
    """Código del rol"""
    roleCode: RoleCode!
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Types\\UserRoleInfoFieldResolvers@roleCode")

    """Nombre del rol"""
    roleName: String!
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Types\\UserRoleInfoFieldResolvers@roleName")

    # ===== EMPRESA (opcional, reutiliza CompanyMinimal) =====
    """
    Empresa asociada al rol
    Presente para AGENT y COMPANY_ADMIN
    Null para USER y PLATFORM_ADMIN
    Reutiliza CompanyMinimal de shared types
    """
    company: CompanyMinimal
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Types\\UserRoleInfoFieldResolvers@company")

    # ===== ESTADO =====
    """Si el rol está activo"""
    isActive: Boolean!
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Types\\UserRoleInfoFieldResolvers@isActive")

    # ===== METADATA =====
    """Cuándo fue asignado el rol"""
    assignedAt: DateTime!
        @field(resolver: "App\\Features\\UserManagement\\GraphQL\\Types\\UserRoleInfoFieldResolvers@assignedAt")

    """
    Quién asignó el rol
    Reutiliza UserMinimal de shared types
    """
    assignedBy: UserMinimal
}

"""
Información de rol disponible en el sistema V10.1
Para listado de roles y validaciones
SIMPLIFICADO: Elimina permissions y priority
"""
type RoleInfo {
    """Código único del rol"""
    code: RoleCode!

    """Nombre legible"""
    name: String!

    """Descripción completa"""
    description: String!

    """Si requiere empresa asociada"""
    requiresCompany: Boolean!

    """Dashboard por defecto"""
    defaultDashboard: String!

    """Si es rol del sistema (no personalizado)"""
    isSystemRole: Boolean!
}

# ===== PAGINACIÓN =====

"""
Paginador de usuarios
Reutiliza PaginatorInfo de shared types
"""
type UserPaginator {
    data: [User!]!
    paginatorInfo: PaginatorInfo!
}

# ================================================================================
# INPUTS
# ================================================================================

"""
Input para actualizar datos personales del perfil
Solo campos modificables: firstName, lastName, phoneNumber, avatarUrl
"""
input UpdateProfileInput {
    firstName: String
        @rules(apply: ["min:2", "max:100"])

    lastName: String
        @rules(apply: ["min:2", "max:100"])

    phoneNumber: String
        @rules(apply: ["min:10", "max:20"])

    avatarUrl: URL
}

"""
Input para actualizar preferencias de interfaz y notificaciones
Separado de UpdateProfileInput (patrón profesional)
"""
input PreferencesInput {
    theme: String
        @rules(apply: ["in:light,dark"])

    language: String
        @rules(apply: ["in:es,en"])

    timezone: String
        @rules(apply: ["timezone"])

    pushWebNotifications: Boolean

    notificationsTickets: Boolean
}

"""
Input para asignar rol a usuario
Validación crítica: roles que requieren empresa deben tener companyId
"""
input AssignRoleInput {
    """ID del usuario"""
    userId: UUID!
        @rules(apply: ["required", "exists:users,id"])

    """Código del rol a asignar"""
    roleCode: RoleCode!
        @rules(apply: ["required"])

    """
    ID de empresa (requerido SOLO si el rol requiere empresa)
    - AGENT y COMPANY_ADMIN: requieren companyId
    - USER y PLATFORM_ADMIN: NO requieren companyId (debe ser null)
    """
    companyId: UUID
}

"""
Filtros para query users
"""
input UserFilters {
    """Búsqueda de texto en email/nombre"""
    search: String

    """Filtrar por estado"""
    status: UserStatus

    """Filtrar por rol específico"""
    role: RoleCode

    """Filtrar por email verificado"""
    emailVerified: Boolean

    """Filtrar por empresa (usuarios con rol en esta empresa)"""
    companyId: UUID

    """Filtrar por actividad reciente (últimos 7 días)"""
    recentActivity: Boolean

    """Filtrar por rango de creación"""
    createdBetween: DateRange
}

"""
Ordenamiento de usuarios
Reutiliza UserOrderField y SortOrder de shared enums
"""
input UserOrderBy {
    field: UserOrderField!
    order: SortOrder!
}
