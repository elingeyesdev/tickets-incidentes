# ================================================================================
# COMPANY MANAGEMENT SCHEMA V9.0 - Sistema Helpdesk
# BALANCEADO Y PRAGMÁTICO: Sin loops, separación de concerns, performance
# ================================================================================

extend type Query {
    # ===== QUERY PRINCIPAL: 80% de casos de uso =====

    """
    Query principal con contextos inteligentes
    USA ESTO para: selectores, exploradores, listas
    """
    companies(
        """Define qué campos necesitas según el caso de uso"""
        context: CompanyQueryContext!

        """Filtros opcionales"""
        filters: CompanyFilters

        """Búsqueda de texto"""
        search: String

        """Paginación"""
        page: Int = 1
        first: Int = 20
    ): CompanyQueryResult!
        @field(resolver: "CompaniesQuery")

    # ===== QUERIES ESPECÍFICAS: 20% restante =====

    """
    Detalle completo de una empresa específica
    """
    company(id: UUID!): Company
        @jwt
        @can(ability: "view", model: "Company", find: "id")
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Queries\\CompanyQuery")

    """
    Mis empresas seguidas con estadísticas personales
    """
    myFollowedCompanies: [CompanyFollowInfo!]!
        @jwt
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Queries\\MyFollowedCompaniesQuery")

    """
    Verificación rápida de seguimiento
    """
    isFollowingCompany(companyId: UUID!): Boolean!
        @jwt
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Queries\\IsFollowingCompanyQuery")

    """
    Panel administrativo: solicitudes pendientes
    """
    companyRequests(
        status: CompanyRequestStatus
        first: Int = 15
    ): [CompanyRequest!]!
        @jwt(requires: [PLATFORM_ADMIN])
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Queries\\CompanyRequestsQuery")
}

# ================================================================================
# MUTATIONS
# ================================================================================

extend type Mutation {
    # Company Followers
    followCompany(companyId: UUID!): CompanyFollowResult!
        @jwt
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Mutations\\FollowCompanyMutation")
        @audit(action: "company_follow")

    unfollowCompany(companyId: UUID!): Boolean!
        @jwt
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Mutations\\UnfollowCompanyMutation")
        @audit(action: "company_unfollow")

    # Solicitudes
    requestCompany(input: CompanyRequestInput!): CompanyRequest!
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Mutations\\RequestCompanyMutation")
        @rateLimit(max: 3, window: 3600, message: "Solo 3 solicitudes por hora")
        @audit(action: "company_request", includePayload: true)

    # Admin
    approveCompanyRequest(requestId: UUID!): Company!
        @jwt(requires: [PLATFORM_ADMIN])
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Mutations\\ApproveCompanyRequestMutation")
        @audit(action: "company_request_approve", includePayload: true)

    rejectCompanyRequest(
        requestId: UUID!
        reason: String! @rules(apply: ["required", "min:3"])
    ): Boolean!
        @jwt(requires: [PLATFORM_ADMIN])
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Mutations\\RejectCompanyRequestMutation")
        @audit(action: "company_request_reject", includePayload: true)

    createCompany(input: CreateCompanyInput!): Company!
        @jwt(requires: [PLATFORM_ADMIN])
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Mutations\\CreateCompanyMutation")
        @rateLimit(max: 10, window: 3600)
        @audit(action: "company_create", includePayload: true)

    updateCompany(id: UUID!, input: UpdateCompanyInput!): Company!
        @jwt
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Mutations\\UpdateCompanyMutation")
        @audit(action: "company_update", includePayload: true)
}

# ================================================================================
# RESULTADO POLIMÓRFICO: Devuelve el type correcto según contexto
# ================================================================================

"""
Resultado inteligente basado en el contexto solicitado
"""
union CompanyQueryResult =
    | CompanyMinimalList
    | CompanyExploreList
    | CompanyFullList

"""Wrapper para contexto MINIMAL"""
type CompanyMinimalList {
    items: [CompanyMinimal!]!
    totalCount: Int!
    hasNextPage: Boolean!
}

"""Wrapper para contexto EXPLORE"""
type CompanyExploreList {
    items: [CompanyForFollowing!]!
    totalCount: Int!
    hasNextPage: Boolean!
}

"""Wrapper para contexto MANAGEMENT/ANALYTICS"""
type CompanyFullList {
    items: [Company!]!
    totalCount: Int!
    hasNextPage: Boolean!
}

# ================================================================================
# TYPES - Response types
# ================================================================================

"""
Type para EXPLORAR empresas y seguir
CASO DE USO: Página "Explorar Empresas", selector de onboarding
"""
type CompanyForFollowing {
    """ID único"""
    id: UUID!

    """Código único"""
    companyCode: String! @rename(attribute: "company_code")

    """Nombre comercial"""
    name: String!

    """Logo"""
    logoUrl: URL @rename(attribute: "logo_url")

    """Descripción breve del negocio"""
    description: String

    """Sector o industria"""
    industry: String

    """Ciudad"""
    city: String @rename(attribute: "contact_city")

    """País"""
    country: String @rename(attribute: "contact_country")

    """Color primario para branding"""
    primaryColor: HexColor @rename(attribute: "primary_color")

    """Estado de la empresa"""
    status: CompanyStatus!

    """Total de seguidores (social proof)"""
    followersCount: Int!
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Resolvers\\CompanyFieldResolvers@followersCount")

    """Si yo la estoy siguiendo"""
    isFollowedByMe: Boolean!
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Resolvers\\CompanyFieldResolvers@isFollowedByMe")
}

"""
Type COMPLETO de empresa - SIN loops infinitos
CASO DE USO: Query company($id) para detalle completo
"""
type Company implements Node & Timestamped {
    # Identificadores
    id: UUID!
    companyCode: String! @rename(attribute: "company_code")

    # Info básica
    name: String!
    legalName: String @rename(attribute: "legal_name")
    supportEmail: Email @rename(attribute: "support_email")
    phone: PhoneNumber
    website: URL

    # Contacto
    contactAddress: String @rename(attribute: "contact_address")
    contactCity: String @rename(attribute: "contact_city")
    contactCountry: String @rename(attribute: "contact_country")

    # Legal
    taxId: String @rename(attribute: "tax_id")
    legalRepresentative: String @rename(attribute: "legal_representative")

    # Config
    businessHours: JSON! @rename(attribute: "business_hours")
    timezone: String!

    # Branding
    logoUrl: URL @rename(attribute: "logo_url")
    primaryColor: HexColor! @rename(attribute: "primary_color")
    secondaryColor: HexColor! @rename(attribute: "secondary_color")

    # Estado
    status: CompanyStatus!

    # Admin (SIN loops)
    adminId: UUID! @rename(attribute: "admin_user_id")
    adminName: String! @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Resolvers\\CompanyFieldResolvers@adminName")
    adminEmail: Email! @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Resolvers\\CompanyFieldResolvers@adminEmail")

    # Estadísticas (contadores)
    activeAgentsCount: Int! @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Resolvers\\CompanyFieldResolvers@activeAgentsCount")
    totalUsersCount: Int! @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Resolvers\\CompanyFieldResolvers@totalUsersCount")
    totalTicketsCount: Int!
    openTicketsCount: Int!
    followersCount: Int! @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Resolvers\\CompanyFieldResolvers@followersCount")

    # Flags contextuales
    isFollowedByMe: Boolean @jwt

    # Auditoría
    createdAt: DateTime! @rename(attribute: "created_at")
    updatedAt: DateTime! @rename(attribute: "updated_at")
}

"""
Información de empresa seguida CON contexto de seguimiento
CASO DE USO: myFollowedCompanies query
"""
type CompanyFollowInfo {
    id: UUID!
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Resolvers\\CompanyFollowInfoFieldResolvers@id")

    company: CompanyMinimal!
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Resolvers\\CompanyFollowInfoFieldResolvers@company")

    followedAt: DateTime!
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Resolvers\\CompanyFollowInfoFieldResolvers@followedAt")

    myTicketsCount: Int!
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Resolvers\\CompanyFollowInfoFieldResolvers@myTicketsCount")

    lastTicketCreatedAt: DateTime
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Resolvers\\CompanyFollowInfoFieldResolvers@lastTicketCreatedAt")

    hasUnreadAnnouncements: Boolean!
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Resolvers\\CompanyFollowInfoFieldResolvers@hasUnreadAnnouncements")
}

"""
Solicitud de empresa pendiente de aprobación
"""
type CompanyRequest implements Node & Timestamped {
    # Identificadores
    id: UUID!
    requestCode: String! @rename(attribute: "request_code")

    # Información de la empresa solicitada
    companyName: String! @rename(attribute: "company_name")
    legalName: String @rename(attribute: "legal_name")
    adminEmail: Email! @rename(attribute: "admin_email")
    businessDescription: String! @rename(attribute: "business_description")

    # Detalles adicionales
    website: URL
    industryType: String @rename(attribute: "industry_type")
    estimatedUsers: Int @rename(attribute: "estimated_users")

    # Información de contacto
    contactAddress: String @rename(attribute: "contact_address")
    contactCity: String @rename(attribute: "contact_city")
    contactCountry: String @rename(attribute: "contact_country")
    contactPostalCode: String @rename(attribute: "contact_postal_code")
    taxId: String @rename(attribute: "tax_id")

    # Estado y revisión
    status: CompanyRequestStatus!
    reviewedById: UUID @rename(attribute: "reviewed_by")
    reviewedByName: String @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Resolvers\\CompanyRequestFieldResolvers@reviewedByName")
    reviewedAt: DateTime @rename(attribute: "reviewed_at")
    rejectionReason: String @rename(attribute: "rejection_reason")

    # Empresa creada (si fue aprobada)
    createdCompanyId: UUID @rename(attribute: "created_company_id")
    createdCompanyName: String @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Resolvers\\CompanyRequestFieldResolvers@createdCompanyName")

    # Auditoría
    createdAt: DateTime! @rename(attribute: "created_at")
    updatedAt: DateTime! @rename(attribute: "updated_at")
}

"""
Resultado de seguir una empresa
"""
type CompanyFollowResult {
    success: Boolean!
    message: String!
    company: CompanyMinimal!
    followedAt: DateTime!
}

# ================================================================================
# INPUTS
# ================================================================================

"""
Filtros para query companies
"""
input CompanyFilters {
    status: CompanyStatus
    industry: String
    country: String
    hasActiveTickets: Boolean
    followedByMe: Boolean
}

"""
Input para solicitar empresa
"""
input CompanyRequestInput {
    companyName: String!
        @rules(apply: ["required", "min:2", "max:200"])

    legalName: String
        @rules(apply: ["nullable", "max:250"])

    adminEmail: String!
        @rules(apply: ["required", "email"])

    businessDescription: String!
        @rules(apply: ["required", "min:50", "max:1000"])

    industryType: String!
        @rules(apply: ["required", "max:100"])

    website: String
        @rules(apply: ["nullable"])

    estimatedUsers: Int
        @rules(apply: ["nullable", "integer", "min:1"])

    contactAddress: String
        @rules(apply: ["nullable", "max:500"])

    contactCity: String
        @rules(apply: ["nullable", "max:100"])

    contactCountry: String
        @rules(apply: ["nullable", "max:100"])

    contactPostalCode: String
        @rules(apply: ["nullable", "max:20"])

    taxId: String
        @rules(apply: ["nullable", "max:50"])
}

"""
Input para crear empresa directamente (admin)
"""
input CreateCompanyInput {
    name: String!
        @rules(apply: ["required", "min:2", "max:200"])

    legalName: String
        @rules(apply: ["max:250"])

    adminUserId: UUID!
        @rules(apply: ["required"])

    supportEmail: Email
        @rules(apply: ["email"])

    phone: PhoneNumber
    website: URL

    contactInfo: ContactInfoInput
    initialConfig: CompanyConfigInput
}

"""
Input para actualizar empresa
"""
input UpdateCompanyInput {
    name: String
        @rules(apply: ["min:2", "max:200"])

    legalName: String
        @rules(apply: ["max:250"])

    supportEmail: Email
        @rules(apply: ["email"])

    phone: PhoneNumber
    website: URL

    contactInfo: ContactInfoInput
    config: CompanyConfigInput
    branding: CompanyBrandingInput
}

input ContactInfoInput {
    address: String
        @rules(apply: ["max:500"])
    city: String
        @rules(apply: ["max:100"])
    state: String
        @rules(apply: ["max:100"])
    country: String
        @rules(apply: ["max:100"])
    postalCode: String
        @rules(apply: ["max:20"])
    taxId: String
        @rules(apply: ["max:50"])
    legalRepresentative: String
        @rules(apply: ["max:200"])
}

input CompanyConfigInput {
    businessHours: JSON
    timezone: String
        @rules(apply: ["timezone"])
    settings: JSON
}

input CompanyBrandingInput {
    logoUrl: URL
    faviconUrl: URL
    primaryColor: HexColor
    secondaryColor: HexColor
}
