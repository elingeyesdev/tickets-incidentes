# ================================================================================
# COMPANY MANAGEMENT SCHEMA V9.0 - Sistema Helpdesk
# BALANCEADO Y PRAGMÁTICO: Sin loops, separación de concerns, performance
# ================================================================================

extend type Query {
    # ===== QUERY PRINCIPAL: 80% de casos de uso =====

    """
    Query principal con contextos inteligentes
    USA ESTO para: selectores, exploradores, listas
    """
    companies(
        """Define qué campos necesitas según el caso de uso"""
        context: CompanyQueryContext!

        """Filtros opcionales"""
        filters: CompanyFilters

        """Búsqueda de texto"""
        search: String

        """Paginación"""
        page: Int = 1
        first: Int = 20
    ): CompanyQueryResult!
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Queries\\CompaniesQuery")
        @cache(ttl: 300, key: "companies_{context}_{filters}")

    # ===== QUERIES ESPECÍFICAS: 20% restante =====

    """
    Detalle completo de una empresa específica
    """
    company(id: UUID!): Company
        @jwt
        @can(ability: "view", model: "Company", find: "id")
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Queries\\CompanyQuery")

    """
    Mis empresas seguidas con estadísticas personales
    """
    myFollowedCompanies: [CompanyFollowInfo!]!
        @jwt
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Queries\\MyFollowedCompaniesQuery")

    """
    Verificación rápida de seguimiento
    """
    isFollowingCompany(companyId: UUID!): Boolean!
        @jwt
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Queries\\IsFollowingCompanyQuery")

    """
    Panel administrativo: solicitudes pendientes
    """
    companyRequests(
        status: CompanyRequestStatus
        first: Int = 15
    ): [CompanyRequest!]!
        @jwt(requires: [PLATFORM_ADMIN])
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Queries\\CompanyRequestsQuery")
}

# ================================================================================
# MUTATIONS
# ================================================================================

extend type Mutation {
    # Company Followers
    followCompany(companyId: UUID!): CompanyFollowResult!
        @jwt
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Mutations\\FollowCompanyMutation")
        @audit(action: "company_follow")

    unfollowCompany(companyId: UUID!): Boolean!
        @jwt
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Mutations\\UnfollowCompanyMutation")
        @audit(action: "company_unfollow")

    # Solicitudes
    requestCompany(input: CompanyRequestInput!): CompanyRequest!
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Mutations\\RequestCompanyMutation")
        @rateLimit(max: 3, window: 3600, message: "Solo 3 solicitudes por hora")
        @audit(action: "company_request", includePayload: true)

    # Admin
    approveCompanyRequest(requestId: UUID!): Company!
        @jwt(requires: [PLATFORM_ADMIN])
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Mutations\\ApproveCompanyRequestMutation")
        @audit(action: "company_request_approve", includePayload: true)

    rejectCompanyRequest(requestId: UUID!, reason: String!): Boolean!
        @jwt(requires: [PLATFORM_ADMIN])
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Mutations\\RejectCompanyRequestMutation")
        @audit(action: "company_request_reject", includePayload: true)

    createCompany(input: CreateCompanyInput!): Company!
        @jwt(requires: [PLATFORM_ADMIN])
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Mutations\\CreateCompanyMutation")
        @rateLimit(max: 10, window: 3600)
        @audit(action: "company_create", includePayload: true)

    updateCompany(id: UUID!, input: UpdateCompanyInput!): Company!
        @jwt(requires: [PLATFORM_ADMIN, COMPANY_ADMIN])
        @can(ability: "update", model: "Company", find: "id")
        @field(resolver: "App\\Features\\CompanyManagement\\GraphQL\\Mutations\\UpdateCompanyMutation")
        @audit(action: "company_update", includePayload: true)
}

# ================================================================================
# RESULTADO POLIMÓRFICO: Devuelve el type correcto según contexto
# ================================================================================

"""
Resultado inteligente basado en el contexto solicitado
"""
union CompanyQueryResult =
    | CompanyMinimalList
    | CompanyExploreList
    | CompanyFullList

"""Wrapper para contexto MINIMAL"""
type CompanyMinimalList {
    items: [CompanyMinimal!]!
    totalCount: Int!
    hasNextPage: Boolean!
}

"""Wrapper para contexto EXPLORE"""
type CompanyExploreList {
    items: [CompanyForFollowing!]!
    totalCount: Int!
    hasNextPage: Boolean!
}

"""Wrapper para contexto MANAGEMENT/ANALYTICS"""
type CompanyFullList {
    items: [Company!]!
    totalCount: Int!
    hasNextPage: Boolean!
}

# ================================================================================
# TYPES - Response types
# ================================================================================

"""
Type para EXPLORAR empresas y seguir
CASO DE USO: Página "Explorar Empresas", selector de onboarding
"""
type CompanyForFollowing {
    """ID único"""
    id: UUID!

    """Código único"""
    companyCode: String!

    """Nombre comercial"""
    name: String!

    """Logo"""
    logoUrl: URL

    """Descripción breve del negocio"""
    description: String

    """Sector o industria"""
    industry: String

    """Ciudad"""
    city: String

    """País"""
    country: String

    """Color primario para branding"""
    primaryColor: HexColor

    """Total de seguidores (social proof)"""
    followersCount: Int!

    """Si yo la estoy siguiendo"""
    isFollowedByMe: Boolean!
}

"""
Type COMPLETO de empresa - SIN loops infinitos
CASO DE USO: Query company($id) para detalle completo
"""
type Company implements Node & Timestamped {
    # Identificadores
    id: UUID!
    companyCode: String!

    # Info básica
    name: String!
    legalName: String
    supportEmail: Email
    phone: PhoneNumber
    website: URL

    # Contacto
    contactAddress: String
    contactCity: String
    contactCountry: String

    # Legal
    taxId: String
    legalRepresentative: String

    # Config
    businessHours: JSON!
    timezone: String!

    # Branding
    logoUrl: URL
    primaryColor: HexColor!
    secondaryColor: HexColor!

    # Estado
    status: CompanyStatus!

    # Admin (SIN loops)
    adminId: UUID!
    adminName: String!
    adminEmail: Email!

    # Estadísticas (contadores)
    activeAgentsCount: Int!
    totalUsersCount: Int!
    totalTicketsCount: Int!
    openTicketsCount: Int!
    followersCount: Int!

    # Flags contextuales
    isFollowedByMe: Boolean @jwt

    # Auditoría
    createdAt: DateTime!
    updatedAt: DateTime!
}

"""
Información de empresa seguida CON contexto de seguimiento
CASO DE USO: myFollowedCompanies query
"""
type CompanyFollowInfo {
    id: UUID!
    company: CompanyMinimal!
    followedAt: DateTime!
    myTicketsCount: Int!
    lastTicketCreatedAt: DateTime
    hasUnreadAnnouncements: Boolean!
}

"""
Solicitud de empresa pendiente de aprobación
"""
type CompanyRequest implements Node & Timestamped {
    id: UUID!
    requestCode: String!
    companyName: String!
    adminEmail: Email!
    businessDescription: String!
    status: CompanyRequestStatus!
    createdAt: DateTime!
    updatedAt: DateTime!
}

"""
Resultado de seguir una empresa
"""
type CompanyFollowResult {
    success: Boolean!
    message: String!
    company: CompanyMinimal!
    followedAt: DateTime!
}

# ================================================================================
# INPUTS
# ================================================================================

"""
Filtros para query companies
"""
input CompanyFilters {
    status: CompanyStatus
    industry: String
    country: String
    hasActiveTickets: Boolean
    followedByMe: Boolean
}

"""
Input para solicitar empresa
"""
input CompanyRequestInput {
    companyName: String!
        @rules(apply: ["required", "min:2", "max:200"])

    adminEmail: Email!
        @rules(apply: ["required", "email"])

    businessDescription: String!
        @rules(apply: ["required", "min:50", "max:1000"])

    industryType: String!
        @rules(apply: ["required", "max:100"])

    website: URL
        @rules(apply: ["active_url"])

    contactAddress: String
        @rules(apply: ["max:500"])

    contactCity: String
        @rules(apply: ["max:100"])

    contactCountry: String
        @rules(apply: ["max:100"])

    taxId: String
        @rules(apply: ["max:50"])
}

"""
Input para crear empresa directamente (admin)
"""
input CreateCompanyInput {
    name: String!
        @rules(apply: ["required", "min:2", "max:200"])

    legalName: String
        @rules(apply: ["max:250"])

    adminUserId: UUID!
        @rules(apply: ["required", "exists:users,id"])

    supportEmail: Email
        @rules(apply: ["email"])

    phone: PhoneNumber
    website: URL
        @rules(apply: ["active_url"])

    contactInfo: ContactInfoInput
    initialConfig: CompanyConfigInput
}

"""
Input para actualizar empresa
"""
input UpdateCompanyInput {
    name: String
        @rules(apply: ["min:2", "max:200"])

    legalName: String
        @rules(apply: ["max:250"])

    supportEmail: Email
        @rules(apply: ["email"])

    phone: PhoneNumber
    website: URL
        @rules(apply: ["active_url"])

    contactInfo: ContactInfoInput
    config: CompanyConfigInput
    branding: CompanyBrandingInput
}

input ContactInfoInput {
    address: String
        @rules(apply: ["max:500"])
    city: String
        @rules(apply: ["max:100"])
    state: String
        @rules(apply: ["max:100"])
    country: String
        @rules(apply: ["max:100"])
    postalCode: String
        @rules(apply: ["max:20"])
    taxId: String
        @rules(apply: ["max:50"])
    legalRepresentative: String
        @rules(apply: ["max:200"])
}

input CompanyConfigInput {
    businessHours: JSON
    timezone: String
        @rules(apply: ["timezone"])
    settings: JSON
}

input CompanyBrandingInput {
    logoUrl: URL
        @rules(apply: ["active_url"])
    faviconUrl: URL
        @rules(apply: ["active_url"])
    primaryColor: HexColor
    secondaryColor: HexColor
}
