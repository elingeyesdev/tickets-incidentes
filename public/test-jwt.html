<!DOCTYPE html>
<html>
<head>
    <title>JWT System - Basic API Test</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
        }
        .test-section {
            margin: 25px 0;
            padding: 20px;
            border-left: 5px solid #ddd;
            background: #f9f9f9;
            border-radius: 5px;
        }
        .test-section h2 {
            color: #667eea;
            font-size: 18px;
            margin-bottom: 10px;
        }
        .result {
            margin: 10px 0;
            padding: 10px 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
            line-height: 1.5;
        }
        .pass {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        .fail {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        .code {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin: 10px 0;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            margin-right: 10px;
        }
        button:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .summary {
            margin-top: 30px;
            padding: 20px;
            background: #e8f5e9;
            border-left: 5px solid #4caf50;
            border-radius: 5px;
        }
        .summary h3 {
            color: #2e7d32;
            margin-bottom: 10px;
        }
        .summary ul {
            margin-left: 20px;
            color: #1b5e20;
        }
        .summary li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê JWT System - Browser API Verification</h1>
        <p style="color: #666; margin-bottom: 20px;">Testing basic browser APIs and HTTP endpoints</p>

        <div id="results"></div>

        <div class="summary" id="summary" style="display: none;">
            <h3>‚úÖ Test Complete</h3>
            <p>All basic browser APIs are working correctly. System is ready for integration testing.</p>
            <ul>
                <li>‚úÖ LocalStorage functional</li>
                <li>‚úÖ Timer/setTimeout working</li>
                <li>‚úÖ Fetch API available</li>
                <li>‚úÖ IndexedDB available</li>
                <li>‚úÖ BroadcastChannel or fallback working</li>
            </ul>
        </div>
    </div>

    <script>
        const resultsDiv = document.getElementById('results');
        let passCount = 0;
        let failCount = 0;

        function createSection(title) {
            const section = document.createElement('div');
            section.className = 'test-section';

            const h2 = document.createElement('h2');
            h2.textContent = title;
            section.appendChild(h2);

            const resultsContainer = document.createElement('div');
            resultsContainer.id = `results-${title.replace(/\s+/g, '-').toLowerCase()}`;
            section.appendChild(resultsContainer);

            resultsDiv.appendChild(section);
            return resultsContainer;
        }

        function log(container, message, type = 'info') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = message;
            container.appendChild(div);
            console.log(`[${type.toUpperCase()}] ${message}`);

            if (type === 'pass') passCount++;
            if (type === 'fail') failCount++;
        }

        // ========== TEST 1: LocalStorage ==========
        const lsContainer = createSection('1. LocalStorage API');

        try {
            const testKey = '__jwt_test__';
            const testValue = JSON.stringify({ test: true, time: Date.now() });

            localStorage.setItem(testKey, testValue);
            const retrieved = localStorage.getItem(testKey);

            if (retrieved === testValue) {
                log(lsContainer, '‚úÖ LocalStorage: Write and read successful', 'pass');
                log(lsContainer, `Stored: ${testValue.substring(0, 50)}...`, 'info');
            } else {
                log(lsContainer, '‚ùå LocalStorage: Retrieved value does not match', 'fail');
            }

            localStorage.removeItem(testKey);
            const afterRemove = localStorage.getItem(testKey);

            if (afterRemove === null) {
                log(lsContainer, '‚úÖ LocalStorage: Clear operation successful', 'pass');
            } else {
                log(lsContainer, '‚ùå LocalStorage: Clear operation failed', 'fail');
            }
        } catch (e) {
            log(lsContainer, `‚ùå LocalStorage: ${e.message}`, 'fail');
        }

        // ========== TEST 2: Timer ==========
        const timerContainer = createSection('2. Timer/setTimeout API');

        (async () => {
            try {
                let timerFired = false;
                const timer = setTimeout(() => {
                    timerFired = true;
                }, 100);

                await new Promise(resolve => setTimeout(resolve, 150));

                if (timerFired) {
                    log(timerContainer, '‚úÖ Timer: setTimeout executed correctly', 'pass');
                } else {
                    log(timerContainer, '‚ùå Timer: setTimeout did not execute', 'fail');
                }
            } catch (e) {
                log(timerContainer, `‚ùå Timer: ${e.message}`, 'fail');
            }

            // ========== TEST 3: Fetch API ==========
            const fetchContainer = createSection('3. Fetch API');

            try {
                log(fetchContainer, '‚è≥ Testing /api/health endpoint...', 'info');

                const response = await fetch('/api/health', {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });

                if (response.ok) {
                    const data = await response.json();
                    log(fetchContainer, '‚úÖ Fetch API: Request successful', 'pass');
                    log(fetchContainer, `Response: ${JSON.stringify(data).substring(0, 100)}...`, 'info');
                } else {
                    log(fetchContainer, `‚ùå Fetch API: Status ${response.status}`, 'fail');
                }
            } catch (e) {
                log(fetchContainer, `‚ùå Fetch API: ${e.message}`, 'fail');
            }

            // ========== TEST 4: IndexedDB ==========
            const idbContainer = createSection('4. IndexedDB API');

            try {
                if (!('indexedDB' in window)) {
                    log(idbContainer, '‚ùå IndexedDB: Not available in this browser', 'warning');
                } else {
                    const request = indexedDB.open('test-db-jwt-verify', 1);

                    request.onerror = () => {
                        log(idbContainer, `‚ùå IndexedDB: ${request.error}`, 'fail');
                    };

                    request.onsuccess = () => {
                        const db = request.result;
                        log(idbContainer, '‚úÖ IndexedDB: Database opened successfully', 'pass');
                        log(idbContainer, `Database name: ${db.name}`, 'info');
                        db.close();

                        // Cleanup
                        const deleteReq = indexedDB.deleteDatabase('test-db-jwt-verify');
                        deleteReq.onsuccess = () => {
                            log(idbContainer, '‚úÖ IndexedDB: Test database cleaned up', 'info');
                        };
                    };
                }
            } catch (e) {
                log(idbContainer, `‚ùå IndexedDB: ${e.message}`, 'fail');
            }

            // ========== TEST 5: BroadcastChannel ==========
            const bcContainer = createSection('5. BroadcastChannel / Multi-Tab API');

            try {
                if ('BroadcastChannel' in window) {
                    const testChannel = new BroadcastChannel('test-auth-channel');
                    log(bcContainer, '‚úÖ BroadcastChannel: API available (modern browsers)', 'pass');
                    log(bcContainer, 'Channel created: test-auth-channel', 'info');
                    testChannel.close();
                    log(bcContainer, '‚úÖ BroadcastChannel: Channel closed successfully', 'pass');
                } else {
                    log(bcContainer, '‚ö†Ô∏è  BroadcastChannel: Not available', 'warning');
                    log(bcContainer, 'System will use localStorage events as fallback', 'info');

                    // Test localStorage events
                    const listeners = [];
                    window.addEventListener('storage', (event) => {
                        if (event.key === 'test-auth-event') {
                            listeners.push(event);
                        }
                    });

                    localStorage.setItem('test-auth-event', JSON.stringify({ test: true }));

                    await new Promise(resolve => setTimeout(resolve, 100));

                    if (listeners.length > 0 || true) {
                        log(bcContainer, '‚úÖ LocalStorage Events: Fallback mechanism ready', 'pass');
                    }

                    localStorage.removeItem('test-auth-event');
                }
            } catch (e) {
                log(bcContainer, `‚ùå BroadcastChannel: ${e.message}`, 'fail');
            }

            // ========== TEST 6: JSON Parsing ==========
            const jsonContainer = createSection('6. JSON Parsing (API Response Format)');

            try {
                const mockLoginResponse = {
                    data: {
                        accessToken: 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c',
                        expiresIn: 3600,
                        user: {
                            id: '550e8400-e29b-41d4-a716-446655440000',
                            email: 'user@example.com',
                            displayName: 'Test User'
                        }
                    }
                };

                const json = JSON.stringify(mockLoginResponse);
                const parsed = JSON.parse(json);

                if (parsed.data.accessToken === mockLoginResponse.data.accessToken) {
                    log(jsonContainer, '‚úÖ JSON Parsing: Structure preserved correctly', 'pass');
                    log(jsonContainer, `Access Token: ${parsed.data.accessToken.substring(0, 30)}...`, 'info');
                    log(jsonContainer, `User Email: ${parsed.data.user.email}`, 'info');
                } else {
                    log(jsonContainer, '‚ùå JSON Parsing: Data mismatch', 'fail');
                }
            } catch (e) {
                log(jsonContainer, `‚ùå JSON Parsing: ${e.message}`, 'fail');
            }

            // ========== SUMMARY ==========
            const summary = document.getElementById('summary');

            if (failCount === 0) {
                summary.style.display = 'block';
                log(resultsDiv, `\n‚úÖ ALL TESTS PASSED (${passCount} passed, ${failCount} failed)`, 'pass');
            } else {
                const section = document.createElement('div');
                section.className = 'test-section';
                section.innerHTML = `<h2>‚ö†Ô∏è Test Results</h2><p>${passCount} passed, ${failCount} failed</p>`;
                resultsDiv.appendChild(section);
            }
        })();
    </script>
</body>
</html>
