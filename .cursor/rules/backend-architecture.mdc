---
alwaysApply: false
---

# Backend Architecture - Laravel + GraphQL + PostgreSQL

## Complete Feature-First Structure

```
app/Features/[FeatureName]/
├── Services/
│   ├── [Feature]Service.php       # Main business logic
│   ├── [Related]Service.php       # Additional services
│   └── .gitkeep
├── Models/
│   ├── [Model].php                # Main model
│   ├── [Related].php              # Related models
│   └── .gitkeep
├── GraphQL/
│   ├── Schema/
│   │   └── [feature].graphql      # Feature schema
│   ├── Queries/
│   │   ├── [Name]Query.php
│   │   └── .gitkeep
│   ├── Mutations/
│   │   ├── [Name]Mutation.php
│   │   └── .gitkeep
│   ├── Types/
│   │   ├── [Type]Type.php         # Field resolvers
│   │   └── .gitkeep
│   ├── DataLoaders/
│   │   ├── [Model]ByIdLoader.php
│   │   └── .gitkeep
│   └── Errors/                     # Feature-specific errors
│       └── .gitkeep
├── Policies/
│   ├── [Model]Policy.php
│   └── .gitkeep
├── Events/
│   ├── [Model]Created.php
│   ├── [Model]Updated.php
│   └── .gitkeep
├── Listeners/
│   ├── [Action]Listener.php
│   └── .gitkeep
├── Jobs/
│   ├── [Task]Job.php
│   └── .gitkeep
├── Mail/
│   ├── [Email]Mail.php
│   └── .gitkeep
├── Exceptions/
│   ├── [Feature]Exception.php
│   └── .gitkeep
├── Database/
│   ├── Migrations/
│   │   └── YYYY_MM_DD_HHMMSS_[description].php
│   ├── Seeders/
│   │   └── [Feature]Seeder.php
│   └── Factories/
│       └── [Model]Factory.php
└── [Feature]ServiceProvider.php

app/Shared/
├── Services/
│   └── .gitkeep
├── Traits/
│   ├── HasUuid.php
│   ├── Auditable.php
│   └── .gitkeep
├── Enums/
│   ├── UserStatus.php
│   ├── CompanyStatus.php
│   ├── Role.php
│   └── .gitkeep
├── Exceptions/
│   ├── HelpdeskException.php      # Base exception
│   ├── NotFoundException.php
│   ├── ValidationException.php
│   ├── AuthenticationException.php
│   ├── AuthorizationException.php
│   ├── ConflictException.php
│   ├── ForbiddenException.php
│   └── .gitkeep
├── Constants/
│   └── .gitkeep
├── Helpers/
│   ├── CodeGenerator.php
│   ├── DeviceInfoParser.php
│   └── .gitkeep
├── GraphQL/
│   ├── Scalars/
│   │   ├── UUID.php
│   │   ├── Email.php
│   │   ├── PhoneNumber.php
│   │   ├── HexColor.php
│   │   ├── URL.php
│   │   ├── JSON.php
│   │   └── DateTimeScalar.php
│   ├── Directives/
│   │   ├── JwtDirective.php       # @jwt
│   │   ├── CompanyDirective.php   # @company
│   │   ├── AuditDirective.php     # @audit
│   │   └── RateLimitDirective.php # @rateLimit
│   ├── DataLoaders/
│   │   ├── UserByIdLoader.php
│   │   ├── CompanyByIdLoader.php
│   │   ├── UserProfileByUserIdLoader.php
│   │   └── .gitkeep
│   ├── Queries/
│   │   ├── BaseQuery.php
│   │   ├── PingQuery.php
│   │   ├── VersionQuery.php
│   │   ├── HealthQuery.php
│   │   └── .gitkeep
│   ├── Mutations/
│   │   ├── BaseMutation.php
│   │   └── .gitkeep
│   ├── Errors/
│   │   ├── BaseErrorHandler.php
│   │   ├── GraphQLErrorFormatter.php
│   │   ├── ErrorCodeRegistry.php
│   │   ├── EnvironmentErrorFormatter.php
│   │   └── .gitkeep
│   ├── Types/
│   │   └── .gitkeep
│   ├── Unions/
│   │   └── .gitkeep
│   └── Interfaces/
│       └── .gitkeep
├── Models/
│   └── .gitkeep
└── Database/
    └── Migrations/
        ├── 0000_00_00_000000_create_postgresql_extensions_and_functions.php
        ├── YYYY_MM_DD_000001_create_ticketing_schema.php
        ├── YYYY_MM_DD_000002_create_audit_schema.php
        └── YYYY_MM_DD_000003_create_audit_log_changes_function.php

tests/                              # ONLY exception to Feature-First
├── Feature/
│   ├── [FeatureName]/
│   │   ├── [Name]Test.php
│   │   └── .gitkeep
│   └── GraphQL/
│       └── ErrorFormattingTest.php
├── Unit/
│   └── [FeatureName]/
│       └── [Name]Test.php
└── TestCase.php

graphql/
├── schema.graphql                  # Main entry point
└── shared/
    ├── scalars.graphql
    ├── directives.graphql
    ├── enums.graphql
    ├── inputs.graphql
    ├── interfaces.graphql
    ├── base-types.graphql          # Anti-loop types
    └── pagination.graphql
```

## Core Rules

### Separation of Concerns (CRITICAL)
- **Services** → ALL business logic
- **Models** → ONLY data, relationships, scopes
- **Resolvers** → ONLY delegate to services
- **Policies** → ONLY authorization
- **Events** → ONLY data, no logic

### File Placement
- Feature code → `app/Features/[Feature]/`
- Shared code (2+ features) → `app/Shared/`
- Tests → `tests/Feature/[Feature]/` (exception)
- GraphQL schema → `[Feature]/GraphQL/Schema/[feature].graphql`

### Naming
- Classes: PascalCase (UserService, LoginMutation)
- Methods: camelCase (createUser, findById)
- Variables: camelCase ($userId)
- Constants: UPPER_SNAKE_CASE
- DB tables: snake_case plural (users)
- DB columns: snake_case (created_at)

### Database
- Schemas: `ticketing` (business), `audit` (logs)
- Primary keys: UUID (use HasUuid trait)
- Auditing: Use Auditable trait
- Foreign keys: [table]_id

### Type Safety
- `declare(strict_types=1);` in ALL files
- Type hint ALL parameters and returns
- Use `final` classes by default
- Use PHP 8.3 features (readonly, enums)

### GraphQL
- DataLoaders for ALL related data in lists
- Resolvers only delegate to Services
- Use directives: @jwt, @can, @audit
- Schema in Feature's GraphQL/Schema/

## Key Principles

1. **Feature-First PURE**: ALL code in `Features/[Feature]/` (except tests)
2. **NO business logic** in Models, Resolvers, Events
3. **ALWAYS use DataLoaders** for GraphQL relationships
4. **Type everything**: strict types, type hints
5. **Event-Driven**: Fire events, handle in Listeners
6. **Eloquent only**: No raw SQL

## Common Mistakes

- ❌ Logic in Models/Resolvers → ✅ Services
- ❌ N+1 queries → ✅ DataLoaders
- ❌ Missing types → ✅ Type everything
- ❌ Files outside Features → ✅ In Features/
- ❌ Auto-increment → ✅ UUIDs

## Quick Reference

- Business logic → `Services/[Name]Service.php`
- Model → `Models/[Name].php`
- Query → `GraphQL/Queries/[Name]Query.php`
- Mutation → `GraphQL/Mutations/[Name]Mutation.php`
- DataLoader → `GraphQL/DataLoaders/[Name]Loader.php`
- Policy → `Policies/[Name]Policy.php`
- Event → `Events/[Name].php`
- Listener → `Listeners/[Name].php`
- Job → `Jobs/[Name]Job.php`
- Migration → `Database/Migrations/YYYY_MM_DD_[name].php`
- Test → `tests/Feature/[Feature]/[Test]Test.php`
